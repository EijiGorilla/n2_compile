"use strict";(self.webpackChunkn2_compile=self.webpackChunkn2_compile||[]).push([[37945],{13491:(e,t,i)=>{i.d(t,{Q:()=>o});var n=i(63780),a=i(27546),s=i(36231);class o{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:9,t=arguments.length>1?arguments[1]:void 0;this._compareMinX=d,this._compareMinY=p,this._toBBox=e=>e,this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this._toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),_.prune(),C.prune(),x.prune(),T.prune()}all(e){this._all(this._data,e)}search(e,t){let i=this._data;const n=this._toBBox;if(g(e,i))for(_.clear();i;){for(let a=0,s=i.children.length;a<s;a++){const s=i.children[a],o=i.leaf?n(s):s;g(e,o)&&(i.leaf?t(s):f(e,o)?this._all(s,t):_.push(s))}i=_.pop()}}collides(e){let t=this._data;const i=this._toBBox;if(!g(e,t))return!1;for(_.clear();t;){for(let n=0,a=t.children.length;n<a;n++){const a=t.children[n],s=t.leaf?i(a):a;if(g(e,s)){if(t.leaf||f(e,s))return!0;_.push(a)}}t=_.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}let t=this._build(e.slice(0,e.length),0,e.length-1,0);if(this._data.children.length)if(this._data.height===t.height)this._splitRoot(this._data,t);else{if(this._data.height<t.height){const e=this._data;this._data=t,t=e}this._insert(t,this._data.height-t.height-1,!0)}else this._data=t;return this}insert(e){return e&&this._insert(e,this._data.height-1),this}clear(){return this._data=new L([]),this}remove(e){if(!e)return this;let t,i=this._data,a=null,s=0,o=!1;const r=this._toBBox(e);for(x.clear(),T.clear();i||x.length>0;){if(i||(i=x.pop(),a=x.data[x.length-1],s=T.pop()??0,o=!0),i.leaf&&(t=(0,n.cq)(i.children,e,i.children.length,i.indexHint),-1!==t))return i.children.splice(t,1),x.push(i),this._condense(x),this;o||i.leaf||!f(i,r)?a?(s++,i=a.children[s],o=!1):i=null:(x.push(i),T.push(s),s=0,a=i,i=i.children[0])}return this}toJSON(){return this._data}fromJSON(e){return this._data=e,this}_all(e,t){let i=e;for(C.clear();i;){if(!0===i.leaf)for(const e of i.children)t(e);else C.pushArray(i.children);i=C.pop()??null}}_build(e,t,i,n){const a=i-t+1;let s=this._maxEntries;if(a<=s){const n=new L(e.slice(t,i+1));return r(n,this._toBBox),n}n||(n=Math.ceil(Math.log(a)/Math.log(s)),s=Math.ceil(a/s**(n-1)));const o=new k([]);o.height=n;const l=Math.ceil(a/s),h=l*Math.ceil(Math.sqrt(s));b(e,t,i,h,this._compareMinX);for(let r=t;r<=i;r+=h){const t=Math.min(r+h-1,i);b(e,r,t,l,this._compareMinY);for(let i=r;i<=t;i+=l){const a=Math.min(i+l-1,t);o.children.push(this._build(e,i,a,n-1))}}return r(o,this._toBBox),o}_chooseSubtree(e,t,i,n){for(;n.push(t),!0!==t.leaf&&n.length-1!==i;){let i,n=1/0,a=1/0;for(let s=0,o=t.children.length;s<o;s++){const o=t.children[s],r=u(o),l=y(e,o)-r;l<a?(a=l,n=r<n?r:n,i=o):l===a&&r<n&&(n=r,i=o)}t=i||t.children[0]}return t}_insert(e,t,i){const n=this._toBBox,a=i?e:n(e);x.clear();const s=this._chooseSubtree(a,this._data,t,x);for(s.children.push(e),h(s,a);t>=0&&x.data[t].children.length>this._maxEntries;)this._split(x,t),t--;this._adjustParentBBoxes(a,x,t)}_split(e,t){const i=e.data[t],n=i.children.length,a=this._minEntries;this._chooseSplitAxis(i,a,n);const s=this._chooseSplitIndex(i,a,n);if(!s)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const o=i.children.splice(s,i.children.length-s),l=i.leaf?new L(o):new k(o);l.height=i.height,r(i,this._toBBox),r(l,this._toBBox),t?e.data[t-1].children.push(l):this._splitRoot(i,l)}_splitRoot(e,t){this._data=new k([e,t]),this._data.height=e.height+1,r(this._data,this._toBBox)}_chooseSplitIndex(e,t,i){let n,a,s;n=a=1/0;for(let o=t;o<=i-t;o++){const t=l(e,0,o,this._toBBox),r=l(e,o,i,this._toBBox),h=m(t,r),d=u(t)+u(r);h<n?(n=h,s=o,a=d<a?d:a):h===n&&d<a&&(a=d,s=o)}return s}_chooseSplitAxis(e,t,i){const n=e.leaf?this._compareMinX:d,a=e.leaf?this._compareMinY:p;this._allDistMargin(e,t,i,n)<this._allDistMargin(e,t,i,a)&&e.children.sort(n)}_allDistMargin(e,t,i,n){e.children.sort(n);const a=this._toBBox,s=l(e,0,t,a),o=l(e,i-t,i,a);let r=c(s)+c(o);for(let l=t;l<i-t;l++){const t=e.children[l];h(s,e.leaf?a(t):t),r+=c(s)}for(let l=i-t-1;l>=t;l--){const t=e.children[l];h(o,e.leaf?a(t):t),r+=c(o)}return r}_adjustParentBBoxes(e,t,i){for(let n=i;n>=0;n--)h(t.data[n],e)}_condense(e){for(let t=e.length-1;t>=0;t--){const i=e.data[t];if(0===i.children.length)if(t>0){const a=e.data[t-1],s=a.children;s.splice((0,n.cq)(s,i,s.length,a.indexHint),1)}else this.clear();else r(i,this._toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this._compareMinX=new Function("a","b",t.join(e[0])),this._compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}function r(e,t){l(e,0,e.children.length,t,e)}function l(e,t,i,n,a){a||(a=new L([])),a.minX=1/0,a.minY=1/0,a.maxX=-1/0,a.maxY=-1/0;for(let s,o=t;o<i;o++)s=e.children[o],h(a,e.leaf?n(s):s);return a}function h(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function d(e,t){return e.minX-t.minX}function p(e,t){return e.minY-t.minY}function u(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function c(e){return e.maxX-e.minX+(e.maxY-e.minY)}function y(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function m(e,t){const i=Math.max(e.minX,t.minX),n=Math.max(e.minY,t.minY),a=Math.min(e.maxX,t.maxX),s=Math.min(e.maxY,t.maxY);return Math.max(0,a-i)*Math.max(0,s-n)}function f(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function g(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function b(e,t,i,n,a){const o=[t,i];for(;o.length;){const t=o.pop(),i=o.pop();if(t-i<=n)continue;const r=i+Math.ceil((t-i)/n/2)*n;(0,s.q)(e,r,i,t,a),o.push(i,r,r,t)}}const _=new a.Z,C=new a.Z,x=new a.Z,T=new a.Z({deallocator:void 0});class M{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class w extends M{constructor(){super(...arguments),this.height=1,this.indexHint=new n.SO}}class L extends w{constructor(e){super(),this.children=e,this.leaf=!0}}class k extends w{constructor(e){super(),this.children=e,this.leaf=!1}}},84683:(e,t,i)=>{i.d(t,{bU:()=>T,fC:()=>w,ir:()=>m,zp:()=>f});i(93169);var n=i(16889),a=i(53866),s=i(80885),o=i(78952),r=i(22186),l=i(83406),h=i(80457),d=i(19995);const p=new Float64Array(2),u=new Float64Array(2),c="0123456789bcdefghjkmnpqrstuvwxyz",y=64;function m(e,t,i,n){const r=[e.xmin,e.ymin,e.xmax,e.ymax],p=s.Z.fromExtent(a.Z.fromBounds(r,n)),u=(0,d.iV)(p,n,o.Z.WGS84,{densificationStep:t*y});if(!u)return null;const c=(0,l.Uy)(new h.Z,u,!1,!1),m=c.coords.filter(((e,t)=>!(t%2))),g=c.coords.filter(((e,t)=>t%2)),b=Math.min(...m),_=Math.min(...g),C=Math.max(...m),x=Math.max(...g),T=f(b,_,i,o.Z.WGS84),M=f(C,x,i,o.Z.WGS84);return T&&M?{bounds:r,geohashBounds:{xLL:T[0],yLL:T[1],xTR:M[0],yTR:M[1]},level:i}:null}function f(e,t,i,a){if(a.isWebMercator){const a=(0,n.BV)(e/r.sv.radius),s=a-360*Math.floor((a+180)/360),o=[0,0];return M(o,0,(0,n.BV)(Math.PI/2-2*Math.atan(Math.exp(-t/r.sv.radius))),s,i),o}const s=(0,d.iV)({x:e,y:t},a,o.Z.WGS84);if(!s)return null;const l=[0,0];return M(l,0,s.y,s.x,i),l}function g(e){return c[e]}function b(e){return(e[0]+e[1])/2}function _(e,t,i){return e[0]=t,e[1]=i,e}function C(e,t){const i=b(e),n=t,a=!t;e[0]=a*e[0]+n*i,e[1]=a*i+n*e[1]}function x(e,t){const i=t>b(e);return C(e,i),i}function T(e,t){let i=-90,n=90,a=-180,s=180;for(let o=0;o<t;o++){const t=Math.ceil((o+1)/2),r=Math.floor((o+1)/2),l=1-o%2,h=30-(3*t+2*r),d=30-(2*t+3*r),p=3*l+2*(1-l),u=2*l+3*(1-l),c=3*l+7*(1-l)<<d,y=(7*l+3*(1-l)<<h&e.geohashX)>>h,m=(c&e.geohashY)>>d;for(let e=p-1;e>=0;e--){const t=(a+s)/2,i=y&1<<e?1:0;a=(1-i)*a+i*t,s=(1-i)*t+i*s}for(let e=u-1;e>=0;e--){const t=(i+n)/2,a=m&1<<e?1:0;i=(1-a)*i+a*t,n=(1-a)*t+a*n}}return[a,i,s,n]}function M(e,t,i,n,a){a%2&&(a+=1);let s=0,o=0,r=-90,l=90,h=-180,d=180;for(let p=0;p<a/2;p++){for(let e=0;e<5;e++){const t=(h+d)/2,i=n>t?1:0;s|=i<<29-(e+5*p),h=(1-i)*h+i*t,d=(1-i)*t+i*d}for(let e=0;e<5;e++){const t=(r+l)/2,n=i>t?1:0;o|=n<<29-(e+5*p),r=(1-n)*r+n*t,l=(1-n)*t+n*l}}e[2*t]=s,e[2*t+1]=o}function w(e,t,i){let n="";const a=_(p,-90,90),s=_(u,-180,180);for(let o=0;o<i;o++){let i=0;o%2?(i|=x(a,e)<<4,i|=x(s,t)<<3,i|=x(a,e)<<2,i|=x(s,t)<<1,i|=x(a,e)<<0):(i|=x(s,t)<<4,i|=x(a,e)<<3,i|=x(s,t)<<2,i|=x(a,e)<<1,i|=x(s,t)<<0),n+=g(i)}return n}},27203:(e,t,i)=>{i.r(t),i.d(t,{default:()=>De});var n=i(27366),a=(i(59486),i(80987)),s=i(10064),o=i(32718),r=i(66978),l=i(49861),h=(i(93169),i(84936),i(69912)),d=i(84683),p=i(30651),u=i(83406),c=i(80457),y=i(7138),m=i(77427),f=i(76672),g=i(80885),b=i(79803),_=i(92975),C=i(3182),x=i(77981);class T{constructor(){this._featureLookup=new Map}static getInstance(){return T.instance||(T.instance=new T),T.instance}static resetInstance(){T.instance&&(T.instance=null)}deleteFromStore(e){e.forEach((e=>{this._featureLookup.delete(e)}))}readFromStoreByList(e){const t=[];return e.forEach((e=>{const i=this.readFromStoreById(e);i&&t.push(i)})),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,t,i){const n=[];return e.forEach((e=>{if(!e?.id)return;e.properties||(e.properties=[]);let a,s=null;if(i&&e.properties[i]&&(s=(0,u.GH)(e.properties[i])),"originId"in e&&"destinationId"in e&&(e.properties.ESRI__ORIGIN_ID=e.originId,e.properties.ESRI__DESTINATION_ID=e.destinationId),e.properties[t]=e.id,e.id&&this._featureLookup.has(e.id)&&this._featureLookup.get(e.id).attributes){const n=this._featureLookup.get(e.id),o=JSON.parse(JSON.stringify(Object.assign(n.attributes,e.properties)));i&&e.properties[i]&&(o[i]=(0,x.im)(e.properties[i])),a=new C.u_(s?JSON.parse(JSON.stringify(s)):n?.geometry?JSON.parse(JSON.stringify(n.geometry)):null,o,null,e.properties[t])}else a=new C.u_(s?JSON.parse(JSON.stringify(s)):null,e.properties,null,e.properties[t]);this._featureLookup.set(e.id,a),n.push(a)})),n}}i(76200);var M,w=i(92848),L=i(5924);i(78952);!function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"}(M||(M={}));M.ELEMENTUID,M.TYPENAME;var k,I;!function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"}(k||(k={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(I||(I={}));var E,D,v,N;i(72430),i(71084);function R(e){if(!e.spatialReference.isWGS84)throw new s.Z("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");let t;return t=e.xmax>180&&e.xmin<180?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[-180,e.ymin]]]:e.xmax>180&&e.xmin>180?[[[e.xmin-360,e.ymin],[e.xmin-360,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[e.xmin-360,e.ymin]]]:e.xmax>-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin+360,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[-180,e.ymin]]]:e.xmax<-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[e.xmax+360,e.ymax],[e.xmax+360,e.ymin],[e.xmin+360,e.ymin]]]:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]],t}!function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"}(E||(E={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(D||(D={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(v||(v={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(N||(N={}));var S=i(21149),A=i(53866);const B="ESRI__ID",G="ESRI__ORIGIN_ID",Z="ESRI__DESTINATION_ID",j="ESRI__LAYOUT_GEOMETRY",F="ESRI__AGGREGATION_COUNT",q=12;let O=class extends y.Z{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach((i=>{i.name&&(t.set(i.name,"entity"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(i.name),i.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(i.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((i=>{i.name&&(t.set(i.name,"relationship"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(i.name),i.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(i.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((i,n)=>{if("entity"===t.get(n))this.entityTypeNames.add(n);else{if("relationship"!==t.get(n))return o.Z.getLogger(this).warn(`A named type, ${n}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(n);this.relationshipTypeNames.add(n)}const a=new Map;i.members?.forEach((e=>{(0,m.s1)(this.memberIdTypeLookup,e.id,(()=>new Set)).add(n);const t=this.getById(e.id);t&&a.set(e.id,t)})),this.sublayerCaches.set(n,a)}))}addToLayer(e){e.forEach((e=>{let{typeName:t,id:i}=e;if(!this.inclusionModeDefinition)throw new s.Z("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){const e=this.inclusionModeDefinition.namedTypeDefinitions.get(t);e.members||(e.members=new Map),e.members.set(i,{id:i}),(0,m.s1)(this.memberIdTypeLookup,i,(()=>new Set)).add(t)}}else{const e=new Map;e.set(i,{id:i}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:e}),(0,m.s1)(this.memberIdTypeLookup,i,(()=>new Set)).add(t)}}))}getById(e){return T.getInstance().readFromStoreById(e)}async getData(e,t,i){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let n;if(n=e||new S.Z({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){const e=t.parentCompositeLayer,i=this._processingCacheUpdatesLookup.get(t.objectType.name??""),a=n.outFields,s=n.geometry;let o="",r="";s&&s.extent&&(o=(0,d.fC)(s.extent.ymin,s.extent.xmin,q),r=(0,d.fC)(s.extent.ymax,s.extent.xmax,q)),a&&1===a.length&&a[0]===B&&"1=1"===n.where||await Promise.all(i??[]);const l=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],h=[];return l.forEach((i=>{if(this.relationshipTypeNames.has(t.objectType.name)?i.geometry=e.relationshipLinkChartDiagramLookup.get(i.attributes[t.objectIdField]):i.geometry=e.entityLinkChartDiagramLookup.get(i.attributes[t.objectIdField]),i.attributes[j]=i.geometry,o&&r){const n=e.linkChartGeohashLookup.get(i.attributes[t.objectIdField]);n?n>=o&&n<=r&&h.push(i):h.push(i)}else h.push(i)})),h}return this.retrieveDataFromService(n,t,i)}async getConnectedRecordIds(e,t){const i=[];let n="";const a=[],s=new Map;if(e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e)){if(!this.entityTypeNames.has(t))return;s.has(t)?s.get(t)?.push(e):s.set(t,[e])}})),t&&0!==t?.length){for(const e of t)n=n+e+"|";n=n.slice(0,-1)}return s.forEach(((e,s)=>{let r;r=t&&0!==t?.length?`MATCH (n:${s})-[r:${n}]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${s})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`;const l=new Promise((t=>{(async()=>{const t=(await(0,w.executeQueryStreaming)(this.knowledgeGraph,new L.Z({openCypherQuery:r,bindParameters:{ids:e}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:n}=await t.read();if(e)break;for(let t=0;t<n.length;t++){const e=n[t];i.push({id:e[0],typeName:e[1]}),i.push({id:e[2],typeName:e[3]})}}}catch(n){if("AbortError"!==n.name)throw n;o.Z.getLogger(this).info("Request aborted as expected")}})().then((()=>{t()}))}));a.push(l)})),this.refreshCacheContent(),await Promise.all(a),i}async refreshCacheContent(e,t,i){let n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const a=T.getInstance(),o=[],r=new Map,l=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&l.set(e.name,e)})),this.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&l.set(e.name,e)})),e||this.inclusionModeDefinition?e?e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e))r.has(t)?r.get(t)?.push(e):r.set(t,[e])})):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e.useAllData?r.set(t,null):e.members&&e.members.forEach((e=>{r.has(t)&&null!==r.get(t)?r.get(t)?.push(e.id):r.set(t,[e.id])}))})):(this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&r.set(e.name,null)})),this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&r.set(e.name,null)})));for(const[h,d]of r){const e=new Promise((e=>{(async()=>{const e=new Set,o=[];let r,p="",u=!1;if(t||l.get(h)?.properties?.forEach((t=>{t.name&&e.add(t.name)})),i&&this.geographicLookup.has(h)){const t=this.geographicLookup.get(h)?.name;t&&e.add(t)}if(this.entityTypeNames.has(h))p=`MATCH (n:${h}) ${d?"WHERE id(n) IN $ids ":""}return ID(n)`,e.forEach((e=>{p+=`, n.${e}`,o.push(e)}));else{if(!this.relationshipTypeNames.has(h))throw new s.Z("knowledge-graph:layer-data-manager",`The graph type of ${h} could not be determined. Was this type set in the KG data model and inclusion definition?`);u=!0,p=`MATCH ()-[n:${h}]->() ${d?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,e.forEach((e=>{p+=`, n.${e}`,o.push(e)}))}r=new L.Z(d?{openCypherQuery:p,bindParameters:{ids:d}}:{openCypherQuery:p});const c=(await(0,w.executeQueryStreaming)(this.knowledgeGraph,r)).resultRowsStream.getReader();for(;;){const{done:e,value:t}=await c.read();if(e)break;const i=[];for(let n=0;n<t.length;n++){const e=t[n];let a=0,s=0;const r={properties:{}};for(r.id=e[a],a++,s++,u&&(r.originId=e[a],a++,s++,r.destinationId=e[a],a++,s++,(0,m.s1)(this.nodeConnectionsLookup,r.originId,(()=>new Set)).add(r.id),(0,m.s1)(this.nodeConnectionsLookup,r.destinationId,(()=>new Set)).add(r.id),(0,m.s1)(this.relationshipConnectionsLookup,r.id,(()=>[r.originId,r.destinationId])));a<e.length;a++)r.properties[o[a-s]]=e[a];i.push(r)}const s=a.writeToStore(i,B,this.geographicLookup.get(h)?.name);this.sublayerCaches.has(h)||this.sublayerCaches.set(h,new Map),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(h)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(h,{useAllData:!1,members:new Map}),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(h).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(h).members=new Map);const r=this.sublayerCaches.get(h);s.forEach((e=>{r?.set(e.attributes[B],e),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(h).members.has(e.attributes[B])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(h).members.set(e.attributes[B],{id:e.attributes[B]}),(0,m.s1)(this.memberIdTypeLookup,e.attributes[B],(()=>new Set)).add(h))}))}})().then((()=>{e(null)}))}));o.push(e),this._processingCacheUpdatesLookup.get(h)?.push(e)}await Promise.all(o)}removeFromLayer(e){const t=new Set,i=new Set(e.map((e=>e.id)));for(const n of e)t.add(n.typeName),1===this.memberIdTypeLookup.get(n.id)?.size?this.memberIdTypeLookup.delete(n.id):this.memberIdTypeLookup.get(n.id)?.delete(n.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{t===n.typeName&&e.members?.has(n.id)&&e.members.delete(n.id)}));t.forEach((e=>{this.sublayerCaches.get(e)?.forEach(((t,n)=>{i.has(n)&&this.sublayerCaches.get(e)?.delete(n)}))}))}async retrieveDataFromService(e,t,i){const n=T.getInstance(),a=new Set,o=[];let r,l="",h=[];const d="relationship"===t.graphType,p=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,u=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let c=!p&&u?Array.from(u).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&null!=e.objectIds&&(c=e.objectIds);else if(null!=e.objectIds&&c&&c.length>0){const t=e.objectIds;e.objectIds=c.filter((e=>t.includes(e)))}else if(null!=e.objectIds)c=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=c}if(null!=e.outFields){const i=e.outFields;i.includes("*")?t.fields.forEach((e=>{a.add(e.name)})):i.forEach((e=>{e!==B&&e!==t.geometryFieldName&&a.add(e)}))}if(null!=e.geometry){const i=e.geometry;let n;const h=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,p=h?.spatialReference,u=h?.serviceCapabilities?.geometryCapabilities;let c=u?.geometryMaxBoundingRectangleSizeX,y=u?.geometryMaxBoundingRectangleSizeY;if(i?.extent?.spatialReference&&!i.spatialReference?.isWGS84?(await(0,b.initializeProjection)(i.extent.spatialReference,_.YU),n=(0,b.project)(i.extent,_.YU)):n=i.extent,c&&y&&p){if(4326!==p.wkid){const e=new A.Z({spatialReference:p,xmax:c,ymax:y}),t=(0,b.project)(e,_.YU);c=t.xmax,y=t.ymax}if(n.xmax-n.xmin>c)throw new s.Z("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${c}\xb0 latitude, limit exceeded`);if(n.ymax-n.ymin>y)throw new s.Z("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${y}\xb0 longitude, limit exceeded`)}if(null!=e.where&&"1=1"!==e.where){const i=await(0,f.E)(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach((e=>{i.fieldNames.includes(e.name)&&a.add(e.name)}))}l=d?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&a.add(t.geometryFieldName),a.forEach((e=>{l+=`, n.${e}`,o.push(e)})),r=new L.Z({openCypherQuery:l,bindParameters:{param_filter_geom:new g.Z({rings:R(n)})}})}else{let i="";if(null!=e.where&&"1=1"!==e.where){const n=await(0,f.E)(e.where,t.fieldsIndex);t.fields.forEach((e=>{n.fieldNames.includes(e.name)&&a.add(e.name)}));const s=new Set(["column-reference","string","number","binary-expression"]),o=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let r=!1;const l=e=>{if("column-reference"===e.type)return`n.${e.column}`;if("string"===e.type)return`'${e.value}'`;if("number"===e.type)return`${e.value}`;if("binary-expression"===e.type&&s.has(e.left.type)&&s.has(e.right.type)&&o.has(e.operator))return`${l(e.left)} ${e.operator} ${l(e.right)}`;if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+=`lower(n.${e.left.args.value[0].column})`;else{if("column-reference"!==e.left.type)return r=!0,"";t+=`lower(n.${e.left.column})`}if(t+=" CONTAINS (","string"!==e.right.type)return r=!0,"";{let i=e.right.value;"%"===i.charAt(0)&&(i=i.slice(1)),"%"===i.charAt(i.length-1)&&(i=i.slice(0,-1)),t+=`'${i.toLowerCase()}')`}return t}return r=!0,""};i=l(n.parseTree),r&&(i="")}let n="";n=d?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let s=!1;c&&(s=!0,n+=" WHERE ID(n) IN $ids"),i&&(n+=s?" AND":" WHERE",n+=` ${i}`),n+=" return ID(n)",d&&(n+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&a.add(t.geometryFieldName),a.forEach((e=>{n+=`, n.${e}`,o.push(e)})),r=new L.Z(c?{openCypherQuery:n,bindParameters:{ids:c}}:{openCypherQuery:n})}const y=(await(0,w.executeQueryStreaming)(t.parentCompositeLayer.dataManager.knowledgeGraph,r,i)).resultRowsStream.getReader();for(;;){const{done:e,value:i}=await y.read();if(e)break;const a=[];for(let t=0;t<i.length;t++){const e=i[t];let n=0,s=0;const r={properties:{}};for(r.id=e[n],n++,s++,d&&(r.originId=e[n],n++,s++,r.destinationId=e[n],n++,s++);n<e.length;n++)r.properties[o[n-s]]=e[n];a.push(r)}h=h.concat(n.writeToStore(a,B,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return h}};(0,n._)([(0,l.Cb)()],O.prototype,"knowledgeGraph",void 0),(0,n._)([(0,l.Cb)()],O.prototype,"inclusionModeDefinition",void 0),(0,n._)([(0,l.Cb)()],O.prototype,"entityTypeNames",void 0),(0,n._)([(0,l.Cb)()],O.prototype,"relationshipTypeNames",void 0),(0,n._)([(0,l.Cb)()],O.prototype,"geographicLookup",void 0),(0,n._)([(0,l.Cb)()],O.prototype,"sublayerCaches",void 0),(0,n._)([(0,l.Cb)()],O.prototype,"nodeConnectionsLookup",void 0),(0,n._)([(0,l.Cb)()],O.prototype,"relationshipConnectionsLookup",void 0),(0,n._)([(0,l.Cb)()],O.prototype,"memberIdTypeLookup",void 0),O=(0,n._)([(0,h.j)("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],O);var P=i(44055),Y=(i(94931),i(15126),i(98689),i(57823),i(32066),i(49018),i(34999),i(28189),i(9014)),U=i(40464),Q=(i(70431),i(68928)),$=i(75878),X=i(63543);const H=(0,i(25610).v)(),z=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return(0,n._)([(0,l.Cb)(H.fields)],t.prototype,"fields",void 0),(0,n._)([(0,l.Cb)(H.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=(0,n._)([(0,h.j)("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],t),t};var J=i(6693),V=i(64834),W=i(71684),K=i(56811),ee=i(45948),te=i(83040),ie=i(37270),ne=i(49818),ae=i(81085),se=i(82485),oe=i(29909),re=i(27823);let le=class extends((0,V.M)(z((0,J.h)((0,K.M)((0,W.Q)(p.Z)))))){constructor(e){var t;if(super(e),t=this,this.capabilities=(0,X.MS)(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=B,this.objectType=null,this.parentCompositeLayer=null,this.popupEnabled=!0,this.popupTemplate=null,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new se.Z(e.port1,{channel:e,client:{queryFeatures:function(e){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=S.Z.fromJSON(e);return t.queryFeaturesJSON(n,i)}}}),[e.port2]}))},this.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=j;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&"esriGeometryNull"!==e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?re.M.fromJSON(t.geometryType):null;const i=t?.name,n=i?e.objectType.properties?.[i]:null;n?(this.hasM=n.hasM??!1,this.hasZ=n.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach((e=>{let t=e.fieldType;"esriFieldTypeOID"===t&&(t="esriFieldTypeInteger"),this.fields.push(te.Z.fromJSON({name:e.name,type:t,alias:e.alias,defaultValue:null,editable:e.editable,nullable:e.nullable}))})),this.fields.push(te.Z.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this.fields.push(te.Z.fromJSON({name:F,type:"esriFieldTypeInteger",alias:F,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?this.renderer=(0,Y.i)((0,X.bU)(re.M.toJSON("polyline")).renderer):this.renderer=(0,Y.i)((0,X.bU)(re.M.toJSON("point")).renderer):this.renderer=(0,Y.i)((0,X.bU)(re.M.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){(0,ie.YN)(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return(0,ae.eZ)(this,e)}createQuery(){return new S.Z({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];return null}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e),a=ne.Z.fromJSON(await n.executeQuery(i.toJSON(),t?.signal));return a.features.forEach((e=>{e.sourceLayer=this})),a}async queryFeaturesJSON(e,t){const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e);return await n.executeQuery(i.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e);return n.executeQueryForCount(i.toJSON(),t?.signal)}async queryExtent(){let e=arguments.length>1?arguments[1]:void 0;const t={...arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},returnGeometry:!0},{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(t),a=await n.executeQueryForExtent(i.toJSON(),e?.signal);let s;return s=null!=a.extent?.xmin&&null!=a.extent?.xmax&&null!=a.extent?.ymin&&null!=a.extent?.ymax?new A.Z(a.extent):new A.Z,{count:a.count,extent:s}}async queryObjectIds(e,t){const i=S.Z.from(e);let n;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(i,this,t);n=this.loadQueryEngine(e)}return n.executeQueryForIds(i.toJSON(),t?.signal)}loadQueryEngine(e){const t=new Q.Z({geometryType:re.M.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),i=new $.q({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:re.M.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return i.featureStore.addMany(e),i}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new S.Z({where:"1=1",outFields:[B]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const i=S.Z.from(e),n=i.geometry;let a;if(n&&!n.spatialReference?.isWGS84&&(await(0,b.initializeProjection)(n.spatialReference,_.YU),i.geometry=(0,b.project)(n instanceof g.Z||n instanceof oe.Z?n:n.extent,_.YU)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)a=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(i,this,t);a=this.loadQueryEngine(e)}return{resolvedQuery:i,queryEngine:a}}};(0,n._)([(0,l.Cb)()],le.prototype,"capabilities",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],le.prototype,"defaultPopupTemplate",null),(0,n._)([(0,l.Cb)()],le.prototype,"definitionExpression",void 0),(0,n._)([(0,l.Cb)()],le.prototype,"displayField",void 0),(0,n._)([(0,l.Cb)()],le.prototype,"elevationInfo",void 0),(0,n._)([(0,l.Cb)()],le.prototype,"geometryType",void 0),(0,n._)([(0,l.Cb)()],le.prototype,"geometryFieldName",void 0),(0,n._)([(0,l.Cb)()],le.prototype,"graphType",void 0),(0,n._)([(0,l.Cb)()],le.prototype,"hasM",void 0),(0,n._)([(0,l.Cb)()],le.prototype,"hasZ",void 0),(0,n._)([(0,l.Cb)()],le.prototype,"labelsVisible",void 0),(0,n._)([(0,l.Cb)()],le.prototype,"labelingInfo",void 0),(0,n._)([(0,l.Cb)()],le.prototype,"objectIdField",void 0),(0,n._)([(0,l.Cb)()],le.prototype,"objectType",void 0),(0,n._)([(0,l.Cb)()],le.prototype,"parentCompositeLayer",void 0),(0,n._)([(0,l.Cb)(ee.C_)],le.prototype,"popupEnabled",void 0),(0,n._)([(0,l.Cb)({type:P.Z,json:{name:"popupInfo",write:!0}})],le.prototype,"popupTemplate",void 0),(0,n._)([(0,l.Cb)({types:U.A,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],le.prototype,"renderer",null),(0,n._)([(0,l.Cb)()],le.prototype,"source",void 0),(0,n._)([(0,l.Cb)({json:{read:!1}})],le.prototype,"type",void 0),le=(0,n._)([(0,h.j)("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],le);const he=le;var de=i(65905);let pe,ue=null;function ce(){return pe||(pe=i.e(39672).then(i.bind(i,39672)).then((e=>e.l)).then((e=>{let{default:t}=e;return t({locateFile:e=>(0,de.V)(`esri/libs/linkchartlayout/${e}`)})})).then((e=>{!function(e){ue=e}(e)})),pe)}var ye,me;function fe(e,t,i,n,a,s){const o=i.length,r=a.length,l=Float64Array.BYTES_PER_ELEMENT,h=Uint32Array.BYTES_PER_ELEMENT,d=Uint8Array.BYTES_PER_ELEMENT,p=15+o*(d+2*l)+r*(2*h),u=ue._malloc(p);try{const d=u+16-u%16,p=d+o*l,c=p+o*l,y=c+r*h,m=y+r*h,f=()=>[ue.HEAPF64.subarray(d>>3,(d>>3)+o),ue.HEAPF64.subarray(p>>3,(p>>3)+o),ue.HEAPU32.subarray(c>>2,(c>>2)+r),ue.HEAPU32.subarray(y>>2,(y>>2)+r),ue.HEAPU8.subarray(m,m+o)],[g,b,_,C,x]=f();g.set(i),b.set(n),_.set(a),C.set(s),x.set(t);let T=e(o,m,d,p,r,c,y),M=null;if(T){const e=ue.getLayoutLinksTypes(),t=ue.getLayoutLinksVerticesEndIndices(),i=ue.getLayoutLinksVertices(),n=ue.countLayoutLinksVertices();!r||e&&t?n&&!i?T=!1:M={types:new Uint8Array(ue.HEAPU8.subarray(e,e+r)),vertexEndIndex:new Uint32Array(ue.HEAPU32.subarray(t>>2,(t>>2)+r)),vertices:new Float64Array(ue.HEAPF64.subarray(i>>3,(i>>3)+2*n))}:T=!1}const[w,L,k,I,E]=f();return i.set(w),n.set(L),a.set(k),s.set(I),t.set(E),{success:T,links:M}}finally{ue._free(u),ue.cleanupLayout()}}!function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"}(ye||(ye={})),function(e){e[e.Regular=0]="Regular",e[e.Orthogonal=1]="Orthogonal",e[e.Curved=2]="Curved",e[e.Recursive=3]="Recursive"}(me||(me={}));var ge,be,_e,Ce,xe,Te,Me,we;!function(e){e.getMinIdealEdgeLength=function(){return ue.getMinIdealEdgeLength()},e.apply=function(e,t,i,n,a){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,r=arguments.length>7&&void 0!==arguments[7]?arguments[7]:-1;return fe(((e,t,i,n,a,l,h)=>ue.applyForceDirectedLayout(e,t,i,n,a,l,h,s,o,r)),e,t,i,n,a)}}(ge||(ge={})),function(e){e.apply=function(e,t,i,n,a){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,r=arguments.length>7&&void 0!==arguments[7]?arguments[7]:-1;return fe(((e,t,i,n,a,l,h)=>ue.applyCommunityLayout(e,t,i,n,a,l,h,s,o,r)),e,t,i,n,a)}}(be||(be={})),function(e){e.apply=function(e,t,i,n,a){return fe(ue.applySimpleLayout,e,t,i,n,a)}}(_e||(_e={})),function(e){e.apply=function(e,t,i,n,a){return fe(ue.applyHierarchicalLayout,e,t,i,n,a)}}(Ce||(Ce={})),function(e){e.apply=function(e,t,i,n,a){return fe(ue.applyRadialTreeLayout,e,t,i,n,a)}}(xe||(xe={})),function(e){e.apply=function(e,t,i,n,a){return fe(ue.applySmartTreeLayout,e,t,i,n,a)}}(Te||(Te={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(Me||(Me={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(we||(we={}));var Le=i(54958),ke=i(85136),Ie=i(585);let Ee=class extends((0,J.h)((0,K.M)(p.Z))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new a.Z,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new A.Z({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new a.Z,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new s.Z("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const e=this.url.split("/");this.title=e[e.length-2]}const t=new Set;let i=[],n=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new s.Z("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.inclusionModeDefinition?.generateAllSublayers?(i=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((a,s)=>{if(!this._graphTypeLookup.get(s))return o.Z.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);this._graphTypeLookup.get(s)instanceof ke.Z||"strictOrigin"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),n.push(this._graphTypeLookup.get(s))):this._graphTypeLookup.get(s)instanceof Le.Z||"properties"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),i.push(this._graphTypeLookup.get(s))):(o.Z.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(s))})):(i=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]);const a=new O({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=i,this.memberRelationshipTypes=n,this.dataManager=a}load(e){return this.addResolvingPromise(new Promise((t=>{(0,w.fetchKnowledgeGraph)(this.url).then((i=>{if(this._initializeLayerProperties({knowledgeGraph:i,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})})),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}))),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e=>{e.useAllData=!1,e.members?.forEach((e=>{let t;t=e.linkChartLocation instanceof c.Z?e.linkChartLocation:e.linkChartLocation?(0,u.GH)(e.linkChartLocation):null,t&&2===t.coords.length&&0===t.lengths.length?(this.linkChartGeohashLookup.set(e.id,(0,d.fC)(t.coords[1],t.coords[0],q)),this.entityLinkChartDiagramLookup.set(e.id,t)):(this.linkChartGeohashLookup.set(e.id,""),this.relationshipLinkChartDiagramLookup.set(e.id,t))})),this.addResolvingPromise(this._initializeDiagram().then((async()=>{this.layers.forEach((async e=>{await e.refreshCachedQueryEngine()})),this.tables.forEach((async e=>{await e.refreshCachedQueryEngine()}))})))}));else{const t="GEOGRAPHIC"===this.defaultLinkChartConfig?.layoutMode;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,t,!0).then((async()=>{(0,r.k_)(e);const t=[],i=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach((e=>{e.useAllData=!1}))),await this._initializeDiagram(),this.layers.forEach((e=>{i.push(e.refreshCachedQueryEngine()),t.push(new Promise((t=>{e.on("layerview-create",(()=>{t(null)}))})))})),this.tables.forEach((e=>{i.push(e.refreshCachedQueryEngine())})),await Promise.all(i)})))}t(null)}))}))),Promise.resolve(this)}async addRecords(e,t){let i=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(i=await async function(e,t){const i=[],n=new Map,a=[];if(t.dataModel?.relationshipTypes)for(const s of t.dataModel.relationshipTypes)s.name&&n.set(s.name,[]);for(const s of e)n.has(s.typeName)&&n.get(s.typeName)?.push(s.id);for(const[s,o]of n){if(o.length<1)continue;const e=new L.Z({openCypherQuery:`MATCH (n)-[r:${s}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:o}});a.push((0,w.executeQueryStreaming)(t,e).then((async e=>{const t=e.resultRowsStream.getReader();for(;;){const{done:e,value:n}=await t.read();if(e)break;for(const t of n)i.push({id:t[0],typeName:t[1]}),i.push({id:t[2],typeName:t[3]})}})))}return await Promise.all(a),i}(e,this.dataManager.knowledgeGraph));const n=e.concat(i).filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));await this._handleNewRecords(n)}async removeRecords(e){let{cascadeRemoveRelationships:t=!0,recalculateLayout:i=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{cascadeRemoveRelationships:!0,recalculateLayout:!1},n=[];for(const s of e)!1===this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(s.typeName)?.useAllData&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(s.typeName)?.members?.has(s.id)&&n.push(s);if(t){const e=new Set,t=[];for(const i of n)if(this.dataManager.nodeConnectionsLookup.has(i.id))for(const t of this.dataManager.nodeConnectionsLookup.get(i.id))e.add(t);for(const i of e)if(this.dataManager.memberIdTypeLookup.has(i))for(const e of this.dataManager.memberIdTypeLookup.get(i))this.dataManager.relationshipTypeNames.has(e)&&t.push({id:i,typeName:e});n=n.concat(t)}this.dataManager.removeFromLayer(n);for(const s of n)this.sublayerIdsCache.get(s.typeName)?.delete(s.id),this.dataManager.relationshipTypeNames.has(s.typeName)?this.relationshipLinkChartDiagramLookup.delete(s.id):this.entityLinkChartDiagramLookup.delete(s.id);i&&await this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,{});const a=[];return this.layers.forEach((e=>{a.push(e.refreshCachedQueryEngine())})),await Promise.all(a),this._refreshNamedTypes(),n}async expand(e,t){const i=await this.dataManager.getConnectedRecordIds(e,t),n=i.filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));return await this._handleNewRecords(i),{records:n}}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach((e=>{const t=new he({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.memberEntityTypes.forEach((e=>{const t=new he({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{const i=((e,t,i)=>(e.has(t)||e.set(t,i()),e.get(t)))(this.sublayerIdsCache,t,(()=>new Set));e.members?.forEach((e=>{if(i.add(e.id),e.linkChartLocation)if(e.linkChartLocation instanceof c.Z)this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation),2===e.linkChartLocation.coords.length&&0===e.linkChartLocation.lengths.length?this.linkChartGeohashLookup.set(e.id,(0,d.fC)(e.linkChartLocation.coords[1],e.linkChartLocation.coords[0],q)):this.linkChartGeohashLookup.set(e.id,"");else{const i=(0,u.GH)(e.linkChartLocation);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation?i:null):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation?i:null),"x"in e.linkChartLocation&&"y"in e.linkChartLocation?this.linkChartGeohashLookup.set(e.id,(0,d.fC)(e.linkChartLocation.x,e.linkChartLocation.y,q)):this.linkChartGeohashLookup.set(e.id,"")}}))}))}async calculateLinkChartLayout(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"RADIAL_TREE",t=arguments.length>1?arguments[1]:void 0;const i=[],n=[],a=[];this.dataManager.sublayerCaches.forEach(((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach((e=>{i.push({typeName:t,feature:e})})):this.dataManager.relationshipTypeNames.has(t)&&e.forEach((e=>{n.push({typeName:t,feature:e})}))})),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const r=new Map,l=new Map,h=new Map,p=new Map,c=new Uint8Array(i.length),y=new Float64Array(i.length),m=new Float64Array(i.length),f=new Uint32Array(n.length),g=new Uint32Array(n.length),b=[],_=new A.Z({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let C,x="FORCE_DIRECTED",T=0,M=0;switch(x="GEOGRAPHIC"===e?"FORCE_DIRECTED":e,x){case"FORCE_DIRECTED":C=ge.apply;break;case"COMMUNITY":C=be.apply;break;case"HIERARCHICAL":C=Ce.apply;break;case"RADIAL_TREE":C=xe.apply;break;case"SMART_TREE":C=Te.apply;break;default:C=_e.apply}i.forEach((i=>{let{typeName:n,feature:a}=i;if(t?.lockedNodeLocations?.has(a.attributes[B])){"GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(n)?c[T]=ye.IsGeographic:c[T]=ye.None;const i=t.lockedNodeLocations.get(a.attributes[B]);y[T]=i.x,m[T]=i.y}else if("GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(n)){c[T]=ye.IsGeographic;let e=null;const t=a.attributes[this.dataManager.geographicLookup.get(n).name],i=this.dataManager.geographicLookup.get(n)?.geometryType;switch(i){case"esriGeometryPoint":y[T]=t?.x,m[T]=t?.y;break;case"esriGeometryPolygon":e=t?.centroid,null!=e?.x&&null!=e?.y?(y[T]=e.x,m[T]=e.y):c[T]=ye.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=t?.extent?.center,null!=e?.x&&null!=e?.y?(y[T]=e.x,m[T]=e.y):c[T]=ye.IsMovable;break;default:c[T]=ye.IsMovable}(null==y[T]||null==m[T]||Number.isNaN(y[T])||Number.isNaN(m[T]))&&(c[T]=ye.IsMovable,y[T]=0,m[T]=0)}else c[T]=ye.IsMovable,y[T]=0,m[T]=0;p.set(a.attributes[B],T),b[T]={feature:a,typeName:n},T++}));let w=!1;const L=new Map;n.forEach((e=>{const t=e.feature.attributes[G],i=e.feature.attributes[Z],n=p.get(t),s=p.get(i);if(void 0!==n&&void 0!==s){const o=t+"-"+i,r=L.get(o),l=r?.has(e.typeName);l||(f[M]=n,g[M]=s,void 0===r?L.set(o,new Map([[e.typeName,M]])):r.set(e.typeName,M),M++),a.push(e)}else w=!0,this.relationshipLinkChartDiagramLookup.set(t,null),this.linkChartGeohashLookup.set(t,null)})),w&&o.Z.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await ce();const{success:k,links:I}=C(c,y,m,f.subarray(0,M),g.subarray(0,M));if(!k)throw new s.Z("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let s=0;s<b.length;s++){if(m[s]>84.9999?m[s]=84.9999:m[s]<-84.9999&&(m[s]=-84.9999),y[s]>179.9999?y[s]=179.9999:y[s]<-179.9999&&(y[s]=-179.9999),b[s].feature.attributes[j]=new Ie.Z(y[s],m[s]),r.has(b[s].typeName)){const e=r.get(b[s].typeName);e?.set(b[s].feature.attributes[B],b[s].feature)}else{const e=new Map;e.set(b[s].feature.attributes[B],b[s].feature),r.set(b[s].typeName,e)}h.set(b[s].feature.attributes[B],b[s].feature);const e=(0,u.GH)(b[s].feature.attributes[j]);this.entityLinkChartDiagramLookup.set(b[s].feature.attributes[B],b[s].feature.attributes[j]?e:null),this.linkChartGeohashLookup.set(b[s].feature.attributes[B],(0,d.fC)(b[s].feature.attributes[j].y,b[s].feature.attributes[j].x,q)),b[s].feature.attributes[j].x<_.xmin&&(_.xmin=b[s].feature.attributes[j].x),b[s].feature.attributes[j].x>_.xmax&&(_.xmax=b[s].feature.attributes[j].x),b[s].feature.attributes[j].y<_.ymin&&(_.ymin=b[s].feature.attributes[j].y),b[s].feature.attributes[j].y>_.ymax&&(_.ymax=b[s].feature.attributes[j].y)}if(this.linkChartExtent.xmin=_.xmin,this.linkChartExtent.xmax=_.xmax,this.linkChartExtent.ymin=_.ymin,this.linkChartExtent.ymax=_.ymax,!I)throw new s.Z("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const E=new Map,D=new Map,v=new Map,N=new Set;for(let s=0;s<a.length;s++){const e=[],t=a[s],i=t.feature.attributes[G],n=t.feature.attributes[Z],r=i+"-"+n,d=L.get(r).get(t.typeName),c=0===d?0:I?.vertexEndIndex[d-1];if(!N.has(d)){if(N.add(d),I.types[d]===me.Recursive){const t=[I.vertices[2*c],I.vertices[2*c+1]],i=[I.vertices[2*(c+1)],I.vertices[2*(c+1)+1]],n=[.5*(t[0]+i[0]),.5*(t[1]+i[1])],a=[n[0]-t[0],n[1]-t[1]],s=[n[0]+a[1],n[1]-a[0]],o=[n[0]-a[1],n[1]+a[0]];e.push(t),e.push(s),e.push(i),e.push(o),e.push(t)}else{if(I.types[d]!==me.Regular){o.Z.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let t=c;t<I.vertexEndIndex[d];t++)e.push([I.vertices[2*t],I.vertices[2*t+1]])}const t=b[p.get(i)]?.feature.attributes[j],a=b[p.get(n)]?.feature.attributes[j];e[0][0]===t.x&&e[0][1]===t.y||(e[0]=[t.x,t.y]),e[e.length-1][0]===a.x&&e[e.length-1][1]===a.y||(e[e.length-1]=[a.x,a.y]);for(let i=1;i<e.length-1;i++)e[i][1]>85.5?e[i][1]=85.5:e[i][1]<-85.5&&(e[i][1]=-85.5),e[i][0]>179.9999?e[i][0]=179.9999:e[i][0]<-179.9999&&(e[i][0]=-179.9999);E.has(r)?E.get(r).push(e):E.set(r,[e])}const y=E.get(r);D.has(r)||(D.set(r,new Map),v.set(r,new Map));const m=D.get(r),f=v.get(r);m.has(t.typeName)||(m.set(t.typeName,y.shift()),f.set(t.typeName,0));const g=m.get(t.typeName);f.set(t.typeName,f.get(t.typeName)+1);const _=new oe.Z({paths:g});if(t.feature.attributes[j]=_,l.has(t.typeName)){const e=l.get(t.typeName);e?.set(t.feature.attributes[B],t.feature)}else{const e=new Map;e.set(t.feature.attributes[B],t.feature),l.set(t.typeName,e)}h.set(t.feature.attributes[B],t.feature);const C=(0,u.GH)(t.feature.attributes[j]);this.relationshipLinkChartDiagramLookup.set(t.feature.attributes[B],t.feature.attributes[j]?C:null),this.linkChartGeohashLookup.set(t.feature.attributes[B],"")}for(const s of a)s.feature.attributes[F]=v.get(s.feature.attributes[G]+"-"+s.feature.attributes[Z])?.get(s.typeName)??null;return this._currentLinkChartConfig={layoutMode:e},{nodes:r,links:l,idMap:h}}async applyNewLinkChartLayout(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"RADIAL_TREE",t=arguments.length>1?arguments[1]:void 0;const i=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach((e=>{i.push(e.refreshCachedQueryEngine())})),await Promise.all(i),this._refreshNamedTypes()}getCurrentNodeLocations(){const e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t=>{t?.members?.forEach((t=>{const i=t.linkChartLocation;let n;const a=t.id;i&&(n="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]},e.set(a,new Ie.Z({x:n.x,y:n.y})))}))})),e}async synchronizeInclusionListWithCache(){return new Promise((e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{if(e.useAllData=!1,e.members&&e.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;const i=new Set(Array.from(this.dataManager.sublayerCaches.get(t).keys()));Array.from(e.members.keys()).filter((e=>!i.has(e))).forEach((t=>{e.members?.delete(t)}))}})),e()}))}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach((e=>{t.push(e.refreshCachedQueryEngine())})),await Promise.all(t),this._refreshNamedTypes()}async _handleNewRecords(e){const t=[];this.dataManager.addToLayer(e);for(const i of e)this.sublayerIdsCache.has(i.typeName)||(this.sublayerIdsCache.set(i.typeName,new Set),t.push(i.typeName)),this.sublayerIdsCache.get(i.typeName).add(i.id);for(const i of t)if(this._graphTypeLookup.has(i)){const e=this._graphTypeLookup.get(i),t="endPoints"in e?"relationship":"entity",n=new he({objectType:e,parentCompositeLayer:this,graphType:t,title:i});"entity"===t?this.dataManager.entityTypeNames.add(i):this.dataManager.relationshipTypeNames.add(i),n.geometryType?this.layers.push(n):this.tables.push(n),this.dataManager.sublayerCaches.set(i,new Map)}await this.dataManager.refreshCacheContent(e.map((e=>e.id))),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode)}async _initializeDiagram(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e?.members?.forEach((e=>{const i=e.linkChartLocation;let n;const a=e.id;if(!i)return;n="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]};const s=(0,u.GH)(n);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(a,s):this.entityLinkChartDiagramLookup.set(a,s),this.linkChartGeohashLookup.set(a,(0,d.fC)(n.x,n.y,q)),this.linkChartExtent.xmin>n.x&&(this.linkChartExtent.xmin=n.x),this.linkChartExtent.xmax<n.x&&(this.linkChartExtent.xmax=n.x),this.linkChartExtent.ymin>n.y&&(this.linkChartExtent.ymin=n.y),this.linkChartExtent.ymax<n.y&&(this.linkChartExtent.ymax=n.y)}))})),this.memberRelationshipTypes.forEach((e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach((e=>{const t=this.relationshipLinkChartDiagramLookup.get(e.attributes[G]),i=this.relationshipLinkChartDiagramLookup.get(e.attributes[Z]);if(t&&i){const n=(0,u.GH)(new oe.Z({paths:[[t.coords[0],t.coords[1]],[i.coords[0],i.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(e.attributes[B],n)}else this.relationshipLinkChartDiagramLookup.set(e.attributes[B],null);this.linkChartGeohashLookup.set(e.attributes[B],"")}))}))):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}};(0,n._)([(0,l.Cb)()],Ee.prototype,"dataPreloadedInLocalCache",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"defaultLinkChartConfig",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"dataManager",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"knowledgeGraph",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"layers",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"entityLinkChartDiagramLookup",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"relationshipLinkChartDiagramLookup",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"linkChartExtent",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"linkChartGeohashLookup",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"memberEntityTypes",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"memberRelationshipTypes",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"sublayerIdsCache",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"tables",void 0),(0,n._)([(0,l.Cb)({json:{read:!1}})],Ee.prototype,"type",void 0),Ee=(0,n._)([(0,h.j)("esri.layers.LinkChartLayer")],Ee);const De=Ee},66020:(e,t,i)=>{i.d(t,{H:()=>l});var n=i(93169),a=i(13491),s=i(65156);const o={minX:0,minY:0,maxX:0,maxY:0};function r(e,t,i){(function(e){o.minX=e[0],o.minY=e[1],o.maxX=e[2],o.maxY=e[3]})(t),e.search(o,i)}class l{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new a.Q(9,(0,n.Z)("esri-csp-restrictions")?e=>({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const e=new Array(this._idByBounds.size);let t=0;this._idByBounds.forEach(((i,n)=>{e[t++]=n})),this._indexInvalid=!1,this._index.clear(),this._index.load(e)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter((e=>this._idByBounds.has(e)))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const e=(0,s.cS)();for(const t of this._boundsById.values())t&&(e[0]=Math.min(t[0],e[0]),e[1]=Math.min(t[1],e[1]),e[2]=Math.max(t[2],e[2]),e[3]=Math.max(t[3],e[3]));return e}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(e){const t=this._boundsById.get(e);this._boundsById.delete(e),t&&(this._idByBounds.delete(t),this._indexInvalid||this._index.remove(t))}forEachInBounds(e,t){this._loadIndex(),r(this._index,e,(e=>t(this._idByBounds.get(e))))}get(e){return this._boundsById.get(e)}has(e){return this._boundsById.has(e)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(e,t){if(!this._indexInvalid){const t=this._boundsById.get(e);t&&(this._index.remove(t),this._idByBounds.delete(t))}this._boundsById.set(e,t),t&&(this._idByBounds.set(t,e),this._indexInvalid||(this._boundsToLoad.push(t),this._boundsToLoad.length>5e4&&this._loadIndex()))}}},68928:(e,t,i)=>{i.d(t,{Z:()=>y});var n=i(63780),a=i(10064),s=i(91505),o=i(32718),r=i(41414),l=i(65156),h=i(83406),d=i(66020),p=i(3306),u=i(77835);const c=(0,r.Ue)();class y{constructor(e){this.geometryInfo=e,this._boundsStore=new d.H,this._featuresById=new Map,this._markedIds=new Set,this.events=new s.Z,this.featureAdapter=u.n}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=0;return this._featuresById.forEach((t=>{null!=t.geometry&&t.geometry.coords&&(e+=t.geometry.coords.length)})),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(e){if(null==this.fullBounds)return null;const[t,i,n,a]=this.fullBounds;return{xmin:t,ymin:i,xmax:n,ymax:a,spatialReference:(0,p.S2)(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}upsertMany(e){const t=e.map((e=>this._upsert(e)));return this._emitChanged(),t.filter(n.pC)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t){for(const i of e){const e=this._boundsStore.get(i.objectId);e&&t((0,r.JR)(c,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach((t=>e(t)))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,(e=>{t(this._featuresById.get(e))}))}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let e=!1;this._featuresById.forEach(((t,i)=>{this._markedIds.has(i)||(e=!0,this._remove(t))})),this._markedIds.clear(),e&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(e){if(!e)return;const t=e.objectId;if(null==t)return void o.Z.getLogger("esri.layers.graphics.data.FeatureStore").error(new a.Z("featurestore:invalid-feature","feature id is missing",{feature:e}));const i=this._featuresById.get(t);let n;if(this._markedIds.add(t),i?(e.displayId=i.displayId,n=this._boundsStore.get(t),this._boundsStore.delete(t)):null!=this.onFeatureAdd&&this.onFeatureAdd(e),!e.geometry?.coords?.length)return this._boundsStore.set(t,null),void this._featuresById.set(t,e);n=(0,h.$)(null!=n?n:(0,l.Ue)(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=n&&this._boundsStore.set(t,n),this._featuresById.set(t,e)}_upsert(e){const t=e?.objectId;if(null==t)return o.Z.getLogger("esri.layers.graphics.data.FeatureStore").error(new a.Z("featurestore:invalid-feature","feature id is missing",{feature:e})),null;const i=this._featuresById.get(t);if(!i)return this._add(e),e;this._markedIds.add(t);const{geometry:n,attributes:s}=e;for(const a in s)i.attributes[a]=s[a];return n&&(i.geometry=n,this._boundsStore.set(t,(0,h.$)((0,l.Ue)(),n,this.geometryInfo.hasZ,this.geometryInfo.hasM)??null)),i}_remove(e){null!=this.onFeatureRemove&&this.onFeatureRemove(e);const t=e.objectId;return this._markedIds.delete(t),this._boundsStore.delete(t),this._featuresById.delete(t),e}}},63543:(e,t,i)=>{i.d(t,{Dm:()=>d,Hq:()=>p,MS:()=>u,bU:()=>r});var n=i(93169),a=i(84652),s=i(60480),o=i(76115);function r(e){return{renderer:{type:"simple",symbol:"esriGeometryPoint"===e||"esriGeometryMultipoint"===e?o.I4:"esriGeometryPolyline"===e?o.ET:o.lF}}}const l=/^[_$a-zA-Z][_$a-zA-Z0-9]*$/;let h=1;function d(e,t){if((0,n.Z)("esri-csp-restrictions"))return()=>({[t]:null,...e});try{let i=`this.${t} = null;`;for(const t in e)i+=`this${l.test(t)?`.${t}`:`["${t}"]`} = ${JSON.stringify(e[t])};`;const n=new Function(`\n      return class AttributesClass$${h++} {\n        constructor() {\n          ${i};\n        }\n      }\n    `)();return()=>new n}catch(i){return()=>({[t]:null,...e})}}function p(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return[{name:"New Feature",description:"",prototype:{attributes:(0,a.d9)(e)}}]}function u(e,t){return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:e},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:t,supportsDelete:t,supportsEditing:t,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:t,supportsExceedsLimitStatistics:!0,supportsAsyncConvert3D:!1},query:s.g,queryRelated:{supportsCount:!0,supportsOrderBy:!0,supportsPagination:!0,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},editing:{supportsGeometryUpdate:t,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsAsyncApplyEdits:!1,zDefault:void 0}}}},14725:(e,t,i)=>{i.d(t,{Z:()=>h});var n=i(27366),a=(i(59486),i(49861)),s=(i(93169),i(32718),i(84936),i(69912)),o=i(25695),r=i(585);let l=class extends o.Z{constructor(e){super(e),this.layoutGeometry=null}};(0,n._)([(0,a.Cb)({type:r.Z,json:{write:!0}})],l.prototype,"layoutGeometry",void 0),l=(0,n._)([(0,s.j)("esri.rest.knowledgeGraph.Entity")],l);const h=l},25695:(e,t,i)=>{i.d(t,{Z:()=>l});var n=i(27366),a=i(49861),s=(i(93169),i(32718),i(84936),i(69912)),o=i(92364);let r=class extends o.Z{constructor(e){super(e),this.typeName=null,this.id=null}};(0,n._)([(0,a.Cb)({type:String,json:{write:!0}})],r.prototype,"typeName",void 0),(0,n._)([(0,a.Cb)({type:String,json:{write:!0}})],r.prototype,"id",void 0),r=(0,n._)([(0,s.j)("esri.rest.knowledgeGraph.GraphNamedObject")],r);const l=r},92364:(e,t,i)=>{i.d(t,{Z:()=>l});var n=i(27366),a=i(46784),s=i(49861),o=(i(93169),i(32718),i(84936),i(69912));let r=class extends a.wq{constructor(e){super(e),this.properties=null}};(0,n._)([(0,s.Cb)({json:{write:!0}})],r.prototype,"properties",void 0),r=(0,n._)([(0,o.j)("esri.rest.knowledgeGraph.GraphObject")],r);const l=r},5924:(e,t,i)=>{i.d(t,{Z:()=>d});var n=i(27366),a=i(49861),s=(i(93169),i(32718),i(84936),i(69912)),o=i(7138);let r=class extends o.Z{constructor(e){super(e),this.openCypherQuery=""}};(0,n._)([(0,a.Cb)()],r.prototype,"openCypherQuery",void 0),r=(0,n._)([(0,s.j)("esri.rest.knowledgeGraph.GraphQuery")],r);const l=r;let h=class extends l{constructor(e){super(e),this.bindParameters=null,this.bindGeometryQuantizationParameters=null,this.outputQuantizationParameters=null,this.outputSpatialReference=null}};(0,n._)([(0,a.Cb)()],h.prototype,"bindParameters",void 0),(0,n._)([(0,a.Cb)()],h.prototype,"bindGeometryQuantizationParameters",void 0),(0,n._)([(0,a.Cb)()],h.prototype,"outputQuantizationParameters",void 0),(0,n._)([(0,a.Cb)()],h.prototype,"outputSpatialReference",void 0),h=(0,n._)([(0,s.j)("esri.rest.knowledgeGraph.GraphQueryStreaming")],h);const d=h},2736:(e,t,i)=>{i.d(t,{Z:()=>r});var n=i(27366),a=(i(32718),i(93169),i(84936),i(10064),i(69912)),s=i(92364);let o=class extends s.Z{constructor(e){super(e)}};o=(0,n._)([(0,a.j)("esri.rest.knowledgeGraph.ObjectValue")],o);const r=o},11933:(e,t,i)=>{i.d(t,{Z:()=>h});var n=i(27366),a=i(46784),s=i(49861),o=(i(93169),i(32718),i(84936),i(69912)),r=i(92364);let l=class extends a.wq{constructor(e){super(e),this.path=null}};(0,n._)([(0,s.Cb)({type:[r.Z],json:{write:!0}})],l.prototype,"path",void 0),l=(0,n._)([(0,o.j)("esri.rest.knowledgeGraph.Path")],l);const h=l},49074:(e,t,i)=>{i.d(t,{Z:()=>h});var n=i(27366),a=(i(59486),i(49861)),s=(i(93169),i(32718),i(84936),i(69912)),o=i(25695),r=i(29909);let l=class extends o.Z{constructor(e){super(e),this.originId=null,this.destinationId=null,this.layoutGeometry=null}};(0,n._)([(0,a.Cb)({type:String,json:{write:!0}})],l.prototype,"originId",void 0),(0,n._)([(0,a.Cb)({type:String,json:{write:!0}})],l.prototype,"destinationId",void 0),(0,n._)([(0,a.Cb)({type:r.Z,json:{write:!0}})],l.prototype,"layoutGeometry",void 0),l=(0,n._)([(0,s.j)("esri.rest.Relationship.Relationship")],l);const h=l}}]);
//# sourceMappingURL=37945.6c93e55b.chunk.js.map