"use strict";(self.webpackChunkn2_compile=self.webpackChunkn2_compile||[]).push([[51213],{84683:(e,t,r)=>{r.d(t,{bU:()=>w,fC:()=>S,ir:()=>_,zp:()=>y});r(93169);var s=r(16889),i=r(53866),n=r(80885),o=r(78952),a=r(22186),c=r(83406),u=r(80457),l=r(19995);const h=new Float64Array(2),d=new Float64Array(2),p="0123456789bcdefghjkmnpqrstuvwxyz",f=64;function _(e,t,r,s){const a=[e.xmin,e.ymin,e.xmax,e.ymax],h=n.Z.fromExtent(i.Z.fromBounds(a,s)),d=(0,l.iV)(h,s,o.Z.WGS84,{densificationStep:t*f});if(!d)return null;const p=(0,c.Uy)(new u.Z,d,!1,!1),_=p.coords.filter(((e,t)=>!(t%2))),m=p.coords.filter(((e,t)=>t%2)),g=Math.min(..._),x=Math.min(...m),b=Math.max(..._),v=Math.max(...m),w=y(g,x,r,o.Z.WGS84),I=y(b,v,r,o.Z.WGS84);return w&&I?{bounds:a,geohashBounds:{xLL:w[0],yLL:w[1],xTR:I[0],yTR:I[1]},level:r}:null}function y(e,t,r,i){if(i.isWebMercator){const i=(0,s.BV)(e/a.sv.radius),n=i-360*Math.floor((i+180)/360),o=[0,0];return I(o,0,(0,s.BV)(Math.PI/2-2*Math.atan(Math.exp(-t/a.sv.radius))),n,r),o}const n=(0,l.iV)({x:e,y:t},i,o.Z.WGS84);if(!n)return null;const c=[0,0];return I(c,0,n.y,n.x,r),c}function m(e){return p[e]}function g(e){return(e[0]+e[1])/2}function x(e,t,r){return e[0]=t,e[1]=r,e}function b(e,t){const r=g(e),s=t,i=!t;e[0]=i*e[0]+s*r,e[1]=i*r+s*e[1]}function v(e,t){const r=t>g(e);return b(e,r),r}function w(e,t){let r=-90,s=90,i=-180,n=180;for(let o=0;o<t;o++){const t=Math.ceil((o+1)/2),a=Math.floor((o+1)/2),c=1-o%2,u=30-(3*t+2*a),l=30-(2*t+3*a),h=3*c+2*(1-c),d=2*c+3*(1-c),p=3*c+7*(1-c)<<l,f=(7*c+3*(1-c)<<u&e.geohashX)>>u,_=(p&e.geohashY)>>l;for(let e=h-1;e>=0;e--){const t=(i+n)/2,r=f&1<<e?1:0;i=(1-r)*i+r*t,n=(1-r)*t+r*n}for(let e=d-1;e>=0;e--){const t=(r+s)/2,i=_&1<<e?1:0;r=(1-i)*r+i*t,s=(1-i)*t+i*s}}return[i,r,n,s]}function I(e,t,r,s,i){i%2&&(i+=1);let n=0,o=0,a=-90,c=90,u=-180,l=180;for(let h=0;h<i/2;h++){for(let e=0;e<5;e++){const t=(u+l)/2,r=s>t?1:0;n|=r<<29-(e+5*h),u=(1-r)*u+r*t,l=(1-r)*t+r*l}for(let e=0;e<5;e++){const t=(a+c)/2,s=r>t?1:0;o|=s<<29-(e+5*h),a=(1-s)*a+s*t,c=(1-s)*t+s*c}}e[2*t]=n,e[2*t+1]=o}function S(e,t,r){let s="";const i=x(h,-90,90),n=x(d,-180,180);for(let o=0;o<r;o++){let r=0;o%2?(r|=v(i,e)<<4,r|=v(n,t)<<3,r|=v(i,e)<<2,r|=v(n,t)<<1,r|=v(i,e)<<0):(r|=v(n,t)<<4,r|=v(i,e)<<3,r|=v(n,t)<<2,r|=v(i,e)<<1,r|=v(n,t)<<0),s+=m(r)}return s}},48035:(e,t,r)=>{r.d(t,{b:()=>u,j:()=>c});var s=r(65905),i=r(93169);const n=128e3;let o=null,a=null;async function c(){return o||(o=async function(){const e=(0,i.Z)("esri-csp-restrictions")?await r.e(5948).then(r.bind(r,5948)).then((e=>e.l)):await r.e(97069).then(r.bind(r,97069)).then((e=>e.l));a=await e.default({locateFile:e=>(0,s.V)(`esri/core/libs/libtess/${e}`)})}()),o}function u(e,t){const r=Math.max(e.length,n);return a.triangulate(e,t,r)}},22585:(e,t,r)=>{function s(e){const t={};for(const r in e){if("declaredClass"===r)continue;const i=e[r];if(null!=i&&"function"!=typeof i)if(Array.isArray(i)){t[r]=[];for(let e=0;e<i.length;e++)t[r][e]=s(i[e])}else"object"==typeof i?i.toJSON&&(t[r]=JSON.stringify(i)):t[r]=i}return t}r.d(t,{A:()=>s})},5192:(e,t,r)=>{r.d(t,{Ev:()=>y,JT:()=>p,Vn:()=>x,Vr:()=>g,hH:()=>m,n7:()=>_,qp:()=>f});var s=r(76200),i=r(35995),n=r(77981),o=r(91340),a=r(92975),c=r(22585),u=r(27607),l=r(68620);const h="Layer does not support extent calculation.";function d(e,t){const r=e.geometry,s=e.toJSON();delete s.compactGeometryEnabled,delete s.defaultSpatialReferenceEnabled;const i=s;let o,c,u;if(null!=r&&(c=r.spatialReference,u=(0,a.B9)(c),i.geometryType=(0,n.Ji)(r),i.geometry=function(e,t){if(t&&"extent"===e.type)return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(t&&"point"===e.type)return`${e.x},${e.y}`;const r=e.toJSON();return delete r.spatialReference,JSON.stringify(r)}(r,e.compactGeometryEnabled),i.inSR=u),s.groupByFieldsForStatistics&&(i.groupByFieldsForStatistics=s.groupByFieldsForStatistics.join(",")),s.objectIds&&(i.objectIds=s.objectIds.join(",")),s.orderByFields&&(i.orderByFields=s.orderByFields.join(",")),!s.outFields||!s.returnDistinctValues&&(t?.returnCountOnly||t?.returnExtentOnly||t?.returnIdsOnly)?delete i.outFields:s.outFields.includes("*")?i.outFields="*":i.outFields=s.outFields.join(","),s.outSR?(i.outSR=(0,a.B9)(s.outSR),o=e.outSpatialReference):r&&(s.returnGeometry||s.returnCentroid)&&(i.outSR=i.inSR,o=c),s.returnGeometry&&delete s.returnGeometry,s.outStatistics&&(i.outStatistics=JSON.stringify(s.outStatistics)),s.fullText&&(i.fullText=JSON.stringify(s.fullText)),s.pixelSize&&(i.pixelSize=JSON.stringify(s.pixelSize)),s.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=c&&null!=e.quantizationParameters?.extent&&c.equals(e.quantizationParameters.extent.spatialReference)&&delete s.quantizationParameters.extent.spatialReference,i.quantizationParameters=JSON.stringify(s.quantizationParameters)),s.parameterValues&&(i.parameterValues=JSON.stringify(s.parameterValues)),s.rangeValues&&(i.rangeValues=JSON.stringify(s.rangeValues)),s.dynamicDataSource&&(i.layer=JSON.stringify({source:s.dynamicDataSource}),delete s.dynamicDataSource),s.timeExtent){const e=s.timeExtent,{start:t,end:r}=e;null==t&&null==r||(i.time=t===r?t:`${t??"null"},${r??"null"}`),delete s.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=c&&null!=o&&c.equals(o)&&(i.defaultSR=i.inSR,delete i.inSR,delete i.outSR),i}async function p(e,t,r,s){const i=null!=t.timeExtent&&t.timeExtent.isEmpty?{data:{features:[]}}:await x(e,t,"json",s);return(0,l.p)(t,r,i.data),i}async function f(e,t,r,s){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:r.createFeatureResult()};const i=await _(e,t,s),n=i;return n.data=(0,u.C)(i.data,r),n}function _(e,t,r){return x(e,t,"pbf",r)}function y(e,t,r){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):x(e,t,"json",r,{returnIdsOnly:!0})}function m(e,t,r){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):x(e,t,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})}async function g(e,t,r){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:{count:0,extent:null}};const s=await x(e,t,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}),i=s.data;if(i.hasOwnProperty("extent"))return s;if(i.features)throw new Error(h);if(i.hasOwnProperty("count"))throw new Error(h);return s}async function x(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const u="string"==typeof e?(0,i.mN)(e):e,l=t.geometry?[t.geometry]:[],h=await(0,o.aX)(l,null,{signal:n.signal}),p=h?.[0];null!=p&&((t=t.clone()).geometry=p);const f=(0,c.A)({...u.query,f:r,...a,...d(t,a)});return(0,s.Z)((0,i.v_)(u.path,function(e,t){return null!=e.formatOf3DObjects&&!(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)}(t,a)?"query3d":"query"),{...n,responseType:"pbf"===r?"array-buffer":"json",query:{...f,...n.query}})}},51750:(e,t,r)=>{r.d(t,{L:()=>i,v:()=>s});const s=15.5,i=1024},82010:(e,t,r)=>{r.d(t,{z:()=>_});var s=r(48202),i=r(94109);function n(e,t){return e.x===t.x&&e.y===t.y}function o(e){if(!e)return;const t=e.length;if(t<=1)return;let r=0;for(let s=1;s<t;s++)n(e[s],e[r])||++r===s||(e[r]=e[s]);e.length=r+1}function a(e,t){return e.x=t.y,e.y=-t.x,e}function c(e,t){return e.x=-t.y,e.y=t.x,e}function u(e,t){return e.x=t.x,e.y=t.y,e}function l(e,t){return e.x=-t.x,e.y=-t.y,e}function h(e){return Math.sqrt(e.x*e.x+e.y*e.y)}function d(e,t){return e.x*t.y-e.y*t.x}function p(e,t){return e.x*t.x+e.y*t.y}function f(e,t,r,s){return e.x=t.x*r+t.y*s,e.y=t.x*s-t.y*r,e}class _{constructor(e,t,r){this._writeVertex=e,this._writeTriangle=t,this._canUseThinTessellation=r,this._prevNormal={x:void 0,y:void 0},this._nextNormal={x:void 0,y:void 0},this._textureNormalLeft={x:0,y:1},this._textureNormalRight={x:0,y:-1},this._textureNormal={x:void 0,y:void 0},this._joinNormal={x:void 0,y:void 0},this._inner={x:void 0,y:void 0},this._outer={x:void 0,y:void 0},this._roundStart={x:void 0,y:void 0},this._roundEnd={x:void 0,y:void 0},this._startBreak={x:void 0,y:void 0},this._endBreak={x:void 0,y:void 0},this._innerPrev={x:void 0,y:void 0},this._innerNext={x:void 0,y:void 0},this._bevelStart={x:void 0,y:void 0},this._bevelEnd={x:void 0,y:void 0},this._bevelMiddle={x:void 0,y:void 0}}tessellate(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._canUseThinTessellation;o(e),r&&t.halfWidth<i.do&&!t.offset?this._tessellateThin(e,t):this._tessellate(e,t)}_tessellateThin(e,t){if(e.length<2)return;const r=t.wrapDistance||65535;let s=t.initialDistance||0,i=!1,n=e[0].x,o=e[0].y;const a=e.length;for(let c=1;c<a;++c){i&&(i=!1,s=0);let t=e[c].x,a=e[c].y,u=t-n,l=a-o,h=Math.sqrt(u*u+l*l);if(u/=h,l/=h,s+h>r){i=!0;const e=(r-s)/h;h=r-s,t=(1-e)*n+e*t,a=(1-e)*o+e*a,--c}const d=this._writeVertex(n,o,0,0,u,l,l,-u,0,-1,s),p=this._writeVertex(n,o,0,0,u,l,-l,u,0,1,s);s+=h;const f=this._writeVertex(t,a,0,0,u,l,l,-u,0,-1,s),_=this._writeVertex(t,a,0,0,u,l,-l,u,0,1,s);this._writeTriangle(d,p,f),this._writeTriangle(p,f,_),n=t,o=a}}_tessellate(e,t){const r=e[0],i=e[e.length-1],o=n(r,i),_=o?3:2;if(e.length<_)return;const y=t.pixelCoordRatio,m=null!=t.capType?t.capType:s.RL.BUTT,g=null!=t.joinType?t.joinType:s.AH.MITER,x=null!=t.miterLimit?Math.min(t.miterLimit,4):2,b=null!=t.roundLimit?Math.min(t.roundLimit,1.05):1.05,v=null!=t.halfWidth?t.halfWidth:2,w=!!t.textured;let I,S,T,M=null;const k=this._prevNormal,F=this._nextNormal;let E=-1,C=-1;const P=this._joinNormal;let A,R;const O=this._textureNormalLeft,z=this._textureNormalRight,D=this._textureNormal;let N=-1,B=-1;const V=t.wrapDistance||65535;let L=t.initialDistance||0;const G=this._writeVertex,U=this._writeTriangle,q=(e,t,r,s,i,n)=>{const o=G(S,T,A,R,r,s,e,t,i,n,L);return N>=0&&B>=0&&o>=0&&U(N,B,o),N=B,B=o,o};o&&(I=e[e.length-2],F.x=i.x-I.x,F.y=i.y-I.y,C=h(F),F.x/=C,F.y/=C);let W=!1;for(let n=0;n<e.length;++n){if(W&&(W=!1,L=0),I&&(k.x=-F.x,k.y=-F.y,E=C,L+E>V&&(W=!0)),W){const t=(V-L)/E;E=V-L,I={x:(1-t)*I.x+t*e[n].x,y:(1-t)*I.y+t*e[n].y},--n}else I=e[n];S=I.x,T=I.y;const t=n<=0&&!W,r=n===e.length-1;if(t||(L+=E),M=r?o?e[1]:null:e[n+1],M?(F.x=M.x-S,F.y=M.y-T,C=h(F),F.x/=C,F.y/=C):(F.x=void 0,F.y=void 0),!o){if(t){c(P,F),A=P.x,R=P.y,m===s.RL.SQUARE&&(q(-F.y-F.x,F.x-F.y,F.x,F.y,0,-1),q(F.y-F.x,-F.x-F.y,F.x,F.y,0,1)),m===s.RL.ROUND&&(q(-F.y-F.x,F.x-F.y,F.x,F.y,-1,-1),q(F.y-F.x,-F.x-F.y,F.x,F.y,-1,1)),m!==s.RL.ROUND&&m!==s.RL.BUTT||(q(-F.y,F.x,F.x,F.y,0,-1),q(F.y,-F.x,F.x,F.y,0,1));continue}if(r){a(P,k),A=P.x,R=P.y,m!==s.RL.ROUND&&m!==s.RL.BUTT||(q(k.y,-k.x,-k.x,-k.y,0,-1),q(-k.y,k.x,-k.x,-k.y,0,1)),m===s.RL.SQUARE&&(q(k.y-k.x,-k.x-k.y,-k.x,-k.y,0,-1),q(-k.y-k.x,k.x-k.y,-k.x,-k.y,0,1)),m===s.RL.ROUND&&(q(k.y-k.x,-k.x-k.y,-k.x,-k.y,1,-1),q(-k.y-k.x,k.x-k.y,-k.x,-k.y,1,1));continue}}let i,_,G=-d(k,F);if(Math.abs(G)<.01)p(k,F)>0?(P.x=k.x,P.y=k.y,G=1,i=Number.MAX_VALUE,_=!0):(c(P,F),G=1,i=1,_=!1);else{P.x=(k.x+F.x)/G,P.y=(k.y+F.y)/G,i=h(P);const e=(i-1)*v*y;_=i>4||e>E&&e>C}A=P.x,R=P.y;let U=g;switch(g){case s.AH.BEVEL:i<1.05&&(U=s.AH.MITER);break;case s.AH.ROUND:i<b&&(U=s.AH.MITER);break;case s.AH.MITER:i>x&&(U=s.AH.BEVEL)}switch(U){case s.AH.MITER:if(q(P.x,P.y,-k.x,-k.y,0,-1),q(-P.x,-P.y,-k.x,-k.y,0,1),r)break;if(w){const e=W?0:L;N=this._writeVertex(S,T,A,R,F.x,F.y,P.x,P.y,0,-1,e),B=this._writeVertex(S,T,A,R,F.x,F.y,-P.x,-P.y,0,1,e)}break;case s.AH.BEVEL:{const e=G<0;let t,s,i,n;if(e){const e=N;N=B,B=e,t=O,s=z}else t=z,s=O;if(_)i=e?c(this._innerPrev,k):a(this._innerPrev,k),n=e?a(this._innerNext,F):c(this._innerNext,F);else{const t=e?l(this._inner,P):u(this._inner,P);i=t,n=t}const o=e?a(this._bevelStart,k):c(this._bevelStart,k);q(i.x,i.y,-k.x,-k.y,t.x,t.y);const h=q(o.x,o.y,-k.x,-k.y,s.x,s.y);if(r)break;const d=e?c(this._bevelEnd,F):a(this._bevelEnd,F);if(_){const e=this._writeVertex(S,T,A,R,-k.x,-k.y,0,0,0,0,L);N=this._writeVertex(S,T,A,R,F.x,F.y,n.x,n.y,t.x,t.y,L),B=this._writeVertex(S,T,A,R,F.x,F.y,d.x,d.y,s.x,s.y,L),this._writeTriangle(h,e,B)}else{if(w){const e=this._bevelMiddle;e.x=(o.x+d.x)/2,e.y=(o.y+d.y)/2,f(D,e,-k.x,-k.y),q(e.x,e.y,-k.x,-k.y,D.x,D.y),f(D,e,F.x,F.y),N=this._writeVertex(S,T,A,R,F.x,F.y,e.x,e.y,D.x,D.y,L),B=this._writeVertex(S,T,A,R,F.x,F.y,n.x,n.y,t.x,t.y,L)}else{const e=N;N=B,B=e}q(d.x,d.y,F.x,F.y,s.x,s.y)}if(e){const e=N;N=B,B=e}break}case s.AH.ROUND:{const e=G<0;let t,s;if(e){const e=N;N=B,B=e,t=O,s=z}else t=z,s=O;const n=e?l(this._inner,P):u(this._inner,P);let o,h;_?(o=e?c(this._innerPrev,k):a(this._innerPrev,k),h=e?a(this._innerNext,F):c(this._innerNext,F)):(o=n,h=n);const d=e?a(this._roundStart,k):c(this._roundStart,k),y=e?c(this._roundEnd,F):a(this._roundEnd,F),m=q(o.x,o.y,-k.x,-k.y,t.x,t.y),g=q(d.x,d.y,-k.x,-k.y,s.x,s.y);if(r)break;const x=this._writeVertex(S,T,A,R,-k.x,-k.y,0,0,0,0,L);_||this._writeTriangle(N,B,x);const b=l(this._outer,n),v=this._writeVertex(S,T,A,R,F.x,F.y,y.x,y.y,s.x,s.y,L);let I,M;const E=i>2;if(E){let t;i!==Number.MAX_VALUE?(b.x/=i,b.y/=i,t=p(k,b),t=(i*(t*t-1)+1)/t):t=-1,I=e?a(this._startBreak,k):c(this._startBreak,k),I.x+=k.x*t,I.y+=k.y*t,M=e?c(this._endBreak,F):a(this._endBreak,F),M.x+=F.x*t,M.y+=F.y*t}f(D,b,-k.x,-k.y);const C=this._writeVertex(S,T,A,R,-k.x,-k.y,b.x,b.y,D.x,D.y,L);f(D,b,F.x,F.y);const V=w?this._writeVertex(S,T,A,R,F.x,F.y,b.x,b.y,D.x,D.y,L):C,U=x,W=w?this._writeVertex(S,T,A,R,F.x,F.y,0,0,0,0,L):x;let Z=-1,Y=-1;if(E&&(f(D,I,-k.x,-k.y),Z=this._writeVertex(S,T,A,R,-k.x,-k.y,I.x,I.y,D.x,D.y,L),f(D,M,F.x,F.y),Y=this._writeVertex(S,T,A,R,F.x,F.y,M.x,M.y,D.x,D.y,L)),w?E?(this._writeTriangle(U,g,Z),this._writeTriangle(U,Z,C),this._writeTriangle(W,V,Y),this._writeTriangle(W,Y,v)):(this._writeTriangle(U,g,C),this._writeTriangle(W,V,v)):E?(this._writeTriangle(x,g,Z),this._writeTriangle(x,Z,Y),this._writeTriangle(x,Y,v)):(this._writeTriangle(x,g,C),this._writeTriangle(x,V,v)),_?(N=this._writeVertex(S,T,A,R,F.x,F.y,h.x,h.y,t.x,t.y,L),B=v):(N=w?this._writeVertex(S,T,A,R,F.x,F.y,h.x,h.y,t.x,t.y,L):m,this._writeTriangle(N,W,v),B=v),e){const e=N;N=B,B=e}break}}}}}},51213:(e,t,r)=>{r.r(t),r.d(t,{default:()=>Lu});var s=r(10064),i=r(42537),n=r(93169),o=r(70758),a=r(66978),c=r(84936),u=r(94172),l=r(17842),h=r(22824),d=r(37995),p=r(73828),f=(r(32344),r(85269),r(94109));class _{constructor(e){this._client=e,this.layerView=this._client.createInvokeProxy("",{ignoreConnectionErrors:!0}),this.container=this._client.createInvokeProxy("container",{ignoreConnectionErrors:!0}),this.eventLog=this._client.createInvokeProxy("eventLog",{ignoreConnectionErrors:!0})}}var y=r(92026),m=r(48732),g=r(78952);class x{constructor(e,t,r,s,i,n,o){this.instanceId=e,this.textureKey=t,this.indexStart=r,this.indexCount=s,this.vertexStart=i,this.vertexCount=n,this.overlaps=o}updateBaseOffsets(e){this.vertexStart+=e.vertexFrom,this.indexStart+=e.indexFrom}clone(){return new x(this.instanceId,this.textureKey,this.indexStart,this.indexCount,this.vertexStart,this.vertexCount,this.overlaps)}static write(e,t,r,s,i,n,o,a){e.push(t),e.push(r),e.push(s),e.push(i),e.push(n),e.push(o),e.push(a)}serialize(e){return e.push(this.instanceId),e.push(this.textureKey),e.push(this.indexStart),e.push(this.indexCount),e.push(this.vertexStart),e.push(this.vertexCount),e.push(this.overlaps),e}static deserialize(e){const t=e.readInt32(),r=e.readInt32(),s=e.readInt32(),i=e.readInt32(),n=e.readInt32(),o=e.readInt32(),a=e.readInt32();return new x(t,r,s,i,n,o,a)}}function b(e,t){if(null!==t){e.push(t.length);for(const r of t)r.serialize(e);return e}e.push(0)}function v(e,t,r){const s=e.readInt32(),i=new Array(s);for(let n=0;n<i.length;n++)i[n]=t.deserialize(e,r);return i}x.byteSizeHint=7*Uint32Array.BYTES_PER_ELEMENT;class w{constructor(e,t){this.id=e,this.sortKey=t,this.records=[]}serialize(e){return e.push(this.id),e.writeF32(this.sortKey),b(e,this.records),e}static deserialize(e){const t=e.readInt32(),r=e.readF32(),s=new w(t,r);return s.records=v(e,x)??[],s}}w.byteSizeHint=2*Uint32Array.BYTES_PER_ELEMENT+x.byteSizeHint;class I{get length(){return this._pos}constructor(e,t){this._pos=0;const r=t?this._roundToNearest(t,e.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(r),this._buffer=new e(this._array),this._ctor=e,this._i16View=new Int16Array(this._array)}_roundToNearest(e,t){const r=Math.round(e);return 1===t?r:r+(t-r%t)}_ensureSize(e){if(this._pos+e>=this._buffer.length){const t=this._roundToNearest(1.25*(this._array.byteLength+e*this._buffer.BYTES_PER_ELEMENT),this._buffer.BYTES_PER_ELEMENT),r=new ArrayBuffer(t),s=new this._ctor(r);s.set(this._buffer,0),this._array=r,this._buffer=s,this._i16View=new Int16Array(this._array)}}ensureSize(e){this._ensureSize(e)}writeF32(e){this._ensureSize(1);const t=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=e,this._pos++,t}push(e){this._ensureSize(1);const t=this._pos;return this._buffer[this._pos++]=e,t}writeFixed(e){this._buffer[this._pos++]=e}setValue(e,t){this._buffer[e]=t}i1616Add(e,t,r){this._i16View[2*e]+=t,this._i16View[2*e+1]+=r}getValue(e){return this._buffer[e]}getValueF32(e){return new Float32Array(this._array,4*e,1)[0]}incr(e){if(this._buffer.length<e)throw new Error("Increment index overflows the target buffer");this._buffer[e]++}decr(e){this._buffer[e]--}writeRegion(e){this._ensureSize(e.length);const t=this._pos;return this._buffer.set(e,this._pos),this._pos+=e.length,t}writeManyFrom(e,t,r){this._ensureSize(r-t);for(let s=t;s!==r;s++)this.writeFixed(e._buffer[s])}buffer(){const e=this._array.slice(0,4*this._pos);return this.destroy(),e}toArray(){return[...this._buffer]}seek(e){this._pos=e}destroy(){this._array=null,this._buffer=null}}class S{constructor(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const i=6*s*Uint32Array.BYTES_PER_ELEMENT,n=4*s*r,o=r/4,a=t.attributes.find((e=>"pos"===e.name||"position"===e.name));if(!a)throw new Error("InternalError: Unable to find position attribute");this.layout={...t,position:a},this._indices=new I(Uint32Array,i),this._vertices=new I(Uint32Array,n),this._metrics=new I(Uint32Array,0),this._metricCountOffset=this._metrics.push(0),this._strideInt=o,this._instanceId=e}serialize(e){const t=this._indices.buffer(),r=this._vertices.buffer(),s=this._metrics.length?this._metrics.buffer():null;return e.push(t,r),{instanceId:this._instanceId,layout:this.layout,indices:t,vertices:r,metrics:s}}get strideInt(){return this._strideInt}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(e){this._vertices.ensureSize(e)}indexEnsureSize(e){this._indices.ensureSize(e)}writeIndex(e){this._indices.push(e)}writeVertex(e){this._vertices.push(e)}writeVertexRegion(e){this._vertices.writeRegion(e)}writeVertexF32(e){this._vertices.writeF32(e)}writeMetric(e){this._metrics.incr(this._metricCountOffset),e.serialize(this._metrics)}}class T{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._id=e,this._sizeHint=t,this._entityRecordCountOffset=0,this._entityCountOffset=0,this._entityIdIndex=0,this._entitySortKeyIndex=0,this._instanceIdToVertexData=new Map,this._recordIndexStart=0,this._recordIndexCount=0,this._recordVertexStart=0,this._recordVertexCount=0,this._current={metric:null,writer:null,start:0,sortKey:0,instanceId:0,layoutHash:0,indexStart:0,vertexStart:0,textureKey:0,metricBoxLenPointer:0},this._entities=new I(Uint32Array,this._sizeHint*w.byteSizeHint),this._entityCountOffset=this._entities.push(0)}get id(){return this._id}serialize(){const e=new Array,t=[],r=this._entities.buffer();for(const s of this._instanceIdToVertexData.values())t.push(s.serialize(e));return{message:{data:t,entities:r},transferList:e}}vertexCount(){return this._current.writer?.vertexCount??0}indexCount(){return this._current.writer?.indexCount??0}vertexEnsureSize(e){this._current.writer.vertexEnsureSize(e)}indexEnsureSize(e){this._current.writer.indexEnsureSize(e)}vertexWrite(e){this._current.writer.writeVertex(e)}vertexWriteRegion(e){this._current.writer.writeVertexRegion(e)}vertexWriteF32(e){this._current.writer.writeVertexF32(e)}recordBounds(e,t,r,s){}indexWrite(e){this._current.writer.writeIndex(e)}metricStart(e){this._current.metric=e}metricEnd(){const e=this._current.writer;this._current.metric.bounds.length&&e.writeMetric(this._current.metric)}metricBoxWrite(e){this._current.metric.bounds.push(e)}entityStart(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;this._entityIdIndex=this._entities.push(e),this._entitySortKeyIndex=this._entities.writeF32(t),this._entityRecordCountOffset=this._entities.push(0)}entityRecordCount(){return this._entities.getValue(this._entityRecordCountOffset)}entityEnd(){0===this.entityRecordCount()?this._entities.seek(this._entityIdIndex):this._entities.incr(this._entityCountOffset)}recordCount(){return this._entities.getValue(this._entityRecordCountOffset)}recordStart(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._current.writer=this._getVertexWriter(e,t),this._current.indexStart=this._current.writer.indexCount,this._current.vertexStart=this._current.writer.vertexCount,this._current.instanceId=e,this._current.layoutHash=t.hash,this._current.textureKey=r}recordEnd(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;const t=this._current.vertexStart,r=this._current.writer.vertexCount-t;if(!r)return!1;const s=this._current.indexStart,i=this._current.writer.indexCount-s;return this._recordIndexStart=s,this._recordIndexCount=i,this._recordVertexStart=t,this._recordVertexCount=r,this._entities.incr(this._entityRecordCountOffset),x.write(this._entities,this._current.instanceId,this._current.textureKey,s,i,t,r,e),!0}copyLast(e,t){const r=this._recordVertexStart+this._recordVertexCount;this._entities.incr(this._entityRecordCountOffset),x.write(this._entities,this._current.instanceId,this._current.textureKey,this._recordIndexStart+this._recordIndexCount,this._recordIndexCount,r,this._recordVertexCount,0);const s=this._current.writer.indexWriter,i=this._current.writer.vertexWriter,n=this._recordIndexStart+this._recordIndexCount,o=this._recordVertexCount;for(let _=this._recordIndexStart;_!==n;_++){const e=s.getValue(_);s.push(e+o)}const a=this._current.writer.layout.stride/Uint32Array.BYTES_PER_ELEMENT,c=this._recordVertexStart*a,u=(this._recordVertexStart+this._recordVertexCount)*a;for(let _=c;_!==u;_++){const e=i.getValue(_);i.push(e)}const l=this._current.writer.layout.position,h=l.packPrecisionFactor??1,d=l.offset/Uint32Array.BYTES_PER_ELEMENT,p=e*h,f=t*h;for(let _=r*a;_<=i.length;_+=a)i.i1616Add(_+d,p,f);this.recordEnd()}copyLastFrom(e,t,r){const s=e._entities.getValue(e._entityIdIndex);if(s!==this._entities.getValue(this._entityIdIndex)){const t=e._entities.getValueF32(e._entitySortKeyIndex);this.entityStart(s,t)}this.recordStart(e._current.instanceId,e._current.writer.layout,e._current.textureKey);const i=this._current.writer.layout.stride/Uint32Array.BYTES_PER_ELEMENT,n=this._current.vertexStart,o=e._current.vertexStart-n,a=this._current.writer.indexWriter,c=this._current.writer.vertexWriter,u=e._current.writer.indexWriter,l=e._current.writer.vertexWriter;for(let y=e._current.indexStart;y!==u.length;y++){const e=u.getValue(y);a.push(e-o)}for(let y=e._current.vertexStart*i;y!==l.length;y++){const e=l.getValue(y);c.push(e)}const h=this._current.writer.layout.position,d=h.packPrecisionFactor??1,p=h.offset/Uint32Array.BYTES_PER_ELEMENT,f=t*d,_=r*d;for(let y=n*i;y<=c.length;y+=i)c.i1616Add(y+p,f,_);this.recordEnd()}_getVertexWriter(e,t){const{stride:r}=t,s=this._instanceIdToVertexData;return s.has(e)||s.set(e,new S(e,t,r,this._sizeHint)),s.get(e)}}const M=128;function k(e){switch(e){case 1:case 8:case 32:return-1;case 2:case 64:return 0;case 4:case 16:case M:return 1}}function F(e){switch(e){case 1:case 2:case 4:return-1;case 8:case 16:return 0;case 32:case 64:case M:return 1}}class E{constructor(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this.tileKey=e,this._bufferingEnabled=t,this._sizeHint=s,this._meshes={self:new T(this.id,this._sizeHint),neighbors:new Array},this._currentRecordOverlaps=0,this._currentEntityOverlaps=0,this._copyBufferedDataIntoSelf=r&&this._bufferingEnabled&&0===e.level}get id(){return this.tileKey.id}vertexCount(){return this._meshes.self.vertexCount()}indexCount(){return this._meshes.self.indexCount()}indexEnsureSize(e){this._meshes.self.indexEnsureSize(e)}entityStart(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;this._currentEntityOverlaps=0,this._meshes.self.entityStart(e,t)}entityRecordCount(){return this._meshes.self.entityRecordCount()}entityEnd(){if(this._meshes.self.entityEnd(),this._bufferingEnabled){if(this._copyBufferedDataIntoSelf)return;for(let e=0;e<8;e++){const t=1<<e;this._currentEntityOverlaps&t&&this._meshes.neighbors[e].entityEnd()}}}recordStart(e,t,r){this._currentRecordOverlaps=0,this._meshes.self.recordStart(e,t,r)}recordEnd(){const e=this._meshes.self.recordEnd(this._currentRecordOverlaps);return e&&0!==this._currentRecordOverlaps?(this._copyIntoNeighbors(),this._currentEntityOverlaps|=this._currentRecordOverlaps,!0):e}recordBounds(e,t,r,s){this._bufferingEnabled&&this._addOverlap(e,t,r,s)}recordCount(){return this._meshes.self.recordCount()}metricStart(e){this._meshes.self.metricStart(e)}metricBoxWrite(e){this._meshes.self.metricBoxWrite(e)}metricEnd(){this._meshes.self.metricEnd()}vertexWrite(e){this._meshes.self.vertexWrite(e)}vertexWriteF32(e){this._meshes.self.vertexWriteF32(e)}vertexWriteRegion(e){this._meshes.self.vertexWriteRegion(e)}indexWrite(e){this._meshes.self.indexWrite(e)}serialize(e){const t={message:[],transferList:[]},r=this._meshes.self.serialize();return t.message.push({tileId:this.tileKey.id,...r.message}),t.transferList.push(...r.transferList),this._meshes.neighbors.forEach(((r,s)=>{const i=r.serialize(),n=1<<s,o=k(n),a=F(n),c=function(e,t,r,s){const i=e.clone(),n=1<<i.level,o=i.col+t,a=i.row+r;return s&&o<0?(i.col=o+n,i.world-=1):o>=n?(i.col=o-n,i.world+=1):i.col=o,i.row=a,i}(new p.Z(this.tileKey),o,a,e);t.message.push({tileId:c.id,...i.message}),t.transferList.push(...i.transferList)})),t}_addOverlap(e,t,r,s){const i=Math.min(f.i9/2,r),n=Math.min(f.i9/2,s),o=255^((e<0+i?148:e>=f.i9-i?41:189)|(t<0+n?224:t>=f.i9-n?7:231));this._currentRecordOverlaps|=o}_copyIntoNeighbors(){for(let e=0;e<8;e++){const t=1<<e;if(this._currentRecordOverlaps&t){if(this._copyBufferedDataIntoSelf){const e=-k(t)*f.i9,r=-F(t)*f.i9;this._meshes.self.copyLast(e,r);continue}if(!this._meshes.neighbors[e]){const r=Math.floor(this._sizeHint/16);this._meshes.neighbors[e]=new T(t,r)}const r=this._meshes.neighbors[e],s=-k(t)*f.i9,i=-F(t)*f.i9;r.copyLastFrom(this._meshes.self,s,i)}}}}class C{}var P=r(63780),A=r(84652),R=r(32718),O=r(643);function z(e){return Math.floor(function(e,t){let r;if("string"==typeof e)r=(0,O.hP)(e+`-seed(${t})`);else{let s=12;r=e^t;do{r=107*(r>>8^r)+s|0}while(0!=--s)}return(1+r/(1<<31))/2}(e,D)*N)}const D=53290320,N=10;function B(e,t,r,s,i,n,o){if(e.primitiveName===t)for(const a in e)if(a===r){let t=s?.readWithDefault(i,n,e[a]&&o);return"text"===e.type&&(t=t.toString()),void(e[a]=t)}if("type"in e&&null!=e.type)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(e.symbolLayers)for(const a of e.symbolLayers)B(a,t,r,s,i,n,o);break;case"CIMHatchFill":e.lineSymbol&&B(e.lineSymbol,t,r,s,i,n,o);break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if("CIMVectorMarker"===e.type&&e.markerGraphics)for(const a of e.markerGraphics)B(a,t,r,s,i,n,o),B(a.symbol,t,r,s,i,n,o)}}function V(e){const t=e.width;return null!=e.effects?256:Math.max(1.25*t,8)}class L{destroy(){}}class G extends L{constructor(e){super(),this._value=e}resize(e){}read(e,t){return this._value}readWithDefault(e,t,r){return this._value}referencesScale(){return!1}referencesGeometry(){return!1}}async function U(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{defaultValue:s,valueExpressionInfo:i,value:n}=t;if(i){const{expression:n}=i,o=await e.createComputedField({expression:n},r);return o?{...t,computed:o,defaultValue:s}:null}return{...t,computed:new G(n),defaultValue:s}}async function q(e,t){const{defaultValue:r,valueExpressionInfo:s}=t,{expression:i}=s,n=await e.createComputedField({expression:i});return n?{...t,computed:n,defaultValue:r}:null}const W=e=>"boolean"!=typeof e&&"number"!=typeof e&&"valueExpressionInfo"in e,Z=e=>e.some((e=>{for(const t in e){const r=e[t];if(W(r))return!0}return!1}));class Y{static async create(e,t,r){const s={},i=new Map,n=new Map,o=new Map,a=new Map,c=new Map;for(const u in r.params){const l=r.params[u];if(null!=l&&"object"==typeof l)if(Array.isArray(l)){if("object"==typeof l[0])throw new Error(`InternalError: Cannot handle ${u}. Nested array params are not supported`);s[u]=l}else if("valueExpressionInfo"in l){if(l.value){s[u]=l.value;continue}const t=await q(e,l);if(!t){s[u]=l.defaultValue;continue}i.set(u,t),s[u]=null}else switch(l.type){case"cim-effect-infos":if(l.effectInfos.some((e=>e.overrides.length))){n.set(u,{effects:await Promise.all(l.effectInfos.map((async t=>{const r=t.overrides.map((t=>U(e,t)));return{effect:t.effect,compiledOverrides:(await Promise.all(r)).filter(P.pC)}})))});break}s[u]=l.effectInfos.map((e=>e.effect));break;case"cim-marker-placement-info":l.overrides.length&&o.set(u,{placementInfo:l,compiledOverrides:(await Promise.all(l.overrides.map((t=>U(e,t))))).filter(P.pC)}),s[u]=l.placement;break;case"text-rasterization-param":{if(l.overrides.length){const t=l.overrides.map((t=>U(e,t,l.useLegacyLabelEvaluationRules)));a.set(u,{compiledOverrides:(await Promise.all(t)).filter(P.pC),rasterizationParam:l,objectIdToResourceId:new Map});continue}const r={type:"cim-rasterization-info",resource:l.resource};s[u]=await t.fetchResourceImmediate(r)??null;break}case"sprite-rasterization-param":{if(l.overrides.length){const t=l.overrides.map((t=>U(e,t)));a.set(u,{compiledOverrides:(await Promise.all(t)).filter(P.pC),rasterizationParam:l,objectIdToResourceId:new Map});continue}if("animated"===l.resource.type){a.set(u,{compiledOverrides:[],rasterizationParam:l,objectIdToResourceId:new Map});continue}const r={type:"cim-rasterization-info",resource:l.resource};s[u]=await t.fetchResourceImmediate(r)??null;break}case"cim-marker-transform-param":{const{params:t}=l;if(Z(t)){const r={compiledMarkerInfos:[]};await Promise.all(t.map((async t=>{const s={props:{}};for(const r in t)if(W(t[r])){const i=await q(e,t[r]);s.compiledExpressionMap||(s.compiledExpressionMap=new Map);const n=s.compiledExpressionMap;i&&n.set(r,i)}else s.props[r]=t[r];r.compiledMarkerInfos.push(s)}))),c.set(u,r)}else s[u]={type:"cim-marker-transform-info",infos:t};break}default:s[u]=l}else s[u]=l}return new Y(r,s,i,n,o,a,c)}constructor(e,t,r,s,i,n,o){this.inputMeshParams=e,this._resolvedMeshParams=t,this._dynamicProperties=r,this._dynamicEffectProperties=s,this._dynamicPlacementProperties=i,this._dynamicAsyncProperties=n,this._dynamicTransformProperties=o,this.evaluator=e=>e}get hasDynamicProperties(){return!!(this._dynamicProperties.size||this._dynamicAsyncProperties.size||this._dynamicEffectProperties.size||this._dynamicTransformProperties.size||this._dynamicPlacementProperties.size)}get evaluatedMeshParams(){return this._evaluatedMeshParams||(this._evaluatedMeshParams=this.evaluator(this._resolvedMeshParams)),this._evaluatedMeshParams}enqueueRequest(e,t,r){for(const n of this._dynamicAsyncProperties.values()){const o=(0,A.d9)(n.rasterizationParam.resource);"animated"===n.rasterizationParam.resource.type&&n.rasterizationParam.resource.randomizeStartTime&&(o.primitiveName="__RESERVED__PRIMITIVE__NAME__",o.startGroup=z(t.getObjectId()||0));for(const{primitiveName:e,propertyName:c,computed:u,defaultValue:l,valueExpressionInfo:h}of n.compiledOverrides)try{B(o,"animated"===n.rasterizationParam.resource.type?o.primitiveName:e,c,u,t,r,l)}catch(i){R.Z.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.mesh.MeshWriterInputEvaluator").errorOnce(new s.Z("invalid-arcade-expression",`Encountered an error when evaluating the arcade expression '${h?.expression}' (primitive: '${e}', property: '${c}')`,i))}const a=e.enqueueRequest({type:"cim-rasterization-info",resource:o});n.objectIdToResourceId.set(t.getObjectId(),a)}}evaluateMeshParams(e,t,r){for(const[s,i]of this._dynamicProperties.entries())this._resolvedMeshParams[s]=i.computed.readWithDefault(t,r,i.defaultValue);for(const[s,i]of this._dynamicPlacementProperties.entries())for(const{computed:e,defaultValue:n,propertyName:o}of i.compiledOverrides){const a=e.readWithDefault(t,r,n);i.placementInfo.placement[o]=a,this._resolvedMeshParams[s]=i.placementInfo.placement}for(const[s,i]of this._dynamicEffectProperties.entries())for(const e of i.effects){for(const{computed:s,defaultValue:i,propertyName:n}of e.compiledOverrides){const o=s.readWithDefault(t,r,i);e.effect[n]=o}this._resolvedMeshParams[s]=i.effects.map((e=>e.effect))}for(const[s,i]of this._dynamicTransformProperties.entries()){const e={type:"cim-marker-transform-info",infos:[]};for(const s of i.compiledMarkerInfos){const i={...s.props};if(s.compiledExpressionMap)for(const[e,n]of s.compiledExpressionMap){const s=n.computed.readWithDefault(t,r,n.defaultValue);i[e]="number"==typeof s||"boolean"==typeof s?s:n.defaultValue}e.infos.push(i)}this._resolvedMeshParams[s]=e}for(const[s,i]of this._dynamicAsyncProperties.entries()){const r=i.objectIdToResourceId.get(t.getObjectId());if(null==r)continue;const n=e.getResource(r);this._resolvedMeshParams[s]=n}return this._evaluatedMeshParams=this.evaluator(this._resolvedMeshParams),this.evaluatedMeshParams}}var j=r(48035),$=(r(79347),r(40316)),H=r(80457);function X(e,t,r,s,i,n,o){be=0;const a=(s-r)*n,c=i&&i.length,u=c?(i[0]-r)*n:a;let l,h,d,p,f,_=K(t,r,s,0,u,n,!0);if(_&&_.next!==_.prev){if(c&&(_=function(e,t,r,s,i,n){const o=new Array;for(let a=0,c=s.length;a<c;a++){const i=K(e,t,r,s[a]*n,a<c-1?s[a+1]*n:r*n,n,!1);i===i.next&&(i.steiner=!0),o.push(ie(i))}o.sort(pe);for(const a of o)i=ne(a,i);return i}(t,r,s,i,_,n)),a>80*n){l=d=t[0+r*n],h=p=t[1+r*n];for(let e=n;e<u;e+=n){const s=t[e+r*n],i=t[e+1+r*n];l=Math.min(l,s),h=Math.min(h,i),d=Math.max(d,s),p=Math.max(p,i)}f=Math.max(d-l,p-h),f=0!==f?1/f:0}J(_,e,n,l,h,f,o,0)}}function K(e,t,r,s,i,n,o){let a;if(o===function(e,t,r,s,i,n){let o=0;for(let a=s,c=i-n;a<i;a+=n)o+=(e[c+t*n]-e[a+t*n])*(e[a+1+t*n]+e[c+1+t*n]),c=a;return o}(e,t,0,s,i,n)>0)for(let c=s;c<i;c+=n)a=re(c+t*n,e[c+t*n],e[c+1+t*n],a);else for(let c=i-n;c>=s;c-=n)a=re(c+t*n,e[c+t*n],e[c+1+t*n],a);return a&&de(a,a.next)&&(se(a),a=a.next),a}function Q(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;if(!e)return e;let r,s=e;do{if(r=!1,s.steiner||!de(s,s.next)&&0!==ae(s.prev,s,s.next))s=s.next;else{if(se(s),s=t=s.prev,s===s.next)break;r=!0}}while(r||s!==t);return t}function J(e,t,r,s,i,n,o,a){if(!e)return;!a&&n&&(e=oe(e,s,i,n));let c=e;for(;e.prev!==e.next;){const u=e.prev,l=e.next;if(n?te(e,s,i,n):ee(e))t.push(u.index/r+o),t.push(e.index/r+o),t.push(l.index/r+o),se(e),e=l.next,c=l.next;else if((e=l)===c){a?1===a?J(e=fe(e,t,r,o),t,r,s,i,n,o,2):2===a&&_e(e,t,r,s,i,n,o):J(Q(e),t,r,s,i,n,o,1);break}}}function ee(e){const t=e.prev,r=e,s=e.next;if(ae(t,r,s)>=0)return!1;let i=e.next.next;const n=i;let o=0;for(;i!==e.prev&&(0===o||i!==n);){if(o++,ue(t.x,t.y,r.x,r.y,s.x,s.y,i.x,i.y)&&ae(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function te(e,t,r,s){const i=e.prev,n=e,o=e.next;if(ae(i,n,o)>=0)return!1;const a=i.x<n.x?i.x<o.x?i.x:o.x:n.x<o.x?n.x:o.x,c=i.y<n.y?i.y<o.y?i.y:o.y:n.y<o.y?n.y:o.y,u=i.x>n.x?i.x>o.x?i.x:o.x:n.x>o.x?n.x:o.x,l=i.y>n.y?i.y>o.y?i.y:o.y:n.y>o.y?n.y:o.y,h=he(a,c,t,r,s),d=he(u,l,t,r,s);let p=e.prevZ,f=e.nextZ;for(;p&&p.z>=h&&f&&f.z<=d;){if(p!==e.prev&&p!==e.next&&ue(i.x,i.y,n.x,n.y,o.x,o.y,p.x,p.y)&&ae(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,f!==e.prev&&f!==e.next&&ue(i.x,i.y,n.x,n.y,o.x,o.y,f.x,f.y)&&ae(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;p&&p.z>=h;){if(p!==e.prev&&p!==e.next&&ue(i.x,i.y,n.x,n.y,o.x,o.y,p.x,p.y)&&ae(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;f&&f.z<=d;){if(f!==e.prev&&f!==e.next&&ue(i.x,i.y,n.x,n.y,o.x,o.y,f.x,f.y)&&ae(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function re(e,t,r,s){const i=ge.create(e,t,r);return s?(i.next=s.next,i.prev=s,s.next.prev=i,s.next=i):(i.prev=i,i.next=i),i}function se(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function ie(e){let t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function ne(e,t){const r=function(e,t){let r=t;const s=e.x,i=e.y;let n,o=-1/0;do{if(i<=r.y&&i>=r.next.y&&r.next.y!==r.y){const e=r.x+(i-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(e<=s&&e>o){if(o=e,e===s){if(i===r.y)return r;if(i===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!n)return null;if(s===o)return n.prev;const a=n,c=n.x,u=n.y;let l,h=1/0;for(r=n.next;r!==a;)s>=r.x&&r.x>=c&&s!==r.x&&ue(i<u?s:o,i,c,u,i<u?o:s,i,r.x,r.y)&&(l=Math.abs(i-r.y)/(s-r.x),(l<h||l===h&&r.x>n.x)&&le(r,e)&&(n=r,h=l)),r=r.next;return n}(e,t);if(!r)return t;const s=me(r,e);return Q(s,s.next),Q(r,r.next)}function oe(e,t,r,s){let i;for(;i!==e;i=i.next){if(i=i||e,null===i.z&&(i.z=he(i.x,i.y,t,r,s)),i.prev.next!==i||i.next.prev!==i)return i.prev.next=i,i.next.prev=i,oe(e,t,r,s);i.prevZ=i.prev,i.nextZ=i.next}return e.prevZ.nextZ=null,e.prevZ=null,function(e){let t,r=1;for(;;){let s,i=e;e=null,t=null;let n=0;for(;i;){n++,s=i;let o=0;for(;o<r&&s;o++)s=s.nextZ;let a=r;for(;o>0||a>0&&s;){let r;0===o?(r=s,s=s.nextZ,a--):0!==a&&s?i.z<=s.z?(r=i,i=i.nextZ,o--):(r=s,s=s.nextZ,a--):(r=i,i=i.nextZ,o--),t?t.nextZ=r:e=r,r.prevZ=t,t=r}i=s}if(t.nextZ=null,r*=2,n<2)return e}}(e)}function ae(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function ce(e,t,r,s){return!!(de(e,t)&&de(r,s)||de(e,s)&&de(r,t))||ae(e,t,r)>0!=ae(e,t,s)>0&&ae(r,s,e)>0!=ae(r,s,t)>0}function ue(e,t,r,s,i,n,o,a){return(i-o)*(t-a)-(e-o)*(n-a)>=0&&(e-o)*(s-a)-(r-o)*(t-a)>=0&&(r-o)*(n-a)-(i-o)*(s-a)>=0}function le(e,t){return ae(e.prev,e,e.next)<0?ae(e,t,e.next)>=0&&ae(e,e.prev,t)>=0:ae(e,t,e.prev)<0||ae(e,e.next,t)<0}function he(e,t,r,s,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-s)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function de(e,t){return e.x===t.x&&e.y===t.y}function pe(e,t){return e.x-t.x}function fe(e,t,r,s){let i=e;do{const n=i.prev,o=i.next.next;!de(n,o)&&ce(n,i,i.next,o)&&le(n,o)&&le(o,n)&&(t.push(n.index/r+s),t.push(i.index/r+s),t.push(o.index/r+s),se(i),se(i.next),i=e=o),i=i.next}while(i!==e);return i}function _e(e,t,r,s,i,n,o){let a=e;do{let e=a.next.next;for(;e!==a.prev;){if(a.index!==e.index&&ye(a,e)){let c=me(a,e);return a=Q(a,a.next),c=Q(c,c.next),J(a,t,r,s,i,n,o,0),void J(c,t,r,s,i,n,o,0)}e=e.next}a=a.next}while(a!==e)}function ye(e,t){return e.next.index!==t.index&&e.prev.index!==t.index&&!function(e,t){let r=e;do{if(r.index!==e.index&&r.next.index!==e.index&&r.index!==t.index&&r.next.index!==t.index&&ce(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&le(e,t)&&le(t,e)&&function(e,t){let r=e,s=!1;const i=(e.x+t.x)/2,n=(e.y+t.y)/2;do{r.y>n!=r.next.y>n&&r.next.y!==r.y&&i<(r.next.x-r.x)*(n-r.y)/(r.next.y-r.y)+r.x&&(s=!s),r=r.next}while(r!==e);return s}(e,t)}function me(e,t){const r=ge.create(e.index,e.x,e.y),s=ge.create(t.index,t.x,t.y),i=e.next,n=t.prev;return e.next=t,t.prev=e,r.next=i,i.prev=r,s.next=r,r.prev=s,n.next=s,s.prev=n,s}class ge{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(e,t,r){const s=be<xe.length?xe[be++]:new ge;return s.index=e,s.x=t,s.y=r,s.prev=null,s.next=null,s.z=null,s.prevZ=null,s.nextZ=null,s.steiner=!1,s}}const xe=[];let be=0;for(let Gu=0;Gu<8096;Gu++)xe.push(new ge);const ve=new $.bN(0,0,0,1,0),we=new $.bN(0,0,0,1,0);function Ie(e,t,r){let s=0;for(let i=1;i<r;i++){const r=e[2*(t+i-1)],n=e[2*(t+i-1)+1];s+=(e[2*(t+i)]-r)*(e[2*(t+i)+1]+n)}return s}function Se(e,t,r,s,i){let n=0;for(let o=r;o<s;o+=3){const r=2*(e[o]-i),s=2*(e[o+1]-i),a=2*(e[o+2]-i);n+=Math.abs((t[r]-t[a])*(t[s+1]-t[r+1])-(t[r]-t[s])*(t[a+1]-t[r+1]))}return n}function Te(e,t){if(null==e)return null;if(!function(e,t,r){let s=0;for(let i=0;i<e.lengths.length;i++){const n=e.lengths[i];for(let i=0;i<n;i++){const n=e.coords[2*(i+s)],o=e.coords[2*(i+s)+1];if(n<t||n>r||o<t||o>r)return!0}s+=n}return!1}(e,-128,f.i9+128))return e;ve.setPixelMargin(t),ve.reset($.Vl.Polygon);let r=0;for(let o=0;o<e.lengths.length;o++){const t=e.lengths[o];let s=e.coords[2*(0+r)],i=e.coords[2*(0+r)+1];ve.moveTo(s,i);for(let n=1;n<t;n++)s=e.coords[2*(n+r)],i=e.coords[2*(n+r)+1],ve.lineTo(s,i);ve.close(),r+=t}const s=ve.result(!1);if(!s)return null;const i=[],n=[];for(const o of s){let e=0;for(const t of o)n.push(t.x),n.push(t.y),e++;i.push(e)}return new H.Z(i,n)}ve.setExtent(f.i9),we.setExtent(f.i9);var Me=r(23895),ke=r(41116),Fe=r(35747),Ee=r(63695),Ce=r(94457);class Pe{static executeEffects(e,t,r,s){const i=(0,Ce.Tg)(e);let n=new Fe.z(t);for(const o of e){const e=(0,Ee.h)(o);e&&(n=e.execute(n,o,1.3333333333333333,r,s,i))}return n}static applyEffects(e,t,r){if(!e)return t;const s=(0,Ce.Tg)(e);let i,n=new Fe.z(Me.z.fromJSONCIM(t));for(const c of e){const e=(0,Ee.h)(c);e&&(n=e.execute(n,c,1,null,r,s))}const o=[];let a=null;for(;i=n.next();)o.push(...(0,ke.M)(i)),a=i.geometryType;return 0===o.length||null===a?null:"esriGeometryPolygon"===a?{rings:o}:{paths:o}}}let Ae=null;function Re(){return Ae}const Oe=new Float32Array(1);new Uint32Array(Oe.buffer);var ze=r(8548);function De(e){switch(e){case ze.g.BYTE:case ze.g.UNSIGNED_BYTE:return 1;case ze.g.SHORT:case ze.g.UNSIGNED_SHORT:return 2;case ze.g.FLOAT:case ze.g.INT:case ze.g.UNSIGNED_INT:return 4}}class Ne{static fromVertexSpec(e,t){let r,s,i,{attributes:n}=e;const o=[];for(const p in n){const e=n[p];!1!==t?.[p]&&("position"===e.pack?r={...e,name:p,offset:0}:"id"===e.pack?s={...e,name:p,offset:4}:"bitset"===p?i={...e,name:p,offset:7}:o.push({...e,name:p}))}const a=function(e){const t=[],r=[],s=[];for(const i of e){const e=De(i.type)*i.count;switch(e%2||e%4||4){case 4:t.push(i);continue;case 2:r.push(i);continue;case 1:s.push(i);continue;default:throw new Error("Found unexpected dataType byte count")}}return t.push(...r),t.push(...s),t}(o),c=[];let u=8,l=1;for(const p of a)c.push({...p,offset:u}),u+=De(p.type)*p.count,p.packAlternating&&(l=Math.max(p.packAlternating.count,l));const h=Uint32Array.BYTES_PER_ELEMENT,d=u%h;return new Ne(r,s,i,c,u+(d?h-d:0),l)}constructor(e,t,r,s,i,n){this.position=e,this.id=t,this.bitset=r,this.standardAttributes=s,this.stride=i,this.packVertexCount=n,s.push(r),this._attributes=[e,t,r,...s]}get attributeLayout(){if(!this._attributeLayout){const e=function(e){const t=e.map((e=>{let{name:t,count:r,type:s}=e;return`${t}.${r}.${s}`})).join(",");return(0,O.hP)(t)}(this._attributes),t=this._attributes.map((e=>({name:e.name,count:e.count,offset:e.offset,type:e.type,packPrecisionFactor:e.packPrecisionFactor,normalized:e.normalized??!1})));this._attributeLayout={attributes:t,hash:e,stride:this.stride}}return this._attributeLayout}}class Be{static fromVertexSpec(e,t){const r=Ne.fromVertexSpec(e,t);return new Be(r)}constructor(e){this._spec=e,this._packed=new Uint8Array(this._spec.stride*this._spec.packVertexCount),this._packedU32View=new Uint32Array(this._packed.buffer),this._dataView=new DataView(this._packed.buffer)}get attributeLayout(){return this._spec.attributeLayout}get stride(){return this._spec.stride}writeVertex(e,t,r,s,i,n){for(let o=0;o<this._spec.packVertexCount;o++){const e=o*this._spec.stride;this._packPosition(r,s,e),this._packId(t,e);const a=this._spec.bitset;if(n){if(a.packTessellation){const t=a.packTessellation(n,i);this._pack(t,a,e)}for(const t of this._spec.standardAttributes)if(null!=t.packTessellation){const r=t.packTessellation(n,i);this._pack(r,t,e)}else if(t.packAlternating?.packTessellation){const e=t.packAlternating.packTessellation(n,i);for(let r=0;r<this._spec.packVertexCount;r++){const s=e[r];this._pack(s,t,r*this._spec.stride)}}}}e.vertexWriteRegion(this._packedU32View)}pack(e,t){for(const r of this._spec.standardAttributes)if(r.pack&&"string"!=typeof r.pack){const s=r.pack(e,t);for(let e=0;e<this._spec.packVertexCount;e++)this._pack(s,r,e*this._spec.stride)}else if(r.packAlternating?.pack){const s=r.packAlternating.pack(e,t);for(let e=0;e<this._spec.packVertexCount;e++){const t=s[e];this._pack(t,r,e*this._spec.stride)}}}_packPosition(e,t,r){const{offset:s}=this._spec.position,i=this._spec.position.packPrecisionFactor??1,n=function(e,t){return 65535&e|t<<16}(e*i,t*i);this._dataView.setUint32(r+s,n,!0)}_packId(e,t){const r=e*(this._spec.id.packPrecisionFactor??1),s=4278190080&this._dataView.getUint32(t+this._spec.id.offset,!0);this._dataView.setUint32(t+this._spec.id.offset,r|s,!0)}_pack(e,t,r){!function(e,t,r,s){const i=r.packPrecisionFactor??1;switch(r.type){case ze.g.BYTE:if(1===r.count)e.setInt8(s+r.offset,t*i);else for(let n=0;n<r.count;n++){const o=n*Int8Array.BYTES_PER_ELEMENT;e.setInt8(s+r.offset+o,t[n]*i)}break;case ze.g.UNSIGNED_BYTE:if(1===r.count)e.setUint8(s+r.offset,t*i);else for(let n=0;n<r.count;n++){const o=n*Uint8Array.BYTES_PER_ELEMENT;e.setUint8(s+r.offset+o,t[n]*i)}break;case ze.g.SHORT:if(1===r.count)e.setInt16(s+r.offset,t*i,!0);else for(let n=0;n<r.count;n++){const o=n*Int16Array.BYTES_PER_ELEMENT;e.setInt16(s+r.offset+o,t[n]*i,!0)}break;case ze.g.UNSIGNED_SHORT:if(1===r.count)e.setUint16(s+r.offset,t*i,!0);else for(let n=0;n<r.count;n++){const o=n*Uint16Array.BYTES_PER_ELEMENT;e.setUint16(s+r.offset+o,t[n]*i,!0)}break;case ze.g.INT:if(1===r.count)e.setInt32(s+r.offset,t*i,!0);else for(let n=0;n<r.count;n++){const o=n*Int32Array.BYTES_PER_ELEMENT;e.setInt32(s+r.offset+o,t[n]*i,!0)}break;case ze.g.UNSIGNED_INT:if(1===r.count)e.setUint32(s+r.offset,t*i,!0);else for(let n=0;n<r.count;n++){const o=n*Uint32Array.BYTES_PER_ELEMENT;e.setUint32(s+r.offset+o,t[n]*i,!0)}break;case ze.g.FLOAT:if(1===r.count)e.setFloat32(s+r.offset,t*i,!0);else for(let n=0;n<r.count;n++){const o=n*Float32Array.BYTES_PER_ELEMENT;e.setFloat32(s+r.offset+o,t[n]*i,!0)}}}(this._dataView,e,t,r)}}class Ve{constructor(e,t,r,s){this._instanceId=e,this._evaluator=t,this._viewParams=r,this._optionalAttributes=s,this._evaluator.evaluator=e=>this.vertexSpec.createComputedParams(e)}get _vertexPack(){if(!this._cachedVertexPack){const e=Be.fromVertexSpec(this.vertexSpec,this._optionalAttributes);this._evaluator.hasDynamicProperties||e.pack(this._evaluator.evaluatedMeshParams,this._viewParams),this._cachedVertexPack=e}return this._cachedVertexPack}get evaluatedMeshParams(){return this._evaluator.evaluatedMeshParams}get hasEffects(){return!!this.evaluatedMeshParams.effects}get instanceId(){return this._instanceId}get attributeLayout(){return this._vertexPack.attributeLayout}setReferences(e){this._references=e}getBoundsInfo(){return null}getTileInfo(){return this._viewParams.tileInfo}async loadDependencies(){(function(e){if(!e)return!1;for(const t of e)switch(t.effect.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":case"CIMGeometricEffectDonut":return!0}return!1})(this._evaluator.inputMeshParams.params.effects?.effectInfos)&&await async function(){Ae=await Promise.all([r.e(99058),r.e(63645)]).then(r.bind(r,50309))}()}enqueueRequest(e,t,r){this._evaluator.hasDynamicProperties&&this._evaluator.enqueueRequest(e,t,r)}write(e,t,r,s,i){this.ensurePacked(t,r,s);const n=this.evaluatedMeshParams.effects;if(!n||0===n.length)return void this._write(e,r,void 0,i);const o=r.readGeometryForDisplay()?.clone();if(!o)return;const a=Me.z.fromOptimizedCIM(o,r.geometryType),c=Re();a.invertY();const u=e.id||"",l=Pe.executeEffects(n,a,u,c);let h;for(;h=l.next();)h.invertY(),this._write(e,r,h,i)}ensurePacked(e,t,r){if(!this._evaluator.hasDynamicProperties)return;const s=this._evaluator.evaluateMeshParams(e,t,r);this._vertexPack.pack(s,this._viewParams)}_writeVertex(e,t,r,s,i){const n=this.evaluatedMeshParams;this._vertexPack.writeVertex(e,t,r,s,n,i)}}const Le=(0,n.Z)("featurelayer-fast-triangulation-enabled");class Ge extends Ve{async loadDependencies(){await Promise.all([super.loadDependencies(),(0,j.j)()])}_write(e,t,r){const s=r?.asOptimized()??t.readGeometryForDisplay(),i=this._clip(s);i&&(e.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(e,t,i),e.recordEnd())}_clip(e){if(!e)return null;return Te(e,this.hasEffects?256:8)}_writeGeometry(e,t,r){const s=r.maxLength>100,i=[],n=this.createTesselationParams(t);if(!s&&Le&&function(e,t){const{coords:r,lengths:s,hasIndeterminateRingOrder:i}=t,n=e;if(i)return!1;let o=0;for(let a=0;a<s.length;){let e=a,t=s[a],i=Ie(r,o,t);const c=[];for(;++e<s.length;){const n=s[e],a=Ie(r,o+t,n);if(!(a>0))break;i+=a,c.push(o+t),t+=n}const u=n.length;X(n,r,o,o+t,c,2,0);const l=Se(n,r,u,n.length,0),h=Math.abs(i);if(Math.abs((l-h)/Math.max(1e-7,h))>1e-5)return n.length=0,!1;a=e,o+=t}return!0}(i,r))return void(i.length&&this._writeVertices(e,t,r.coords,n,i));const o=function(e){const{coords:t,lengths:r}=e,{buffer:s}=(0,j.b)(t,r);return s}(r);this._writeVertices(e,t,o,n)}_writeVertices(e,t,r,s,i){const n=t.getDisplayId(),o=e.vertexCount(),a=this.hasEffects;let c=0;if(i)for(const u of i){const t=r[2*u],i=r[2*u+1];a&&e.recordBounds(t,i,0,0),this._writeVertex(e,n,t,i,s),c++}else for(let u=0;u<r.length;u+=2){const t=Math.round(r[u]),i=Math.round(r[u+1]);a&&e.recordBounds(t,i,0,0),this._writeVertex(e,n,t,i,s),c++}e.indexEnsureSize(c);for(let u=0;u<c;u++)e.indexWrite(u+o)}}const Ue={createComputedParams:e=>e,attributes:{id:{type:ze.g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:ze.g.UNSIGNED_BYTE,count:1},pos:{type:ze.g.SHORT,count:2,pack:"position",packPrecisionFactor:10},inverseArea:{type:ze.g.FLOAT,count:1,packTessellation:e=>{let{inverseArea:t}=e;return t}}}};var qe=r(99201),We=r(51995),Ze=r(48202);function Ye(e,t){return[!!e?.minScale&&t.scaleToZoom(e.minScale)||0,!!e?.maxScale&&t.scaleToZoom(e.maxScale)||100]}function je(e){return 1<<e}function $e(e){let t=0;for(const[r,s]of e)s&&(t|=1<<r);return t}function He(e){let t;if(!e)return[0,0,0,0];if("string"==typeof e){const r=We.Z.fromString(e);if(!r)return R.Z.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.meshWriterUtils").errorOnce(new s.Z("mapview:mesh-processing","Unable to parse string into color",{color:e})),[0,0,0,0];t=r.toArray()}else t=e;const[r,i,n,o]=t;return[r*(o/255),i*(o/255),n*(o/255),o]}function Xe(e,t){return Math.round(Math.min(Math.sqrt(e*t),255))}function Ke(e,t){return Math.round(e*t)/t}function Qe(e,t){return Math.ceil(e*t)/t}const Je={createComputedParams:e=>e,attributes:{id:{type:ze.g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:ze.g.UNSIGNED_BYTE,count:1},pos:{type:ze.g.SHORT,count:2,pack:"position",packPrecisionFactor:10},zoomRange:{type:ze.g.SHORT,count:2,packPrecisionFactor:f.JS,pack:(e,t)=>{let{scaleInfo:r}=e,{tileInfo:s}=t;return Ye(r,s)}},color:{type:ze.g.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{color:t}=e;return He(t)}}}};class et extends Ge{constructor(){super(...arguments),this.vertexSpec=Je}createTesselationParams(e){return null}}const tt={createComputedParams:e=>e,attributes:{...Je.attributes,tlbr:{count:4,type:ze.g.UNSIGNED_SHORT,pack:e=>{let{sprite:t}=e;const{rect:r,width:s,height:i}=t,n=r.x+f.s4,o=r.y+f.s4;return[n,o,n+s,o+i]}},inverseRasterizationScale:{count:1,type:ze.g.BYTE,packPrecisionFactor:16,pack:e=>{let{sprite:t}=e;return 1/t.rasterizationScale}}}};class rt extends et{constructor(){super(...arguments),this.vertexSpec=tt}_write(e,t,r){const s=r?.asOptimized()??t.readGeometryForDisplay(),i=this._clip(s);if(!i)return;const n=this.evaluatedMeshParams.sprite?.textureBinding;e.recordStart(this.instanceId,this.attributeLayout,n),this._writeGeometry(e,t,i),e.recordEnd()}}var st;!function(e){e[e.Geographic=0]="Geographic",e[e.Arithmatic=1]="Arithmatic"}(st||(st={}));const it=1.1,nt=1,ot=1e-5,at=.05,ct=1e-30,ut=2;function lt(e){const{sprite:t,aspectRatio:r,scaleProportionally:s}=e,i=(0,l.F2)(e.height),n=i>0?i:t.height;let o=i*r;return o<=0?o=t.width:s&&(o*=t.width/t.height),{width:o,height:n}}function ht(e){const{applyRandomOffset:t,sampleAlphaOnly:r}=e,{width:s,height:i}=lt(e);return $e([[ut,t],[4,r],[6,s<f.oh],[5,i<f.oh]])}function dt(e){const{width:t}=lt(e);return Math.round(t<f.oh?t*f.Kg:t)}function pt(e){const{height:t}=lt(e);return Math.round(t<f.oh?t*f.Kg:t)}const ft={createComputedParams:e=>e,attributes:{...tt.attributes,bitset:{count:1,type:ze.g.UNSIGNED_BYTE,pack:ht},width:{count:1,type:ze.g.UNSIGNED_SHORT,pack:dt},height:{count:1,type:ze.g.UNSIGNED_SHORT,pack:pt},offset:{count:2,type:ze.g.SHORT,pack:e=>{let{offsetX:t,offsetY:r}=e;return[(0,l.F2)(t),-(0,l.F2)(r)]}},scale:{count:2,type:ze.g.UNSIGNED_BYTE,packPrecisionFactor:16,pack:e=>{let{scaleX:t,scaleY:r}=e;return[t,r]}},angle:{count:1,type:ze.g.UNSIGNED_BYTE,pack:e=>{let{angle:t}=e;return(0,qe.s5)(t)}}}};var _t=r(82010);class yt{constructor(){this.extrusionOffsetX=0,this.extrusionOffsetY=0,this.normalX=0,this.normalY=0,this.directionX=0,this.directionY=0,this.distance=0}}const mt={createComputedParams:e=>e,attributes:{id:{type:ze.g.UNSIGNED_BYTE,count:3,pack:"id"},pos:{type:ze.g.SHORT,count:2,pack:"position",packPrecisionFactor:10},bitset:{type:ze.g.UNSIGNED_BYTE,count:1},zoomRange:{type:ze.g.SHORT,count:2,packPrecisionFactor:f.JS,pack:(e,t)=>{let{scaleInfo:r}=e,{tileInfo:s}=t;return Ye(r,s)}},color:{type:ze.g.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{color:t}=e;return He(t)}},offset:{type:ze.g.BYTE,count:2,packPrecisionFactor:16,packTessellation:e=>{let{extrusionOffsetX:t,extrusionOffsetY:r}=e;return[Ke(t,16),Ke(r,16)]}},normal:{type:ze.g.BYTE,count:2,packPrecisionFactor:16,packTessellation:e=>{let{normalX:t,normalY:r}=e;return[Ke(t,16),Ke(r,16)]}},halfWidth:{type:ze.g.UNSIGNED_SHORT,count:1,packPrecisionFactor:16,pack:e=>{let{width:t}=e;return Qe((0,l.F2)(.5*t),16)}},referenceHalfWidth:{type:ze.g.UNSIGNED_SHORT,count:1,packPrecisionFactor:16,pack:e=>{let{referenceWidth:t}=e;return Qe((0,l.F2)(.5*t),16)}}}};class gt{constructor(){this.id=0,this.bitset=0,this.indexCount=0,this.vertexCount=0,this.vertexFrom=0,this.vertexBounds=0}}class xt extends Ve{constructor(e,t,r,s){super(e,t,r,s),this.vertexSpec=mt,this._currentWrite=new gt,this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0,wrapDistance:65535,textured:!1},this._tessParams=new yt,this._initializeTessellator()}writeLineVertices(e,t,r){const s=this._getLines(t);null!=s&&this._writeVertices(e,r,s)}_initializeTessellator(){this._lineTessellator=new _t.z(this._writeTesselatedVertex.bind(this),this._writeTriangle.bind(this),!0)}_write(e,t,r){const s=r??Me.z.fromFeatureSetReaderCIM(t);s&&this._writeGeometry(e,t,s)}_writeGeometry(e,t,r,s){e.recordStart(this.instanceId,this.attributeLayout,s),this.writeLineVertices(e,r,t),e.recordEnd()}_getLines(e){return function(e,t){we.setPixelMargin(t);const r=we,s=-t,i=f.i9+t;let n=[],o=!1;if(!e.nextPath())return null;let a=!0;for(;a;){e.seekPathStart();const t=[];if(!e.pathSize)return null;r.reset($.Vl.LineString),e.nextPoint();let c=e.x,u=e.y;if(o)r.moveTo(c,u);else{if(c<s||c>i||u<s||u>i){o=!0;continue}t.push({x:c,y:u})}let l=!1;for(;e.nextPoint();)if(c=e.x,u=e.y,o)r.lineTo(c,u);else{if(c<s||c>i||u<s||u>i){l=!0;break}t.push({x:c,y:u})}if(l)o=!0;else{if(o){const e=r.resultWithStarts();if(e)for(const t of e)n.push(t)}else n.push({line:t,start:0});a=e.nextPath(),o=!1}}return n=n.filter((e=>e.line.length>1)),0===n.length?null:n}(e,V(this.evaluatedMeshParams))}_writeVertices(e,t,r){const{_currentWrite:s,_tessellationOptions:i,evaluatedMeshParams:n}=this,{width:o,capType:a,joinType:c,miterLimit:u,hasSizeVV:h}=n,d=(0,l.F2)(.5*o);i.halfWidth=d,i.capType=function(e){switch(e){case"butt":case Ze.kP.Butt:return Ze.RL.BUTT;case"round":case Ze.kP.Round:return Ze.RL.ROUND;case"square":case Ze.kP.Square:return Ze.RL.SQUARE}}(a),i.joinType=function(e){switch(e){case"bevel":case Ze.r4.Bevel:return Ze.AH.BEVEL;case"miter":case Ze.r4.Miter:return Ze.AH.MITER;case"round":case Ze.r4.Round:return Ze.AH.ROUND}}(c),i.miterLimit=u;const p=!h;s.out=e,s.id=t.getDisplayId(),s.vertexCount=0,s.indexCount=0,s.vertexFrom=e.vertexCount(),s.vertexBounds=p&&d<f.do?0:1;for(const{line:l,start:f}of r)i.initialDistance=f%65535,this._lineTessellator.tessellate(l,i,p)}_writeTesselatedVertex(e,t,r,s,i,n,o,a,c,u,l){const{out:h,id:d,vertexBounds:p}=this._currentWrite;return this.hasEffects&&h.recordBounds(e,t,p,p),this._tessParams.extrusionOffsetX=o,this._tessParams.extrusionOffsetY=a,this._tessParams.normalX=c,this._tessParams.normalY=u,this._tessParams.directionX=i,this._tessParams.directionY=n,this._tessParams.distance=l,this._writeVertex(h,d,e,t,this._tessParams),this._currentWrite.vertexFrom+this._currentWrite.vertexCount++}_writeTriangle(e,t,r){const{out:s}=this._currentWrite;s.indexEnsureSize(3),s.indexWrite(e),s.indexWrite(t),s.indexWrite(r),this._currentWrite.indexCount+=3}}const bt={createComputedParams:e=>e,attributes:{...mt.attributes,bitset:{type:ze.g.UNSIGNED_BYTE,count:1,pack:e=>0},color:{type:ze.g.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{color:t}=e;return He(t)}}}},vt={createComputedParams:e=>e,attributes:{...mt.attributes,bitset:{type:ze.g.UNSIGNED_BYTE,count:1,pack:e=>$e([[0,!0]])},color:{type:ze.g.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{outlineColor:t}=e;return He(t)}}}};class wt extends xt{constructor(){super(...arguments),this.vertexSpec=vt}}class It extends et{constructor(e,t,r,s){super(e,t,r,s),this.vertexSpec=bt,this._lineMeshWriter=this._createOutlineWriter(e,t,r,s)}_createOutlineWriter(e,t,r,s){return new wt(e,t,r,s)}_write(e,t,r){const s=r?.asOptimized()??t.readGeometryForDisplay(),i=this._clip(s);i&&(e.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(e,t,i),this._lineMeshWriter.writeLineVertices(e,Me.z.fromOptimizedCIM(i,"esriGeometryPolyline"),t),e.recordEnd())}_clip(e){return e?Te(e,V(this.evaluatedMeshParams)):null}ensurePacked(e,t,r){super.ensurePacked(e,t,r),this._lineMeshWriter.ensurePacked(e,t,r)}enqueueRequest(e,t,r){super.enqueueRequest(e,t,r),this._lineMeshWriter.enqueueRequest(e,t,r)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}var St=r(27366),Tt=r(99340),Mt=r(97731);const kt=()=>R.Z.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class Ft{constructor(){this._includedModules=new Map}include(e,t){if(this._includedModules.has(e)){const r=this._includedModules.get(e);if(r!==t){kt().error("Trying to include shader module multiple times with different sets of options.");const t=new Set;for(const s of Object.keys(r))r[s]!==e[s]&&t.add(s);for(const s of Object.keys(e))r[s]!==e[s]&&t.add(s);t.forEach((t=>console.error(`  ${t}: current ${r[t]} new ${e[t]}`)))}}else this._includedModules.set(e,t),e(this.builder,t)}}class Et extends Ft{constructor(){super(...arguments),this.vertex=new At,this.fragment=new At,this.attributes=new Rt,this.varyings=new Ot,this.extensions=new zt,this.constants=new Dt}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const r=this.extensions.generateSource(e),s=this.attributes.generateSource(e),i=this.varyings.generateSource(e),n="vertex"===e?this.vertex:this.fragment,o=n.uniforms.generateSource(),a=n.code.generateSource(),c="vertex"===e?Nt:function(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return`#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif\n${e?"out vec4 fragColor;":""}\n`}(t),u=this.constants.generateSource().concat(n.constants.generateSource());return`${t?"#version 300 es":""}\n${r.join("\n")}\n${c}\n${u.join("\n")}\n${o.join("\n")}\n${s.join("\n")}\n${i.join("\n")}\n${a.join("\n")}`}generateBindPass(e){const t=new Map;this.vertex.uniforms.entries.forEach((e=>{const r=e.bind[Tt.P.Pass];r&&t.set(e.name,r)})),this.fragment.uniforms.entries.forEach((e=>{const r=e.bind[Tt.P.Pass];r&&t.set(e.name,r)}));const r=Array.from(t.values()),s=r.length;return(t,i)=>{for(let n=0;n<s;++n)r[n](e,t,i)}}generateBindDraw(e){const t=new Map;this.vertex.uniforms.entries.forEach((e=>{const r=e.bind[Tt.P.Draw];r&&t.set(e.name,r)})),this.fragment.uniforms.entries.forEach((e=>{const r=e.bind[Tt.P.Draw];r&&t.set(e.name,r)}));const r=Array.from(t.values()),s=r.length;return(t,i,n)=>{for(let o=0;o<s;++o)r[o](e,t,i,n)}}}class Ct{constructor(){this._entries=new Map}add(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];for(const s of t)this._add(s)}get(e){return this._entries.get(e)}_add(e){if(null!=e){if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new s.Z(`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}else kt().error(`Trying to add null Uniform from ${(new Error).stack}.`)}generateSource(){return Array.from(this._entries.values()).map((e=>null!=e.arraySize?`uniform ${e.type} ${e.name}[${e.arraySize}];`:`uniform ${e.type} ${e.name};`))}get entries(){return Array.from(this._entries.values())}}class Pt{constructor(){this._entries=new Array}add(e){this._entries.push(e)}generateSource(){return this._entries}}class At extends Ft{constructor(){super(...arguments),this.uniforms=new Ct,this.code=new Pt,this.constants=new Dt}get builder(){return this}}class Rt{constructor(){this._entries=new Array}add(e,t){this._entries.push([e,t])}generateSource(e){return"fragment"===e?[]:this._entries.map((e=>`in ${e[1]} ${e[0]};`))}}class Ot{constructor(){this._entries=new Map}add(e,t){this._entries.has(e)&&(0,Mt.hu)(this._entries.get(e)===t),this._entries.set(e,t)}generateSource(e){const t=new Array;return this._entries.forEach(((r,s)=>t.push("vertex"===e?`out ${r} ${s};`:`in ${r} ${s};`))),t}}class zt{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const t="vertex"===e?zt.ALLOWLIST_VERTEX:zt.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((e=>t.includes(e))).map((e=>`#extension ${e} : enable`))}}zt.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],zt.ALLOWLIST_VERTEX=[];class Dt{constructor(){this._entries=new Set}add(e,t,r){let s="ERROR_CONSTRUCTOR_STRING";switch(t){case"float":s=Dt._numberToFloatStr(r);break;case"int":s=Dt._numberToIntStr(r);break;case"bool":s=r.toString();break;case"vec2":s=`vec2(${Dt._numberToFloatStr(r[0])},                            ${Dt._numberToFloatStr(r[1])})`;break;case"vec3":s=`vec3(${Dt._numberToFloatStr(r[0])},                            ${Dt._numberToFloatStr(r[1])},                            ${Dt._numberToFloatStr(r[2])})`;break;case"vec4":s=`vec4(${Dt._numberToFloatStr(r[0])},                            ${Dt._numberToFloatStr(r[1])},                            ${Dt._numberToFloatStr(r[2])},                            ${Dt._numberToFloatStr(r[3])})`;break;case"ivec2":s=`ivec2(${Dt._numberToIntStr(r[0])},                             ${Dt._numberToIntStr(r[1])})`;break;case"ivec3":s=`ivec3(${Dt._numberToIntStr(r[0])},                             ${Dt._numberToIntStr(r[1])},                             ${Dt._numberToIntStr(r[2])})`;break;case"ivec4":s=`ivec4(${Dt._numberToIntStr(r[0])},                             ${Dt._numberToIntStr(r[1])},                             ${Dt._numberToIntStr(r[2])},                             ${Dt._numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":s=`${t}(${Array.prototype.map.call(r,(e=>Dt._numberToFloatStr(e))).join(", ")})`}return this._entries.add(`const ${t} ${e} = ${s};`),this}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}}const Nt="precision highp float;\nprecision highp sampler2D;";function Bt(e,t){const r=[];for(r.push(t);r.length;){const t=r.pop();if("object"==typeof t&&!e.has(t.uid)){e.add(t.uid);for(const e of t.children)r.push(e)}}}class Vt{constructor(){this.uid=Vt.NodeCount++,this._debugName=null,this._isMutable=!1,this.isImplicit=!1}get isMutable(){return this._isMutable}setMutable(){return this._isMutable=!0,this}setDebugName(e){return e=function(e){return e.split(" ").map(((e,t)=>t>0?e.charAt(0).toUpperCase()+e.slice(1):e)).join("")}(e),this._debugName=e,this.isImplicit&&this.children[0]instanceof Vt&&this.children[0].setDebugName(e),this}get debugInfo(){return{name:this._debugName??""}}cloneInto(e){e._debugName=this._debugName,e._isMutable=this._isMutable,e.isImplicit=this.isImplicit,e.uid=this.uid}}function Lt(e){return"object"==typeof e?e.clone():e}Vt.NodeCount=0;class Gt extends Vt{constructor(){super(...arguments),this.shaderType="primitive-node"}}class Ut extends Vt{constructor(e){super(),this.child=e,this.shaderType="scope-node"}get children(){return[this.child]}clone(){const e=new Ut(Lt(this.child));return this.cloneInto(e),e}}class qt extends Vt{constructor(e,t,r){super(),this.property=e,this.target=t,this.returnType=r,this.shaderType="property-access-node"}get children(){const e=[this.target];return"string"!=typeof this.property&&e.push(this.property),e}clone(){const e=new qt(this.property,Lt(this.target),this.returnType);return this.cloneInto(e),e}}class Wt extends Vt{constructor(e,t,r){super(),this.condition=e,this.ifTrue=t,this.ifFalse=r,this.shaderType="condition-node"}get children(){return[this.condition,this.ifTrue,this.ifFalse]}clone(){const e=Lt(this.ifTrue),t=this.ifFalse?Lt(this.ifFalse):null,r=new Wt(this.condition,e,t);return this.cloneInto(r),r}}class Zt extends Vt{constructor(e,t,r,s){super(),this.captureList=e,this.returnType=t,this.generator=s,this.shaderType="block-node",r&&(this.subgraph=new Ut(r))}get children(){return Object.keys(this.captureList).map((e=>this.captureList[e])).concat(this.subgraph??[])}clone(){const e={};for(const r in this.captureList)e[r]=Lt(this.captureList[r]);const t=new Zt(e,this.returnType,this.subgraph?Lt(this.subgraph.child):this.subgraph,this.generator);return this.cloneInto(t),t}}class Yt extends Vt{constructor(e,t,r,s,i){let n=arguments.length>5&&void 0!==arguments[5]&&arguments[5];super(),this.token=e,this._children=t,this.isInfix=r,this.isPropertyAccess=s,this.returnType=i,this.isTernary=n,this.shaderType="function-node"}get children(){return this._children}clone(){const e=new Yt(this.token,this._children.map(Lt),this.isInfix,this.isPropertyAccess,this.returnType,this.isTernary);return this.cloneInto(e),e}}var jt,$t,Ht,Xt,Kt,Qt,Jt,er,tr,rr,sr,ir,nr,or;function ar(e){return new Proxy(e,{get(t,r){if("constructor"===r)return new Proxy(t.constructor,{construct:(e,t,r)=>ar(new e(...t))});if(r in t)return t[r];if("string"==typeof r){const t=function(e){const t=[["float","vec2","vec3","vec4"],["int","ivec2","ivec3","ivec4"],["uint","uvec2","uvec3","uvec4"],["bool","bvec2","bvec3","bvec4"]];for(const r of t)if(r.includes(e))return r.map((e=>Ar[e]));throw new Error("Unable to find type family")}(e.type);return Br(e,r,t[r.length-1])}}})}function cr(e){return new Proxy(e,{construct:(e,t,r)=>ar(new e(...t))})}class ur extends Error{}let lr=jt=class extends Gt{constructor(e,t){super(),this.elementType=e,this.size=t,this.children=[],this.type="array"}clone(){const e=new jt(this.elementType,this.size);return super.cloneInto(e),e}get(e){if("number"==typeof e){const t=new Tr(e);return t.isImplicit=!0,Br(this,t,this.elementType.constructor)}return Br(this,e,this.elementType.constructor)}last(){return this.get(this.size-1)}first(){return this.get(0)}findIndex(e,t,r){return function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.size;const i=new Tr(r).setMutable().setDebugName("FindIndexIterator"),n=t(e.get(i)).setDebugName("FindIndexPredicate"),o=Wr({iter:i},Tr,n,(e=>{let{out:t,iter:r,subgraph:i}=e;return`\n${t} = -1;\n\nfor (; ${r} < ${s}; ${r}++) {\n\n${i.body}\n\n  if (${i.varName}) {\n    ${t} = ${r};\n    break;\n  }\n\n}\n`})).setDebugName("FindIndexBlock");return o}(this,e,t,r)}glslFindIndex(e,t,r){return function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.size;const i=Wr({array:e},Tr,null,(e=>{let{out:i,array:n}=e;return`\n${i} = -1;\nfor (int i = ${r}; i < ${s}; i++) {\n  bool condition;\n  ${t({array:n,i:"i",out:"condition"})}\n  if (condition) {\n    ${i} = i;\n    break;\n  }\n}\n`})).setDebugName("GlslFindIndexBlock");return i}(this,e,t,r)}static ofType(e,t){const r={construct:(r,s)=>new jt(new e,t)};return new Proxy(jt,r)}};lr.type="array",lr=jt=(0,St._)([function(e){return new Proxy(e,{construct:(e,t,r)=>function(e){return new Proxy(e,{get(t,r){if(r in t)return t[r];if("string"==typeof r){const t=parseInt(r,10);if(!isNaN(t))return Br(e,`[${t}]`,e.elementType.constructor)}}})}(new e(...t))})}],lr);class hr extends Gt{constructor(){super(...arguments),this.type="sampler2D",this.children=[]}clone(){const e=new hr;return e.children=this.children.map(Lt),super.cloneInto(e),e}}hr.type="sampler2D";class dr extends Gt{constructor(e){super(),this.type="float",this.children=[e]}clone(){const e=new dr(Lt(this.children[0]));return super.cloneInto(e),e}multiply(e){return jr(this,"number"==typeof e?Ir(e,dr):e)}divide(e){return $r(this,"number"==typeof e?Ir(e,dr):e)}add(e){return Hr(this,"number"==typeof e?Ir(e,dr):e)}subtract(e){return Xr(this,"number"==typeof e?Ir(e,dr):e)}}dr.type="float";let pr=$t=class extends Gt{constructor(e,t){super(),this.type="vec2",this.children=[e,t].filter((e=>null!=e))}clone(){const e=new $t(Lt(this.children[0]),Lt(this.children[1]));return super.cloneInto(e),e}get 0(){return Br(this,"[0]",dr)}get 1(){return Br(this,"[1]",dr)}get 2(){throw new ur}get 3(){throw new ur}multiply(e){return jr(this,"number"==typeof e?Ir(e,dr):e)}divide(e){return $r(this,"number"==typeof e?Ir(e,dr):e)}add(e){return Hr(this,"number"==typeof e?Ir(e,dr):e)}subtract(e){return Xr(this,"number"==typeof e?Ir(e,dr):e)}};pr.type="vec2",pr=$t=(0,St._)([cr],pr);let fr=Ht=class extends Gt{constructor(e,t,r){super(),this.type="vec3",this.children=[e,t,r].filter((e=>null!=e))}get 0(){return Br(this,"[0]",dr)}get 1(){return Br(this,"[1]",dr)}get 2(){return Br(this,"[2]",dr)}get 3(){throw new ur}clone(){const e=new Ht(Lt(this.children[0]),Lt(this.children[1]),Lt(this.children[2]));return super.cloneInto(e),e}multiply(e){return jr(this,"number"==typeof e?Ir(e,dr):e)}divide(e){return $r(this,"number"==typeof e?Ir(e,dr):e)}add(e){return Hr(this,"number"==typeof e?Ir(e,dr):e)}subtract(e){return Xr(this,"number"==typeof e?Ir(e,dr):e)}};fr.type="vec3",fr=Ht=(0,St._)([cr],fr);let _r=Xt=class extends Gt{constructor(e,t,r,s){super(),this.type="vec4",this.children=[e,t,r,s].filter((e=>null!=e))}clone(){const e=new Xt(Lt(this.children[0]),Lt(this.children[1]),Lt(this.children[2]),Lt(this.children[3]));return super.cloneInto(e),e}get 0(){return Br(this,"[0]",dr)}get 1(){return Br(this,"[1]",dr)}get 2(){return Br(this,"[2]",dr)}get 3(){return Br(this,"[3]",dr)}multiply(e){return jr(this,"number"==typeof e?Ir(e,dr):e)}divide(e){return $r(this,"number"==typeof e?Ir(e,dr):e)}add(e){return Hr(this,"number"==typeof e?Ir(e,dr):e)}subtract(e){return Xr(this,"number"==typeof e?Ir(e,dr):e)}};_r.type="vec4",_r=Xt=(0,St._)([cr],_r);let yr=Kt=class extends Gt{constructor(e){super(),this.type="uint",this.children=[e]}clone(){const e=new Kt(Lt(this.children[0]));return super.cloneInto(e),e}};yr.type="uint",yr=Kt=(0,St._)([cr],yr);let mr=Qt=class extends Gt{constructor(e,t){super(),this.type="uvec2",this.children=[e,t].filter((e=>null!=e))}clone(){const e=new Qt(Lt(this.children[0]),Lt(this.children[1]));return super.cloneInto(e),e}};mr.type="uvec2",mr=Qt=(0,St._)([cr],mr);let gr=Jt=class extends Gt{constructor(e,t,r){super(),this.type="uvec3",this.children=[e,t,r].filter((e=>null!=e))}clone(){const e=new Jt(Lt(this.children[0]),Lt(this.children[1]),Lt(this.children[2]));return super.cloneInto(e),e}};gr.type="uvec3",gr=Jt=(0,St._)([cr],gr);let xr=er=class extends Gt{constructor(e,t,r,s){super(),this.type="uvec4",this.children=[e,t,r,s].filter((e=>null!=e))}clone(){const e=new er(Lt(this.children[0]),Lt(this.children[1]),Lt(this.children[2]),Lt(this.children[3]));return super.cloneInto(e),e}};xr.type="uvec4",xr=er=(0,St._)([cr],xr);class br extends Gt{constructor(e){super(),this.type="bool",this.children=[e]}and(e){return rs(this,e)}or(e){return ts(this,e)}clone(){const e=new br(Lt(this.children[0]));return super.cloneInto(e),e}}br.type="bool";let vr=tr=class extends Gt{constructor(e,t){super(),this.type="bvec2",this.children=[e,t].filter((e=>null!=e))}all(){return ss(this)}any(){return is(this)}clone(){const e=new tr(Lt(this.children[0]),Lt(this.children[1]));return super.cloneInto(e),e}};vr.type="bvec2",vr=tr=(0,St._)([cr],vr);let wr=rr=class extends Gt{constructor(e,t,r){super(),this.type="bvec3",this.children=[e,t,r].filter((e=>null!=e))}all(){return ss(this)}any(){return is(this)}clone(){const e=new rr(Lt(this.children[0]),Lt(this.children[1]),Lt(this.children[2]));return super.cloneInto(e),e}};function Ir(e,t){return"number"==typeof e?new t(e):e}wr.type="bvec3",wr=rr=(0,St._)([cr],wr);let Sr=sr=class extends Gt{constructor(e,t,r,s){super(),this.type="bvec4",this.children=[e,t,r,s].filter((e=>null!=e))}all(){return ss(this)}any(){return is(this)}clone(){const e=new sr(Lt(this.children[0]),Lt(this.children[1]),Lt(this.children[2]),Lt(this.children[3]));return super.cloneInto(e),e}};Sr.type="bvec4",Sr=sr=(0,St._)([cr],Sr);class Tr extends Gt{constructor(e){super(),this.type="int",this.children=[e]}multiply(e){return jr(this,Ir(e,Tr))}add(e){return Hr(this,Ir(e,Tr))}subtract(e){return Xr(this,Ir(e,Tr))}divide(e){return $r(this,Ir(e,Tr))}clone(){const e=new Tr(Lt(this.children[0]));return super.cloneInto(e),e}}Tr.type="int";let Mr=ir=class extends Gt{constructor(e,t){super(),this.type="ivec2",this.children=[e,t].filter((e=>null!=e))}clone(){const e=new ir(Lt(this.children[0]),Lt(this.children[1]));return super.cloneInto(e),e}};Mr.type="ivec2",Mr=ir=(0,St._)([cr],Mr);let kr=nr=class extends Gt{constructor(e,t,r){super(),this.type="ivec3",this.children=[e,t,r].filter((e=>null!=e))}clone(){const e=new nr(Lt(this.children[0]),Lt(this.children[1]),Lt(this.children[2]));return super.cloneInto(e),e}};kr.type="ivec3",kr=nr=(0,St._)([cr],kr);let Fr=or=class extends Gt{constructor(e,t,r,s){super(),this.type="ivec4",this.children=[e,t,r,s].filter((e=>null!=e))}clone(){const e=new or(Lt(this.children[0]),Lt(this.children[1]),Lt(this.children[2]),Lt(this.children[3]));return super.cloneInto(e),e}};Fr.type="ivec4",Fr=or=(0,St._)([cr],Fr);class Er extends Gt{constructor(e,t,r,s){super(),this.type="mat2",this.children=[e,t,r,s]}clone(){const e=new Er(Lt(this.children[0]),Lt(this.children[1]),Lt(this.children[2]),Lt(this.children[3]));return super.cloneInto(e),e}}Er.type="mat2";class Cr extends Gt{static identity(){return new Cr(1,0,0,0,1,0,0,0,1)}static fromRotation(e){const t=_s(e),r=os(e);return new Cr(r,t,0,qr(t),r,0,0,0,1)}constructor(e,t,r,s,i,n,o,a,c){super(),this.type="mat3",this.children=[e,t,r,s,i,n,o,a,c]}add(e){return Hr(this,e)}multiply(e){return jr(this,e)}clone(){const e=new Cr(Lt(this.children[0]),Lt(this.children[1]),Lt(this.children[2]),Lt(this.children[3]),Lt(this.children[4]),Lt(this.children[5]),Lt(this.children[6]),Lt(this.children[7]),Lt(this.children[8]));return super.cloneInto(e),e}}Cr.type="mat3";class Pr extends Gt{static identity(){return new Pr(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}constructor(e,t,r,s,i,n,o,a,c,u,l,h,d,p,f,_){super(),this.type="mat4",this.children=[e,t,r,s,i,n,o,a,c,u,l,h,d,p,f,_]}static fromColumns(e,t,r,s){return new Pr(e.x,e.y,e.z,e.w,t.x,t.y,t.z,t.w,r.x,r.y,r.z,r.w,s.x,s.y,s.z,s.w)}multiply(e){return jr(this,e)}clone(){const e=new Pr(Lt(this.children[0]),Lt(this.children[1]),Lt(this.children[2]),Lt(this.children[3]),Lt(this.children[4]),Lt(this.children[5]),Lt(this.children[6]),Lt(this.children[7]),Lt(this.children[8]),Lt(this.children[9]),Lt(this.children[10]),Lt(this.children[11]),Lt(this.children[12]),Lt(this.children[13]),Lt(this.children[14]),Lt(this.children[15]));return super.cloneInto(e),e}}Pr.type="mat4";const Ar={float:dr,vec2:pr,vec3:fr,vec4:_r,int:Tr,ivec2:Mr,ivec3:kr,ivec4:Fr,uint:yr,uvec2:mr,uvec3:gr,uvec4:xr,bool:br,bvec2:vr,bvec3:wr,bvec4:Sr},Rr=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new Tr(...t)},Or=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new dr(...t)},zr=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new pr(...t)},Dr=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new _r(...t)},Nr=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new Cr(...t)};function Br(e,t,r){const s=new r(new qt(t,e,r));return s.isImplicit=!0,s}function Vr(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(s){const i=new s,n=new s(new Yt(e,[t,r],!0,!1,i));return n.isImplicit=!0,n}if("float"===t.type||"int"===t.type){const s=new r.constructor(new Yt(e,[t,r],!0,!1,r.constructor));return s.isImplicit=!0,s}if(("mat2"===t.type||"mat3"===t.type||"mat4"===t.type)&&"float"!==r.type){const s=new r.constructor(new Yt(e,[t,r],!0,!1,r.constructor));return s.isImplicit=!0,s}const i=new t.constructor(new Yt(e,[t,r],!0,!1,t.constructor));return i.isImplicit=!0,i}function Lr(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.constructor;const s=new r(new Yt(e,[t],!1,!1,r));return s.isImplicit=!0,s}function Gr(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.constructor;const i=new s(new Yt(e,[t,r],!1,!1,s));return i.isImplicit=!0,i}function Ur(e,t,r,s){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:t.constructor;const n=new i(new Yt(e,[t,r,s],!1,!1,i));return n.isImplicit=!0,n}function qr(e){return jr(e,Or(-1))}function Wr(e,t,r,s){return new t(new Zt(e,t,r,s))}function Zr(e,t,r){const s="function"==typeof t?t():t,i="function"==typeof r?r():r,n=new s.constructor(new Wt(e,s,i));return n.isImplicit=!0,n}function Yr(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];const s=t.map((e=>{let[t,r]=e;return"function"==typeof r?[t,r()]:[t,r]})),i=s[0][1].constructor,n=s.findIndex((e=>!0===e[0]));if(-1===n)throw new Error("A cond must have a fallthrough case with `true`/; ");const o=s.slice(0,n),a=s[n][1],c=new i(o.reduceRight(((e,t)=>Zr(t[0],t[1],e)),a));return c.isImplicit=!0,c}function jr(e,t){return Vr("*",e,t)}function $r(e,t){return Vr("/",e,t)}function Hr(e,t){return Vr("+",e,t)}function Xr(e,t){return Vr("-",e,t)}function Kr(e,t){return Vr("==",e,t,br)}function Qr(e,t){return Vr("<=",e,t,br)}function Jr(e,t){return Vr(">",e,t,br)}function es(e,t){return Vr(">=",e,t,br)}function ts(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.length<=1?t[0]:t.slice(1).reduce(((e,t)=>function(e,t){return Vr("||",e,t,br)}(e,t)),t[0])}function rs(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.length<=1?t[0]:t.slice(1).reduce(((e,t)=>function(e,t){return Vr("&&",e,t,br)}(e,t)),t[0])}function ss(e){return Lr("all",e,br)}function is(e){return Lr("any",e,br)}function ns(e,t,r){return Ur("clamp",e,t,r,e.constructor)}function os(e){return Lr("cos",e)}function as(e,t){return Gr("dot",e,t,dr)}function cs(e){return Lr("fract",e)}function us(e){return Lr("length",e,dr)}function ls(e,t){return Gr("max",e,t)}function hs(e,t){return Gr("min",e,t)}function ds(e,t,r){return Ur("mix",e,t,r)}function ps(e,t){return Gr("mod",e,t)}function fs(e){return"bool"===e.type?Lr("!",e):Lr("not",e)}function _s(e){return Lr("sin",e)}function ys(e,t){return Gr("step",e,t,t.constructor)}function ms(e,t){return Gr("texture2D",e,t,_r)}function gs(e,t,r){const s=t.split("\n");for(const i of s)if(i.trim().length){{let t="";null!=r&&(t+=`/*id:${r??"000"}*/   `),e.body+=t.padEnd(14)}e.body+=" ".repeat(e.indent)+i+"\n"}}class xs{write(e){for(const t of e.rootOutputNodes())e.shouldPruneOutputNode(t)||(t.variableName=this._write(e,t.node));return e}_createVarName(e,t){let r="";return"boolean"!=typeof t&&"number"!=typeof t&&t.debugInfo.name&&(r=`${t.debugInfo.name}_`),`${r}v${e.varCount++}`}_write(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if("number"==typeof t)return t.toString();if("boolean"==typeof t)return t.toString();let s=e.getEmit(t);if(s)return s;switch(t.shaderType){case"scope-node":s=this._writeScopeNode(e,t);break;case"primitive-node":s=this._writePrimitveNode(e,t,r);break;case"function-node":s=this._writeFunctionNode(e,t);break;case"property-access-node":s=this._writePropertyAccessNode(e,t);break;case"text-node":s=t.text;break;case"block-node":s=this._writeBlockNode(e,t);break;case"condition-node":s=this._writeConditionNode(e,t)}return e.setEmit(t,s),s}_writeScopeNode(e,t){const r=new t.child.constructor;r.setDebugName(t.debugInfo.name);const s=this._write(e,r,!0);return gs(e,`{ /*ScopeStart: ${t.uid} ${t.debugInfo.name}*/`),e.indent+=2,gs(e,`${s} = ${this._write(e,t.child)};`),e.indent-=2,gs(e,`} /*ScopeEnd: ${t.uid} ${t.debugInfo.name}*/`),s}_writeConditionNode(e,t){const r=new t.ifTrue.constructor,s=this._write(e,r,!0);gs(e,`if (${this._write(e,t.condition)}) {`),e.indent+=2;const i=e.createSubgraphContext(),n=this._write(i,t.ifTrue);if(e.body+=i.body,n&&gs(e,`${s} = ${n};`),e.indent-=2,gs(e,"}"),t.ifFalse){gs(e,"else {"),e.indent+=2;const r=e.createSubgraphContext(),i=this._write(r,t.ifFalse);e.body+=r.body,i&&gs(e,`${s} = ${i};`),e.indent-=2,gs(e,"}")}return s}_writeBlockNode(e,t){const{captureList:r,generator:s,returnType:i}=t,n={};for(const u in r){if(!r[u])continue;const t=this._write(e,r[u]);n[u]=t}const o=new i,a=this._write(e,o,!0);if(n.out=a,t.subgraph){const r=e.createSubgraphContext(),s=this._write(r,t.subgraph.child),i=r.body;n.subgraph={varName:s,body:i}}const c=s(n);return gs(e,"{\n"),e.indent+=2,gs(e,c),e.indent-=2,gs(e,"}\n"),a}_writePropertyAccessNode(e,t){const r=this._write(e,t.target);return"string"==typeof t.property&&t.property.includes("[")?`${r}${t.property}`:"string"!=typeof t.property?`${r}[${this._write(e,t.property)}]`:`${r}.${t.property}`}_writeFunctionNode(e,t){const r=t.returnType.type;if(t.isInfix){const[s,i]=t.children.map((t=>this._write(e,t))),n=this._createVarName(e,t);return gs(e,`${r.padEnd(5)} ${n} = ${s} ${t.token} ${i};`,t.uid),n}const s=t.children.map((t=>this._write(e,t))).join(", "),i=this._createVarName(e,t);return gs(e,`${r.padEnd(5)} ${i} = ${t.token}(${s});`,t.uid),i}_writePrimitveNode(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const s=e.getInput(t);if(s)return s.isUsed=!0,s.variableName;const i=1===t.children.length&&t.children[0]?.type===t.type;if(t.isImplicit||i)return this._write(e,t.children[0]);const n=this._createVarName(e,t);if(r)return gs(e,`${t.type.padEnd(5)} ${n};`,t.uid),n;const o=!t.debugInfo.name&&!t.isMutable;if(o&&"float"===t.type&&"number"==typeof t.children[0])return Number.isInteger(t.children[0])?t.children[0].toFixed(1):t.children[0].toString();if(o&&"int"===t.type&&"number"==typeof t.children[0]&&Number.isInteger(t.children[0]))return t.children[0].toString();const a=t.children.map((t=>this._write(e,t))).join(", ");return"array"===t.type?(gs(e,`${t.type.padEnd(5)} ${n} = [${a}];`,t.uid),n):o?`${t.type}(${a})`:(gs(e,`${t.type.padEnd(5)} ${n} = ${t.type}(${a});`,t.uid),n)}}class bs{constructor(e,t,r){this.variableName=e,this.variableInputType=t,this.node=r,this.type="shader-input",this.isUsed=!1}clone(){return new bs(this.variableName,this.variableInputType,Lt(this.node))}}class vs{constructor(e,t,r){this.outVariableName=e,this.outVariableType=t,this.node=r,this.type="shader-output"}clone(){const e=new vs(this.outVariableName,this.outVariableType,Lt(this.node));return e.variableName=this.variableName,e}}class ws{static createVertex(e,t,r,s,i,n){const o=[];for(const c in e){const t=e[c],s=r.get(c);s?o.push(new bs(s,"builtin",t)):o.push(new bs("a_"+c,"attribute",t))}for(const c of s){const e=c.uniformHydrated;o.push(new bs(c.uniformName,"uniform",e))}const a=[];for(const c in t){const e=t[c];"glPosition"===c?a.push(new vs("gl_Position","builtin",e)):"glPointSize"===c?a.push(new vs("gl_PointSize","builtin",e)):a.push(new vs("v_"+c,"varying",e))}return new ws(o,a,i,n)}static createFragment(e,t,r,s,i,n){const o=[],a=Array.from(i.rootOutputNodes());for(const u in e){const t=e[u],s=r.get(u);if(s){o.push(new bs(s,"builtin",t));continue}const i=a.find((e=>e.node===t));i&&o.push(new bs(i.outVariableName,i.outVariableType,t))}for(const u of s){const e=u.uniformHydrated;o.push(new bs(u.uniformName,"uniform",e))}const c=[];for(const u in t){const e=t[u],s=r.get(u);if("discard"===u)c.push(new vs(null,"discard",e));else{if(!s)throw new Error(`Member ${u} in shader fragment output shoule be tagged as builtin`);c.push(new vs(s,"builtin",e))}}return new ws(o,c,n)}constructor(e,t,r,s){this.type="shader-graph-context",this.indent=0,this.body="",this.varCount=0,this._inputShaderTypesByNodeUid=new Map,this._nodeEmitMap=new Map;for(const i of e)this._inputShaderTypesByNodeUid.set(i.node.uid,i);this._outputShaderTypes=t,this._transformFeedbackBindings=r,this._transformFeedbackNames=new Set(r.map((e=>"v_"+e.propertyKey))),this._usedInFragmentShader=s}shouldPruneOutputNode(e){return!!this._usedInFragmentShader&&"builtin"!==e.outVariableType&&!this._transformFeedbackNames.has(e.outVariableName)&&!this._usedInFragmentShader.has(e.node.uid)}setEmit(e,t){this._nodeEmitMap.set(e.uid,t)}getEmit(e){return this._nodeEmitMap.get(e.uid)}inputs(){return this._inputShaderTypesByNodeUid.values()}getInput(e){return this._inputShaderTypesByNodeUid.get(e.uid)}*rootOutputNodes(){for(const e of this._outputShaderTypes)yield e}*nodes(){const e=[];for(const t of this._outputShaderTypes.values())e.push(t.node);for(;e.length;){const t=e.pop();"number"!=typeof t&&"boolean"!=typeof t&&e.push(...t.children.filter(Boolean)),yield t}}*nodesOfTypeOrFunction(){for(const e of this.nodes())"number"!=typeof e&&"boolean"!=typeof e&&(yield e)}createSubgraphContext(){const e=this.clone();return e.body="",e.indent=this.indent+2,e._nodeEmitMap=new Map(this._nodeEmitMap),e}clone(){const e=new ws([],this._outputShaderTypes,this._transformFeedbackBindings,this._usedInFragmentShader);return e._inputShaderTypesByNodeUid=this._inputShaderTypesByNodeUid,e.indent=this.indent,e.body=this.body,e.varCount=this.varCount,e._nodeEmitMap=this._nodeEmitMap,e}insertVertexShader(e){e.vertex.code.add(""),this._insertInputs(e,"vertex"),e.vertex.code.add(""),e.vertex.code.add("// OUTPUTS: "),e.vertex.code.add("// --------------------------------------------------------- ");for(const t of this.rootOutputNodes()){const r="builtin"===t.outVariableType;this.shouldPruneOutputNode(t)||(r?e.vertex.code.add(`// ${t.outVariableType.padEnd(7)} ${t.node.type.padEnd(9)} ${t.outVariableName};`):e.vertex.code.add(`${t.outVariableType.padEnd(10)} ${t.node.type.padEnd(9)} ${t.outVariableName};`))}e.vertex.code.add(""),e.vertex.code.add("void main() {"),e.vertex.code.add("  "+this.body.split("\n").join("\n  "));for(const t of this.rootOutputNodes())this.shouldPruneOutputNode(t)||e.vertex.code.add(`  ${t.outVariableName} = ${t.variableName};`);e.vertex.code.add("}")}insertFragmentShader(e){this._insertInputs(e,"fragment"),e.fragment.code.add(""),e.fragment.code.add("void main() {"),e.fragment.code.add("  "+this.body.split("\n").join("\n  "));for(const t of this.rootOutputNodes())"discard"===t.outVariableType?(e.fragment.code.add("  // TODO: Should ensure codegen for discard appears first in fragment shader"),e.fragment.code.add(`  if (${t.variableName}) {`),e.fragment.code.add("    discard;"),e.fragment.code.add("  }"),e.fragment.code.add("  ")):e.fragment.code.add(`  ${t.outVariableName} = ${t.variableName};`);e.fragment.code.add("}")}_insertInputs(e,t){e[t].code.add("// INPUTS: "),e[t].code.add("// --------------------------------------------------------- ");for(const r of this.inputs())r.isUsed&&"builtin"!==r.variableInputType&&("array"===r.node.type?e[t].code.add(`${r.variableInputType.padEnd(10)} ${r.node.elementType.type.padEnd(9)} ${r.variableName}[${r.node.size}];`):e[t].code.add(`${r.variableInputType.padEnd(10)} ${r.node.type.padEnd(9)} ${r.variableName};`))}}var Is=r(18202),Ss=(r(37825),r(53634),r(47428)),Ts=(r(46888),r(57808)),Ms=(r(3667),r(39769),r(52311));const ks=()=>R.Z.getLogger("esri.views.2d.engine.webgl.Utils");new Map;function Fs(e,t,r){const s=new Ms.X(t.width,t.height);return s.dataType=t.dataType,t.depth&&(s.depth=t.depth),t.flipped&&(s.flipped=t.flipped),t.hasMipmap&&(s.hasMipmap=t.hasMipmap),s.internalFormat=t.internalFormat,t.isImmutable&&(s.isImmutable=t.isImmutable),t.isOpaque&&(s.isOpaque=t.isOpaque),t.maxAnisotropy&&(s.maxAnisotropy=t.maxAnisotropy),s.pixelFormat=t.pixelFormat,t.preMultiplyAlpha&&(s.preMultiplyAlpha=t.preMultiplyAlpha),t.samplingMode&&(s.samplingMode=t.samplingMode),t.target&&(s.target=t.target),s.uniform=t.uniform,t.unpackAlignment&&(s.unpackAlignment=t.unpackAlignment),t.wrapMode&&(s.wrapMode=t.wrapMode),new Ts.x(e,s,r)}function Es(e,t,r){const i=t.length;if(i!==r){const n=new s.Z("Invalid Uniform",`Invalid length, expected ${r} but got ${i}`,{uniformName:e,values:t});R.Z.getLogger("esri.views.2d.engine.webgl.shaderGraph.typed.TypedShaderProgram").errorOnce(n)}}class Cs{constructor(e,t,r,s,i,n){this._program=null,this._vao=null,this._temporaryTextures=[],this.vertexShader=e,this.fragmentShader=t,this._locations=r,this._locationInfo=s,this._uniformBindings=i,this._transformFeedbackBindings=n}destroy(){this._program&&this._program.dispose(),this.cleanupTemporaryTextures()}get locations(){return this._locations}get locationInfo(){return this._locationInfo}setUniforms(e){this._uniforms=e}cleanupTemporaryTextures(){for(const e of this._temporaryTextures)e.dispose();this._temporaryTextures=[]}bind(e){const t=this._uniforms;if(!this._program){const t=new Map;for(const[e,s]of this._locations)t.set(e,s);const r=[];for(const e of this._transformFeedbackBindings??[]){const{index:t,propertyKey:s}=e;r[t]=`v_${s}`}this._program=new Ss.$(e,this.vertexShader,this.fragmentShader,t,new Map,r)}const r=this._program;e.useProgram(r);for(const s of this._uniformBindings){const{shaderModulePath:i,uniformName:n,uniformType:o,uniformArrayLength:a}=s,c=(0,Is.hS)(i,t);if(null==c){if("sampler2D"===o)continue;throw new Error(`Failed to find uniform value for ${i}`)}switch("array"===o?s.uniformArrayElementType:o){case"sampler2D":{const{unit:t,texture:s}=c;if(r.setUniform1i(n,t),"type"in s)e.bindTexture(s,t);else{const r=Fs(e,s.descriptor,s.data);e.bindTexture(r,t)}break}case"int":if(!a){r.setUniform1i(n,c);break}Es(s.uniformName,c,a),r.setUniform1iv(n,c);break;case"float":if(!a){r.setUniform1f(n,c);break}Es(s.uniformName,c,a),r.setUniform1fv(n,c);break;case"vec2":if(!a){r.setUniform2f(n,c[0],c[1]);break}Es(s.uniformName,c,a),r.setUniform2fv(n,c.flat());break;case"vec3":if(!a){r.setUniform3f(n,c[0],c[1],c[2]);break}Es(s.uniformName,c,a),r.setUniform3fv(n,c.flat());break;case"vec4":if(!a){r.setUniform4f(n,c[0],c[1],c[2],c[3]);break}Es(s.uniformName,c,a),r.setUniform4fv(n,c.flat());break;case"mat3":r.setUniformMatrix3fv(n,c.flat());break;case"mat4":r.setUniformMatrix4fv(n,c.flat());break;default:throw new Error(`Unable to set uniform for type ${o}`)}}}}function Ps(e){return new e}function As(e,t,r){const s=e.constructor[t]??[];e.constructor.hasOwnProperty(t)||Object.defineProperty(e.constructor,t,{value:s.slice()}),e.constructor[t].push(r)}function Rs(e,t){return(r,s)=>{As(r,"locations",{typeCtor:t,propertyKey:s,parameterIndex:null,index:e})}}const Os=e=>(t,r,s)=>{As(t,"inputs",{inputCtor:e,propertyKey:r,parameterIndex:s})},zs=e=>(t,r)=>{As(t,"uniforms",{typeCtor:e,propertyKey:r})},Ds=e=>(t,r)=>{As(t,"options",{typeCtor:e,propertyKey:r})},Ns=(e,t)=>{As(e,"defines",{propertyKey:t})};const Bs=(e,t)=>(r,s)=>{r.constructor.builtins.push({builtin:e,propertyKey:s,typeCtor:t})};class Vs{}Vs.builtins=[],(0,St._)([Bs("gl_VertexID",Tr)],Vs.prototype,"glVertexID",void 0);class Ls{}class Gs{}Gs.builtins=[],(0,St._)([Bs("gl_FragCoord",_r)],Gs.prototype,"glFragCoord",void 0),(0,St._)([Bs("gl_PointCoord",pr)],Gs.prototype,"glPointCoord",void 0);class Us{}(0,St._)([(e=>(t,r)=>{As(t,"builtins",{builtin:e,propertyKey:r})})("gl_FragColor")],Us.prototype,"glFragColor",void 0);class qs{constructor(){this.type="uniform-group"}get _uniforms(){return this.constructor.uniforms??[]}}class Ws{constructor(){this.logShader=!1,this.computeAttributes={}}get vertexInput(){const e=(0,P.dF)(this._shaderModuleClass.inputs,(e=>"vertex"===e.propertyKey&&0===e.parameterIndex));if(!e)throw new Error("Unable to find vertex input parameter");return e}get computeInput(){return(0,P.dF)(this._shaderModuleClass.inputs,(e=>"vertex"===e.propertyKey&&1===e.parameterIndex))}get fragmentInput(){const e=(0,P.dF)(this._shaderModuleClass.inputs,(e=>"fragment"===e.propertyKey));if(!e)throw new Error("Unable to find fragment input parameter");return e}get transformFeedbackBindings(){return this.fragmentInput.inputCtor.transformFeedbackBindings??[]}get locations(){return[...this.vertexInput.inputCtor.locations,...this.computeInput?.inputCtor.locations??[]]}get locationsMap(){const e=new Map,t=new Set;for(const r of this.locations)t.has(r.index)?R.Z.getLogger("esri.views.2d.engine.webgl.shaderGraph.GraphShaderModule").warnOnce("mapview-rendering",`Unable to assigned attribute ${r.propertyKey} to ${r.index}. Index already in use`,{locationsMap:e}):(e.set(r.propertyKey,r.index),t.add(r.index));return e}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map((e=>{let[t,r]=e;return`${t}.${r}`})).join("."),r=(0,O.hP)(t);this._locationInfo={hash:r,locations:e}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const t of this.locations)e.set("a_"+t.propertyKey,t.index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set;for(const t of this._options)e.add(t.propertyKey);this._optionPropertyKeys=e}return this._optionPropertyKeys}get _shaderModuleClass(){return this.constructor}get _defines(){return this._shaderModuleClass.defines??[]}get _options(){return this._shaderModuleClass.options??[]}get _uniforms(){return this._shaderModuleClass.uniforms??[]}getProgram(e,t,r,s){try{const{vertex:i,fragment:n,uniformBindings:o}=this._generateShaders(e,t,r,s);return new Cs(i,n,this.renamedLocationsMap,this.locationInfo,o,this.transformFeedbackBindings)}catch(i){return console.error("Failed to create program",{error:i}),new Cs("","",this.renamedLocationsMap,this.locationInfo,[],this.transformFeedbackBindings)}}getDebugUniformClassInfo(e){const t=this._options.find((t=>t.propertyKey===e));if(t)return{type:"option",className:t.typeCtor};const r=this._uniforms.find((t=>t.propertyKey===e));if(!r)throw new Error(`Unable to find uniform class type for property: ${e}`);return{type:"required",className:r.typeCtor}}getShaderKey(e,t,r,s){const i=Object.keys(r).map((e=>`${e}.${r[e]}`)).join("."),n=Object.keys(s).map((e=>`${e}.${s[e]}`)).join("."),o=Object.keys(t).filter((e=>this.optionPropertyKeys.has(e)&&t[e])).join(".");return`${this.constructor.name}.${e.hash}.${i}.${n}.${o}`}_generateShaders(e,t,r,s){const i=[];this._setDefines(r),this._setOptionalUniforms(i,t),this._setRequiredUniforms(i);const n=this._hydrateVertexInput(s),o=this._injectPackPrecisionFactor(n,e),a=this._hydrateComputeInput(),c=a&&this._injectPackPrecisionFactor(a,e),u=this.vertex(o,c),l=this._hydrateFragmentInput(u),h=this.fragment(l),d=new Set;for(const b in h){Bt(d,h[b])}const p=this._getVertexInputBuiltins(),f=ws.createVertex({...n,...a},u,p,i,this.transformFeedbackBindings,d);(new xs).write(f);const _=this._getFragmentInputBuiltins(h);_.set("glPointCoord","gl_PointCoord");const y=ws.createFragment(l,h,_,i,f,this.transformFeedbackBindings);(new xs).write(y);const m=this._createShaderBuilder(f,y),g=m.generate("vertex",!1),x=m.generate("fragment",!1);return this.logShader&&(console.log(g),console.log(x)),{vertex:g,fragment:x,uniformBindings:i}}_setDefines(e){for(const t in e)this[t]=e[t]}_setOptionalUniforms(e,t){for(const r of this._options)t[r.propertyKey]?this[r.propertyKey]=this._hydrateUniformGroup(e,r):this[r.propertyKey]=null}_setRequiredUniforms(e){for(const t of this._uniforms)this[t.propertyKey]=this._hydrateUniformGroup(e,t)}_hydrateUniformGroup(e,t){const r=new(0,t.typeCtor);for(const s of r._uniforms??[]){const i=Ps(s.typeCtor),n=`u_${t.propertyKey}_${s.propertyKey}`,o=i.type,a=[t.propertyKey,s.propertyKey].join(".");if("type"in s.typeCtor&&"array"===s.typeCtor.type){const t=i;e.push({shaderModulePath:a,uniformName:n,uniformType:o,uniformArrayLength:t.size,uniformArrayElementType:t.elementType.type,uniformHydrated:i})}else e.push({shaderModulePath:a,uniformName:n,uniformType:o,uniformHydrated:i});r[s.propertyKey]=i}return r}_hydrateVertexInput(e){const t=this.vertexInput.inputCtor,r=t.locations.reduce(((t,r)=>!1===e[r.propertyKey]?t:{...t,[r.propertyKey]:Ps(r.typeCtor)}),{});for(const{propertyKey:s,typeCtor:i}of t.builtins){const e=Ps(i);r[s]=e}return r}_hydrateComputeInput(){return null==this.computeInput?null:this.computeInput.inputCtor.locations.reduce(((e,t)=>({...e,[t.propertyKey]:Ps(t.typeCtor)})),{})}_injectPackPrecisionFactor(e,t){const r={};for(const s in e){const i=e[s],n=t.attributes.find((e=>e.name===s));if(n?.packPrecisionFactor){if("float"!==i.type&&"vec2"!==i.type&&"vec3"!==i.type&&"vec4"!==i.type)throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${i.type}`);r[s]=i.divide(new dr(n.packPrecisionFactor))}else r[s]=i}return r}_hydrateFragmentInput(e){const t={};for(const r in e)t[r]=e[r];for(const{propertyKey:r,typeCtor:s}of Gs.builtins){const e=Ps(s);t[r]=e}return t}_getVertexInputBuiltins(){const e=this.vertexInput.inputCtor,t=new Map;for(const{builtin:r,propertyKey:s}of e.builtins)t.set(s,r);return t}_getFragmentInputBuiltins(e){const t=e.constructor,r=new Map;for(const s of t.builtins??[])r.set(s.propertyKey,s.builtin);return r}_createShaderBuilder(e,t){const r=new Et;return this._insertDebugInfo(r),e.insertVertexShader(r),t.insertFragmentShader(r),r}_insertDebugInfo(e){e.vertex.code.add("// DEFINES: "),e.vertex.code.add("// --------------------------------------------------------- ");for(const t of this._defines)this[t.propertyKey]?e.vertex.code.add(`//   ${t.propertyKey}: true`):e.vertex.code.add(`//   ${t.propertyKey}: false`);e.vertex.code.add(""),e.vertex.code.add("// OPTIONS: "),e.vertex.code.add("// --------------------------------------------------------- ");for(const t of this._options)this[t.propertyKey]?e.vertex.code.add(`//   ${t.propertyKey}: true`):e.vertex.code.add(`//   ${t.propertyKey}: false`)}}var Zs=r(7138),Ys=r(49861),js=r(69912);let $s=class extends Zs.Z{constructor(){super(...arguments),this.color=new We.Z([0,255,255]),this.haloOpacity=1,this.fillOpacity=.25,this.multiHighlightEnabled=!1}equals(e){return this.color.equals(e.color)&&(this.haloColor||this.color).equals(e.haloColor||e.color)&&this.haloOpacity===e.haloOpacity&&this.fillOpacity===e.fillOpacity&&this.multiHighlightEnabled===e.multiHighlightEnabled}};(0,St._)([(0,Ys.Cb)({type:We.Z})],$s.prototype,"color",void 0),(0,St._)([(0,Ys.Cb)({type:We.Z})],$s.prototype,"haloColor",void 0),(0,St._)([(0,Ys.Cb)()],$s.prototype,"haloOpacity",void 0),(0,St._)([(0,Ys.Cb)()],$s.prototype,"fillOpacity",void 0),(0,St._)([(0,Ys.Cb)()],$s.prototype,"multiHighlightEnabled",void 0),$s=(0,St._)([(0,js.j)("esri.views.2d.support.HighlightOptions")],$s);const Hs=$s,Xs={selection:e=>new Hs({color:new We.Z([e.color.r/2,e.color.g/2,e.color.b/2,e.color.a])}),highlight:e=>e,popup:e=>new Hs({color:new We.Z([e.color.g,e.color.b,e.color.r,e.color.a])})};const Ks=Object.keys(Xs);function Qs(e){const t=Or(12.9898),r=Or(78.233),s=Or(43758.5453);return cs(_s(ps(as(e,zr(t,r)),Or(3.14))).multiply(s))}function Js(e){return Kr(e,Or(ct))}function ei(e,t){const r=Or(2**t);return ps(function(e){return Lr("floor",e)}(e.divide(r)),Or(2))}function ti(e,t){return ei(e,t+Ks.length)}function ri(e){const t=ei(e.z,7),r=Or(1).subtract(t),s=e.xyz.subtract(function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new fr(...t)}(0,0,Or(128)));return r.multiply(e).add(t.multiply(s))}class si extends qs{getVisualVariableData(e){if(!this._vvData){const t=this.getAttributeDataCoords(e);this._vvData=ms(this.visualVariableData,t).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(e){if(!this._uv){const t=ri(e),r=this.size,s=Rr(t.x),i=Rr(t.y).multiply(Rr(256)),n=Rr(t.z).multiply(Rr(256)).multiply(Rr(256)),o=Or(s.add(i).add(n)),a=ps(o,r),c=o.subtract(a).divide(r);this._uv=new pr(a,c).add(.5).divide(r)}return this._uv}getFilterData(e){const t=this.getAttributeDataCoords(e);return ms(this.filterFlags,t).setDebugName("storage0")}getAnimationData(e){const t=this.getAttributeDataCoords(e);return ms(this.animation,t).setDebugName("storage1")}getVVData(e){return this.getVisualVariableData(e)}getDataDrivenData0(e){const t=this.getAttributeDataCoords(e);return ms(this.dataDriven0,t).setDebugName("storage30")}getDataDrivenData1(e){const t=this.getAttributeDataCoords(e);return ms(this.dataDriven1,t).setDebugName("storage31")}getDataDrivenData2(e){const t=this.getAttributeDataCoords(e);return ms(this.dataDriven2,t).setDebugName("storage32")}getGPGPUData(e){const t=this.getAttributeDataCoords(e);return ms(this.gpgpu,t).setDebugName("storage4")}getFilterFlags(e){return(0,n.Z)("webgl-ignores-sampler-precision")?function(e){return Lr("ceil",e)}(this.getFilterData(e).x.multiply(Or(255))):this.getFilterData(e).x.multiply(Or(255))}getAnimationValue(e){return this.getAnimationData(e).x}getSizeValue(e){return this.getVisualVariableData(e).x}getColorValue(e){return this.getVisualVariableData(e).y}getOpacityValue(e){return this.getVisualVariableData(e).z}getRotationValue(e){return this.getVisualVariableData(e).w}}(0,St._)([zs(hr)],si.prototype,"filterFlags",void 0),(0,St._)([zs(hr)],si.prototype,"animation",void 0),(0,St._)([zs(hr)],si.prototype,"gpgpu",void 0),(0,St._)([zs(hr)],si.prototype,"visualVariableData",void 0),(0,St._)([zs(hr)],si.prototype,"dataDriven0",void 0),(0,St._)([zs(hr)],si.prototype,"dataDriven1",void 0),(0,St._)([zs(hr)],si.prototype,"dataDriven2",void 0),(0,St._)([zs(dr)],si.prototype,"size",void 0);class ii extends qs{}(0,St._)([zs(dr)],ii.prototype,"activeReasons",void 0),(0,St._)([zs(dr)],ii.prototype,"highlightAll",void 0);class ni extends qs{}(0,St._)([zs(pr)],ni.prototype,"position",void 0),(0,St._)([zs(dr)],ni.prototype,"distance",void 0),(0,St._)([zs(dr)],ni.prototype,"smallSymbolDistance",void 0),(0,St._)([zs(dr)],ni.prototype,"smallSymbolSizeThreshold",void 0);class oi extends qs{}(0,St._)([zs(Cr)],oi.prototype,"displayViewScreenMat3",void 0),(0,St._)([zs(Cr)],oi.prototype,"displayViewMat3",void 0),(0,St._)([zs(Cr)],oi.prototype,"displayMat3",void 0),(0,St._)([zs(Cr)],oi.prototype,"viewMat3",void 0),(0,St._)([zs(Cr)],oi.prototype,"tileMat3",void 0),(0,St._)([zs(dr)],oi.prototype,"displayZoomFactor",void 0),(0,St._)([zs(dr)],oi.prototype,"requiredZoomFactor",void 0),(0,St._)([zs(pr)],oi.prototype,"tileOffset",void 0),(0,St._)([zs(dr)],oi.prototype,"currentScale",void 0),(0,St._)([zs(dr)],oi.prototype,"currentZoom",void 0),(0,St._)([zs(dr)],oi.prototype,"metersPerSRUnit",void 0),(0,St._)([zs(dr)],oi.prototype,"rotation",void 0),(0,St._)([zs(dr)],oi.prototype,"pixelRatio",void 0);class ai extends Vs{}(0,St._)([Rs(0,fr)],ai.prototype,"id",void 0),(0,St._)([Rs(1,dr)],ai.prototype,"bitset",void 0),(0,St._)([Rs(2,pr)],ai.prototype,"pos",void 0);class ci extends Ls{}(0,St._)([Rs(14,pr)],ci.prototype,"nextPos1",void 0),(0,St._)([Rs(15,pr)],ci.prototype,"nextPos2",void 0);class ui extends Gs{}class li extends Ws{clip(e,t){let r=new dr(0);const s=this.storage.getFilterFlags(e);if(r=r.add(Or(2).multiply(Or(1).subtract(ti(s,0)))),this.inside?r=r.add(Or(2).multiply(Or(1).subtract(ti(s,1)))):this.outside?r=r.add(Or(2).multiply(ti(s,1))):this.highlight&&(r=r.add(Or(2).multiply(Or(1).subtract(this._checkHighlight(s))))),null!=t){const e=new dr(1).subtract(ys(t.x,this.view.currentZoom)),s=ys(t.y,this.view.currentZoom);r=r.add(new dr(2).multiply(e.add(s)))}return r}getFragmentOutput(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new dr(1/255);const s=new Us;return s.glFragColor=this._maybeWriteHittest(t)??this._maybeHighlight(e,r)??e,s}_maybeHighlight(e,t){return this.highlight?new _r(e.rgb,ys(t,e.a)):null}_checkHighlight(e){let t=this._checkHighlightBit(e,0);for(let r=1;r<Ks.length;r++)t=t.add(this._checkHighlightBit(e,r));return ys(new dr(.1),t.add(this.highlight.highlightAll))}_checkHighlightBit(e,t){return function(e,t){return ei(e,t)}(e,t).multiply(ei(this.highlight.activeReasons,t))}maybeRunHittest(e,t,r){if(null==this.hittestRequest)return null;let s=Zr(Jr(this.hittest(e,t,r),this.hittestRequest.distance),new dr(2),new dr(0));const i=function(e){return e.multiply(2).subtract(1)}(this.storage.getAttributeDataCoords(e.id));s=s.add(this.clip(e.id,e.zoomRange));const n=new _r(new dr(1/255),0,0,0);return{glPointSize:new dr(1),glPosition:new _r(i,s,1),color:n}}_maybeWriteHittest(e){return null!=this.hittestRequest?e.color:null}}function hi(e,t){return as(e,function(e){return Lr("normalize",e)}(t))}function di(e,t,r){const s=r.subtract(t),i=ns(hi(e.subtract(t),s).divide(us(s)),new dr(0),new dr(1));return function(e,t){return Gr("distance",e,t,dr)}(e,t.add(i.multiply(r.subtract(t))))}function pi(e){const t=function(e){return Lr("abs",e)}(e);return ys(t.x.add(t.y).add(t.z),new dr(1.05))}function fi(e,t,r,s){return Kr(pi(function(e,t,r,s){const i=new Cr(r.x.multiply(s.y).subtract(s.x.multiply(r.y)),s.x.multiply(t.y).subtract(t.x.multiply(s.y)),t.x.multiply(r.y).subtract(r.x.multiply(t.y)),r.y.subtract(s.y),s.y.subtract(t.y),t.y.subtract(r.y),s.x.subtract(r.x),t.x.subtract(s.x),r.x.subtract(t.x)),n=t.x.multiply(r.y.subtract(s.y)),o=r.x.multiply(s.y.subtract(t.y)),a=s.x.multiply(t.y.subtract(r.y)),c=n.add(o).add(a);return new dr(1).divide(c).multiply(i.multiply(new fr(1,e)))}(e,t,r,s)),new dr(1))}function _i(e,t,r,s){const i=function(e,t){return e.x.multiply(t.y).subtract(t.x.multiply(e.y))}(r.subtract(t),s.subtract(t)),n=rs(function(e,t){return Vr("<",e,t,br)}(i,new dr(at)),Jr(i,new dr(-at)));return Yr([rs(fs(n),fi(e.xy,t,r,s)),new dr(-1)],[!0,()=>{const i=di(e,t,r),n=di(e,r,s),o=di(e,s,t);return hs(hs(i,n),o)}])}function yi(e){return e.distance.add(1)}function mi(e,t,r){const{viewMat3:s,tileMat3:i}=e.view,n=s.multiply(i),o=n.multiply(new fr(t.pos,1)),a=n.multiply(new fr(r.nextPos1,1)),c=n.multiply(new fr(r.nextPos2,1));return _i(e.hittestRequest.position,o.xy,a.xy,c.xy)}(0,St._)([Ns],li.prototype,"inside",void 0),(0,St._)([Ns],li.prototype,"outside",void 0),(0,St._)([Ds(ii)],li.prototype,"highlight",void 0),(0,St._)([zs(si)],li.prototype,"storage",void 0),(0,St._)([zs(oi)],li.prototype,"view",void 0),(0,St._)([Ds(ni)],li.prototype,"hittestRequest",void 0);class gi extends qs{getColor(e,t,r){return Yr([ts(Js(e),r),t],[Qr(e,this.values.first()),this.colors.first()],[es(e,this.values.last()),this.colors.last()],[!0,()=>{const t=this.values.findIndex((t=>Jr(t,e))),r=this.values.get(t),s=t.subtract(1),i=this.values.get(s),n=e.subtract(i).divide(r.subtract(i));return ds(this.colors.get(s),this.colors.get(t),n)}])}}(0,St._)([zs(lr.ofType(_r,8))],gi.prototype,"colors",void 0),(0,St._)([zs(lr.ofType(dr,8))],gi.prototype,"values",void 0);class xi extends qs{getOpacity(e){return Yr([Js(e),new dr(1)],[Qr(e,this.opacityValues.first()),this.opacities.first()],[es(e,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const t=this.opacityValues.findIndex((t=>Jr(t,e))),r=this.opacityValues.get(t),s=t.subtract(1),i=this.opacityValues.get(s),n=e.subtract(i).divide(r.subtract(i));return ds(this.opacities.get(s),this.opacities.get(t),n)}])}}function bi(e){return null!=e.visualVariableSizeMinMaxValue||null!=e.visualVariableSizeScaleStops||null!=e.visualVariableSizeStops||null!=e.visualVariableSizeUnitValue}function vi(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new br(!1);if(null==e.visualVariableColor)return r;const i=e.storage.getColorValue(t);return e.visualVariableColor.getColor(i,r,s)}function wi(e,t){if(null==e.visualVariableOpacity)return new dr(1);const r=e.storage.getOpacityValue(t);return e.visualVariableOpacity.getOpacity(r)}(0,St._)([zs(lr.ofType(dr,8))],xi.prototype,"opacities",void 0),(0,St._)([zs(lr.ofType(dr,8))],xi.prototype,"opacityValues",void 0);class Ii extends ai{}(0,St._)([Rs(3,_r)],Ii.prototype,"color",void 0),(0,St._)([Rs(4,pr)],Ii.prototype,"zoomRange",void 0);class Si extends li{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const r=wi(this,e.id),s=vi(this,e.id,e.color).multiply(r),i=this.view.displayViewScreenMat3.multiply(new fr(e.pos.xy,1)),n=this.clip(e.id,e.zoomRange);return{glPosition:new _r(i.xy,n,1),color:s,...this.maybeRunHittest(e,t,null)}}fragment(e){return this.getFragmentOutput(e.color,e,new dr(0))}hittest(e,t){return mi(this,e,t)}}(0,St._)([Ds(gi)],Si.prototype,"visualVariableColor",void 0),(0,St._)([Ds(xi)],Si.prototype,"visualVariableOpacity",void 0),(0,St._)([(0,St.a)(0,Os(Ii)),(0,St.a)(1,Os(ci))],Si.prototype,"vertex",null),(0,St._)([(0,St.a)(0,Os(ui))],Si.prototype,"fragment",null);class Ti extends qs{getPatternOffsetAtTileOrigin(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new dr(0),r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new dr(1);const s=new pr(16777216).divide(e);let i=e.multiply(cs(this.maxIntsToLocalOrigin.multiply(s))).add(this.tileOffsetFromLocalOrigin).subtract(new dr(.5).multiply(e));return i=new pr(i.x.multiply(r).subtract(i.y.multiply(t)),i.x.multiply(t).add(i.y.multiply(r))),ps(i,e)}}(0,St._)([zs(pr)],Ti.prototype,"tileOffsetFromLocalOrigin",void 0),(0,St._)([zs(pr)],Ti.prototype,"maxIntsToLocalOrigin",void 0);class Mi extends qs{}(0,St._)([zs(pr)],Mi.prototype,"size",void 0),(0,St._)([zs(hr)],Mi.prototype,"texture",void 0);class ki extends Ii{}(0,St._)([Rs(5,_r)],ki.prototype,"tlbr",void 0),(0,St._)([Rs(6,dr)],ki.prototype,"width",void 0),(0,St._)([Rs(7,dr)],ki.prototype,"height",void 0),(0,St._)([Rs(8,pr)],ki.prototype,"offset",void 0),(0,St._)([Rs(9,pr)],ki.prototype,"scale",void 0),(0,St._)([Rs(10,dr)],ki.prototype,"angle",void 0);function Fi(e,t,r,s,i){const n=Kr(ei(i,ut),Or(1)),o=function(e){return as(e,Dr(255/256,255/65536,255/16777216,255/4294967296))}(new _r(e,0));return Zr(n,Nr(s.divide(t.x),r.divide(t.y),0,qr(r.divide(t.x)),s.divide(t.y),0,Qs(zr(o,0)),Qs(zr(0,o)),1),Nr(s.divide(t.x),r.divide(t.y),0,qr(r.divide(t.x)),s.divide(t.y),0,0,0,1))}function Ei(e,t){const r=ds(new pr(1),new pr(1/f.Kg),new pr(ei(t.bitset,6),ei(t.bitset,5))),s=e.view.requiredZoomFactor,i=new pr(t.width,t.height).multiply(r),n=i.multiply(t.scale).multiply(s),o=t.angle.multiply(.024543692606171875),a=_s(o),c=os(o),u=Fi(t.id,n,a,c,t.bitset),l=e.localTileOffset.getPatternOffsetAtTileOrigin(i,a,c),h=s.multiply(t.scale).multiply(t.offset.subtract(l)).divide(n),d=new fr(t.pos,1),p=u.multiply(d).xy.subtract(h),_=t.tlbr.divide(e.mosaicInfo.size.xyxy);let y=ei(t.bitset,4);return null!=e.visualVariableColor&&(y=Zr(Js(e.storage.getColorValue(t.id)),new dr(0),y)),{tileTextureCoord:p,tlbr:_,sampleAlphaOnly:y}}function Ci(e,t){const r=ps(t.tileTextureCoord,new dr(1)),s=ds(t.tlbr.xy,t.tlbr.zw,r);let i=ms(e.mosaicInfo.texture,s);return i=Zr(Jr(t.sampleAlphaOnly,new dr(.5)),i.aaaa,i),t.color.multiply(i)}class Pi extends Si{vertex(e,t){return{...super.vertex(e,t),...Ei(this,e)}}fragment(e){const t=Ci(this,e);return this.getFragmentOutput(t,e,new dr(0))}}(0,St._)([zs(Mi)],Pi.prototype,"mosaicInfo",void 0),(0,St._)([zs(Ti)],Pi.prototype,"localTileOffset",void 0),(0,St._)([(0,St.a)(0,Os(ki)),(0,St.a)(1,Os(ci))],Pi.prototype,"vertex",null),(0,St._)([(0,St.a)(0,Os(class extends ui{}))],Pi.prototype,"fragment",null);class Ai extends qs{getSize(e,t){const r=this.minMaxValueAndSize.xy,s=this.minMaxValueAndSize.zw;return Zr(Js(e),t,(()=>{const t=ns(e.subtract(r.x).divide(r.y.subtract(r.x)),new dr(0),new dr(1));return s.x.add(t.multiply(s.y.subtract(s.x)))}))}}(0,St._)([zs(_r)],Ai.prototype,"minMaxValueAndSize",void 0);class Ri extends qs{getSizeForViewScale(e){return Yr([Qr(e,this.values.first()),this.sizes.first()],[es(e,this.values.last()),this.sizes.last()],[!0,()=>{const t=this.values.findIndex((t=>Jr(t,e))),r=this.values.get(t),s=t.subtract(1),i=this.values.get(s),n=e.subtract(i).divide(r.subtract(i));return ds(this.sizes.get(s),this.sizes.get(t),n)}])}}(0,St._)([zs(lr.ofType(dr,8))],Ri.prototype,"sizes",void 0),(0,St._)([zs(lr.ofType(dr,8))],Ri.prototype,"values",void 0);class Oi extends qs{getSize(e,t){const r=Yr([Js(e),t],[Qr(e,this.values.first()),this.sizes.first()],[es(e,this.values.last()),this.sizes.last()],[!0,()=>{const t=this.values.findIndex((t=>Jr(t,e))),r=this.values.get(t),s=t.subtract(1),i=this.values.get(s),n=e.subtract(i).divide(r.subtract(i));return ds(this.sizes.get(s),this.sizes.get(t),n)}]);return Zr(Js(r),t,r)}}(0,St._)([zs(lr.ofType(dr,8))],Oi.prototype,"sizes",void 0),(0,St._)([zs(lr.ofType(dr,8))],Oi.prototype,"values",void 0);class zi extends qs{getSize(e,t){return Zr(Js(e),t,e.multiply(this.unitValueToPixelsRatio))}}(0,St._)([zs(dr)],zi.prototype,"unitValueToPixelsRatio",void 0);class Di extends ai{}(0,St._)([Rs(3,_r)],Di.prototype,"color",void 0),(0,St._)([Rs(4,pr)],Di.prototype,"offset",void 0),(0,St._)([Rs(5,pr)],Di.prototype,"normal",void 0),(0,St._)([Rs(6,dr)],Di.prototype,"halfWidth",void 0),(0,St._)([Rs(7,dr)],Di.prototype,"referenceHalfWidth",void 0),(0,St._)([Rs(8,pr)],Di.prototype,"zoomRange",void 0);class Ni extends ui{}class Bi extends qs{}function Vi(e){return ls(new dr(it).multiply(ys(e,new dr(nt))),new dr(1))}function Li(e,t){const{id:r,halfWidth:s,referenceHalfWidth:i}=t;if(bi(e)){const t=function(e,t,r){if(bi(e)){const s=e.storage.getSizeValue(t);return e.visualVariableSizeMinMaxValue?.getSize(s,r)??e.visualVariableSizeScaleStops?.getSizeForViewScale(e.view.currentScale)??e.visualVariableSizeStops?.getSize(s,r)??e.visualVariableSizeUnitValue?.getSize(s,r)}return r}(e,r,new dr(2).multiply(i));return new dr(.5).multiply(s.divide(ls(i,new dr(ot)))).multiply(t)}return s}function Gi(e,t){const{id:r,offset:s,pos:i,normal:n,zoomRange:o}=t,{displayViewScreenMat3:a,displayViewMat3:c}=e.view,u=vi(e,r,t.color),l=wi(e,r),h=Li(e,t),d=new dr(.5).multiply(e.antialiasingControls.antialiasing),p=ls(h.add(d),new dr(.45)).add(new dr(.1).multiply(d)),f=Vi(p).multiply(p).multiply(s),_=c.multiply(new fr(f,new dr(0))),y=a.multiply(new fr(i,new dr(1))).add(_),m=new dr(2).multiply(ys(h,new dr(0))).add(e.clip(r,o)),g=new _r(y.xy,m,1);return{color:u,opacity:l,halfWidth:p,normal:n,scaledOffset:f,scaledHalfWidth:h,glPosition:new _r(g.xy,m,1)}}function Ui(e,t){const{opacity:r,color:s}=e,i=function(e,t){const{halfWidth:r,normal:s}=e,i=Vi(r),n=us(s).multiply(r);return ns(i.multiply(r.subtract(n)).divide(t.add(i).subtract(new dr(1))),new dr(0),new dr(1))}(e,t);return r.multiply(s).multiply(i)}(0,St._)([zs(dr)],Bi.prototype,"antialiasing",void 0),(0,St._)([zs(dr)],Bi.prototype,"blur",void 0);class qi extends li{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const r=Gi(this,e);return{...r,...this.maybeRunHittest(e,t,r.halfWidth)}}fragment(e){const t=Ui(e,this.antialiasingControls.blur);return this.getFragmentOutput(t,e)}hittest(e,t,r){const{viewMat3:s,tileMat3:i}=this.view,n=s.multiply(i),o=n.multiply(new fr(e.pos,1)),a=n.multiply(new fr(t.nextPos1,1)),c=n.multiply(new fr(t.nextPos2,1)),{distance:u,smallSymbolDistance:l,smallSymbolSizeThreshold:h}=this.hittestRequest,d=ys(r,h.multiply(.5)).multiply(u.subtract(l)),p=this.hittestRequest.position;return hs(di(p,o.xy,a.xy),di(p,o.xy,c.xy)).subtract(r).add(d)}}(0,St._)([zs(Bi)],qi.prototype,"antialiasingControls",void 0),(0,St._)([Ds(gi)],qi.prototype,"visualVariableColor",void 0),(0,St._)([Ds(xi)],qi.prototype,"visualVariableOpacity",void 0),(0,St._)([Ds(Ai)],qi.prototype,"visualVariableSizeMinMaxValue",void 0),(0,St._)([Ds(Ri)],qi.prototype,"visualVariableSizeScaleStops",void 0),(0,St._)([Ds(Oi)],qi.prototype,"visualVariableSizeStops",void 0),(0,St._)([Ds(zi)],qi.prototype,"visualVariableSizeUnitValue",void 0),(0,St._)([(0,St.a)(0,Os(Di)),(0,St.a)(1,Os(ci))],qi.prototype,"vertex",null),(0,St._)([(0,St.a)(0,Os(Ni))],qi.prototype,"fragment",null);class Wi extends ai{}(0,St._)([Rs(3,pr)],Wi.prototype,"offset",void 0),(0,St._)([Rs(4,_r)],Wi.prototype,"color",void 0),(0,St._)([Rs(5,pr)],Wi.prototype,"normal",void 0),(0,St._)([Rs(6,dr)],Wi.prototype,"halfWidth",void 0),(0,St._)([Rs(7,dr)],Wi.prototype,"referenceHalfWidth",void 0),(0,St._)([Rs(8,pr)],Wi.prototype,"zoomRange",void 0);class Zi extends Ni{}function Yi(e,t,r){const{id:s,bitset:i}=t,n=ei(i,0),o=Jr(n,new dr(.5)),a=Gi(e,t),c=Zr(o,a.halfWidth,new dr(0)),u=wi(e,s),l=vi(e,s,t.color),h=Zr(o,t.color,l.multiply(u)),d=e.view.displayViewScreenMat3.multiply(new fr(t.pos.xy,1)),p=e.clip(t.id),f=new _r(d.xy,p,1),_=Zr(o,a.glPosition,f),y=r&&e.maybeRunHittest(t,r,o);return{isOutline:n,color:h,opacity:new dr(1),halfWidth:c,normal:a.normal,glPosition:_,...y}}class ji extends li{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}}(0,St._)([zs(Bi)],ji.prototype,"antialiasingControls",void 0),(0,St._)([Ds(gi)],ji.prototype,"visualVariableColor",void 0),(0,St._)([Ds(xi)],ji.prototype,"visualVariableOpacity",void 0),(0,St._)([Ds(Ai)],ji.prototype,"visualVariableSizeMinMaxValue",void 0),(0,St._)([Ds(Ri)],ji.prototype,"visualVariableSizeScaleStops",void 0),(0,St._)([Ds(Oi)],ji.prototype,"visualVariableSizeStops",void 0),(0,St._)([Ds(zi)],ji.prototype,"visualVariableSizeUnitValue",void 0);class $i extends ji{vertex(e,t){return Yi(this,e,t)}fragment(e){const{color:t,isOutline:r}=e,s=Jr(r,new dr(.5)),i=Zr(s,Ui(e,this.antialiasingControls.blur),t),n=Zr(s,new dr(1/255),new dr(0));return this.getFragmentOutput(i,e,n)}hittest(e,t,r){return Zr(r,yi(this.hittestRequest),mi(this,e,t))}}(0,St._)([(0,St.a)(0,Os(Wi)),(0,St.a)(1,Os(ci))],$i.prototype,"vertex",null),(0,St._)([(0,St.a)(0,Os(Zi))],$i.prototype,"fragment",null);class Hi extends Ii{}(0,St._)([Rs(5,_r)],Hi.prototype,"tlbr",void 0),(0,St._)([Rs(6,dr)],Hi.prototype,"inverseRasterizationScale",void 0);function Xi(e,t){const r=t.tlbr.xy,s=t.tlbr.zw,i=s.x.subtract(r.x),n=r.y.subtract(s.y),o=new pr(i,n).multiply(t.inverseRasterizationScale),a=o.multiply(e.view.requiredZoomFactor),c=function(e){const t=new dr(1),r=new dr(0);return new Cr(t.divide(e.x),r.divide(e.y),0,qr(r.divide(e.x)),t.divide(e.y),0,0,0,1)}(a),u=e.localTileOffset.getPatternOffsetAtTileOrigin(o).divide(a),l=new fr(t.pos,1);return{tileTextureCoord:c.multiply(l).xy.subtract(u),tlbr:t.tlbr.divide(e.mosaicInfo.size.xyxy)}}function Ki(e,t){const r=ps(e.tileTextureCoord,new dr(1)),s=ds(e.tlbr.xy,e.tlbr.zw,r),i=ms(t.texture,s);return e.color.multiply(i)}class Qi extends Si{vertex(e,t){return{...super.vertex(e,t),...Xi(this,e)}}fragment(e){const t=Ki(e,this.mosaicInfo);return this.getFragmentOutput(t,e,new dr(0))}}(0,St._)([zs(Mi)],Qi.prototype,"mosaicInfo",void 0),(0,St._)([zs(Ti)],Qi.prototype,"localTileOffset",void 0),(0,St._)([(0,St.a)(0,Os(Hi)),(0,St.a)(1,Os(ci))],Qi.prototype,"vertex",null),(0,St._)([(0,St.a)(0,Os(class extends ui{}))],Qi.prototype,"fragment",null);class Ji extends Wi{}(0,St._)([Rs(9,_r)],Ji.prototype,"tlbr",void 0),(0,St._)([Rs(10,dr)],Ji.prototype,"inverseRasterizationScale",void 0);class en extends Zi{}class tn extends $i{vertex(e,t){return{...Yi(this,e,t),...Xi(this,e)}}fragment(e){const{isOutline:t}=e,r=Jr(t,new dr(.5)),s=Zr(r,Ui(e,this.antialiasingControls.blur),Ki(e,this.mosaicInfo)),i=Zr(r,new dr(1/255),new dr(0));return this.getFragmentOutput(s,e,i)}}(0,St._)([zs(Mi)],tn.prototype,"mosaicInfo",void 0),(0,St._)([zs(Ti)],tn.prototype,"localTileOffset",void 0),(0,St._)([(0,St.a)(0,Os(Ji)),(0,St.a)(1,Os(ci))],tn.prototype,"vertex",null),(0,St._)([(0,St.a)(0,Os(en))],tn.prototype,"fragment",null);const rn=16,sn=.0625;class nn extends ai{}(0,St._)([Rs(3,_r)],nn.prototype,"color",void 0),(0,St._)([Rs(4,_r)],nn.prototype,"tlbr",void 0),(0,St._)([Rs(5,dr)],nn.prototype,"angle",void 0),(0,St._)([Rs(6,dr)],nn.prototype,"aux1",void 0),(0,St._)([Rs(7,dr)],nn.prototype,"aux2",void 0),(0,St._)([Rs(8,pr)],nn.prototype,"aux3",void 0),(0,St._)([Rs(9,pr)],nn.prototype,"aux4",void 0),(0,St._)([Rs(10,pr)],nn.prototype,"zoomRange",void 0);class on extends ji{vertex(e,t){const{aux1:r,aux2:s,aux3:i,aux4:n}=e,o={...e,width:r,height:s,offset:i,scale:n.multiply(sn)},a=Yi(this,{...e,halfWidth:r.multiply(sn),referenceHalfWidth:s.multiply(sn),offset:i.multiply(sn),normal:n.subtract(128).multiply(sn)}),c=Ei(this,o),u=Jr(a.isOutline,new dr(.5));return{...a,...c,...this.maybeRunHittest(e,t,u)}}fragment(e){const{isOutline:t}=e,r=Jr(t,new dr(.5)),s=Zr(r,Ui(e,this.antialiasingControls.blur),Ci(this,e)),i=Zr(r,new dr(1/255),new dr(0));return this.getFragmentOutput(s,e,i)}hittest(e,t,r){return Zr(r,yi(this.hittestRequest),mi(this,e,t))}}(0,St._)([zs(Mi)],on.prototype,"mosaicInfo",void 0),(0,St._)([zs(Ti)],on.prototype,"localTileOffset",void 0),(0,St._)([(0,St.a)(0,Os(nn)),(0,St.a)(1,Os(ci))],on.prototype,"vertex",null),(0,St._)([(0,St.a)(0,Os(class extends en{}))],on.prototype,"fragment",null);const an=ft.attributes,cn=vt.attributes,un={createComputedParams:e=>e,attributes:{id:an.id,pos:an.pos,zoomRange:an.zoomRange,tlbr:an.tlbr,angle:an.angle,color:an.color,bitset:{type:ze.g.UNSIGNED_BYTE,count:1,pack:e=>ht(e)},aux1:{count:1,type:ze.g.UNSIGNED_SHORT,pack:e=>dt(e)},aux2:{count:1,type:ze.g.UNSIGNED_SHORT,pack:e=>pt(e)},aux3:{count:2,type:ze.g.SHORT,pack:e=>{let{offsetX:t,offsetY:r}=e;return[(0,l.F2)(t),(0,l.F2)(r)]}},aux4:{count:2,type:ze.g.UNSIGNED_BYTE,pack:e=>{let{scaleX:t,scaleY:r}=e;return[t*rn,r*rn]}}}},ln={createComputedParams:e=>e,attributes:{id:an.id,pos:an.pos,zoomRange:an.zoomRange,tlbr:an.tlbr,angle:an.angle,color:cn.color,bitset:{type:ze.g.UNSIGNED_BYTE,count:1,pack:e=>$e([[0,!0]])},aux1:{count:1,type:ze.g.UNSIGNED_SHORT,pack:e=>(0,l.F2)(.5*e.width)*rn},aux2:{count:1,type:ze.g.UNSIGNED_SHORT,pack:e=>(0,l.F2)(.5*e.referenceWidth)*rn},aux3:{count:2,type:ze.g.SHORT,packTessellation:e=>{let{extrusionOffsetX:t,extrusionOffsetY:r}=e;return[t*rn,r*rn]}},aux4:{count:2,type:ze.g.UNSIGNED_BYTE,packTessellation:e=>{let{normalX:t,normalY:r}=e;return[t*rn+128,r*rn+128]}}}};class hn extends wt{constructor(){super(...arguments),this.vertexSpec=ln}}const dn={createComputedParams:e=>e,attributes:{...tt.attributes,...bt.attributes}},pn={createComputedParams:e=>e,attributes:{...tt.attributes,...vt.attributes}};class fn extends wt{constructor(){super(...arguments),this.vertexSpec=pn}}const _n={createComputedParams:e=>e,attributes:{pos:{type:ze.g.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:ze.g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:ze.g.UNSIGNED_BYTE,count:1},offset:{type:ze.g.BYTE,count:2,packAlternating:{count:4,pack:()=>[[-1,-1],[1,-1],[-1,1],[1,1]]}}}};var yn=r(77427),mn=r(50264),gn=r(35609),xn=r(38999);const bn=8388607,vn=8388608,wn=e=>e&bn;var In=r(28289);class Sn{constructor(e,t,r,s,i,n,o,a){let c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:[];this.entityTexel=e,this.anchorX=t,this.anchorY=r,this.directionX=s,this.directionY=i,this.maxScale=n,this.minScale=o,this.referenceBounds=a,this.bounds=c}serialize(e){e.push(this.entityTexel),e.writeF32(this.anchorX),e.writeF32(this.anchorY),e.writeF32(this.directionX),e.writeF32(this.directionY),e.writeF32(this.maxScale),e.writeF32(this.minScale),null===this.referenceBounds?(e.writeF32(0),e.writeF32(0),e.writeF32(0)):(e.writeF32(this.referenceBounds.size),e.writeF32(this.referenceBounds.offsetX),e.writeF32(this.referenceBounds.offsetY)),b(e,this.bounds)}static deserialize(e){const t=e.readInt32(),r=e.readF32(),s=e.readF32(),i=e.readF32(),n=e.readF32(),o=e.readF32(),a=e.readF32(),c=e.readF32(),u=e.readF32(),l=e.readF32(),h=v(e,In.Z)??[];return new Sn(t,r,s,i,n,o,a,{size:c,offsetX:u,offsetY:l},h)}}var Tn=r(51750);function Mn(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e}function kn(e,t){return Math.sqrt(e*e+t*t)}function Fn(e){const t=kn(e[0],e[1]);e[0]/=t,e[1]/=t}function En(e,t){return kn(e[0]-t[0],e[1]-t[1])}function Cn(e){return e.length-1}function Pn(e){let t=0;for(let r=0;r<Cn(e);r++)t+=An(e,r);return t}function An(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,[s,i]=function(e,t){return e[t+1]}(e,t);return[s,i]=[Math.round(s),Math.round(i)],Math.sqrt(s*s+i*i)*r}class Rn{constructor(e,t,r,s,i){this._segments=e,this._index=t,this._distance=r,this._xStart=s,this._yStart=i,this._done=!1}static create(e){return new Rn(e,0,0,e[0][0],e[0][1])}clone(){return new Rn(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(e){return this._index===e._index||e._index===this._index-1&&(0===this._distance||1===e._distance)||e._index===this._index+1&&(1===this._distance||0===e._distance)}leq(e){return this._index<e._index||this._index===e._index&&this._distance<=e._distance}geq(e){return this._index>e._index||this._index===e._index&&this._distance>=e._distance}get _segment(){return this._segments[this._index+1]}get angle(){const e=this.dy,t=(0*e+-1*-this.dx)/(1*this.length);let r=Math.acos(t);return e>0&&(r=2*Math.PI-r),r}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:e,dy:t}=this;return Math.sqrt(e*e+t*t)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Cn(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(e,t){const r=this.backwardLength;if(e<=r)return this._distance=(r-e)/this.length,this;let s=this.backwardLength;for(;this.prev();){if(s+this.length>e)return this._seekBackwards(e-s);s+=this.length}return this._distance=0,t?this:null}seek(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e<0)return this._seekBackwards(Math.abs(e),t);if(e<=this.remainingLength)return this._distance=(this.backwardLength+e)/this.length,this;let r=this.remainingLength;for(;this.next();){if(r+this.length>e)return this.seek(e-r,t);r+=this.length}return this._distance=1,t?this:null}}function On(e,t,r){let s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const i=Pn(e),n=Rn.create(e),o=i/2;if(!s)return n.seek(o),void(Math.abs(n.x)<Tn.L&&Math.abs(n.y)<Tn.L&&r(n.clone(),0,o+0*t,i));const a=Math.max((i-t)/2,0),c=Math.floor(a/t),u=o-c*t;n.seek(u);for(let l=-c;l<=c;l++)Math.abs(n.x)<Tn.L&&Math.abs(n.y)<Tn.L&&r(n.clone(),l,o+l*t,i),n.seek(t)}function zn(e,t){const r=1e-6;if(t<=0)return;const s=e.length;if(s<3)return;const i=[];let n=0;i.push(0);for(let h=1;h<s;h++)n+=En(e[h],e[h-1]),i.push(n);t=Math.min(t,.2*n);const o=[];o.push(e[0][0]),o.push(e[0][1]);const a=e[s-1][0],c=e[s-1][1],u=Mn([0,0],e[0],e[1]);Fn(u),e[0][0]+=t*u[0],e[0][1]+=t*u[1],Mn(u,e[s-1],e[s-2]),Fn(u),e[s-1][0]+=t*u[0],e[s-1][1]+=t*u[1];for(let h=1;h<s;h++)i[h]+=t;i[s-1]+=t;const l=.5*t;for(let h=1;h<s-1;h++){let n=0,a=0,c=0;for(let s=h-1;s>=0&&!(i[s+1]<i[h]-l);s--){const o=l+i[s+1]-i[h],u=i[s+1]-i[s],d=i[h]-i[s]<l?1:o/u;if(Math.abs(d)<r)break;const p=d*d,f=d*o-.5*p*u,_=d*u/t,y=e[s+1],m=e[s][0]-y[0],g=e[s][1]-y[1];n+=_/f*(y[0]*d*o+.5*p*(o*m-u*y[0])-p*d*u*m/3),a+=_/f*(y[1]*d*o+.5*p*(o*g-u*y[1])-p*d*u*g/3),c+=_}for(let o=h+1;o<s&&!(i[o-1]>i[h]+l);o++){const s=l-i[o-1]+i[h],u=i[o]-i[o-1],d=i[o]-i[h]<l?1:s/u;if(Math.abs(d)<r)break;const p=d*d,f=d*s-.5*p*u,_=d*u/t,y=e[o-1],m=e[o][0]-y[0],g=e[o][1]-y[1];n+=_/f*(y[0]*d*s+.5*p*(s*m-u*y[0])-p*d*u*m/3),a+=_/f*(y[1]*d*s+.5*p*(s*g-u*y[1])-p*d*u*g/3),c+=_}o.push(n/c),o.push(a/c)}o.push(a),o.push(c);for(let h=0,d=0;h<s;h++)e[h][0]=o[d++],e[h][1]=o[d++]}var Dn=r(16889);class Nn{static getPlacement(e,t,r,s,i,n){const o=(0,Ee.W)(r);return o?(-1===t&&e.invertY(),o.execute(e,r,s,i,n)):null}}var Bn=r(62106),Vn=r(31027);class Ln{constructor(e){const{offsetX:t,offsetY:r,postAngle:s,fontSize:i,scaleFactor:n,transforms:o}=e;if(this.offsetX=t,this.offsetY=r,this.postAngle=s,this.fontSize=Math.min(i,96),this.transforms=o,o&&o.infos.length>1){const e=(0,Vn.yl)(i,s,!1,t,r,o);this.fontSize=Math.min(e.size,96),this.postAngle=e.rotation,this.offsetX=e.offsetX,this.offsetY=e.offsetY}n&&(this.fontSize*=n,this.offsetX*=n,this.offsetY*=n)}}const Gn=[4,4],Un=[16,4],qn={topLeft:Un,topRight:Un,bottomLeft:Un,bottomRight:Un},Wn=[4,2],Zn=[4,6],Yn={topLeft:Wn,topRight:Wn,bottomLeft:Zn,bottomRight:Zn},jn={topLeft:Wn,topRight:Zn,bottomLeft:Wn,bottomRight:Zn},$n={topLeft:Zn,topRight:Zn,bottomLeft:Gn,bottomRight:Gn},Hn={topLeft:Gn,topRight:Gn,bottomLeft:Zn,bottomRight:Zn},Xn={topLeft:Zn,topRight:Gn,bottomLeft:Zn,bottomRight:Gn},Kn={topLeft:Gn,topRight:Zn,bottomLeft:Gn,bottomRight:Zn},Qn={createComputedParams:e=>e,attributes:{pos:{type:ze.g.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:ze.g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:ze.g.UNSIGNED_BYTE,count:1,packTessellation:e=>{let{isBackground:t,mapAligned:r}=e;return $e([[0,t],[3,!!r]])}},zoomRange:{type:ze.g.UNSIGNED_SHORT,count:2,packPrecisionFactor:f.JS,packTessellation:e=>{let{minZoom:t,maxZoom:r}=e;return[t||0,r||28]}},offset:{type:ze.g.SHORT,count:2,packPrecisionFactor:8,packAlternating:{count:4,packTessellation:e=>{let{offsets:t}=e;const{bottomLeft:r,bottomRight:s,topLeft:i,topRight:n}=t;return[i,n,r,s]}}},textureUV:{type:ze.g.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,packTessellation:e=>{let{texcoords:t}=e;const{bottomLeft:r,bottomRight:s,topLeft:i,topRight:n}=t;return[i,n,r,s]}}},color:{type:ze.g.UNSIGNED_BYTE,count:4,normalized:!0,packTessellation:e=>{let{color:t}=e;return t}},fontSize:{type:ze.g.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,packTessellation:e=>{let{fontSize:t}=e;return(0,l.F2)(t)}},referenceSize:{type:ze.g.UNSIGNED_BYTE,count:1,packPrecisionFactor:4,packTessellation:(e,t)=>{let{fontSize:r}=e,{referenceSize:s}=t;return(0,l.F2)(s??r)}},haloColor:{type:ze.g.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{haloColor:t}=e;return He(t)}},haloFontSize:{type:ze.g.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,pack:e=>{let{haloFontSize:t}=e;return(0,l.F2)(t)}},clipAngle:{type:ze.g.UNSIGNED_BYTE,count:1,packTessellation:e=>{let{clipAngle:t}=e;return eo(t||0)}},referenceSymbol:{type:ze.g.BYTE,count:4,packPrecisionFactor:1,packTessellation:(e,t)=>{if(!e.referenceBounds)return[0,0,0,0];const r=(0,xn.g)(t.horizontalAlignment),s=(0,xn.tf)(t.verticalAlignment),{offsetX:i,offsetY:n,size:o}=e.referenceBounds;return[(0,l.F2)(i),-(0,l.F2)(n),(0,l.F2)(o),r+1<<2|s+1]}}}};class Jn extends Ve{constructor(){super(...arguments),this.vertexSpec=Qn,this._textMeshParamsPropsInitialized=!1}ensurePacked(e,t,r){super.ensurePacked(e,t,r),this._textMeshParamsPropsInitialized&&!this._evaluator.hasDynamicProperties||(this._textMeshTransformProps=new Ln(this.evaluatedMeshParams),this._textMeshParamsPropsInitialized=!0)}_write(e,t,r){const s=this._getShaping();if(!s)return;const i=t.getDisplayId();if(null!=this.evaluatedMeshParams.placement)return this._writePlacedTextMarkers(e,t,s,r);if(r&&r.nextPath())return r.nextPoint(),this._writeGlyphs(e,i,r.x,r.y,s,0);if("esriGeometryPolygon"===t.geometryType){const r=t.readCentroidForDisplay();if(!r)return;const[n,o]=r.coords;return this._writeGlyphs(e,i,n,o,s,0)}if("esriGeometryMultipoint"===t.geometryType){const r=t.readGeometryForDisplay();return void r?.forEachVertex(((t,r)=>this._writeGlyphs(e,i,t,r,s,0)))}const n=t.readXForDisplay(),o=t.readYForDisplay();return this._writeGlyphs(e,i,n,o,s,0)}_writePlacedTextMarkers(e,t,r,s){const i=s??Me.z.fromFeatureSetReaderCIM(t);if(!i)return;const n=Nn.getPlacement(i,-1,this.evaluatedMeshParams.placement,(0,l.F2)(1),e.id,Re());if(!n)return;const o=t.getDisplayId();let a=n.next();for(;null!=a;){const t=a.tx,s=-a.ty,i=-a.getAngle();this._writeGlyphs(e,o,t,s,r,i),a=n.next()}}_getShaping(){const e=this._textMeshTransformProps,t=this.evaluatedMeshParams;if(!t.glyphs?.glyphs.length)return null;const r=Math.round((0,l.F2)(e.fontSize)),s=(0,l.F2)(e.offsetX),i=(0,l.F2)(e.offsetY),n=(0,Dn.uZ)((0,l.F2)(t.lineWidth),32,512),o=f.uk*(0,Dn.uZ)(t.lineHeightRatio,.25,4);return(0,Bn.Nr)(t.glyphs,{scale:r/f.iD,angle:e.postAngle,xOffset:s,yOffset:i,horizontalAlignment:t.horizontalAlignment,verticalAlignment:t.verticalAlignment,maxLineWidth:n,lineHeight:o,decoration:t.decoration,borderLineSizePx:(0,l.F2)(t.boxBorderLineSize),hasBackground:!!t.boxBackgroundColor,useCIMAngleBehavior:t.useCIMAngleBehavior})}_writeGlyphs(e,t,r,s,i,n,o,a){const c=this.evaluatedMeshParams,u=this._textMeshTransformProps,h=u.fontSize,d=(0,l.F2)(u.offsetX),p=(0,l.F2)(u.offsetY),[f,_]=Ye(c.scaleInfo,this.getTileInfo());0!==n&&i.setRotation(n);const y=i.bounds,m=r+y.x+d,g=s+y.y-p,x=2*(c.minPixelBuffer?c.minPixelBuffer/h:1),b=Math.max(y.width,y.height)*x;i.textBox&&(e.recordStart(this.instanceId,this.attributeLayout,i.glyphs[0].textureBinding),e.recordBounds(m,g,b,b),this._writeTextBox(e,t,r,s,i.textBox,o,a),e.recordEnd());for(const l of i.glyphs){e.recordStart(this.instanceId,this.attributeLayout,l.textureBinding),e.recordBounds(m,g,b,b);const{texcoords:i,offsets:n}=l;this._writeQuad(e,t,r,s,{texcoords:i,offsets:n,fontSize:h,color:He(c.color),isBackground:!1,referenceBounds:o,minZoom:f,maxZoom:_,...a}),e.recordEnd()}0!==n&&i.setRotation(-n)}_writeTextBox(e,t,r,s,i,n,o){const a=this.evaluatedMeshParams,{fontSize:c}=this._textMeshTransformProps,{boxBackgroundColor:u,boxBorderLineColor:l}=a,h={isBackground:!0,fontSize:c,referenceBounds:n,...o};u&&(this._writeQuad(e,t,r,s,{texcoords:qn,offsets:i.main,color:He(u),...h}),l||(this._writeQuad(e,t,r,s,{texcoords:$n,offsets:i.top,color:He(u),...h}),this._writeQuad(e,t,r,s,{texcoords:Hn,offsets:i.bot,color:He(u),...h}),this._writeQuad(e,t,r,s,{texcoords:Xn,offsets:i.left,color:He(u),...h}),this._writeQuad(e,t,r,s,{texcoords:Kn,offsets:i.right,color:He(u),...h}))),l&&(this._writeQuad(e,t,r,s,{texcoords:Yn,offsets:i.top,color:He(l),...h}),this._writeQuad(e,t,r,s,{texcoords:Yn,offsets:i.bot,color:He(l),...h}),this._writeQuad(e,t,r,s,{texcoords:jn,offsets:i.left,color:He(l),...h}),this._writeQuad(e,t,r,s,{texcoords:jn,offsets:i.right,color:He(l),...h}))}_writeQuad(e,t,r,s,i){const n=e.vertexCount();this._writeVertex(e,t,r,s,i),e.indexWrite(n+0),e.indexWrite(n+1),e.indexWrite(n+2),e.indexWrite(n+1),e.indexWrite(n+3),e.indexWrite(n+2)}}const eo=e=>Math.round(e*(254/360)),to=(0,yn.HP)((e=>{let t=0;if(0===e)return 1/0;for(;!(e%2);)t++,e/=2;return t}));const ro={createComputedParams:e=>e,attributes:{...mt.attributes,bitset:{type:ze.g.UNSIGNED_BYTE,count:1,pack:e=>{let{shouldSampleAlphaOnly:t,shouldScaleDash:r,isSDF:s}=e;return $e([[4,t],[2,r],[3,s]])}},tlbr:{type:ze.g.UNSIGNED_SHORT,count:4,pack:e=>{let{sprite:t}=e;const{rect:r,width:s,height:i}=t,n=r.x+f.s4,o=r.y+f.s4;return[n,o,n+s,o+i]}},accumulatedDistance:{type:ze.g.UNSIGNED_SHORT,count:1,packTessellation:e=>{let{distance:t}=e;return t}},segmentDirection:{type:ze.g.BYTE,count:2,packPrecisionFactor:16,packTessellation:e=>{let{directionX:t,directionY:r}=e;return[t,r]}}}};var so=r(13611);class io{static from(e){return"width"in e?this.fromSimpleMeshParams(e):this.fromComplexMeshParams(e)}static fromSimpleMeshParams(e){const t=new io(e.sprite,e.color,e.outlineColor,e.minPixelBuffer,e.placement,e.scaleInfo,e.effects),{type:r,width:s,height:i,angle:n,alignment:o,outlineSize:a,referenceSize:c,sprite:u,overrideOutlineColor:h}=e;t.rawWidth=(0,l.F2)(s),t.rawHeight=(0,l.F2)(i),t.angle=n,t.alignment=o,t.outlineSize=(0,l.F2)(a),t.referenceSize=(0,l.F2)(c),t.overrideOutlineColor=h,t.offsetX=(0,l.F2)(e.offsetX),t.offsetY=(0,l.F2)(e.offsetY),"simple"!==r||u.sdf||(t.rawWidth=u.width,t.rawHeight=u.height);return t.sizeRatio=u.sdf?2:1,t._computeSize(e,!1),t}static fromComplexMeshParams(e){const t=new io(e.sprite,e.color,e.outlineColor,e.minPixelBuffer,e.placement,e.scaleInfo,e.effects);let{alignment:r,transforms:s,size:i,scaleX:n,anchorX:o,anchorY:a,angle:c,colorLocked:u,frameHeight:h,widthRatio:d,offsetX:p,offsetY:f,outlineSize:_,referenceSize:y,scaleFactor:m,sizeRatio:g,isAbsoluteAnchorPoint:x,rotateClockwise:b,scaleSymbolsProportionally:v,sprite:w}=e;if(s&&s.infos.length>0){const e=(0,Vn.yl)(i,c,b,p,f,s);i=e.size,c=e.rotation,p=e.offsetX,f=e.offsetY,b=!1}m&&(i*=m,p*=m,f*=m);const I=n*(w.width/w.height);t.alignment=r,t.rawHeight=(0,l.F2)(i),t.rawWidth=t.rawHeight*I,t.referenceSize=(0,l.F2)(y),t.sizeRatio=g,t.angle=c,t.rotateClockwise=b,t.anchorX=o,t.anchorY=a,t.offsetX=(0,l.F2)(p),t.offsetY=(0,l.F2)(f),x&&i&&(w.sdf?t.anchorX=o/(i*d):t.anchorX=o/(i*I),t.anchorY=a/i);const S=v&&h?i/h:1;return t.outlineSize=0===_||isNaN(_)?0:(0,l.F2)(_)*S,t.scaleSymbolsProportionally=v,t.colorLocked=u,t._computeSize(e,!0),t}constructor(e,t,r,s,i,n,o){this.sprite=e,this.color=t,this.outlineColor=r,this.minPixelBuffer=s,this.placement=i,this.scaleInfo=n,this.effects=o,this.rawWidth=0,this.rawHeight=0,this.angle=0,this.outlineSize=0,this.referenceSize=0,this.sizeRatio=1,this.alignment=Ze.v2.SCREEN,this.scaleSymbolsProportionally=!1,this.overrideOutlineColor=!1,this.colorLocked=!1,this.anchorX=0,this.anchorY=0,this.computedWidth=0,this.computedHeight=0,this.texXmin=0,this.texYmin=0,this.texXmax=0,this.texYmax=0,this.offsetX=0,this.offsetY=0,this.rotateClockwise=!0}get boundsInfo(){return{size:Math.max(this.computedHeight,this.computedWidth),offsetX:this.offsetX,offsetY:this.offsetY}}_computeSize(e,t){const{sprite:r,hasSizeVV:s}=e,i=!!r.sdf,{rawWidth:n,rawHeight:o,sizeRatio:a,outlineSize:c}=this,u=n*a,l=o*a;if(i&&!s){const e=t&&n>o?u:n,r=o,s=c+2;this.computedWidth=Math.min(e+s,u),this.computedHeight=Math.min(r+s,l)}else this.computedWidth=u,this.computedHeight=l;const h=i?f.qu/Math.max(u,l):1,d=.5*(u-this.computedWidth)*h,p=.5*(l-this.computedHeight)*h,_=r.rect.x+f.s4+d,y=r.rect.y+f.s4+p,m=_+r.width-2*d,g=y+r.height-2*p;this.texXmin=Math.floor(_),this.texYmin=Math.floor(y),this.texXmax=Math.ceil(m),this.texYmax=Math.ceil(g),this.computedWidth*=(this.texXmax-this.texXmin)/(m-_),this.computedHeight*=(this.texYmax-this.texYmin)/(g-y),this.anchorX*=u/this.computedWidth,this.anchorY*=l/this.computedHeight}}const no={isSDF:0,isMapAligned:1,scaleSymbolsProportionally:2,overrideOutlineColor:3,colorLocked:4},oo=3.14159265359/180,ao=128/Math.PI;function co(e){return function(e,t){return e%=t,Math.abs(e>=0?e:e+t)}(e*ao,256)}const uo={createComputedParams:e=>io.from(e),attributes:{pos:{type:ze.g.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:ze.g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:ze.g.UNSIGNED_BYTE,count:1,pack:e=>{let{sprite:t,alignment:r,scaleSymbolsProportionally:s,overrideOutlineColor:i,colorLocked:n}=e,o=0;return t.sdf&&(o|=je(no.isSDF)),r===Ze.v2.MAP&&(o|=je(no.isMapAligned)),s&&(o|=je(no.scaleSymbolsProportionally)),i&&(o|=je(no.overrideOutlineColor)),n&&(o|=je(no.colorLocked)),o}},zoomRange:{type:ze.g.SHORT,count:2,packPrecisionFactor:f.JS,pack:(e,t)=>{let{scaleInfo:r}=e,{tileInfo:s}=t;return Ye(r,s)}},offset:{type:ze.g.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:e=>{let{angle:t,computedWidth:r,computedHeight:s,anchorX:i,anchorY:n,offsetX:o,offsetY:a,rotateClockwise:c}=e;const u=function(e,t,r,s){let i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const n=(0,gn.Ue)(),o=i?1:-1;return e?(0,mn.Us)(n,o*oo*e):(0,mn.yR)(n),(t||r)&&(0,mn.Iu)(n,n,[t,-r]),s&&(0,mn.U1)(n,n,o*oo*-s),n}(0,o,a,-t,c),l=-(.5+i)*r,h=-(.5-n)*s,d=[l,h],p=[l+r,h],f=[l,h+s],_=[l+r,h+s];return(0,so.iu)(d,d,u),(0,so.iu)(p,p,u),(0,so.iu)(f,f,u),(0,so.iu)(_,_,u),[d,p,f,_]}}},textureUV:{type:ze.g.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:e=>{let{texXmax:t,texXmin:r,texYmax:s,texYmin:i}=e;return[[r,i],[t,i],[r,s],[t,s]]}}},color:{type:ze.g.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{color:t}=e;return He(t)}},outlineColor:{type:ze.g.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{outlineColor:t}=e;return He(t)}},sizing:{type:ze.g.UNSIGNED_BYTE,count:4,pack:e=>{let{rawWidth:t,rawHeight:r,outlineSize:s,referenceSize:i}=e;return[Xe(Math.max(t,r),128),Xe(s,128),Xe(i,128),0]}},placementAngle:{type:ze.g.UNSIGNED_BYTE,count:1,packTessellation:e=>{let{placementAngle:t}=e;return co(t)}},sizeRatio:{type:ze.g.UNSIGNED_SHORT,count:1,packPrecisionFactor:64,pack:e=>{let{sizeRatio:t}=e;return t}}}};const lo={createComputedParams:e=>e,attributes:{pos:{type:ze.g.SHORT,count:2,packPrecisionFactor:10,pack:"position"},id:{type:ze.g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:ze.g.UNSIGNED_BYTE,count:1,pack:e=>0},offset:{type:ze.g.SHORT,count:2,packPrecisionFactor:16,packAlternating:{count:4,pack:e=>{let{size:t}=e;const r=(0,l.F2)(t),s=-r/2,i=-r/2;return[[s,i],[s+r,i],[s,i+r],[s+r,i+r]]}}},texCoords:{type:ze.g.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:()=>[[0,1],[1,1],[0,0],[1,0]]}},size:{type:ze.g.UNSIGNED_BYTE,count:2,pack:e=>{let{size:t}=e;return[t,t]}},referenceSize:{type:ze.g.UNSIGNED_BYTE,count:1,pack:e=>{let{size:t}=e;return(0,l.F2)(t)}},zoomRange:{type:ze.g.UNSIGNED_BYTE,count:2,pack:(e,t)=>{let{scaleInfo:r}=e,{tileInfo:s}=t;return Ye(r,s)}}}};const ho=function(e){const t={};for(const r in e){const s={name:r,constructor:e[r]};t[r]=s}return t}({FillMeshWriter:et,DotDensityMeshWriter:class extends Ge{constructor(){super(...arguments),this.vertexSpec=Ue}createTesselationParams(e){return{inverseArea:1/e.readGeometryArea()}}},ComplexFillMeshWriter:class extends rt{constructor(){super(...arguments),this.vertexSpec=ft}},PatternFillMeshWriter:rt,OutlineFillMeshWriter:It,PatternOutlineFillMeshWriter:class extends It{constructor(){super(...arguments),this.vertexSpec=dn}_createOutlineWriter(e,t,r,s){return new fn(e,t,r,s)}_write(e,t,r){const s=r?.asOptimized()??t.readGeometryForDisplay(),i=this._clip(s);if(!i)return;const n=this.evaluatedMeshParams.sprite?.textureBinding;e.recordStart(this.instanceId,this.attributeLayout,n),this._writeGeometry(e,t,i),this._lineMeshWriter.writeLineVertices(e,Me.z.fromOptimizedCIM(i,"esriGeometryPolyline"),t),e.recordEnd()}ensurePacked(e,t,r){super.ensurePacked(e,t,r),this._lineMeshWriter.ensurePacked(e,t,r)}enqueueRequest(e,t,r){super.enqueueRequest(e,t,r),this._lineMeshWriter.enqueueRequest(e,t,r)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}},ComplexOutlineFillMeshWriter:class extends It{constructor(){super(...arguments),this.vertexSpec=un}_createOutlineWriter(e,t,r,s){return new hn(e,t,r,s)}_write(e,t,r){const s=r?.asOptimized()??t.readGeometryForDisplay(),i=this._clip(s);if(!i)return;const n=this.evaluatedMeshParams.sprite?.textureBinding;e.recordStart(this.instanceId,this.attributeLayout,n),this._writeGeometry(e,t,i),this._lineMeshWriter.writeLineVertices(e,Me.z.fromOptimizedCIM(i,"esriGeometryPolyline"),t),e.recordEnd()}ensurePacked(e,t,r){super.ensurePacked(e,t,r),this._lineMeshWriter.ensurePacked(e,t,r)}enqueueRequest(e,t,r){super.enqueueRequest(e,t,r),this._lineMeshWriter.enqueueRequest(e,t,r)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}},MarkerMeshWriter:class extends Ve{constructor(){super(...arguments),this.vertexSpec=uo}getBoundsInfo(){return this.evaluatedMeshParams.boundsInfo}_write(e,t,r){const s=this.evaluatedMeshParams.sprite?.textureBinding,i=t.getDisplayId();e.recordStart(this.instanceId,this.attributeLayout,s);const n=this.evaluatedMeshParams.minPixelBuffer,o=Math.max(this.evaluatedMeshParams.computedWidth,n),a=Math.max(this.evaluatedMeshParams.computedHeight,n),c=this.evaluatedMeshParams.offsetX,u=-this.evaluatedMeshParams.offsetY;if(null!=this.evaluatedMeshParams.placement)this._writePlacedMarkers(e,t,r,o,a);else if(r&&r.nextPath()){r.nextPoint();const t=r.x,s=r.y;e.recordBounds(t+c,s+u,o,a),this._writeQuad(e,i,t,s)}else if("esriGeometryPolygon"===t.geometryType){const r=t.readCentroidForDisplay();if(!r)return;const[s,n]=r.coords;e.recordBounds(s+c,n+u,o,a),this._writeQuad(e,i,s,n)}else if("esriGeometryPoint"===t.geometryType){const r=t.readXForDisplay(),s=t.readYForDisplay();e.recordBounds(r+c,s+u,o,a),this._writeQuad(e,i,r,s)}else{const r=t.readGeometryForDisplay();r?.forEachVertex(((t,r)=>{e.recordBounds(t+c,r+u,o,a),Math.abs(t)>Tn.L||Math.abs(r)>Tn.L||this._writeQuad(e,i,t,r)}))}e.recordEnd()}_writePlacedMarkers(e,t,r,s,i){const n=r??Me.z.fromFeatureSetReaderCIM(t)?.clone();if(!n)return;const o=Nn.getPlacement(n,-1,this.evaluatedMeshParams.placement,(0,l.F2)(1),e.id,Re());if(!o)return;const a=t.getDisplayId();let c=o.next();const u=this.evaluatedMeshParams.offsetX,h=-this.evaluatedMeshParams.offsetY;for(;null!=c;){const t=c.tx,r=-c.ty;if(Math.abs(t)>Tn.L||Math.abs(r)>Tn.L){c=o.next();continue}const n=-c.getAngle();e.recordBounds(t+u,r+h,s,i),this._writeQuad(e,a,t,r,n),c=o.next()}}_writeQuad(e,t,r,s,i){const n=e.vertexCount(),o=null==i?null:{placementAngle:i};this._writeVertex(e,t,r,s,o),e.indexWrite(n+0),e.indexWrite(n+1),e.indexWrite(n+2),e.indexWrite(n+1),e.indexWrite(n+3),e.indexWrite(n+2)}},PieChartMeshWriter:class extends Ve{constructor(){super(...arguments),this.vertexSpec=lo}_write(e,t){const r=t.getDisplayId(),s=this.evaluatedMeshParams.minPixelBuffer,i=Math.max((0,l.F2)(this.evaluatedMeshParams.size),s);let n,o;if("esriGeometryPoint"===t.geometryType)n=t.readXForDisplay(),o=t.readYForDisplay();else{const e=t.readCentroidForDisplay();if(!e)return;n=e?.coords[0],o=e?.coords[1]}e.recordStart(this.instanceId,this.attributeLayout),e.recordBounds(n,o,i,i);const a=e.vertexCount();this._writeVertex(e,r,n,o),e.indexWrite(a+0),e.indexWrite(a+1),e.indexWrite(a+2),e.indexWrite(a+1),e.indexWrite(a+3),e.indexWrite(a+2),e.recordEnd()}},TextMeshWriter:Jn,LineMeshWriter:xt,TexturedLineMeshWriter:class extends xt{constructor(e,t,r,s){super(e,t,r,s),this.vertexSpec=ro,this._tessellationOptions.textured=!0}_write(e,t,r){const s=r??Me.z.fromFeatureSetReaderCIM(t);if(!s)return;const{sprite:i}=this.evaluatedMeshParams;this._writeGeometry(e,t,s,i?.textureBinding)}},HeatmapMeshWriter:class extends Ve{constructor(){super(...arguments),this.vertexSpec=_n}_write(e,t){e.recordStart(this.instanceId,this.attributeLayout);const r=t.getDisplayId();if("esriGeometryPoint"===t.geometryType){const s=t.readXForDisplay(),i=t.readYForDisplay();this._writeQuad(e,r,s,i)}else if("esriGeometryMultipoint"===t.geometryType){const s=t.readGeometryForDisplay();s?.forEachVertex(((t,s)=>{t>=0&&t<=512&&s>=0&&s<=512&&this._writeQuad(e,r,t,s)}))}e.recordEnd()}_writeQuad(e,t,r,s){const i=e.vertexCount();this._writeVertex(e,t,r,s),e.indexWrite(i+0),e.indexWrite(i+1),e.indexWrite(i+2),e.indexWrite(i+1),e.indexWrite(i+3),e.indexWrite(i+2)}},LabelMeshWriter:class extends Jn{constructor(){super(...arguments),this._zoomLevel=0}_write(e,t,r,s){if(this._zoomLevel=s||0,null!=r)throw new Error("InternalError: EffectGeometry not support for LabelMeshWriter");switch(t.geometryType){case"esriGeometryPoint":{const r=t.readXForDisplay(),s=t.readYForDisplay();return this._writePoint(e,r,s,t)}case"esriGeometryEnvelope":case"esriGeometryPolygon":case"esriGeometryMultipoint":{const r=t.readCentroidForDisplay();if(!r)return;const[s,i]=r.coords;return this._writePoint(e,s,i,t)}case"esriGeometryPolyline":{const r=t.readLegacyGeometryForDisplay();this._writeLines(e,t,r)}}}_writePoint(e,t,r,s){const i=this._getShaping();if(!i)return;let n=this._getPointReferenceBounds();n||(n={offsetX:0,offsetY:0,size:0});const o=i.boundsT,a=(0,xn.kH)(this.evaluatedMeshParams.horizontalAlignment),c=(0,xn.b7)(this.evaluatedMeshParams.verticalAlignment),u=this.evaluatedMeshParams.scaleInfo?.maxScale??0,l=this.evaluatedMeshParams.scaleInfo?.minScale??0,h=wn(s.getDisplayId());e.metricStart(new Sn(h,t,r,a,c,u,l,n)),e.metricBoxWrite(o),this._writeGlyphs(e,s.getDisplayId(),t,r,i,0,n),e.metricEnd()}_getPointReferenceBounds(){if(!this._references)return null;for(const e of this._references){const t=e.getBoundsInfo();if(t)return t}return null}_writeLines(e,t,r){const{repeatLabel:s,scaleInfo:i}=this.evaluatedMeshParams,n=this.evaluatedMeshParams.repeatLabelDistance||128,o=this._getShaping();if(!o)return;this._current={out:e,id:t.getDisplayId(),shaping:o,zoomRange:Ye(i,this.getTileInfo()),referenceBounds:this._getPointReferenceBounds()||{offsetX:0,offsetY:0,size:0}};const a=function(e,t){const r=t;for(let s=0;s<e.length;s++){let t=e[s];zn(t,r);const i=[];i.push(t[0]);for(let e=1;e<t.length;e++){const[r,s]=t[e-1],[n,o]=t[e],a=n-r,c=o-s;i.push([a,c])}e[s]=i,t=i}return e}(r.paths,o.bounds.width),c=this._placeSubdivGlyphs.bind(this),u=(o.bounds.width+n)/2;for(const l of a)On(l,u,c,!!s)}_placeSubdivGlyphs(e,t,r,s){const{allowOverrun:i,labelPosition:n,repeatLabelDistance:o}=this.evaluatedMeshParams,a=this._current.zoomRange[0],c=to(t),u=this._current.shaping.bounds.width/2,l=Math.sqrt(o||128)/2,h=Math.min(r,s-r),d=this._current.shaping.isMultiline?28:Math.log2(h/(l+u/2)),p=0===t?d:Math.min(c,d),f=Math.max(a,this._zoomLevel+1-p),_=this._zoomLevel-f,y=this._current.shaping.bounds.width/2*2**_;this._current.shaping.isMultiline?0===t&&this._placeStraight(e,f):i&&_<0?this._placeStraightAlong(e,a):"parallel"===n?this._placeStraightAlong(e,f):"curved"===n&&this._placeCurved(e,f,y)}_placeStraight(e,t){const{out:r,id:s,shaping:i,referenceBounds:n}=this._current,{x:o,y:a}=e,c=wn(s),u=this.evaluatedMeshParams.scaleInfo?.maxScale??0,l=this.evaluatedMeshParams.scaleInfo?.minScale??0;r.metricStart(new Sn(c,e.x,e.y,0,0,u,l,null)),r.metricBoxWrite(i.boundsT);const h=e.angle*(180/Math.PI)%360,d=(e.angle*(180/Math.PI)+180)%360;this._writeGlyphs(r,s,o,a,i,0,n,{clipAngle:h,mapAligned:!0,isLineLabel:!0,minZoom:t}),this._writeGlyphs(r,s,o,a,i,0,n,{clipAngle:d,mapAligned:!0,isLineLabel:!0,minZoom:t}),r.metricEnd()}_placeCurved(e,t,r){const{out:s,id:i}=this._current,n=e.clone(),o=e.angle*(180/Math.PI)%360,a=(e.angle*(180/Math.PI)+180)%360,c=wn(i),u=this.evaluatedMeshParams.scaleInfo?.maxScale??0,l=this.evaluatedMeshParams.scaleInfo?.minScale??0;s.metricStart(new Sn(c,e.x,e.y,0,0,u,l,null)),this._placeFirst(n,t,1,o),this._placeBack(e,n,t,r,1,o),this._placeForward(e,n,t,r,1,o),this._placeFirst(n,t,0,a),this._placeBack(e,n,t,r,0,a),this._placeForward(e,n,t,r,0,a),s.metricEnd()}_placeStraightAlong(e,t){const{out:r,id:s,shaping:i,zoomRange:n,referenceBounds:o}=this._current,{boxBorderLineColor:a,boxBackgroundColor:c}=this.evaluatedMeshParams,u=e.clone(),l=e.angle*(180/Math.PI)%360,h=(e.angle*(180/Math.PI)+180)%360;if(i.glyphs.length>0&&(a||c)){const a=Math.max(t,n[0],0),c=Math.min(28,n[1]),u=(0,mn.Us)((0,gn.Ue)(),-e.angle),[d,p]=i.shapeBackground(u),f={minZoom:a,maxZoom:c,clipAngle:l,mapAligned:!0,isLineLabel:!0};r.recordStart(this.instanceId,this.attributeLayout,i.glyphs[0].textureBinding),this._writeTextBox(r,s,e.x,e.y,p,o,f),r.recordEnd(),f.clipAngle=h,r.recordStart(this.instanceId,this.attributeLayout,i.glyphs[0].textureBinding),this._writeTextBox(r,s,e.x,e.y,p,o,f),r.recordEnd()}const d=wn(s),p=this.evaluatedMeshParams.scaleInfo?.maxScale??0,f=this.evaluatedMeshParams.scaleInfo?.minScale??0;r.metricStart(new Sn(d,e.x,e.y,0,0,p,f,null)),this._placeFirst(u,t,1,l,!0),this._placeFirst(u,t,0,h,!0),r.metricEnd()}_placeBack(e,t,r,s,i,n){const o=e.clone();let a=e.backwardLength+0;for(;o.prev()&&!(a>=s);)this._placeOnSegment(o,t,a,r,-1,i,n),a+=o.length+0}_placeForward(e,t,r,s,i,n){const o=e.clone();let a=e.remainingLength+0;for(;o.next()&&!(a>=s);)this._placeOnSegment(o,t,a,r,1,i,n),a+=o.length+0}_placeFirst(e,t,r,s){let i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const n=e,{out:o,id:a,shaping:c,zoomRange:u,referenceBounds:l}=this._current,h=c.glyphs;for(const d of h){const h=d.x>c.bounds.x?r:1-r,p=h*e.remainingLength+(1-h)*e.backwardLength,f=Math.abs(d.x+d.width/2-c.bounds.x),_=Math.max(0,this._zoomLevel+Math.log2(f/(p+0))),y=Math.max(t,i?0:_);d.maxZoom=Math.min(u[1],28),d.angle=e.angle+(1-r)*Math.PI,d.minZoom=Math.max(u[0],y),this._writeLineGlyph(o,a,n.x,n.y,c.bounds,d,s,l,!0),r&&this._isVisible(d.minZoom,d.maxZoom)&&o.metricBoxWrite(d.bounds)}}_placeOnSegment(e,t,r,s,i,n,o){const{out:a,id:c,shaping:u,referenceBounds:l}=this._current,h=u.glyphs,d=e.dx/e.length,p=e.dy/e.length,f={x:e.x+r*-i*d,y:e.y+r*-i*p};for(const _ of h){const h=_.x>u.bounds.x?n:1-n;if(!(h&&1===i||!h&&-1===i))continue;const d=Math.abs(_.x+_.width/2-u.bounds.x),p=Math.max(0,this._zoomLevel+Math.log2(d/r)-.1),y=Math.max(s,this._zoomLevel+Math.log2(d/(r+e.length+0)));if(0!==p&&(_.angle=e.angle+(1-n)*Math.PI,_.minZoom=y,_.maxZoom=p,this._writeLineGlyph(a,c,f.x,f.y,u.bounds,_,o,l,!0),n&&this._isVisible(_.minZoom,_.maxZoom))){const r=_.bounds,s=e.x-t.x,i=e.y-t.y,n=new In.Z(r.center[0]+s,r.center[1]+i,r.width,r.height);a.metricBoxWrite(n)}}}_writeLineGlyph(e,t,r,s,i,n,o,a,c){const u=r+i.x,l=s+i.y,h=2*(this.evaluatedMeshParams.minPixelBuffer?this.evaluatedMeshParams.minPixelBuffer/this._textMeshTransformProps.fontSize:1),d=Math.max(i.width,i.height)*h;e.recordStart(this.instanceId,this.attributeLayout,n.textureBinding),e.recordBounds(u,l,d,d);const{texcoords:p,offsets:f}=n,_=this._textMeshTransformProps.fontSize;this._writeQuad(e,t,r,s,{texcoords:p,offsets:f,fontSize:_,color:He(this.evaluatedMeshParams.color),isBackground:!1,referenceBounds:a,minZoom:Math.max(this._current.zoomRange[0],n.minZoom),maxZoom:Math.min(this._current.zoomRange[1],n.maxZoom),clipAngle:o,mapAligned:c,isLineLabel:!0}),e.recordEnd()}_isVisible(e,t){const r=this._zoomLevel;return e<=r&&r<=t}}});async function po(e,t,r,s){return Promise.all(r.map((r=>async function(e,t,r,s,i,n,o){const a=ho[r],c=await Y.create(e,t,i),u=new a.constructor(s,c,n,o);return await u.loadDependencies(),u}(e,t,r.meshWriterName,r.id,r.options,s,r.optionalAttributes))))}class fo{constructor(){this._defaultResult=null,this._backgroundFillResult=null}static async from(e,t,r,s){const i=new fo;return i.setDefault(await po(e,t,r.meshes,s)),i}size(){return 1}getDefault(){return this._defaultResult}setDefault(e){this._defaultResult=e}getBackgroundFill(){return this._backgroundFillResult}setBackgroundFill(e){this._backgroundFillResult=e}match(e,t){const r=this.doMatch(e,t)||this.getDefault();if(r&&r.length>0){const e=this.getBackgroundFill();if(e)return[...e,...r]}return r}getSortKey(e,t){return 0}doMatch(e,t){return null}async fetchResources(e,t){}}class _o extends fo{static async fromDictionaryRenderer(e,t,r){return new _o(e,t,r)}constructor(e,t,r){super(),this._storage=e,this._schema=t,this._viewParams=r,this._hashToGroup=new Map}get fieldMap(){return this._schema.fieldMap}async fetchResources(e,t){const r=t.getCursor(),s=[];for(;r.next();)s.push(this._updateMeshWriterGroup(e,r));await Promise.all(s)}match(e,t){const r=e.getAttributeHash();return this._hashToGroup.get(r)}async _updateMeshWriterGroup(e,t){const r=t.readLegacyFeatureForDisplay(),s=t.getAttributeHash();if(this._hashToGroup.has(s))return;this._hashToGroup.set(s,null);const i=await e.fetchDictionaryResourceImmediate({type:"dictionary-request",feature:r});if(!i)return;const n=await po(this._storage,e,i.meshes,this._viewParams);this._hashToGroup.set(s,n)}}class yo extends fo{constructor(e,t){super(),this._intervals=[],this._isMaxInclusive=t,this._field=e}static async fromIntervalSchema(e,t,r,s){const i=await e.createComputedField(r),n=new yo(i,r.isMaxInclusive);await Promise.all(r.intervals.map((async r=>{const i=await po(e,t,r.meshes,s);n.add(r,i)})));const o=await po(e,t,r.defaultSymbol,s);n.setDefault(o);const a=await po(e,t,r.backgroundFill,s);return n.setBackgroundFill(a),n}add(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort(((e,t)=>e.interval.min-t.interval.min))}size(){return super.size()+this._intervals.length}doMatch(e,t){const r=this._field?.read(e,t);if(null==r||isNaN(r)||r===1/0||r===-1/0)return null;for(let s=0;s<this._intervals.length;s++){const{interval:e,result:t}=this._intervals[s],i=r>=e.min,n=this._isMaxInclusive?r<=e.max:r<e.max;if(i&&n)return t}return null}}class mo extends fo{static async fromLabelSchema(e,t,r,s){const i=r.classes.map((async r=>{const i=await po(e,t,r.meshes,s);return{minScale:r.minScale,maxScale:r.maxScale,meshes:i,expression:null,where:await e.createWhereClause(r.where)}})),n=await Promise.all(i);return new mo(n)}constructor(e){super(),this._labels=e}match(e,t){if(!this._labels.length)return null;const r=this._getLabels(t.$view.scale),s=[];for(const i of r)i.where&&!i.where(e)||s.push(...i.meshes);return s}_getLabels(e){return this._labels.filter((t=>this._validForTileScale(t,e)))}_validForTileScale(e,t){const r=t-t/4,s=t+t/2;return(!e.minScale||e.minScale>=r)&&(!e.maxScale||e.maxScale<=s)}}class go extends fo{constructor(e,t){super(),this._defaultSymbolSortKey=0,this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fields=e,this._separator=t||""}static async fromMatcherSchema(e,t,r,s){const i=r.expression?[e.createComputedField({expression:r.expression})]:[r.field?e.createComputedField({field:r.field}):null,r.field2?e.createComputedField({field:r.field2}):null,r.field3?e.createComputedField({field:r.field3}):null],n=(await Promise.all(i)).filter((e=>!!e)),o=new go(n,r.fieldDelimiter),a=await po(e,t,r.defaultSymbol,s);o.setDefault(a);const c=await po(e,t,r.backgroundFill,s);return o.setBackgroundFill(c),await Promise.all(r.map.map((async(r,i)=>{const n=await po(e,t,r.symbol,s);"<Null>"===r.value?o.setNullResult(n):o.add(r.value,n,i+1)}))),o}setNullResult(e){this._nullResult=e}getSortKey(e,t){const r=this._getValueFromFields(e,t);if(null==r||""===r||"<Null>"===r)return 0;const s=this._resultsMap.get(r.toString());return s?s.sortKey:this._defaultSymbolSortKey}add(e,t,r){this._resultsMap.set(e.toString(),{meshWriters:t,sortKey:r}),this._defaultSymbolSortKey=Math.max(this._defaultSymbolSortKey,r+1)}size(){return super.size()+this._resultsMap.size}doMatch(e,t){const r=this._getValueFromFields(e,t);if(null!==this._nullResult&&(null==r||""===r||"<Null>"===r))return this._nullResult;if(null==r)return null;const s=r.toString();return this._resultsMap.get(s)?.meshWriters}_getValueFromFields(e,t){const r=[];for(const s of this._fields){const i=s.read(e,t);null==i||""===i?r.push("<Null>"):r.push(i)}return r.join(this._separator)}}async function xo(e,t,r,s){switch(r.type){case"simple":case"heatmap":case"dot-density":case"pie-chart":return fo.from(e,t,r,s);case"interval":return yo.fromIntervalSchema(e,t,r,s);case"dictionary":return _o.fromDictionaryRenderer(e,r,s);case"label":return mo.fromLabelSchema(e,t,r,s);case"map":return go.fromMatcherSchema(e,t,r,s);case"subtype":return bo.fromSubtypes(e,t,r,s);case"cluster":return vo.fromClusterSchema(e,t,r,s);default:throw new Error("Impl")}}class bo extends fo{constructor(e,t){super(),this._subMatchers=e,this._subtypeField=t}static async fromSubtypes(e,t,r,s){const i=new Map,n=[];for(const o in r.renderers){const a=parseInt(o,10),c=xo(e,t,r.renderers[o],s).then((e=>i.set(a,e)));n.push(c)}return await Promise.all(n),new bo(i,r.subtypeField)}match(e,t){const r=e.readAttribute(this._subtypeField),s=this._subMatchers.get(r);return s?s.match(e,t):null}}class vo extends fo{static async fromClusterSchema(e,t,r,s){const[i,n]=await Promise.all([xo(e,t,r.feature,s),xo(e,t,r.cluster,s)]);return new vo(i,n)}constructor(e,t){super(),this._featureMatcher=e,this._clusterMatcher=t}match(e,t){return 1===e.readAttribute("cluster_count")?this._featureMatcher.match(e,t):this._clusterMatcher.match(e,t)}}class wo extends C{static async create(e,t,r,s){const i=await xo(e,t,r.symbology,s),n=r.labels?await xo(e,t,r.labels,s):null;return new wo(i,n)}constructor(e,t){super(),this._symbology=e,this._labels=t}destroy(){}async enqueueMatcherRequests(e,t){await Promise.all([this._symbology.fetchResources(e,t),this._labels?.fetchResources(e,t)])}enqueueWriterRequests(e,t,r){const s=this._symbology.match(t,r);if(s){for(const i of s)i.enqueueRequest(e,t,r);if(this._labels){const s=this._labels.match(t,r);if(!s)return;for(const i of s)i.enqueueRequest(e,t,r)}}}write(e,t,r,s,i){const n=this._symbology.match(r,s);if(n){for(const o of n)o.write(e,t,r,s,i);if(e.entityRecordCount()>=1&&this._labels){const o=this._labels.match(r,s);if(!o)return;for(const a of o)a.setReferences(n),a.write(e,t,r,s,i)}}}getSortKey(e,t){return this._symbology.getSortKey(e,t)}}class Io{}class So extends Io{constructor(e){super(),this._fetcher=e,this._controller=new AbortController,this._pendingIds=new Set,this._pendingRequests=[],this._resourceIdToResource=new Map}destory(){this._controller.abort()}get _abortOptions(){return{signal:this._controller.signal}}enqueueRequest(e){const t=function(e){return"url"in e&&"urlHash"in e?{...e,url:""}:e}(e.resource),r=(0,O.hP)(JSON.stringify(t));return this._pendingIds.has(r)||(this._pendingIds.add(r),this._pendingRequests.push({...e,resourceId:r})),r}async fetchEnqueuedResources(){const e=this._pendingRequests;this._pendingIds.clear(),this._pendingRequests=[];const t=await this._fetcher.fetch(e,this._abortOptions);for(let r=0;r<t.length;r++){const s=e[r].resourceId;this._resourceIdToResource.set(s,t[r])}}async fetchResourceImmediate(e){const t=await this._fetcher.fetch([e],this._abortOptions);if(1!==t.length)throw new Error("FeaturePipelineResourceProxy: failed to fetch resources");return t[0]}async fetchDictionaryResourceImmediate(e){const t=await this._fetcher.fetchDictionary([e],this._abortOptions);if(1!==t.length)throw new Error("FeaturePipelineResourceProxy: failed to fetch dictionary resources");return t[0]}getResource(e){return this._resourceIdToResource.get(e)}}var To=r(38164);class Mo{constructor(e){this._outstandingMessages=[],this._queue=new To.e({concurrency:e.concurrency,process:t=>e.process(t)})}async push(e){if(e.end)return await Promise.all(this._outstandingMessages),await this._queue.push(e),void(this._outstandingMessages=[]);const t=this._queue.push(e);return this._outstandingMessages.push(t),t}}r(59486);var ko=r(84683),Fo=r(83406),Eo=r(3182),Co=r(19995);class Po{static async create(e,t){if("count"===t.statisticType){const e=new G(1);return new Po(t.name,t.alias,t.type,t.statisticType,e)}const r=await e.createComputedField({expression:t.onStatisticExpression?.expression,field:t.onStatisticField});return new Po(t.name,t.alias,t.type,t.statisticType,r)}constructor(e,t,r,s,i){this.name=e,this.alias=t,this.type=r,this.statisticType=s,this.computed=i}}var Ao=r(91505),Ro=r(41414),Oo=r(77835),zo=r(75878);class Do{constructor(e){this.subscription=e,this.handledChunks=new Set}destroy(){}}class No{constructor(e,t){this._source=e,this._attributeStore=t,this._sendStates=new Map}destroy(){}get enablePixelBuffering(){return!0}onSubscribe(e){const t=this.createState(e);this._sendStates.set(e.key.id,t),this.updateChunks()}onUnsubscribe(e){this._sendStates.get(e.key.id)?.destroy(),this._sendStates.delete(e.key.id)}invalidate(){const e=Array.from(this._sendStates.values());this._sendStates.clear();for(const t of e)t.destroy(),this.onSubscribe(t.subscription)}invalidateAttributeData(){}getFeatureObjectIdsForAggregate(e){throw new Error("InternalError: AggregateId lookup not supported")}getDisplayIds(e){return this.displayMap(e,(e=>e),(e=>e))}getDisplayAndObjectIds(e){return this.displayMap(e,(e=>e),((e,t,r)=>[e,r]))}afterUpdateChunks(){}}class Bo extends No{constructor(e,t,r,s){super(e,t),this.spatialReference=r,this.aggregateFields=s,this.events=new Ao.Z,this.featureAdapter=Oo.n}get aggregateQueryEngine(){return this._aggregateQueryEngine||(this._aggregateQueryEngine=new zo.q({featureStore:this,fieldsIndex:this._metadata.fieldsIndex,geometryType:this._metadata.geometryType,objectIdField:this._metadata.objectIdField,spatialReference:this.spatialReference})),this._aggregateQueryEngine}removeChunks(e){}forEach(e){return this.forEachAggregateWorldSpace(e)}forEachInBounds(e,t){}forEachBounds(e,t){const r=(0,Ro.Ue)();for(const s of e){const e=(0,Fo.$)(r,s.geometry,!1,!1);e&&t(e)}}}class Vo{constructor(e,t,r,s,i){this.subscription=e,this.reader=t,this.clear=r,this.end=s,this.debugInfo=i,this.type="append"}get id(){return this.subscription.tile.id}createMessage(e,t,r){return{type:"append",clear:this.clear,id:this.id,append:e,end:this.end,debugInfo:this.debugInfo,subscriptionVesrion:this.subscription.version,version:t,attributeEpoch:r}}}class Lo{constructor(e,t,r,s,i){this.subscription=e,this.reader=t,this.remove=r,this.end=s,this.debugInfo=i,this.type="update"}get id(){return this.subscription.tile.id}createMessage(e,t,r){return{type:"update",id:this.id,modify:e,debugInfo:this.debugInfo,remove:this.remove,version:t,subscriptionVesrion:this.subscription.version,end:this.end,attributeEpoch:r}}}class Go extends L{constructor(e){super(),this._field=e}resize(e){throw new Error("Method not implemented.")}read(e,t){return e.readAttribute(this._field)}readWithDefault(e,t){return e.readAttribute(this._field)}referencesScale(){return!1}referencesGeometry(){return!1}}var Uo=r(819);function qo(e,t,r){if(null==e)return null;const s=t.readArcadeFeature();t.contextTimeZone=r.$view?.timeZone;try{return e.evaluate({...r,$feature:s},e.services)}catch(i){return R.Z.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",i),null}}function Wo(e){return null==e||e===1/0||e===-1/0||"number"==typeof e&&isNaN(e)}function Zo(e,t,r,s){if(null==e)return null!=s?s:null;const i=t.readArcadeFeature();t.contextTimeZone=r.$view?.timeZone;const n=e.evaluate({...r,$feature:i},e.services);return Wo(n)?null!=s?s:null:n}class Yo extends L{static async create(e,t){const r=await(0,Uo.Yi)(e,t.spatialReference,t.fields),s=(0,O.hP)(e);return new Yo(r,s)}constructor(e,t){super(),this._compiled=e,this._cacheKey=t}resize(e){}read(e,t){return this.referencesScale()||"system"!==t.$view.timeZone?qo(this._compiled,e,t):this._readCached(e,t)}readWithDefault(e,t,r){return this.referencesScale()||"system"!==t.$view.timeZone?Zo(this._compiled,e,t,r):this._readWithDefaultCached(e,t,r)}referencesScale(){return this._compiled?.referencesScale()??!1}referencesGeometry(){return this._compiled?.referencesGeometry()??!1}_readCached(e,t){if(e.setCache(this._cacheKey),e.hasCachedValue())return e.getCachedValue();const r=qo(this._compiled,e,t);return e.setCachedValue(r),r}_readWithDefaultCached(e,t,r){if(e.setCache(this._cacheKey),e.hasCachedValue())return e.getCachedValue();const s=Zo(this._compiled,e,t,r);return e.setCachedValue(s),s}}var jo=r(16553),$o=r(93253);class Ho extends L{static async create(e,t){const r=(0,$o.UG)(e);return new Ho((e=>r.replaceAll(/{[^}]*}/g,(t=>{const r=t.slice(1,-1),s=e.metadata.fieldsIndex.get(r);if(null==s)return t;const i=e.readAttribute(r);return null==i?"":(0,jo.B)(i,s)}))))}constructor(e){super(),this._evaluator=e}resize(e){}read(e,t){return this._evaluator(e)}readWithDefault(e,t,r){const s=this._evaluator(e);return Wo(s)?r:s}referencesScale(){return!1}referencesGeometry(){return!1}}class Xo extends L{constructor(e,t){super(),this._field=e,this._normalizationInfo=t}resize(e){throw new Error("Method not implemented.")}read(e,t){return this._readNormalized(e)}readWithDefault(e,t){return this._readNormalized(e)}referencesScale(){return!1}referencesGeometry(){return!1}_readNormalized(e){const t=e.readAttribute(this._field);if(null==t)return null;const{normalizationField:r,normalizationTotal:s,normalizationType:i}=this._normalizationInfo,n=e.readAttribute(r);switch(i??"esriNormalizeByField"){case"esriNormalizeByField":return n?n?t/n:void 0:null;case"esriNormalizeByLog":return Math.log(t)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return s?t/s*100:null}}}class Ko{static fromBuffer(e,t){return new Ko(e,t)}static create(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4294967295;const r=new Uint32Array(Math.ceil(e/32));return new Ko(r,t)}constructor(e,t){this._mask=0,this._buf=e,this._mask=t}_getIndex(e){return Math.floor(e/32)}has(e){const t=this._mask&e;return!!(this._buf[this._getIndex(t)]&1<<t%32)}hasRange(e,t){let r=e,s=t;for(;r%32&&r!==s;){if(this.has(r))return!0;r++}for(;s%32&&r!==s;){if(this.has(r))return!0;s--}if(r===s)return!1;for(let i=r/32;i!==s/32;i++)if(this._buf[i])return!0;return!1}set(e){const t=this._mask&e,r=this._getIndex(t),s=1<<t%32;this._buf[r]|=s}setRange(e,t){let r=e,s=t;for(;r%32&&r!==s;)this.set(r++);for(;s%32&&r!==s;)this.set(s--);if(r!==s)for(let i=r/32;i!==s/32;i++)this._buf[i]=4294967295}unset(e){const t=this._mask&e,r=this._getIndex(t),s=1<<t%32;this._buf[r]&=4294967295^s}resize(e){const t=this._buf,r=new Uint32Array(Math.ceil(e/32));r.set(t),this._buf=r}or(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=e._buf[t];return this}and(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=e._buf[t];return this}xor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=e._buf[t];return this}ior(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=~e._buf[t];return this}iand(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=~e._buf[t];return this}ixor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=~e._buf[t];return this}any(){for(let e=0;e<this._buf.length;e++)if(this._buf[e])return!0;return!1}copy(e){for(let t=0;t<this._buf.length;t++)this._buf[t]=e._buf[t];return this}clone(){return new Ko(this._buf.slice(),this._mask)}clear(){for(let e=0;e<this._buf.length;e++)this._buf[e]=0;return this}forEachSet(e){for(let t=0;t<this._buf.length;t++){let r=this._buf[t],s=32*t;if(r)for(;r;)1&r&&e(s),r>>>=1,s++}}countSet(){let e=0;return this.forEachSet((t=>{e++})),e}}var Qo=r(76672);const Jo=()=>R.Z.getLogger("esri.views.2d.layers.features.support.whereUtils"),ea={getAttribute:(e,t)=>e.readAttribute(t)};async function ta(e,t){try{const r=await(0,Qo.E)(e,t);if(!r.isStandardized){const e=new s.Z("mapview - bad input","Unable to apply filter's definition expression, as expression is not standardized.",r);Jo().error(e)}return s=>{const i=s.readArcadeFeature();try{return r.testFeature(i,ea)}catch(t){return Jo().warn("mapview-bad-where-clause","Encountered an error when evaluating where clause",e),!0}}}catch(w){return Jo().warn("mapview-bad-where-clause","Encountered an error when evaluating where clause",e),e=>!0}}const ra=()=>R.Z.getLogger("esri.views.2d.layers.features.support.ComputedAttributeStorage"),sa=4294967295;function ia(e,t,r){if(!(e.length>t))for(;e.length<=t;)e.push(r)}class na{constructor(e){this._numerics=[],this._strings=[],this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[],this._dirtyBitset=this.getBitset(this.createBitset()),this.compilationOptions=e}createBitset(){const e=this._bitsets.length;return this._bitsets.push(Ko.create(this._allocatedSize,bn)),e+1}async createComputedField(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.expression)try{if(!this.compilationOptions)throw new Error("InternalError: Compilation options not defined");return t?Ho.create(e.expression,this.compilationOptions):await Yo.create(e.expression,this.compilationOptions)}catch(i){const t=new s.Z("featurelayer","Failed to compile arcade expression",{error:i,expression:e.expression});return ra().error(t),null}if(e.normalizationType||e.normalizationField)return new Xo(e.field,e);if(e.field)return new Go(e.field);const r=new s.Z("featurelayer","Unable to create computed field. No expression or field found",{info:e});return ra().error(r),null}async createWhereClause(e){return e?ta(e,this.compilationOptions.fields):null}getBitset(e){return this._bitsets[e-1]}getComputedNumeric(e,t){return this.getComputedNumericAtIndex(e&bn,0)}setComputedNumeric(e,t,r){return this.setComputedNumericAtIndex(e&bn,r,0)}getComputedString(e,t){return this.getComputedStringAtIndex(e&bn,0)}setComputedString(e,t,r){return this.setComputedStringAtIndex(e&bn,0,r)}getComputedNumericAtIndex(e,t){const r=e&bn;return this._ensureNumeric(t,r),this._numerics[t][r]}setComputedNumericAtIndex(e,t,r){const s=e&bn;this._ensureNumeric(t,s),this._numerics[t][s]=r}getPackedChunkId(e){const t=e&bn;return this._ensureInstanceId(t),this._instanceIds[t]}setPackedChunkId(e,t){const r=e&bn;this._ensureInstanceId(r),this._instanceIds[r]=t}getComputedStringAtIndex(e,t){const r=e&bn;return this._ensureString(t,r),this._strings[t][r]}setComputedStringAtIndex(e,t,r){const s=e&bn;this._ensureString(t,s),this._strings[t][s]=r}getXMin(e){return this._bounds[4*(e&bn)]}getYMin(e){return this._bounds[4*(e&bn)+1]}getXMax(e){return this._bounds[4*(e&bn)+2]}getYMax(e){return this._bounds[4*(e&bn)+3]}setBounds(e,t){const r=e&bn;if(!(arguments.length>2&&void 0!==arguments[2]&&arguments[2])&&!this._dirtyBitset.has(e))return this._bounds[4*r]!==sa;this._dirtyBitset.unset(e);const s=t.readGeometryWorldSpace();if(ia(this._bounds,4*r+4,0),!s||!s.coords.length)return this._bounds[4*r]=sa,this._bounds[4*r+1]=sa,this._bounds[4*r+2]=sa,this._bounds[4*r+3]=sa,!1;let i=1/0,n=1/0,o=-1/0,a=-1/0;return s.forEachVertex(((e,t)=>{i=Math.min(i,e),n=Math.min(n,t),o=Math.max(o,e),a=Math.max(a,t)})),this._bounds[4*r]=i,this._bounds[4*r+1]=n,this._bounds[4*r+2]=o,this._bounds[4*r+3]=a,!0}getBounds(e,t){const r=this.getXMin(t),s=this.getYMin(t),i=this.getXMax(t),n=this.getYMax(t);return(0,Ro.bZ)(e,r,s,i,n),r!==sa}_ensureNumeric(e,t){this._numerics[e]||(this._numerics[e]=[]),ia(this._numerics[e],t,0)}_ensureInstanceId(e){ia(this._instanceIds,e,0)}_ensureString(e,t){this._strings[e]||(this._strings[e]=[]),ia(this._strings[e],t,null)}}var oa=r(65156),aa=r(376),ca=r(20994),ua=r(77095),la=r(20311),ha=r(21149);class da{getObjectId(e){return e.getObjectId()}getAttributes(e){return e.readAttributes()}getAttribute(e,t){return e.readAttribute(t)}getAttributeAsTimestamp(e,t){return e.readAttributeAsTimestamp(t)}cloneWithGeometry(e,t){return e}getGeometry(e){return e.readGeometryWorldSpace()}getCentroid(e,t){return e.readCentroidForDisplay()}}da.Shared=new da;class pa{constructor(e){this._geometryBounds=(0,oa.Ue)(),this._idToVisibility=new Map,this._serviceInfo=e}static async create(e){const t=new pa(e);return await t.update(e.filterJSON,e.spatialReference),t}get hash(){return this._hash}check(e){return this._applyFilter(e)}clear(){const e=this._resetAllHiddenIds();return this.update(),{show:e,hide:[]}}invalidate(){this._idToVisibility.forEach(((e,t)=>{this._idToVisibility.set(t,0)}))}setKnownIds(e){for(const t of e)this._idToVisibility.set(t,1)}setTrue(e){const t=[],r=[],s=new Set(e);return this._idToVisibility.forEach(((e,i)=>{const n=!!(1&this._idToVisibility.get(i)),o=s.has(i);!n&&o?t.push(i):n&&!o&&r.push(i),this._idToVisibility.set(i,o?3:0)})),{show:t,hide:r}}createQuery(){const{geometry:e,spatialRel:t,where:r,timeExtent:s,objectIds:i}=this;return ha.Z.fromJSON({geometry:e,spatialRel:t,where:r,timeExtent:s,objectIds:i})}async update(e,t){this._hash=JSON.stringify(e);const r=await(0,ca.j6)(e,null,t);await Promise.all([this._setGeometryFilter(r),this._setIdFilter(r),this._setAttributeFilter(r),this._setTimeFilter(r)])}async _setAttributeFilter(e){if(!e?.where)return this._clause=null,void(this.where=null);this._clause=await ta(e.where,this._serviceInfo.fieldsIndex),this.where=e.where}_setIdFilter(e){this._idsToShow=e?.objectIds&&new Set(e.objectIds),this._idsToHide=e?.hiddenIds&&new Set(e.hiddenIds),this.objectIds=e?.objectIds}async _setGeometryFilter(e){if(!e?.geometry)return this._spatialQueryOperator=null,this.geometry=null,void(this.spatialRel=null);const t=e.geometry,r=e.spatialRel||"esriSpatialRelIntersects",s=await(0,ua.cW)(r,t,this._serviceInfo.geometryType,this._serviceInfo.hasZ,this._serviceInfo.hasM);(0,aa.$P)(this._geometryBounds,t),this._spatialQueryOperator=s,this.geometry=t,this.spatialRel=r}_setTimeFilter(e){if(this.timeExtent=this._timeOperator=null,e?.timeExtent)if(this._serviceInfo.timeInfo)this.timeExtent=e.timeExtent,this._timeOperator=(0,la.y)(this._serviceInfo.timeInfo,e.timeExtent,da.Shared);else{const t=new s.Z("feature-layer-view:time-filter-not-available","Unable to apply time filter, as layer doesn't have time metadata.",e.timeExtent);R.Z.getLogger("esri.views.2d.layers.features.controllers.FeatureFilter").error(t)}}_applyFilter(e){return this._filterByGeometry(e)&&this._filterById(e)&&this._filterByTime(e)&&this._filterByExpression(e)}_filterByExpression(e){return!this.where||this._clause(e)}_filterById(e){return(!this._idsToHide?.size||!this._idsToHide.has(e.getObjectId()))&&(!this._idsToShow?.size||this._idsToShow.has(e.getObjectId()))}_filterByGeometry(e){if(!this.geometry)return!0;const t=e.readGeometryWorldSpace();return!!t&&this._spatialQueryOperator(t)}_filterByTime(e){return null==this._timeOperator||this._timeOperator(e)}_resetAllHiddenIds(){const e=[];return this._idToVisibility.forEach(((t,r)=>{1&t||(this._idToVisibility.set(r,1),e.push(r))})),e}}var fa=r(52410);class _a{constructor(e){this._options=e,this._fieldsIndex="fieldsIndex"in e?fa.Z.fromJSON(e.fieldsIndex):new fa.Z(e.fields),e.spatialReference&&(this._spatialReference=g.Z.fromJSON(e.spatialReference)),this._arcadeSchema={fields:this.fieldsIndex.fields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,objectIdField:this.objectIdField,globalIdField:this._options.globalIdField,spatialReference:this._spatialReference,timeInfo:this._options.timeInfo,typeIdField:this._options.typeIdField??void 0,types:this._options.types??void 0,subtypeField:this._options.subtypeField,subtypes:this._options.subtypes??void 0}}get fieldsIndex(){return this._fieldsIndex}get geometryType(){return this._options.geometryType}get timeInfo(){return this._options.timeInfo}get objectIdField(){return this._options.objectIdField}get globalIdField(){return this._options.globalIdField}get arcadeSchema(){return this._arcadeSchema}get spatialReference(){return this._spatialReference}get timeReferenceUnknownClient(){return this._options.timeReferenceUnknownClient}}var ya=r(51064),ma=r(84726),ga=r(58237),xa=r(36372),ba=r(85403),va=r(6701);class wa{constructor(e){this._valid=Ko.create(e),this._data=new Array(e)}has(e){return this._valid.has(e)}set(e,t){this._valid.set(e),this._data[e]=t}get(e){return this._data[e]}}var Ia=r(77981);const Sa=(0,n.Z)("featurelayer-simplify-thresholds")??[.5,.5,.5,.5],Ta=Sa[0],Ma=Sa[1],ka=Sa[2],Fa=Sa[3],Ea=(0,n.Z)("featurelayer-simplify-payload-size-factors")??[1,2,4],Ca=Ea[0],Pa=Ea[1],Aa=Ea[2],Ra=(0,n.Z)("featurelayer-simplify-mobile-factor")??2,Oa=(0,n.Z)("esri-mobile"),za=4294967295;class Da{constructor(e){this.metadata=e,this.type="FeatureSetReader",this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._boundsBuffer=[],this._caches=new Map,this.arcadeDeclaredClass="esri.arcade.Feature",this._contextTimeZone=null}get isEmpty(){return null!=this._deleted&&this._deleted.countSet()===this.getSize()}getAreaSimplificationThreshold(e,t){let r=1;const s=Oa?Ra:1;t>4e6?r=Aa*s:t>1e6?r=Pa*s:t>5e5?r=Ca*s:t>1e5&&(r=s);let i=0;return e>4e3?i=Fa*r:e>2e3?i=ka*r:e>100?i=Ma:e>15&&(i=Ta),i}parseTimestampOffset(e){return e}getBounds(e){if(function(e,t,r){if(!(e.length>t))for(;e.length<=t;)e.push(r)}(this._boundsBuffer,4*this.getIndex()+4,0),this.getBoundsXMin()===za)return!1;if(0===this.getBoundsXMin()){const t=this.readGeometryWorldSpace();if(!t)return this.setBoundsXMin(za),!1;let r=1/0,s=1/0,i=-1/0,n=-1/0;return t.forEachVertex(((e,t)=>{r=Math.min(r,e),s=Math.min(s,t),i=Math.max(i,e),n=Math.max(n,t)})),this.setBoundsXMin(r),this.setBoundsYMin(s),this.setBoundsXMax(i),this.setBoundsYMax(n),(0,Ro.bZ)(e,r,s,i,n),!0}const t=this.getBoundsXMin(),r=this.getBoundsYMin(),s=this.getBoundsXMax(),i=this.getBoundsYMax();return(0,Ro.bZ)(e,t,r,s,i),!0}getBoundsXMin(){return this._boundsBuffer[4*this.getIndex()]}setBoundsXMin(e){this._boundsBuffer[4*this.getIndex()]=e}getBoundsYMin(){return this._boundsBuffer[4*this.getIndex()+1]}setBoundsYMin(e){this._boundsBuffer[4*this.getIndex()+1]=e}getBoundsXMax(){return this._boundsBuffer[4*this.getIndex()+2]}setBoundsXMax(e){this._boundsBuffer[4*this.getIndex()+2]=e}getBoundsYMax(){return this._boundsBuffer[4*this.getIndex()+3]}setBoundsYMax(e){this._boundsBuffer[4*this.getIndex()+3]=e}readAttributeAsTimestamp(e){const t=this.readAttribute(e);return"string"==typeof t?new Date(t).getTime():"number"==typeof t||null==t?t:null}readAttribute(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const r=this._readAttribute(e,t);if(void 0!==r)return r;for(const s of this._joined){s.setIndex(this.getIndex());const r=s._readAttribute(e,t);if(void 0!==r)return r}}readAttributes(){const e=this._readAttributes();for(const t of this._joined){t.setIndex(this.getIndex());const r=t._readAttributes();for(const t of Object.keys(r))e[t]=r[t]}return e}joinAttributes(e){this._joined.push(e)}removeIds(e){if(null==this._objectIdToIndex){const e=new Map,t=this.getCursor();for(;t.next();){const r=t.getObjectId();(0,y.O3)(r),e.set(r,t.getIndex())}this._objectIdToIndex=e}const t=this._objectIdToIndex;for(const r of e.values())t.has(r)&&this._removeAtIndex(t.get(r))}readOptimizedFeatureWorldSpace(){const e=this.readGeometryWorldSpace(),t=this.readAttributes(),r=this.readCentroidWorldSpace(),s=new Eo.u_(e,t,r);return s.objectId=this.getObjectId(),s.displayId=this.getDisplayId(),s}readLegacyFeatureForDisplay(){const e=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null}}readLegacyFeatureWorldSpace(){const e=this.readCentroidWorldSpace();return{attributes:this.readAttributes(),geometry:this._readLegacyGeometryWorldSpace(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null}}readLegacyGeometryForDisplay(){const e=this.readGeometryForDisplay();return(0,Fo.di)(e,this.geometryType,!1,!1)}readXForDisplay(){return this._readX()}readYForDisplay(){return this._readY()}readXWorldSpace(){const e=this._readX(),t=this.getInTransform();return null==t?e:e*t.scale[0]+t.translate[0]}readYWorldSpace(){const e=this._readY(),t=this.getInTransform();return null==t?e:t.translate[1]-e*t.scale[1]}readGeometryForDisplay(){const e=this._readGeometryDeltaDecoded(!0);if(!e){const e=this._createGeometryFromServerCentroid();return e?e.deltaDecode():null}return e}readGeometryWorldSpace(){let e=this._readGeometry();if(e||(e=this._createGeometryFromServerCentroid()),!e)return null;const t=e.clone(),r=this.getInTransform();return null!=r&&(0,Fo.$g)(t,t,this.hasZ,this.hasM,r),t}readCentroidForDisplay(){const e=this.readGeometryForDisplay();return e?this._computeDisplayCentroid(e):this._readServerCentroid()}readCentroidWorldSpace(){const e=this.readGeometryForDisplay(),t=e?this._computeDisplayCentroid(e):this._readServerCentroid();if(!t)return null;const r=t.clone(),s=this.getInTransform();return null!=s&&(0,Fo.$g)(r,r,this.hasZ,this.hasM,s),r}setCache(e){let t=this._caches.get(e);null==t&&(t=new wa(this.getSize()),this._caches.set(e,t)),this._activeCache=t}setCachedValue(e){this._activeCache.set(this.getIndex(),e)}hasCachedValue(){return this._activeCache.has(this.getIndex())}getCachedValue(){return this._activeCache.get(this.getIndex())}_readGeometryDeltaDecoded(e){const t=this._readGeometry(e);return"esriGeometryPoint"!==this.geometryType&&t&&this.getInTransform()?t.deltaDecode():t}get contextTimeZone(){return this._contextTimeZone}set contextTimeZone(e){this._contextTimeZone=e}readArcadeFeature(){return this}hasField(e){return this.fields.has(e)||this._joined.some((t=>t.hasField(e)))}geometry(){const e=this.readGeometryWorldSpace(),t=(0,Fo.di)(e,this.geometryType,this.hasZ,this.hasM),r=(0,Ia.im)(t);if(r){if(!this.metadata.spatialReference)throw new Error("InternalError: Expected spatial reference to be defined");r.spatialReference=this.metadata.spatialReference}return r}autocastArcadeDate(e,t){return t&&t instanceof Date?this.isUnknownDateTimeField(e)?ya.iG.unknownDateJSToArcadeDate(t):ya.iG.dateJSAndZoneToArcadeDate(t,this.contextTimeZone??va.By):t}isUnknownDateTimeField(e){return this.metadata.fieldsIndex.getTimeZone(e)===va._4}field(e){let t=this.fields.get(e);if(t)switch(t.type){case"date-only":case"esriFieldTypeDateOnly":return ma.u.fromReader(this.readAttribute(e,!1));case"time-only":case"esriFieldTypeTimeOnly":return ga.n.fromReader(this.readAttribute(e,!1));case"esriFieldTypeTimestampOffset":case"timestamp-offset":return ya.iG.fromReaderAsTimeStampOffset(this.readAttribute(e,!1));case"date":case"esriFieldTypeDate":return this.autocastArcadeDate(e,this.readAttribute(e,!0));default:return this.readAttribute(e,!1)}for(const r of this._joined)if(r.setIndex(this.getIndex()),t=r.fields.get(e),t)switch(t.type){case"date-only":case"esriFieldTypeDateOnly":return ma.u.fromReader(r._readAttribute(e,!1));case"time-only":case"esriFieldTypeTimeOnly":return ga.n.fromReader(r._readAttribute(e,!1));case"esriFieldTypeTimestampOffset":case"timestamp-offset":return ya.iG.fromReaderAsTimeStampOffset(r._readAttribute(e,!1));case"date":case"esriFieldTypeDate":return this.autocastArcadeDate(e,r._readAttribute(e,!0));default:return this.readAttribute(e,!1)}throw new Error(`Field ${e} does not exist`)}setField(e,t){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this.fields.fields.map((e=>e.name))}castToText(){if(!(arguments.length>0&&void 0!==arguments[0]&&arguments[0]))return JSON.stringify(this.readLegacyFeatureForDisplay());const e=this.readLegacyFeatureForDisplay();if(!e)return JSON.stringify(null);const t={geometry:e.geometry,attributes:{...e.attributes??{}}};for(const r in t.attributes){const e=t.attributes[r];e instanceof Date&&(t.attributes[r]=e.getTime())}return JSON.stringify(t)}gdbVersion(){return null}fullSchema(){return this.metadata.arcadeSchema}castAsJson(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return{attributes:this._readAttributes(),geometry:!0===e?.keepGeometryType?this.geometry():this.geometry()?.toJSON()??null}}castAsJsonAsync(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return Promise.resolve(this.castAsJson(e))}_getExists(){return null==this._deleted||!this._deleted.has(this.getIndex())}_computeDisplayCentroid(e){if(null==this.getInTransform())return(0,ba.Y)(new H.Z,e,this.hasM,this.hasZ);const t=Me.z.fromOptimized(e,this.geometryType);t.yFactor*=-1;const r=(0,xa.r)(t);return r?(r[1]*=-1,new H.Z([],r)):null}copyInto(e){e._joined=this._joined,e._deleted=this._deleted,e._objectIdToIndex=this._objectIdToIndex,e._boundsBuffer=this._boundsBuffer,e._activeCache=this._activeCache,e._caches=this._caches,e._contextTimeZone=this._contextTimeZone}_readLegacyGeometryWorldSpace(){const e=this.readGeometryWorldSpace();return(0,Fo.di)(e,this.geometryType,!1,!1)}_createGeometryFromServerCentroid(){const e=this._readServerCentroid();if(!e)return null;const[t,r]=e.coords;return this._createQuantizedExtrudedGeometry(t,r)}_createQuantizedExtrudedGeometry(e,t){return"esriGeometryPolyline"===this.geometryType?this._createQuantizedExtrudedLine(e,t):this._createQuantizedExtrudedQuad(e,t)}_createQuantizedExtrudedQuad(e,t){return new H.Z([5],[e-1,t,1,-1,1,1,-1,1,-1,-1])}_createQuantizedExtrudedLine(e,t){return new H.Z([2],[e-1,t+1,1,-1])}_removeAtIndex(e){null==this._deleted&&(this._deleted=Ko.create(this.getSize())),this._deleted.set(e)}}class Na extends Da{static fromFeatures(e,t){const{objectIdField:r,geometryType:s}=t,i=(0,Fo.Yn)([],e,s,!1,!1,r);for(let n=0;n<i.length;n++)i[n].displayId=e[n].displayId;return Na.fromOptimizedFeatures(i,t)}static fromFeatureSet(e,t){const r=(0,Fo.h_)(e,t.objectIdField);return Na.fromOptimizedFeatureSet(r,t)}static fromOptimizedFeatureSet(e,t){const r=Na.fromOptimizedFeatures(e.features,t);return r._exceededTransferLimit=e.exceededTransferLimit,r._transform=e.transform,r._fieldsIndex=new fa.Z(e.fields),r}static fromOptimizedFeatures(e,t,r){const s=new Na(e,t);return s._fieldsIndex=t.fieldsIndex,s._transform=r,s}static empty(e){return new Na([],e)}constructor(e,t){super(t),this._exceededTransferLimit=!1,this._featureIndex=-1,this._fieldsIndex=null,this._geometryType=t.geometryType,this._features=e}get fields(){return this._fieldsIndex}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}get _current(){return this._features[this._featureIndex]}removeIds(e){const t=new Set(e);this._features=this._features.filter((e=>!(null!=e.objectId&&t.has(e.objectId))))}getSize(){return this._features.length}getCursor(){return this.copy()}getInTransform(){return this._transform}getAttributeHash(){let e="";for(const t in this._current.attributes)e+=this._current.attributes[t];return e}getIndex(){return this._featureIndex}setIndex(e){this._featureIndex=e}getObjectId(){return this._current?.objectId}getDisplayId(){return this._current.displayId}setDisplayId(e){this._current.displayId=e}copy(){const e=new Na(this._features,this.metadata);return this.copyInto(e),e}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readGeometryArea(){return(0,Eo.S6)(this._current)?(0,Fo.lz)(this._current.geometry,2):0}_readX(){return(0,Eo.S6)(this._current)?this._current.geometry.coords[0]:0}_readY(){return(0,Eo.S6)(this._current)?this._current.geometry.coords[1]:0}_readGeometry(){return(0,Eo.S6)(this._current)?this._current.geometry??null:null}_readServerCentroid(){return this._current.centroid}_readAttribute(e,t){if(!this._fieldsIndex){const t=this._current.attributes[e];if(void 0!==t)return t;const r=e.toLowerCase();for(const e in this._current.attributes)if(e.toLowerCase()===r)return this._current.attributes[e];return}const r=this._fieldsIndex.get(e);if(!r)return;let s=this._current.attributes[r.name];return null==s?s:("esriFieldTypeTimestampOffset"===this.fields.get(e)?.type&&(s=this.parseTimestampOffset(s)),t&&this.fields.isDateField(e)?new Date(s):s)}_readAttributes(){return this._current.attributes}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._fieldsIndex=this._fieldsIndex}}class Ba extends Do{constructor(e,t){super(e),this.bins=new Map,this.done=!1,this._store=t}reset(){this.destroy(),this.bins.clear(),this.done=!1,this.handledChunks.clear()}destroy(){const e=this.subscription.tile.key.level;for(const t of this.bins.values()){const r=t.cachedFeature?.objectId;null!=r&&this._store.releaseDisplayIdForObjectId(`${r}.${e}`)}}*featuresWorldSpace(){for(const e of this.bins.values()){const t=e.cachedFeature;if(t){const e=t.clone();e.geometry&&(0,Fo.$g)(e.geometry,e.geometry,!1,!1,this.subscription.tile.transform),yield e}}}getGeohashBounds(e,t){const r=this.subscription.tile;return(0,ko.ir)(r.extent,r.resolution,t,e)}}class Va extends Bo{static async create(e,t,r,s,i){const n=new na({spatialReference:t}),o=e.fixedBinLevel,a=await Promise.all(e.fields.map((async e=>Po.create(n,e)))),c=e.featureFilter?await pa.create({geometryType:r.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:r.metadata.timeInfo,fieldsIndex:r.metadata.fieldsIndex,spatialReference:t,filterJSON:e.featureFilter}):null;return await(0,Co._W)(t,g.Z.WGS84),new Va({fields:a,geohashLevel:o,spatialReference:t,featureFilter:c,timeZone:i},e.fields,r,s)}constructor(e,t,r,s){super(r,s,e.spatialReference,e.fields),this._indexOptions=e,this._metadata=new _a({geometryType:"esriGeometryPolygon",objectIdField:"aggregateId",fields:t,globalIdField:null,spatialReference:r.metadata.spatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null})}createState(e){return new Ba(e,this._attributeStore)}async*applyOverride(e){for(const t of this._sendStates.values()){t.reset();const e=new Vo(t.subscription,Na.empty(this._source.metadata),!0,!1,{});yield e}}displayMap(e,t,r){const s=new Map(e.map((e=>[t(e),e]))),i=[];for(const n of this._sendStates.values())for(const e of n.featuresWorldSpace()){const{objectId:t,displayId:n}=e,o=s.get(t);if(null!=o){const e=r(n,o,t);i.push(e),s.delete(t)}}return i}getDisplayFeatures(e){const t=new Set(e),r=new Set,s=[];for(const i of this._sendStates.values())for(const e of i.featuresWorldSpace())t.has(e.displayId)&&!r.has(e.objectId)&&(e.geometry&&s.push({...(0,Fo.EI)(e,this._metadata.geometryType,!1,!1),displayId:e.displayId}),r.add(e.objectId));return{features:[],aggregates:s}}getFeatureObjectIdsForAggregate(e){for(const t of this._sendStates.values())for(const r of t.bins.values())if(r.id===e)return Array.from(r.objectIds);return[]}async*updateChunks(){if(this._source.chunks().length)for(const e of this._sendStates.values())yield*this._update(e,this._source)}forEachAggregateWorldSpace(e){for(const t of this._sendStates.values())for(const r of t.featuresWorldSpace())e(r)}async*_update(e,t){const{handledChunks:r,subscription:s,bins:i}=e,{spatialReference:n,geohashLevel:o}=this._indexOptions,a=s.tile;if(e.done)return;for(const y of t.chunks()){if(r.has(y.chunkId))continue;r.add(y.chunkId);const t=y.queryInfo;if("tileId"in t){const e=new p.Z(t.tileId);if(e.level!==a.level||e.world!==a.key.world)continue}const s=y.getGeohashIndex(this._indexOptions),c=e.getGeohashBounds(n,o);null!=c&&s.putBins(i,c)}const c=[],u=s.tile.transform,l=s.tile.key.level;for(const p of i.values()){if(p.cachedFeature)p.cachedFeature.attributes=p.getAttributes();else{const e=p.getGeometry(this.spatialReference,u),t=new Eo.u_(e,p.getAttributes(),null);e||(t.centroid=p.getGeometryCentroid(this.spatialReference,u)),t.objectId=p.id,t.displayId=this._attributeStore.createDisplayIdForObjectId(`${t.objectId}.${l}`),p.cachedFeature=t}c.push(p.cachedFeature)}this.events.emit("changed"),e.done=!t.updateTracking.updating;const h=Na.fromOptimizedFeatures(c,this._metadata,u),d=h.getCursor(),f=e.subscription.tile.createArcadeEvaluationOptions(this._indexOptions.timeZone);for(;d.next();)this._attributeStore.setAttributeData(d.getDisplayId(),d,f);const _=new Lo(e.subscription,h,[],e.done,{});yield _}}const La=Math.PI/180;class Ga{static create(e){return new Ga(e.map((e=>function(e){switch(e.statisticType){case"min":return new qa(e);case"max":return new Wa(e);case"avg":return new Ya(e);case"avg_angle":return new ja(e);case"sum":case"count":return new Za(e);case"mode":return new $a(e)}}(e))))}constructor(e){this._statistics=e}values(){return this._statistics.values()}insert(e,t){for(const r of this._statistics)r.insert(e,t)}merge(e){for(let t=0;t<this._statistics.length;t++){const r=this._statistics[t],s=e._statistics[t];if(r.field.name!==s.field.name)throw new Error("InternalError: Tried to merge incompatible statistics");r.merge(s)}}clone(){return new Ga(this._statistics.map((e=>e.clone())))}}class Ua{constructor(e){this.field=e}insert(e,t){if(!this.field.computed)return;const r=this.field.computed.read(e,t);Wo(r)||this._insertValue(r)}}class qa extends Ua{constructor(){super(...arguments),this.type="min",this.value=Number.MAX_VALUE}_insertValue(e){this.value=Math.min(this.value,e)}merge(e){this.value=Math.min(this.value,e.value)}clone(){const e=new qa(this.field);return e.value=this.value,e}}class Wa extends Ua{constructor(){super(...arguments),this.type="max",this.value=Number.MIN_VALUE}_insertValue(e){this.value=Math.max(this.value,e)}merge(e){this.value=Math.max(this.value,e.value)}clone(){const e=new Wa(this.field);return e.value=this.value,e}}class Za extends Ua{constructor(){super(...arguments),this.type="sum",this.value=0}_insertValue(e){this.value+=e}merge(e){this.value+=e.value}clone(){const e=new Za(this.field);return e.value=this.value,e}}class Ya extends Ua{constructor(){super(...arguments),this.type="avg",this._total=0,this._count=0}get value(){return this._total/this._count}_insertValue(e){this._total+=e,this._count+=1}merge(e){this._total+=e._total,this._count+=e._count}clone(){const e=new Ya(this.field);return e._total=this._total,e._count=this._count,e}}class ja extends Ua{constructor(){super(...arguments),this.type="avg_angle",this._x=0,this._y=0,this._count=0}get value(){const e=this._x/this._count,t=this._y/this._count,r=180/Math.PI;return Math.atan2(t,e)*r}_insertValue(e){this._x=this._x+Math.cos(e*La),this._y=this._y+Math.sin(e*La),this._count+=1}merge(e){this._x+=e._x,this._y+=e._y,this._count+=e._count}clone(){const e=new ja(this.field);return e._x=this._x,e._y=this._y,e._count=this._count,e}}class $a extends Ua{constructor(){super(...arguments),this._frequencies=new Map}get value(){let e,t=0;for(const[r,s]of this._frequencies.entries())s>t&&(t=s,e=r);return e}_insertValue(e){const t=this._frequencies.get(e);null!=t?this._frequencies.set(e,t+1):this._frequencies.set(e,1)}merge(e){for(const[t,r]of e._frequencies.entries()){const e=this._frequencies.get(t);null!=e?this._frequencies.set(t,e+r):this._frequencies.set(t,r)}}clone(){const e=new $a(this.field);return e._frequencies=new Map(this._frequencies),e}}class Ha{static createId(e,t){return`${e}.${t}`}static create(e,t,r,s){return new Ha(e,t,Ga.create(r),s)}constructor(e,t,r,s){this.gridX=e,this.gridY=t,this._statistics=r,this._worldUnitsPerCell=s,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._objectIds=new Set}get id(){return Ha.createId(this.gridX,this.gridY)}get count(){return this._count}get statistics(){return this._statistics}get objectIds(){return this._objectIds}get firstObjectId(){return this._objectIds.values().next().value}get centroidXWorld(){return this._xWorldTotal/this._count}get centroidYWorld(){return this._yWorldTotal/this._count}clone(){const e=new Ha(this.gridX,this.gridY,this._statistics.clone(),this._worldUnitsPerCell);return e._count=this._count,e._xWorldTotal=this._xWorldTotal,e._yWorldTotal=this._yWorldTotal,e._firstFeatureAttributes=this._firstFeatureAttributes,e._objectIds=new Set(this._objectIds),e}insert(e,t,r,s){0===this._count?this._firstFeatureAttributes=e.readAttributes():this._firstFeatureAttributes=null,this._count+=1,this._xWorldTotal+=r,this._yWorldTotal+=s,this._statistics.insert(e,t),this._objectIds.add(e.getObjectId())}merge(e){if(0!==e._count){this._count+=e._count,this._firstFeatureAttributes=e._firstFeatureAttributes,this._xWorldTotal+=e._xWorldTotal,this._yWorldTotal+=e._yWorldTotal,this._statistics.merge(e._statistics);for(const t of e._objectIds.values())this._objectIds.add(t)}}getCentroidX(e){return null==e?this.centroidXWorld:(0,Fo.Jd)(e,this.centroidXWorld)}getCentroidY(e){return null==e?this.centroidYWorld:(0,Fo.IN)(e,this.centroidYWorld)}getCentroid(e){const t=new H.Z([],[this.centroidXWorld,this.centroidYWorld]);if(null!=e){const r=new H.Z;return(0,Fo.Nh)(r,t,!1,!1,"esriGeometryPoint",e)}return t}getGeometricCentroid(e){const t=this.gridX*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,r=this.gridY*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,s=new H.Z([],[t,r]);if(null!=e){const t=new H.Z;return(0,Fo.Nh)(t,s,!1,!1,"esriGeometryPoint",e)}return s}getAttributes(){const e={aggregateId:this.id};for(const t of this._statistics.values())e[t.field.name]=t.value;return null!=this._firstFeatureAttributes?{...e,...this._firstFeatureAttributes}:e}}var Xa=r(68860);function Ka(e,t){return(0,Xa.c9)(e)*Xa.hd*96/t}class Qa{constructor(e){this._options=e,this._cells=new Map,this._pixelsPerMapUnit=Ka(e.spatialReference,e.scale)}insert(e,t){const r=e.getCursor(),s={$view:{scale:this._options.scale,timeZone:this._options.timeZone}};for(;r.next();)this._insertFeature(r,s,t)}putCellsInBounds(e,t){const[r,s,i,n]=t,o=Math.floor(r*this._pixelsPerMapUnit/this._options.cellSize),a=Math.floor(s*this._pixelsPerMapUnit/this._options.cellSize),c=Math.ceil(i*this._pixelsPerMapUnit/this._options.cellSize),u=Math.ceil(n*this._pixelsPerMapUnit/this._options.cellSize);for(let l=a;l<=u;l++)for(let t=o;t<=c;t++){const r=`${t}.${l}`,s=this._cells.get(r);if(!s)continue;const i=e.get(s.id);i?s&&!e.has(s.id)&&i.merge(s):e.set(s.id,s.clone())}}putCells(e){for(const t of this._cells.values()){const r=e.get(t.id);r?r.merge(t):e.set(t.id,t.clone())}}_insertFeature(e,t,r){const{featureFilter:s}=this._options;if(null!==s&&!s.check(e))return;let i=0,n=0;if("esriGeometryPoint"===e.geometryType)i=e.readXWorldSpace(),n=e.readYWorldSpace();else{if(r){const t=e.readCentroidForDisplay();if(null==t)return;const[r,s]=t.coords;if(r<0||r>f.i9||s<0||s>f.i9)return}const t=e.readCentroidWorldSpace();if(null==t)return;i=t.coords[0],n=t.coords[1]}const o=i*this._pixelsPerMapUnit,a=n*this._pixelsPerMapUnit,c=Math.floor(o/this._options.cellSize),u=Math.floor(a/this._options.cellSize);this._getCellOrCreate(c,u).insert(e,t,i,n)}_getCellOrCreate(e,t){const r=Ha.createId(e,t);let s=this._cells.get(r);if(!s){const i=1*this._options.cellSize/this._pixelsPerMapUnit;s=Ha.create(e,t,this._options.fields,i),this._cells.set(r,s)}return s}}class Ja{constructor(e,t){this.inner=e,this.displayId=t}}const ec=128;class tc extends Do{constructor(e){super(e),this.didSend=!1,this.done=!1}}class rc{constructor(e,t,r,s,i){this._level=e,this._scale=t,this._indexOptions=r,this._clusterRadius=s,this._store=i,this._cells=new Map,this._handledChunks=new Set,this._statistics=new Map,this._clusters=new Map}destroy(){this._clearClusters()}_clearClusters(){for(const e of this._clusters.values())this._store.releaseDisplayIdForObjectId(e.inner.id);this._clusters.clear()}*aggregatesWorldSpace(){for(const e of this._clusters.values()){const t=e.inner.getCentroid(null),r=new Eo.u_(t,e.inner.getAttributes(),null);r.objectId=e.inner.id,r.displayId=e.displayId,yield r}}clusters(){return this._clusters.values()}updateChunks(e,t){let r=!1;for(const o of e){const e=o.queryInfo;"tileId"in e&&new p.Z(e.tileId).level!==this._level||(this._handledChunks.has(o.normalizedChunkId)||(this._handledChunks.add(o.normalizedChunkId),r=!0,o.getGridIndex({...this._indexOptions,scale:this._scale}).putCells(this._cells)))}const s={xMin:1/0,yMin:1/0,xMax:-1/0,yMax:-1/0},i=Ka(this._indexOptions.spatialReference,this._scale),n=this._indexOptions.cellSize;for(const{subscription:o}of t){const e=o.tile.bounds,t=Math.floor(e[0]*i/n),r=Math.floor(e[1]*i/n),a=Math.ceil(e[2]*i/n),c=Math.ceil(e[3]*i/n);s.xMin=Math.min(s.xMin,t),s.yMin=Math.min(s.yMin,r),s.xMax=Math.max(s.xMax,a),s.yMax=Math.max(s.yMax,c)}return null!=this._lastCellBounds&&s.xMin===this._lastCellBounds.xMin&&s.yMin===this._lastCellBounds.yMin&&s.yMin===this._lastCellBounds.yMin&&s.yMax===this._lastCellBounds.yMax||(r=!0,this._lastCellBounds=s),r&&this._clusterCells(s),r}async updateStatistics(e){let t=!1;for(const r of this._clusters.values())r.inner.count>1&&(t=this._updateAggregateStatistics(this._statistics,r.inner)||t);if(t){const t=Array.from(this._statistics.entries()).map((e=>{let[t,r]=e;return{fieldName:t,minValue:r.minValue,maxValue:r.maxValue}}));await e.container.updateStatistics(this._level,t)}}createAggregateFeatures(e,t){const r=e.subscription,s=[],i=r.tile.transform;for(const n of this._clusters.values()){let e=n.inner.getCentroidX(i);const t=n.inner.getCentroidY(i),o=r.tile.lod,a=o.wrap?o.worldSize[0]:null,c=1===n.inner.count?n.inner.firstObjectId:n.inner.id,u=n.displayId;if(null!=a)if(1===a){const r=new H.Z([],[e,t]),i=new Eo.u_(r,n.inner.getAttributes(),null);i.geometry.coords[0]-=f.i9,i.objectId=c,i.displayId=u,s.push(i);const o=new H.Z([],[e,t]),a=new Eo.u_(o,n.inner.getAttributes(),null);a.geometry.coords[0]+=f.i9,a.objectId=c,a.displayId=u,s.push(a)}else e>f.i9+f.i9/2?e-=a*f.i9:e<-f.i9/2&&(e+=a*f.i9);if(e<f.i9+ec&&e>=-128&&t<f.i9+ec&&t>=-128){const r=new H.Z([],[e,t]),i=new Eo.u_(r,n.inner.getAttributes(),null);i.objectId=c,i.displayId=u,s.push(i)}}return Na.fromOptimizedFeatures(s,t,r.tile.transform)}_clusterCells(e){let t=Array.from(this._cells.values());t=t.sort(((e,t)=>t.count-e.count));const r=[];for(const o of this._clusters.values())r.push(o.inner.id);this._clusters.clear();const s=this._clusterRadius*(1/Ka(this._indexOptions.spatialReference,this._scale)),i=1+this._clusterRadius/this._indexOptions.cellSize,n=new Set;for(const o of t){if(n.has(o.id))continue;if(o.gridX<e.xMin||o.gridX>e.xMax||o.gridY<e.yMin||o.gridY>e.yMax)continue;const t=this._store.createDisplayIdForObjectId(o.id),r=new Ja(o.clone(),t);n.add(o.id),this._clusters.set(o.id,r);const a=o.centroidXWorld,c=o.centroidYWorld;for(let e=o.gridY-i;e<=o.gridY+i;e++)for(let t=o.gridX-i;t<=o.gridX+i;t++){if(e===o.gridY&&t===o.gridX)continue;const i=this._cells.get(Ha.createId(t,e));if(!i||n.has(i.id))continue;const u=Math.abs(i.centroidXWorld-a),l=Math.abs(i.centroidYWorld-c);u<s&&l<s&&(r.inner.merge(i),n.add(i.id))}}for(const o of r)this._store.releaseDisplayIdForObjectId(o)}_updateAggregateStatistics(e,t){let r=!1;for(const s of t.statistics.values()){if("esriFieldTypeString"===s.field.type)continue;const t=s.value,i=s.field,n=e.get(i.name);if(n){const{minValue:e,maxValue:s}=n,i=Math.min(n.minValue,t),o=Math.max(n.maxValue,t);e===i&&s===o||(n.minValue=i,n.maxValue=o,r=!0)}else e.set(i.name,{minValue:t,maxValue:t}),r=!0}return r}}class sc extends Bo{static async create(e,t,r,s,i,n){const o=new na({spatialReference:r}),a={fields:await Promise.all(t.fields.map((async e=>Po.create(o,e)))),spatialReference:r,featureFilter:t.featureFilter?await pa.create({geometryType:s.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:s.metadata.timeInfo,fieldsIndex:s.metadata.fieldsIndex,spatialReference:r,filterJSON:t.featureFilter}):null,cellSize:t.clusterRadius/4,timeZone:n};return new sc(e,t.clusterRadius,a,t.fields,s,i)}constructor(e,t,r,s,i,n){super(i,n,r.spatialReference,r.fields),this._connection=e,this._clusterRadius=t,this._indexOptions=r,this._cellsPerScale=new Map,this._metadata=new _a({geometryType:"esriGeometryPoint",objectIdField:"aggregateId",fields:[...s,...this._source.metadata.fieldsIndex.fields,{name:"aggregateId",alias:"aggregateId",type:"esriFieldTypeOID"}],globalIdField:null,spatialReference:i.metadata.spatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null})}get enablePixelBuffering(){return!1}invalidate(){super.invalidate();for(const e of this._cellsPerScale.values())e.destroy();this._cellsPerScale.clear()}onSubscribe(e){super.onSubscribe(e),this._requiredLevel=e.tile.level,this._requiredScale=e.tile.scale}createState(e){return new tc(e)}async*applyOverride(e){for(const t of this._cellsPerScale.values())t.destroy();this._cellsPerScale.clear();for(const t of this._sendStates.values())t.done=!1}displayMap(e,t,r){const s=new Map(e.map((e=>[t(e),e]))),i=[],n=this._getClusterState(this._requiredLevel,this._requiredScale);for(const o of n.clusters()){const e=s.get(o.inner.id);if(null==e){if(1===o.inner.count){const e=s.get(o.inner.firstObjectId);if(null!=e){const t=r(o.displayId,e,o.inner.firstObjectId);i.push(t),s.delete(o.inner.firstObjectId)}}}else{const t=r(o.displayId,e,o.inner.id);i.push(t),s.delete(o.inner.id)}}return i}getDisplayFeatures(e){const t=new Set(e),r=new Set,s=[],i=[],n=this._getClusterState(this._requiredLevel,this._requiredScale);for(const o of n.aggregatesWorldSpace())if(t.has(o.displayId)&&!r.has(o.displayId)){const e=(0,Fo.EI)(o,this._metadata.geometryType,!1,!1);if(r.add(o.displayId),1===e.attributes.cluster_count){s.push({...e,displayId:o.displayId});continue}i.push({...e,displayId:o.displayId})}return{features:s,aggregates:i}}getFeatureObjectIdsForAggregate(e){const t=this._getClusterState(this._requiredLevel,this._requiredScale);for(const r of t.clusters())if(r.inner.id===e)return Array.from(r.inner.objectIds);return[]}async*updateChunks(){const e=this._source.chunks();if(!e.length)return;const t=this._getClusterState(this._requiredLevel,this._requiredScale),r=Array.from(this._sendStates.values()).filter((e=>e.subscription.tile.level===this._requiredLevel));if(t.updateChunks(e,r)||!this._source.updateTracking.updating)for(const n of r)n.subscription.tile.level===this._requiredLevel&&(n.didSend=!1,n.done=!1);const s=Array.from(this._sendStates.values()).filter((e=>e.done)).map((e=>e.subscription.tile.key)),i=new Set(s);for(const n of this._sendStates.values()){if(this._source.updateTracking.updating){if(s.some((e=>e.containsChild(n.subscription.tile.key))))continue;if(n.subscription.tile.key.getChildKeys().every((e=>i.has(e))))continue}n.didSend||n.subscription.tile.level!==this._requiredLevel||(n.didSend=!0,yield*this._update(n,t,this._source))}await t.updateStatistics(this._connection)}forEachAggregateWorldSpace(e){if(null==this._requiredLevel||null==this._requiredScale)return;const t=this._getClusterState(this._requiredLevel,this._requiredScale);for(const r of t.aggregatesWorldSpace())e(r)}_getClusterState(e,t){if(null==e||null==t)throw new Error("InternalError: Level and scale must be defined");let r=this._cellsPerScale.get(t);return r||(r=new rc(e,t,this._indexOptions,this._clusterRadius,this._attributeStore),this._cellsPerScale.set(t,r)),r}async*_update(e,t,r){if(e.done)return;const s=t.createAggregateFeatures(e,this._metadata);this.events.emit("changed"),e.done=!r.updateTracking.updating;const i=s.getCursor(),n=e.subscription.tile.createArcadeEvaluationOptions(this._indexOptions.timeZone);for(;i.next();)this._attributeStore.setAttributeData(i.getDisplayId(),i,n);const o=new Vo(e.subscription,s,!0,e.done,{});yield o}}var ic=r(36231);function nc(e,t){if(!(this instanceof nc))return new nc(e,t);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this.toBBox=t:this._initFormat(t)),this.clear()}function oc(e,t,r){if(!r)return t.indexOf(e);for(var s=0;s<t.length;s++)if(r(e,t[s]))return s;return-1}function ac(e,t){cc(e,0,e.children.length,t,e)}function cc(e,t,r,s,i){i||(i=gc(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var n,o=t;o<r;o++)n=e.children[o],uc(i,e.leaf?s(n):n);return i}function uc(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function lc(e,t){return e.minX-t.minX}function hc(e,t){return e.minY-t.minY}function dc(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function pc(e){return e.maxX-e.minX+(e.maxY-e.minY)}function fc(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function _c(e,t){var r=Math.max(e.minX,t.minX),s=Math.max(e.minY,t.minY),i=Math.min(e.maxX,t.maxX),n=Math.min(e.maxY,t.maxY);return Math.max(0,i-r)*Math.max(0,n-s)}function yc(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function mc(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function gc(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function xc(e,t,r,s,i){for(var n,o=[t,r];o.length;)(r=o.pop())-(t=o.pop())<=s||(n=t+Math.ceil((r-t)/s/2)*s,(0,ic.q)(e,n,t,r,i),o.push(t,n,n,r))}nc.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,r=[],s=this.toBBox;if(!mc(e,t))return r;for(var i,n,o,a,c=[];t;){for(i=0,n=t.children.length;i<n;i++)o=t.children[i],mc(e,a=t.leaf?s(o):o)&&(t.leaf?r.push(o):yc(e,a)?this._all(o,r):c.push(o));t=c.pop()}return r},collides:function(e){var t=this.data,r=this.toBBox;if(!mc(e,t))return!1;for(var s,i,n,o,a=[];t;){for(s=0,i=t.children.length;s<i;s++)if(n=t.children[s],mc(e,o=t.leaf?r(n):n)){if(t.leaf||yc(e,o))return!0;a.push(n)}t=a.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,r=e.length;t<r;t++)this.insert(e[t]);return this}var s=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===s.height)this._splitRoot(this.data,s);else{if(this.data.height<s.height){var i=this.data;this.data=s,s=i}this._insert(s,this.data.height-s.height-1,!0)}else this.data=s;return this},insert:function(e){return null!=e&&this._insert(e,this.data.height-1),this},clear:function(){return this.data=gc([]),this},remove:function(e,t){if(null==e)return this;for(var r,s,i,n,o=this.data,a=this.toBBox(e),c=[],u=[];o||c.length;){if(o||(o=c.pop(),s=c[c.length-1],r=u.pop(),n=!0),o.leaf&&-1!==(i=oc(e,o.children,t)))return o.children.splice(i,1),c.push(o),this._condense(c),this;n||o.leaf||!yc(o,a)?s?(r++,o=s.children[r],n=!1):o=null:(c.push(o),u.push(r),r=0,s=o,o=o.children[0])}return this},toBBox:function(e){return e},compareMinX:lc,compareMinY:hc,toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var r=[];e;)e.leaf?t.push.apply(t,e.children):r.push.apply(r,e.children),e=r.pop();return t},_build:function(e,t,r,s){var i,n=r-t+1,o=this._maxEntries;if(n<=o)return ac(i=gc(e.slice(t,r+1)),this.toBBox),i;s||(s=Math.ceil(Math.log(n)/Math.log(o)),o=Math.ceil(n/Math.pow(o,s-1))),(i=gc([])).leaf=!1,i.height=s;var a,c,u,l,h=Math.ceil(n/o),d=h*Math.ceil(Math.sqrt(o));for(xc(e,t,r,d,this.compareMinX),a=t;a<=r;a+=d)for(xc(e,a,u=Math.min(a+d-1,r),h,this.compareMinY),c=a;c<=u;c+=h)l=Math.min(c+h-1,u),i.children.push(this._build(e,c,l,s-1));return ac(i,this.toBBox),i},_chooseSubtree:function(e,t,r,s){for(var i,n,o,a,c,u,l,h;s.push(t),!t.leaf&&s.length-1!==r;){for(l=h=1/0,i=0,n=t.children.length;i<n;i++)c=dc(o=t.children[i]),(u=fc(e,o)-c)<h?(h=u,l=c<l?c:l,a=o):u===h&&c<l&&(l=c,a=o);t=a||t.children[0]}return t},_insert:function(e,t,r){var s=this.toBBox,i=r?e:s(e),n=[],o=this._chooseSubtree(i,this.data,t,n);for(o.children.push(e),uc(o,i);t>=0&&n[t].children.length>this._maxEntries;)this._split(n,t),t--;this._adjustParentBBoxes(i,n,t)},_split:function(e,t){var r=e[t],s=r.children.length,i=this._minEntries;this._chooseSplitAxis(r,i,s);var n=this._chooseSplitIndex(r,i,s),o=gc(r.children.splice(n,r.children.length-n));o.height=r.height,o.leaf=r.leaf,ac(r,this.toBBox),ac(o,this.toBBox),t?e[t-1].children.push(o):this._splitRoot(r,o)},_splitRoot:function(e,t){this.data=gc([e,t]),this.data.height=e.height+1,this.data.leaf=!1,ac(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,r){var s,i,n,o,a,c,u,l;for(c=u=1/0,s=t;s<=r-t;s++)o=_c(i=cc(e,0,s,this.toBBox),n=cc(e,s,r,this.toBBox)),a=dc(i)+dc(n),o<c?(c=o,l=s,u=a<u?a:u):o===c&&a<u&&(u=a,l=s);return l},_chooseSplitAxis:function(e,t,r){var s=e.leaf?this.compareMinX:lc,i=e.leaf?this.compareMinY:hc;this._allDistMargin(e,t,r,s)<this._allDistMargin(e,t,r,i)&&e.children.sort(s)},_allDistMargin:function(e,t,r,s){e.children.sort(s);var i,n,o=this.toBBox,a=cc(e,0,t,o),c=cc(e,r-t,r,o),u=pc(a)+pc(c);for(i=t;i<r-t;i++)n=e.children[i],uc(a,e.leaf?o(n):n),u+=pc(a);for(i=r-t-1;i>=t;i--)n=e.children[i],uc(c,e.leaf?o(n):n),u+=pc(c);return u},_adjustParentBBoxes:function(e,t,r){for(var s=r;s>=0;s--)uc(t[s],e)},_condense:function(e){for(var t,r=e.length-1;r>=0;r--)0===e[r].children.length?r>0?(t=e[r-1].children).splice(t.indexOf(e[r]),1):this.clear():ac(e[r],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}};class bc{static fromReader(e){const t=[],r=e.copy(),s=(0,Ro.Ue)();for(;r.next();)r.getBounds(s)&&t.push(r.getIndex());const i=nc(9,(e=>(r.setIndex(e),{minX:r.getBoundsXMin(),minY:r.getBoundsYMin(),maxX:r.getBoundsXMax(),maxY:r.getBoundsYMax()})));return i.load(t),new bc(i)}constructor(e){this._index=e}search(e){const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}}class vc{static create(e,t,r,s){const i=Ga.create(e),n=new Array(32);for(let o=0;o<n.length;o++)n[o]=null;return new vc(i,t,r,s,n)}constructor(e,t,r,s,i){this._statistics=e,this.xNode=t,this.yNode=r,this.depth=s,this.children=i,this._objectIds=new Set,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._xGeohashTotal=0,this._yGeohashTotal=0,this.next=null}get id(){return`${this.xNode}.${this.yNode}`}get objectIds(){return this._objectIds}clone(){const e=new vc(this._statistics.clone(),this.xNode,this.yNode,this.depth,this.children);return e._count=this._count,e._xWorldTotal=this._xWorldTotal,e._yWorldTotal=this._yWorldTotal,e._xGeohashTotal=this._xGeohashTotal,e._yGeohashTotal=this._yGeohashTotal,e.next=this.next,e.cachedFeature=this.cachedFeature,e._objectIds=new Set(this._objectIds),e}insert(e,t,r,s,i,n){this._count+=1,this._xWorldTotal+=t,this._yWorldTotal+=r,this._xGeohashTotal+=s,this._yGeohashTotal+=i,this._statistics.insert(e,n),this._objectIds.add(e.getObjectId())}merge(e){if(0!==e._count){this._count+=e._count,this._xWorldTotal+=e._xWorldTotal,this._yWorldTotal+=e._yWorldTotal,this._xGeohashTotal+=e._xWorldTotal,this._yGeohashTotal+=e._yWorldTotal,this._statistics.merge(e._statistics);for(const t of e._objectIds.values())this._objectIds.add(t)}}getGeometry(e,t){const r=this._getLngLatBounds(),[s,i,n,o]=r,a=(0,Co.iV)({rings:[[[s,i],[s,o],[n,o],[n,i],[s,i]]]},g.Z.WGS84,e),c=(0,Fo.Uy)(new H.Z,a,!1,!1);return null!=t?(0,Fo.Nh)(new H.Z,c,!1,!1,"esriGeometryPolygon",t,!1,!1):c}getGeometryCentroid(e,t){const r=this._getLngLatBounds(),[s,i,n,o]=r,a=(0,Co.iV)({x:(s+n)/2,y:(i+o)/2},g.Z.WGS84,e),c=(0,Fo.dd)(new H.Z,a);return null!=t?(0,Fo.Nh)(new H.Z,c,!1,!1,"esriGeometryPoint",t,!1,!1):c}getAttributes(){const e={aggregateId:this.id};for(const t of this._statistics.values())e[t.field.name]=t.value;return e.aggregateCount=this._count,e}_getLngLatBounds(){const e=this.depth,t=Math.ceil(e/2),r=Math.floor(e/2),s=30-(3*t+2*r),i=30-(2*t+3*r),n=this.xNode<<s,o=this.yNode<<i;return(0,ko.bU)({geohashX:n,geohashY:o},this.depth)}}class wc{constructor(e){this._fields=e,this._root=vc.create(this._fields,0,0,0)}destroy(){}insert(e,t,r,s,i,n,o){let a=this._root,c=0,u=0,l=0;for(;null!==a;){if(a.insert(e,t,r,s,i,o),c>=n)return;const h=Math.ceil((c+1)/2),d=Math.floor((c+1)/2),p=1-c%2,f=30-(3*h+2*d),_=30-(2*h+3*d),y=(s&7*p+3*(1-p)<<f)>>f,m=(i&3*p+7*(1-p)<<_)>>_,g=y+m*(8*p+4*(1-p));u=u<<3*p+2*(1-p)|y,l=l<<2*p+3*(1-p)|m,null==a.children[g]&&(a.children[g]=vc.create(this._fields,u,l,c+1)),c+=1,a=a.children[g]}}putBins(e,t){for(const r of this.getNodes(t)){const t=e.get(r.id);t?t.merge(r):e.set(r.id,r.clone())}}getNodes(e){const t=[],{geohashBounds:r,level:s}=e;let i=this._root;for(;null!==i;){const e=i.depth,n=i.xNode,o=i.yNode;if(e>=s){t.push(i),i=i.next;continue}const a=Math.ceil((e+1)/2),c=Math.floor((e+1)/2),u=1-e%2,l=30-(3*a+2*c),h=30-(2*a+3*c),d=~((1<<l)-1),p=~((1<<h)-1),f=(r.xLL&d)>>l,_=(r.yLL&p)>>h,y=(r.xTR&d)>>l,m=(r.yTR&p)>>h,g=n<<3*u+2*(1-u),x=o<<2*u+3*(1-u),b=g+8*u+4*(1-u),v=x+4*u+8*(1-u),w=Math.max(g,f),I=Math.max(x,_),S=Math.min(b,y),T=Math.min(v,m);let M=null,k=null;for(let t=I;t<=T;t++)for(let e=w;e<=S;e++){const r=e-g+(t-x)*(8*u+4*(1-u)),s=i.children[r];s&&(M||(M=s,M.next=i.next),k&&(k.next=s),k=s,s.next=i.next)}i=M||i.next}return t}}class Ic{constructor(e){this._options=e,this._tree=new wc(e.fields)}insert(e,t){const r=e.getCursor(),s={$view:{scale:0,timeZone:this._options.timeZone}};for(;r.next();)this._insertFeature(r,s,t)}putBins(e,t){this._tree.putBins(e,t)}_insertFeature(e,t,r){const{featureFilter:s,geohashLevel:i,spatialReference:n}=this._options;if(null!==s&&!s.check(e))return;let o=0,a=0;if("esriGeometryPoint"===e.geometryType)o=e.readXWorldSpace(),a=e.readYWorldSpace();else{if(r){const t=e.readCentroidForDisplay();if(null==t)return;const[r,s]=t.coords;if(r<0||r>f.i9||s<0||s>f.i9)return}const t=e.readCentroidWorldSpace();if(null==t)return;o=t.coords[0],a=t.coords[1]}const c=(0,ko.zp)(o,a,i,n);c&&this._tree.insert(e,o,a,c[0],c[1],i,t)}}class Sc extends Da{static from(e,t){return new Sc(e.copy(),t)}constructor(e,t){super(e.metadata),this._currentIndex=-1,this._displayTranslationX=0,this._displayTranslationY=0,this._displayScaleX=1,this._displayScaleY=1,this._reader=e,this._indices=t,this._isPoint="esriGeometryPoint"===e.geometryType}setTransformForDisplay(e){const t=this._reader.getInTransform();if(null==t){const[t,r]=e.scale,[s,i]=e.translate;return this._displayTranslationX=-s/t,this._displayScaleX=1/t,this._displayTranslationY=i/r,this._displayScaleY=1/-r,void(this._displayTransform=e)}const[r,s]=t.scale,[i,n]=t.translate,[o,a]=e.scale,[c,u]=e.translate;if(this._displayScaleX=r/o,this._displayTranslationX=(i-c)/o,this._displayScaleY=s/a,this._displayTranslationY=(-n+u)/a,!this._isPoint&&t)throw new Error("InternalError: Relative transformations not supported for non-point features");this._displayTransform=e}getInTransform(){return this._reader.getInTransform()}get fields(){return this._reader.fields}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const e=new Sc(this._reader.copy(),this._indices);return e._currentIndex=this._currentIndex,e._displayTransform=this._displayTransform,e._displayTranslationX=this._displayTranslationX,e._displayTranslationY=this._displayTranslationY,e._displayScaleX=this._displayScaleX,e._displayScaleY=this._displayScaleY,e}get contextTimeZone(){return this._reader.contextTimeZone}set contextTimeZone(e){this._reader.contextTimeZone=e}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}readXForDisplay(){return this._reader.readXForDisplay()*this._displayScaleX+this._displayTranslationX}readYForDisplay(){return this._reader.readYForDisplay()*this._displayScaleY+this._displayTranslationY}readGeometryForDisplay(){const e=this._reader.readGeometryForDisplay();if(!this._displayTransform)return e;const t=new H.Z;return(0,Fo.Nh)(t,e,this.hasZ,this.hasM,this.geometryType,this._displayTransform),t.deltaDecode()}readCentroidForDisplay(){const e=this._reader.readCentroidForDisplay()?.clone();if(e){const[t,r]=e.coords;e.coords[0]=t*this._displayScaleX+this._displayTranslationX,e.coords[1]=r*this._displayScaleY+this._displayTranslationY}return e}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}readAttribute(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._reader.readAttribute(e,t)}readAttributes(){return this._reader.readAttributes()}joinAttributes(e){return this._reader.joinAttributes(e)}getBounds(e){return this._reader.getBounds(e)}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(e){return this._reader.setDisplayId(e)}setIndex(e){return this._reader.setIndex(e)}getIndex(){return this._reader.getIndex()}readXWorldSpace(){return this._reader.readXWorldSpace()}readYWorldSpace(){return this._reader.readYWorldSpace()}_readX(){return this._reader.readXForDisplay()}_readY(){return this._reader.readYForDisplay()}_readServerCentroid(){return this._reader._readServerCentroid()}readLegacyFeatureForDisplay(){const e=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null}}readLegacyGeometryForDisplay(){const e=this.readGeometryForDisplay();return(0,Fo.di)(e,this.geometryType,!1,!1)}readGeometryArea(){return this._reader.readGeometryArea()}readGeometryWorldSpace(){return this._reader.readGeometryWorldSpace()}_readGeometry(){return this._reader._readGeometry()}_readAttribute(e,t){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(e){return this.readAttribute(e,!0)}hasField(e){return this._reader.hasField(e)}setField(e,t){return this._reader.setField(e,t)}keys(){return this._reader.keys()}castToText(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._reader.castToText(e)}}class Tc{size(){return this.reader.getSize()}get fields(){return this.reader.fields}invalidate(){this._geohashIndex=null,this._geohashIndexHash=null,this._spatialIndex=null,this._gridIndex=null,this._gridIndexHash=null}queryFeaturesInBounds(e){const t=this._getSpatialIndex().search(e);return Sc.from(this.reader,t)}getGeohashIndex(e){const t=JSON.stringify(e);return t!==this._geohashIndexHash&&(this._geohashIndexHash=t,this._geohashIndex=new Ic(e),this._geohashIndex.insert(this.reader,this.isTiled)),this._geohashIndex}getGridIndex(e){const t=JSON.stringify(e);return t!==this._gridIndexHash&&(this._gridIndexHash=t,this._gridIndex=new Qa(e),this._gridIndex.insert(this.reader,this.isTiled)),this._gridIndex}_getSpatialIndex(){return this._spatialIndex||(this._spatialIndex=bc.fromReader(this.reader)),this._spatialIndex}}class Mc extends Tc{constructor(e){super(),this.metadata=e,this.chunkId="override",this.normalizedChunkId="override",this.removed=new Set,this.overridenIds=new Set,this._features=[]}get reader(){return Na.fromOptimizedFeatures(this._features,this.metadata)}get queryInfo(){return{}}get first(){return!1}get end(){return!1}get isTiled(){return!1}applyOverrides(e){super.invalidate();const{reader:t,removed:r}=e,s=[],i=new Set,n=t.getCursor(),o=new Set(r);for(this.overridenIds.clear();n.next();){const e=n.readOptimizedFeatureWorldSpace(),t=e.objectId;s.push(e),i.add(t),this.overridenIds.add(t),this.removed.delete(t)}for(const a of this._features){const e=a.objectId;o.has(e)||i.has(e)||(s.push(a),this.overridenIds.add(e))}this._features=s;for(const a of i.values())this.removed.delete(a);for(const a of r)this.removed.add(a),this.overridenIds.add(a)}getTileReader(e){if(!this._features.length)return null;const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}}class kc extends Do{}class Fc extends No{constructor(e,t,r){super(e,t),this._timeZone=r,this.handledChunks=new Set,this.handledChunksForIdCreation=new Set,this.handledChunksForAttributeData=new Set,this._streamLayerDeferredObjectIdsToRemove=[]}destroy(){super.destroy();for(const e of this._source.chunks())this._cleanupChunkIds(e)}invalidateAttributeData(){this.handledChunksForAttributeData.clear()}onSubscribe(e){super.onSubscribe(e),this._evalOptions=e.tile.createArcadeEvaluationOptions(this._timeZone)}createState(e){return new kc(e)}get aggregateQueryEngine(){return null}displayMap(e,t,r){const s=new Map(e.map((e=>[t(e),e]))),i=[];for(const n of this._source.chunks()){const e=n.reader.getCursor();for(;e.next();){const t=e.getObjectId(),n=e.getDisplayId(),o=s.get(t);if(null!=o){const e=r(n,o,t);i.push(e),s.delete(t)}}}return i}getDisplayFeatures(e){const t=new Set(e),r=new Set,s=[];for(const i of this._source.chunks()){const e=i.reader.getCursor();for(;e.next();){const i=e.getObjectId(),n=e.getDisplayId();t.has(n)&&!r.has(i)&&(s.push({...e.readLegacyFeatureWorldSpace(),displayId:n}),r.add(i))}}return{features:s,aggregates:[]}}async*applyOverride(e){const t=[],r=e.reader.getCursor();for(;r.next();){const e=r.getObjectId();t.push(e);const s=this._attributeStore.createDisplayIdForObjectId(e);r.setDisplayId(s),this._attributeStore.setAttributeData(s,r,this._evalOptions)}const s=this.getDisplayIds(t),i=this.getDisplayIds(e.removed),n=new Mc(this._source.metadata);n.applyOverrides(e),this.handledChunks.add(n.chunkId),this.handledChunksForAttributeData.add(n.chunkId),this.handledChunksForIdCreation.add(n.chunkId);for(const o of this._sendStates.values())o.handledChunks.add(n.chunkId),yield new Lo(o.subscription,null,s,!1,n.queryInfo);for(const o of this._sendStates.values()){const e=n.getTileReader(o.subscription.tile);yield new Lo(o.subscription,e,i,!1,n.queryInfo)}for(const o of e.removed)this._attributeStore.releaseDisplayIdForObjectId(o)}async*updateChunks(){if(this._source.chunks().length){await this._updateAttributeData();for(const e of this._sendStates.values())yield*this._update(e)}}removeChunks(e){for(const t of e)this.handledChunks.delete(t.chunkId),this.handledChunksForAttributeData.delete(t.chunkId),this._cleanupChunkIds(t)}afterUpdateChunks(){for(const e of this._streamLayerDeferredObjectIdsToRemove)this._attributeStore.releaseDisplayIdForObjectId(e);this._streamLayerDeferredObjectIdsToRemove=[]}_cleanupChunkIds(e){if(this.handledChunksForIdCreation.has(e.chunkId)){const t=e.reader.getCursor();for(;t.next();){const e=t.getObjectId();this._source.isStream?this._streamLayerDeferredObjectIdsToRemove.push(e):this._attributeStore.releaseDisplayIdForObjectId(e)}this.handledChunksForIdCreation.delete(e.chunkId)}}async _updateAttributeData(){for(const e of this._source.chunks()){const{chunkId:t,reader:r}=e;if(!this.handledChunksForIdCreation.has(t)){this.handledChunksForIdCreation.add(t);const e=r.getCursor();for(;e.next();){const t=this._attributeStore.createDisplayIdForObjectId(e.getObjectId());e.setDisplayId(t)}}}for(const e of this._source.chunks())if(!this.handledChunksForAttributeData.has(e.chunkId)){this.handledChunksForAttributeData.add(e.chunkId);const t=e.reader.getCursor();for(;t.next();){const e=t.getDisplayId();this._attributeStore.setAttributeData(e,t,this._evalOptions)}}}*_update(e){const{subscription:t,handledChunks:r}=e;for(const s of this._source.chunks()){const{chunkId:i}=s;if(r.has(i))continue;r.add(i);const n=s.getTileReader(t.tile);n&&(yield new Vo(e.subscription,n,!1,s.end,s.queryInfo))}}}class Ec{constructor(e){this.data=e,this._referenceCount=0}increment(){this._referenceCount+=1}decrement(){this._referenceCount-=1}empty(){return 0===this._referenceCount}}class Cc{constructor(){this._freeIdsGenerationA=[],this._freeIdsGenerationB=[],this._idCounter=1,this._freeIds=this._freeIdsGenerationA,this._objectIdToDisplayId=new Map}createIdForObjectId(e){let t=this._objectIdToDisplayId.get(e);return t?t.increment():(t=new Ec(function(e,t){return((t?vn:0)|e)>>>0}(this._getFreeId(),!1)),t.increment(),this._objectIdToDisplayId.set(e,t)),t.data}releaseIdForObjectId(e){const t=this._objectIdToDisplayId.get(e);t&&(t.decrement(),t.empty()&&(this._objectIdToDisplayId.delete(e),this._freeIds.push(t.data)))}releaseAll(){for(const e of this._objectIdToDisplayId.values())this._freeIds.push(e.data);this._objectIdToDisplayId.clear()}incrementGeneration(){this._freeIds=this._freeIds===this._freeIdsGenerationA?this._freeIdsGenerationB:this._freeIdsGenerationA}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}const Pc=()=>R.Z.getLogger("esri.views.layers.2d.features.support.AttributeStore"),Ac=((e,t)=>e&&function(){for(var e=arguments.length,r=new Array(e),s=0;s<e;s++)r[s]=arguments[s];return t.warn("DEBUG:",...r)}||(()=>null))(!1,Pc()),Rc=(0,n.Z)("esri-shared-array-buffer");(0,n.Z)("esri-atomics");class Oc{constructor(e,t,r){this.size=0,this.texelSize=4,this.dirtyStart=0,this.dirtyEnd=0;const{pixelType:s,layout:i,textureOnly:n}=t;this.textureOnly=n||!1,this.pixelType=s,this.layout=i,this._resetRange(),this.size=e,this.isLocal=r,n||(this.data=this._initData(s,e))}get buffer(){return this.data?.buffer}unsetComponentAllTexels(e,t){const r=this.data;for(let s=0;s<this.size*this.size;s++)r[s*this.texelSize+e]&=~t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(e,t){const r=this.data;for(let s=0;s<this.size*this.size;s++)r[s*this.texelSize+e]|=255&t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(e,t,r){const s=this.data;for(const i of r)s[i*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i)}setComponentTexel(e,t,r){this.data[r*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}unsetComponentTexel(e,t,r){this.data[r*this.texelSize+e]&=~t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}getData(e,t){const r=wn(e);return this.data[r*this.texelSize+t]}setData(e,t,r){const s=wn(e),i=1<<t;0!=(this.layout&i)?null!=this.data&&(this.data[s*this.texelSize+t]=r,this.dirtyStart=Math.min(this.dirtyStart,s),this.dirtyEnd=Math.max(this.dirtyEnd,s)):Pc().error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}expand(e){if(this.size=e,!this.textureOnly){const t=this._initData(this.pixelType,e),r=this.data;t.set(r),this.data=t}}toMessage(){const e=this.dirtyStart,t=this.dirtyEnd,r=this.texelSize;if(e>t)return null;this._resetRange();const s=!this.isLocal,i=this.pixelType,n=this.layout,o=this.data;return{start:e,end:t,data:s&&o.slice(e*r,(t+1)*r)||null,pixelType:i,layout:n}}_initData(e,t){const r=ArrayBuffer,i=function(e){switch(e){case ze.Br.UNSIGNED_BYTE:return Uint8Array;case ze.Br.UNSIGNED_SHORT_4_4_4_4:return Uint16Array;case ze.Br.FLOAT:return Float32Array;default:return void ks().error(new s.Z("webgl-utils",`Unable to handle type ${e}`))}}(e),n=new i(new r(t*t*4*i.BYTES_PER_ELEMENT));for(let s=0;s<n.length;s+=4)n[s+1]=255;return n}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class zc{constructor(e){this._client=e,this._filters=[],this._blocks=new Array,this._attributeComputeInfo=null,this._abortController=new AbortController,this._size=f._8,this._idsToHighlight=new Map,this._referencesScale=!1,this._referencesGeometry=!1,this._initialized=!1,this.version=0,this._idGenerator=new Cc,this._epoch=1}destroy(){this._abortController.abort()}_initialize(){if(null!=this._blockDescriptors)return;const e=ze.Br.FLOAT;Ac(`Creating AttributeStore ${Rc?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:ze.Br.UNSIGNED_BYTE,layout:1},{pixelType:ze.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:ze.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:e,layout:15},{pixelType:e,layout:15},{pixelType:e,layout:15},{pixelType:e,layout:15}],this._blocks=this._blockDescriptors.map((()=>null))}get referencesScale(){return this._referencesScale}get referencesGeometry(){return this._referencesGeometry}get _signal(){return this._abortController.signal}get hasHighlight(){return this._idsToHighlight.size>0}createDisplayIdForObjectId(e){return this._idGenerator.createIdForObjectId(e)}releaseDisplayIdForObjectId(e){return this._idGenerator.releaseIdForObjectId(e)}incrementDisplayIdGeneration(){this._idGenerator.incrementGeneration()}releaseAllIds(){this._idGenerator.releaseAll()}async update(e,t,r,s){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const o=(0,m.Hg)(this._schema,e);if(this.version=i,o&&((0,n.Z)("esri-2d-update-debug")&&console.debug(`Version[${i}] AttributeStore.update`,{changed:o}),this._schema=e,this._attributeComputeInfo=null,this._initialize(),null!=e))if(r&&(this._filters=await Promise.all(e.filters.map((e=>e?pa.create({geometryType:r.geometryType,hasM:!1,hasZ:!1,timeInfo:r.timeInfo,fieldsIndex:r.fieldsIndex,spatialReference:s??r.spatialReference,filterJSON:e}):null)))),"subtype"!==e.type)this._attributeComputeInfo={isSubtype:!1,map:new Map},await Promise.all(e.bindings.map((async e=>{const r=await this._bind(t,e);this._referencesGeometry=this._referencesGeometry||(r?.referencesGeometry()??!1),this._referencesScale=this._referencesScale||(r?.referencesScale()??!1)})));else{this._attributeComputeInfo={isSubtype:!0,subtypeField:e.subtypeField,map:new Map},this._referencesScale=!1,this._referencesGeometry=!1;for(const r in e.bindings){const s=e.bindings[r];await Promise.all(s.map((async e=>{const s=await this._bind(t,e,parseInt(r,10));this._referencesGeometry=this._referencesGeometry||(s?.referencesGeometry()??!1),this._referencesScale=this._referencesScale||(s?.referencesScale()??!1)})))}}}setHighlight(e,t){const r=this._getBlock(0);r.unsetComponentAllTexels(0,(1<<Ks.length)-1);for(const{displayId:s,highlightFlags:i}of e){if(null==s)continue;const e=wn(s);r.setComponent(0,i,[e])}this._idsToHighlight.clear();for(const{objectId:s,highlightFlags:i}of e)this._idsToHighlight.set(s,i);for(const{objectId:s,highlightFlags:i}of t)this._idsToHighlight.set(s,i)}setData(e,t,r,s){const i=wn(e);this._ensureSizeForTexel(i),this._getBlock(t).setData(e,r,s)}getData(e,t,r){return this._getBlock(t).getData(e,r)}getHighlightFlags(e){return this._idsToHighlight.get(e)||0}unsetAttributeData(e){const t=wn(e);this._getBlock(0).setData(t,0,0)}setAttributeData(e,t,r){const s=wn(e);this._ensureSizeForTexel(s),this._getBlock(0).setData(s,0,this.getFilterFlags(t));const i=this._attributeComputeInfo;let n=null;i&&(n=i.isSubtype?i.map.get(t.readAttribute(i.subtypeField)):i.map,n?.size&&n.forEach(((e,i)=>{const n=1*i%4,o=Math.floor(1*i/4),a=this._getBlock(o+f.wi.VV);let c=e.field?.read(t,r);e.valueRepresentation&&(c=function(e,t){if(!e||!t)return e;switch(t){case"radius":case"distance":return 2*e;case"diameter":case"width":return e;case"area":return Math.sqrt(e)}return e}(c,e.valueRepresentation)),(null===c||isNaN(c)||c===1/0||c===-1/0)&&(c=ct),a.setData(s,n,c)})))}get epoch(){return this._epoch}async sendUpdates(){const e=this._blocks.map((e=>null!=e?e.toMessage():null)),t=this._getInitArgs();(0,n.Z)("esri-2d-log-updating")&&console.log("AttributeStore: _doSendUpdate.start"),await this._client.update({initArgs:t,blockData:e,version:this.version,sendUpdateEpoch:this._epoch},this._signal),this._epoch+=1,(0,n.Z)("esri-2d-log-updating")&&console.log("AttributeStore: _doSendUpdate.end")}_ensureSizeForTexel(e){for(;e>=this._size*this._size;)if(this._expand())return}async _bind(e,t,r){const s=await e.createComputedField(t),{valueRepresentation:i}=t,n=this._attributeComputeInfo;if(n.isSubtype){const e=n.map.get(r)??new Map;e.set(t.binding,{field:s,valueRepresentation:i}),n.map.set(r,e)}else n.map.set(t.binding,{field:s,valueRepresentation:i});return s}_getInitArgs(){return this._initialized?null:(this._initialized=!0,this._getBlock(f.wi.Animation),this._getBlock(f.wi.GPGPU),{blockSize:this._size,blockDescriptors:this._blocks.map((e=>null!=e?{textureOnly:e.textureOnly,buffer:e.buffer,pixelType:e.pixelType}:null))})}_getBlock(e){const t=this._blocks[e];if(null!=t)return t;Ac(`Initializing AttributeBlock at index ${e}`);const r=new Oc(this._size,this._blockDescriptors[e],this._client.isLocal);return this._blocks[e]=r,this._initialized=!1,r}_expand(){if(this._size<this._schema.capabilities.maxTextureSize){const e=this._size<<=1;Ac("Expanding block size to",e,this._blocks);for(const t of this._blocks)t?.expand(e);return this._initialized=!1,this._size=e,0}return Pc().error(new s.Z("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}isVisible(e){return!!(this._getBlock(0).getData(e,0)&1<<Ks.length)}getFilterFlags(e){let t=0;for(let s=0;s<this._filters.length;s++){const r=!!(1<<s),i=this._filters[s];t|=(!r||null==i||i.check(e)?1:0)<<s}let r=0;if(this._idsToHighlight.size){const t=e.getObjectId();r=this.getHighlightFlags(t)}return t<<Ks.length|r}}class Dc{constructor(e,t){this._connection=e,this._source=t,this._version=1,this._proxy=new So({fetch:(e,t)=>this._connection.layerView.fetch(e,t),fetchDictionary:(e,t)=>this._connection.layerView.fetchDictionary(e,t)}),this._attributeStore=new zc({isLocal:!1,update:e=>(0,a.R8)(this._connection.container.updateAttributeView(e))})}destroy(){this._proxy.destory(),this._strategy?.destroy(),this._attributeStore.destroy()}get aggregateQueryEngine(){return this._strategy?.aggregateQueryEngine}getDisplayFeatures(e){return this._strategy?this._strategy.getDisplayFeatures(e):{features:[],aggregates:[]}}getFeatureObjectIdsForAggregate(e){return this._strategy?this._strategy.getFeatureObjectIdsForAggregate(e):[]}onSubscribe(e){this._strategy?.onSubscribe(e)}onUnsubscribe(e){this._strategy?.onUnsubscribe(e)}async update(e,t,r,s,i){const o=e.processor,a=(0,m.Hg)(this._schema,o);if(!a&&!s)return;(0,n.Z)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] SymbolProcessor.update`,{changes:a,schema:o}),this._schema=o;const c=g.Z.fromJSON(e.source.mutable.dataFilter.outSpatialReference),u=new na({fields:this._source.metadata.fieldsIndex,spatialReference:c});return await this._attributeStore.update(o.storage,u,this._source.metadata,c,t),this._strategy?.invalidateAttributeData(),s||(0,m.uD)(a,"mesh")?((0,m.uD)(a,"mesh.strategy")&&await this._updateStrategy(o.mesh.strategy,c,i,o.mesh.timeZone),this._updateSortKey(u,"sortKey"in o.mesh?o.mesh.sortKey:null),((0,m.uD)(a,"mesh.factory")||"dictionary"===o.mesh.factory.symbology.type)&&(this._factory=await wo.create(u,this._proxy,o.mesh.factory,r)),this._invalidate(),this._version=t,this._connection.container.updateRenderState(this._version)):void 0}async applyOverride(e){if(!this._strategy)return;const t=this._strategy.applyOverride(e);for await(const r of t)try{await this._process(r)}catch(w){}this._source.applyOverride(e)}async updateChunks(){await this._doUpdateChunks(),this._strategy?.afterUpdateChunks()}async removeChunks(e){this._strategy?.removeChunks(e),this._attributeStore.incrementDisplayIdGeneration()}updateHighlight(e){let{highlights:t}=e;if(!this._strategy)return void this._attributeStore.setHighlight(t.map((e=>{let{objectId:t,highlightFlags:r}=e;return{objectId:t,highlightFlags:r,displayId:-1}})),t);const r=this._strategy.displayMap(t,(e=>{let{objectId:t}=e;return t}),((e,t,r)=>{let{highlightFlags:s}=t;return{objectId:r,displayId:e,highlightFlags:s}}));this._attributeStore.setHighlight(r,t)}async _doUpdateChunks(){if(!this._strategy)return;const e=this._strategy.updateChunks(),t=[],r=new Map;for await(const i of e){let e=r.get(i.id);null==e&&(e=new Mo({concurrency:16,process:e=>this._process(e)}),r.set(i.id,e));const s=e.push(i).catch((e=>(0,a.H9)(e)));t.push(s)}try{await Promise.all(t)}catch(s){}(0,n.Z)("esri-2d-update-debug")&&console.log("SendUpdates"),await this._attributeStore.sendUpdates(),(0,n.Z)("esri-2d-update-debug")&&console.log("SendUpdates.await")}async _updateStrategy(e,t,r,s){switch(this._strategy?.destroy(),e.type){case"feature":this._strategy=new Fc(this._source,this._attributeStore,s);break;case"binning":this._strategy=await Va.create(e,t,this._source,this._attributeStore,s);break;case"cluster":this._strategy=await sc.create(this._connection,e,t,this._source,this._attributeStore,s)}for(const i of r)this._strategy.onSubscribe(i)}async _updateSortKey(e,t){if(this._sortInfo=(0,y.SC)(this._sortInfo?.computed),null!=t){const r=t.byRenderer?null:await e.createComputedField(t);this._sortInfo={...t,computed:r}}}_invalidate(){this._strategy&&this._strategy.invalidate()}async _process(e){const t=e.subscription;if((0,n.Z)("esri-2d-update-debug")){const r=t.tile;console.debug(`Version[${this._version}] Tile[${r.key.id}, end=${e.end}] Processor._process`)}await this._fetchResources(e),(0,a.k_)(t.signal);const r=await this._write(e,t.tile.createArcadeEvaluationOptions(this._schema.mesh.timeZone)),s=t.tile.tileInfoView.tileInfo.isWrappable,{message:i,transferList:o}=r.serialize(s),c=e.createMessage(i,this._version,this._attributeStore.epoch);if((0,a.k_)(t.signal),this._connection.container.onMessage(c,{signal:t.signal,transferList:o}),this._attributeStore.sendUpdates(),(0,n.Z)("esri-2d-update-debug")){const r=t.tile;console.debug(`Version[${this._version}] Tile[${r.key.id}, end=${e.end}] Processor._process.await`)}}async _fetchResources(e){await this._fetchMatcherResources(e),await this._fetchWriterResources(e)}async _fetchMatcherResources(e){if(e.reader)return this._factory.enqueueMatcherRequests(this._proxy,e.reader)}async _fetchWriterResources(e){if(!e.reader)return;const t=e.reader.getCursor(),r=e.subscription.tile.createArcadeEvaluationOptions(this._schema.mesh.timeZone);for(;t.next();)this._factory.enqueueWriterRequests(this._proxy,t,r);await this._proxy.fetchEnqueuedResources()}async _write(e,t){const r=e.subscription.tile,s=e.reader?.getCursor(),i=s?.getSize()??0,n=r.tileInfoView.tileInfo.isWrappable,o=new E(r.key,this._strategy.enablePixelBuffering,n,i);if(!s)return o;const a=r.createArcadeEvaluationOptions(this._schema.mesh.timeZone);for(;s.next();){const e=this._getSortKeyValue(s,t);o.entityStart(s.getDisplayId(),e),this._factory.write(o,this._proxy,s,a,r.level),o.entityEnd()}return o}_getSortKeyValue(e,t){if(!this._sortInfo)return 0;const{computed:r,order:s,byRenderer:i}=this._sortInfo,n=i?this._factory.getSortKey(e,t):r?.read(e,t);return null==n||isNaN(n)?0:n*("asc"===s?-1:1)}}var Nc=r(76200),Bc=r(5192);class Vc{static from(e){let t=0,r=0,s=0;return e.forEach((e=>{const i=e._readGeometry();i&&(r+=i.isPoint?1:i.lengths.reduce(((e,t)=>e+t),0),s+=i.isPoint?1:i.lengths.length,t+=1)})),new Vc(t,r,s)}constructor(e,t,r){this.featureCount=e,this.vertexCount=t,this.ringCount=r}toJSON(){return{featureCount:this.featureCount,ringCount:this.featureCount,vertexCount:this.featureCount}}}var Lc=r(62044),Gc=r(25899);class Uc{static fromSchema(e,t){return new Uc(function(e,t){const{service:r}=e,s=r.orderByFields??t.objectIdField+" ASC",i=r.source,n={returnCentroid:!(null!==i&&"object"==typeof i&&"path"in i&&(0,Gc.M8)(i.path))&&"esriGeometryPolygon"===t.geometryType,returnGeometry:!0,timeReferenceUnknownClient:t.timeReferenceUnknownClient??void 0,outSpatialReference:g.Z.fromJSON(e.mutable.dataFilter.outSpatialReference),orderByFields:[s],where:e.mutable.dataFilter.definitionExpression??"1=1",outFields:e.mutable.availableFields};if("feature"===e.type){const{gdbVersion:t,historicMoment:r,timeExtent:s}=e.mutable.dataFilter;return{...n,gdbVersion:t,historicMoment:r?new Date(r):null,timeExtent:s?Lc.Z.fromJSON(s):null,outFields:e.mutable.availableFields}}return n}(e,t),e.mutable.dataFilter.customParameters,t.geometryType,e.service.queryMetadata.capabilities)}constructor(e,t,r,s){this._queryParams=e,this._customParameters=t,this._geometryType=r,this._capabilities=s}get pageSize(){if(null==this._capabilities)throw new Error("InternalError: Service does not support paged queries");const{query:e}=this._capabilities,t=e.supportsMaxRecordCountFactor?4:null,r=(e.maxRecordCount??8e3)*(t??1);return Math.min(8e3,r)}updateFields(e){this._queryParams.outFields=e}createPatchFieldsQuery(e,t){const r=e.clone();if("*"===this._queryParams.outFields[0]){if("*"===(r.outFields??[])[0])return null;r.outFields=this._queryParams.outFields}else{const e=new Set(this._queryParams.outFields),s=[];for(const r of e)t.hasField(r)||s.push(r);if(0===s.length)return null;r.outFields=s}return r.returnGeometry=!1,r.returnCentroid=!1,r.quantizationParameters=null,r.cacheHint=!0,{inner:r,customParameters:this._customParameters}}createQuery(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this._queryParams)throw new Error("InternalError: queryInfo should be defined");return{inner:new ha.Z({...this._queryParams,...e}),customParameters:this._customParameters}}createTileQuery(e,t){if(null==this._capabilities)throw new Error("InternalError: Service does not support tile queries");const r=this.createQuery(t),s=r.inner;return s.quantizationParameters=t.quantizationParameters??e.getQuantizationParameters(),s.resultType="tile",s.geometry=e.extent,this._capabilities.query.supportsQuantization?"esriGeometryPolyline"===this._geometryType&&(s.maxAllowableOffset=e.resolution*(0,n.Z)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==this._geometryType&&"esriGeometryPolygon"!==this._geometryType||(s.maxAllowableOffset=e.resolution,"esriGeometryPolyline"===this._geometryType&&(s.maxAllowableOffset*=(0,n.Z)("feature-polyline-generalization-factor"))),s.defaultSpatialReferenceEnabled=this._capabilities.query.supportsDefaultSpatialReference,s.compactGeometryEnabled=this._capabilities.query.supportsCompactGeometry,this._capabilities.query.supportsMaxRecordCountFactor&&(s.maxRecordCountFactor=4),r}createPagedTileQuery(e,t){const r=this.pageSize;return this.createTileQuery(e,{start:r*t,num:r,returnExceededLimitFeatures:!0})}createPagedQuery(e){const t=this.pageSize;return this.createQuery({start:t*e,num:t,returnExceededLimitFeatures:!0,maxRecordCountFactor:4})}}let qc=class extends Zs.Z{constructor(e){super(),this._connection=e,this._enabledEventTypes=new Set,this._updateInfo={websocket:0,client:0},this._lastTime=performance.now(),this.addHandles([(0,u.YP)((()=>this._strategy?.connectionStatus??"disconnected"),(e=>{this._layerView.setProperty({propertyName:"pipelineConnectionStatus",value:e})}),{initial:!0}),(0,u.YP)((()=>this._strategy?.errorString||null),(e=>this._layerView.setProperty({propertyName:"pipelineErrorString",value:e})),{initial:!0})])}destroy(){this._strategy=null,this.removeAllHandles()}get _layerView(){return this._connection.layerView}set strategy(e){null==this._strategy&&this._resetUpdateInfo(performance.now());const t="event-handles";this.removeHandles(t),null!=e&&this.addHandles([e.events.on("data-received",(e=>this._onFeature(e))),e.events.on("message-received",(e=>this._onWebSocketMessage(e))),e.events.on("features-updated",(e=>this._onUpdate(e))),e.events.on("tick",(()=>this._onTick()))],t),this._strategy=e}updateCustomParameters(e){null!=e&&this._strategy?.updateCustomParameters(e)}sendMessageToSocket(e){this._strategy?.sendMessageToSocket(e)}sendMessageToClient(e){this._strategy?.sendMessageToClient(e)}enableEvent(e,t){t?this._enabledEventTypes.add(e):this._enabledEventTypes.delete(e)}disconnect(){this._strategy?.disconnect()}connect(){this._strategy?.connect()}clear(){this._strategy?.clear()}_onWebSocketMessage(e){this._enabledEventTypes.has("message-received")&&this._layerView.emitEvent({name:"message-received",event:e})}_onFeature(e){this._updateInfo.websocket++,this._enabledEventTypes.has("data-received")&&this._layerView.emitEvent({name:"data-received",event:{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry}})}_onUpdate(e){this._updateInfo.client+=e}_onTick(){const e=performance.now(),t=e-this._lastTime;if(t>2500){const r=Math.round(this._updateInfo.client/(t/1e3)),s=Math.round(this._updateInfo.websocket/(t/1e3));this._resetUpdateInfo(e),this._layerView.emitEvent({name:"update-rate",event:{client:r,websocket:s}})}}_resetUpdateInfo(e){this._lastTime=e,this._updateInfo.client=0,this._updateInfo.websocket=0}};(0,St._)([(0,Ys.Cb)()],qc.prototype,"_strategy",void 0),qc=(0,St._)([(0,js.j)("esri.views.2d.layers.features.sources.StreamMessenger")],qc);class Wc{constructor(e){this._store=e,this._controller=new AbortController}destroy(){this._controller.abort()}get _options(){return{signal:this._controller.signal}}async queryOverride(e){throw new Error("InternalError: LoadStrategy does not support fetching")}}var Zc=r(18008),Yc=r(58971),jc=r(67213),$c=r(78084),Hc=r(91347);const Xc=268435455;class Kc{constructor(){this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}}const Qc=268435455,Jc=128e3,eu={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(Jc),decoded:new Int32Array(Jc)}};function tu(e){return e<=eu.small.delta.length?eu.small:(e<=eu.large.delta.length||(eu.large.delta=new Int32Array(Math.round(1.25*e)),eu.large.decoded=new Int32Array(Math.round(1.25*e))),eu.large)}function ru(e){for(;e.next();){if(1===e.tag())return e.getMessage();e.skip()}return null}function su(e,t,r,s,i,n){return.5*Math.abs(e*s+r*n+i*t-e*n-r*t-i*s)}function iu(e,t,r,s){return 0===e*s-r*t&&e*r+t*s>0}class nu extends Da{static fromBuffer(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=t.geometryType,n=function(e){try{const t=2,r=new $c.Z(new Uint8Array(e),new DataView(e));for(;r.next();){if(r.tag()===t)return ru(r.getMessage());r.skip()}}catch(n){const t=new s.Z("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:n});R.Z.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(t)}return null}(e),o=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=e.asUnsafe(),n=i.pos(),o=new Kc;let a=0,c=0,u=null,l=null,h=null,d=!1;const p=[];for(;i.next();)switch(i.tag()){case 1:u=i.getString();break;case 3:l=i.getString();break;case 12:h=i.processMessage(Hc.G$);break;case 9:if(o.exceededTransferLimit=i.getBool(),o.exceededTransferLimit){o.offsets.geometry=r?new Float64Array(8e3):new Int32Array(8e3),o.centroid=r?new Float64Array(16e3):new Int32Array(16e3);for(let e=0;e<o.centroid.length;e++)o.centroid[e]=Xc}break;case 13:{const e=i.processMessage(Hc.wn);e.index=a++,p.push(e);break}case 15:{const e=i.getLength(),s=i.pos()+e;if(!o.exceededTransferLimit){const e=o.offsets.geometry,t=o.centroid;e.push(0),t.push(Xc),t.push(Xc)}!d&&o.exceededTransferLimit&&(d=!0,o.offsets.attributes=r?new Float64Array(8e3*a):new Uint32Array(8e3*a));let n=c*a;for(;i.pos()<s&&i.next();)switch(i.tag()){case 1:{d?o.offsets.attributes[n++]=i.pos():o.offsets.attributes.push(i.pos());const e=i.getLength();i.skipLen(e);break}case 2:if(t){const e=i.getLength(),t=i.pos()+e;for(;i.pos()<t&&i.next();)switch(i.tag()){case 3:{i.getUInt32();const e=i.getSInt64(),t=i.getSInt64();o.centroid[2*c]=e,o.centroid[2*c+1]=t;break}default:i.skip()}}else{o.offsets.geometry[c]=i.pos();const e=i.getLength();o.vertexCount+=e,i.skipLen(e)}break;case 4:{const e=i.getLength(),t=i.pos()+e;for(;i.pos()<t&&i.next();)switch(i.tag()){case 3:{i.getUInt32();const e=i.getSInt64(),t=i.getSInt64();o.centroid[2*c]=e,o.centroid[2*c+1]=t;break}default:i.skip()}break}default:i.skip()}c++,o.hasFeatures=!0;break}default:i.skip()}const f=u||l;if(!f)throw new s.Z("FeatureSet has no objectId or globalId field name");return o.fields=new fa.Z(p),o.featureCount=c,o.fieldCount=a,o.objectIdFieldIndex=o.fields.get(f)?.index,o.transform=h,o.displayIds=new Uint32Array(o.featureCount),o.groupIds=new Uint16Array(o.featureCount),i.move(n),o}(n,"esriGeometryPoint"===i,r);return new nu(n,o,t)}constructor(e,t,r){super(r),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._parseCaches=new Array,this._geometryType=r.geometryType,this._reader=e,this._header=t,this._hasNext=t.hasFeatures,this._isPoints="esriGeometryPoint"===r.geometryType}get _size(){return this._header.featureCount}get fields(){return this._header.fields}get geometryType(){return this._geometryType}get hasZ(){return!1}get hasM(){return!1}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this._size}getInTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e}getAttributeHash(){let e="";for(const t of this._header.fields.fields)e+=this._readAttributeAtIndex(t.index)+".";return e}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(e){this._header.displayIds[this._featureIndex]=e}readGeometryArea(){return this._cache.area||this._readGeometry(!0),this._cache.area}copy(){const e=this._reader.clone(),t=new nu(e,this._header,this.metadata);return this.copyInto(t),t}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}_readX(){return this._header.centroid[2*this._featureIndex]}_readY(){return this._header.centroid[2*this._featureIndex+1]}_readServerCentroid(){const e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1];return e===Qc?null:new H.Z([],[e,t])}_readGeometry(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this._cache.geometry){let r=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===Qc)return null;const e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1];r=new H.Z([],[e,t])}else{const s=this._header.offsets.geometry[this._featureIndex],i=this._reader;if(0===s)return null;i.move(s);try{r=e?this._parseGeometryForDisplay(i):this._parseGeometry(i)}catch(t){return console.error("Failed to parse geometry!",t),null}}return 0===r?.coords.length&&(r=null),this._cache.geometry=r,r}return this._cache.geometry}_readAttribute(e,t){const r=this._header.fields.get(e);if(null==r)return;let s=this._readAttributeAtIndex(r.index);"esriFieldTypeTimestampOffset"===this.fields.get(e)?.type&&(s=this.parseTimestampOffset(s));const i=this._header.fields.isDateField(r.name);return t?null==s?s:i?new Date(s):s:s}_readAttributes(){const e={};for(const t of this._header.fields.fields)e[t.name]=this._readAttributeAtIndex(t.index);return e}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext,e._parseCaches=this._parseCaches}_readAttributeAtIndex(e){let t=this._parseCaches[e];if(t||(t=new wa(this.getSize()),this._parseCaches[e]=t),t.has(this._featureIndex))return t.get(this._featureIndex);const r=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],s=this._reader;s.move(r);const i=function(e){const t=e.getLength(),r=e.pos()+t;for(;e.pos()<r&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}(s);return t.set(this._featureIndex,i),i}_readGeometryDeltaDecoded(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this._cache.unquantGeometry){const t=this._readGeometry(e);if(!t)return this._cache.unquantGeometry=void 0,null;if(!this.getInTransform())return this._cache.unquantGeometry=t,t;const r=tu(t.coords.length).decoded,s=t.clone(r),i=s.coords;let n=0;for(const e of s.lengths){for(let t=1;t<e;t++){const e=2*(n+t),r=2*(n+t-1);i[e]+=i[r],i[e+1]+=i[r+1]}n+=e}return this._cache.unquantGeometry=s,s}return this._cache.unquantGeometry}_parseGeometry(e){const t=e.asUnsafe(),r=t.getLength(),s=t.pos()+r,i=[],n=[];for(;t.pos()<s&&t.next();)switch(t.tag()){case 2:{const e=t.getUInt32(),r=t.pos()+e;for(;t.pos()<r;)n.push(t.getUInt32());break}case 3:{const e=t.getUInt32(),r=t.pos()+e;for(i.push(t.getSInt64()),i.push(t.getSInt64()),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();t.pos()<r;)i.push(t.getSInt64()),i.push(t.getSInt64()),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();break}default:t.skip()}return new H.Z(n,i)}_parseGeometryForDisplay(e){const t=e.asUnsafe(),r=t.getLength(),s=t.pos()+r,i=[],n=[];let o=0,a=0,c=null,u=0;const l="esriGeometryPolygon"===this.geometryType;for(;t.pos()<s&&t.next();)switch(t.tag()){case 2:{const e=t.getUInt32(),r=t.pos()+e;for(;t.pos()<r;){const e=t.getUInt32();i.push(e),o+=e}c=tu(2*o).delta;break}case 3:{t.getUInt32();const e=2+(this.hasZ?1:0)+(this.hasM?1:0);(0,y.O3)(c);for(const r of i)if(a+e*r>c.length)for(let e=0;e<r;e++)t.getSInt32(),t.getSInt32(),this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();else if(l){const e=this.getAreaSimplificationThreshold(r,this._header.vertexCount);let s=2,i=1;const o=!1;let l=t.getSInt32(),h=t.getSInt32();c[a++]=l,c[a++]=h,this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();let d=t.getSInt32(),p=t.getSInt32();for(this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();s<r;){let r=t.getSInt32(),n=t.getSInt32();this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();const o=l+d,f=h+p;su(l,h,o,f,o+r,f+n)>=e?(u+=-.5*(o-l)*(f+h),i>1&&iu(c[a-2],c[a-1],d,p)?(c[a-2]+=d,c[a-1]+=p):(c[a++]=d,c[a++]=p,i++),l=o,h=f):(r+=d,n+=p),d=r,p=n,s++}i<3||o?a-=2*i:(u+=-.5*(l+d-l)*(h+p+h),iu(c[a-2],c[a-1],d,p)?(c[a-2]+=d,c[a-1]+=p,n.push(i)):(c[a++]=d,c[a++]=p,n.push(++i)))}else{let e=0,s=t.getSInt32(),i=t.getSInt32();this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32(),c[a++]=s,c[a++]=i,e+=1;for(let n=1;n<r;n++){const r=t.getSInt32(),o=t.getSInt32(),l=s+r,h=i+o;u+=-.5*(l-s)*(h+i),this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32(),n>2&&iu(c[a-2],c[a-1],r,o)?(c[a-2]+=r,c[a-1]+=o):(c[a++]=r,c[a++]=o,e+=1),s=l,i=h}n.push(e)}break}default:t.skip()}return this._cache.area=u,n.length?new H.Z(n,c):null}}class ou{constructor(e,t){this.service=e,this._metadata=t}destroy(){}}class au extends ou{constructor(e,t){super(e,t),this._portsOpen=async function(e){const t=new Zc.Z;return await t.open(e,{}),t}(e.source).then((e=>this.client=e))}destroy(){this.client.close(),this.client=null}async executeQuery(e,t){await this._portsOpen;const r=await this.client.invoke("queryFeatures",e.toJSON(),t);return Na.fromFeatureSet(r,this._metadata)}}class cu extends ou{async executeQuery(e,t){const{data:r}=await(0,Bc.n7)(this.service.source,e,t),s=!e.quantizationParameters;return nu.fromBuffer(r,this._metadata,s)}}class uu extends ou{async executeQuery(e,t){const{source:r,queryMetadata:s}=this.service,i=s.capabilities;if(null!=e.quantizationParameters&&!i.query.supportsQuantization){const s=e.clone(),i=(0,Yc.vY)(s.quantizationParameters);s.quantizationParameters=null;const{data:n}=await(0,Bc.JT)(r,s,this._metadata.spatialReference,t),o=(0,Fo.h_)(n,this._metadata.objectIdField);return(0,Fo.RZ)(i,o),Na.fromOptimizedFeatureSet(o,this._metadata)}const{data:n}=await(0,Bc.JT)(r,e,this._metadata.spatialReference,t);return"esriGeometryPoint"===this._metadata.geometryType&&(n.features=n.features?.filter((e=>{if(null!=e.geometry){const t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0}))),Na.fromFeatureSet(n,this._metadata)}}class lu extends ou{async executeQuery(e,t){const{capabilities:r}=this.service.queryMetadata;if(e.quantizationParameters&&!r.query.supportsQuantization){const r=e.clone(),s=(0,Yc.vY)(r.quantizationParameters);r.quantizationParameters=null;const i=await(0,jc.WW)(this.service.source,e,t);return(0,Fo.RZ)(s,i),Na.fromOptimizedFeatureSet(i,this._metadata)}const s=await(0,jc.WW)(this.service.source,e,t);return Na.fromOptimizedFeatureSet(s,this._metadata)}}class hu extends Wc{constructor(e,t,r,s,i){super(r),this._serviceInfo=e,this._queryInfo=t,this._metadata=s,this._eventLog=i,this._queue=new To.e({concurrency:16,process:async e=>{const t={signal:e.options?.signal,query:e.query.customParameters};return this._adapter.executeQuery(e.query.inner,t)}}),this._adapter=function(e,t){switch(e.type){case"memory":return new au(e,t);case"ogc":return new lu(e,t);case"feature-service":return e.queryMetadata.capabilities.query.supportsFormatPBF&&(0,n.Z)("featurelayer-pbf")?new cu(e,t):new uu(e,t)}}(e,s)}async updateFields(e){this._queryInfo.updateFields(e);const t=Array.from(this._store.chunks()).map((async e=>{const r=ha.Z.fromJSON(e.queryInfo.queryJSON);if(r)try{return await this._tryUpdateFields(e.reader,r),null}catch(t){return t}})),r=(await Promise.all(t)).filter((e=>e));if(r.length)throw new s.Z("featurelayer-query","Encountered errors when downloading fields",{errors:r})}async queryOverride(e){let{edits:t}=e;const r=[],s=[];for(const o of t.removed)null!=o.objectId&&-1!==o.objectId?r.push(o.objectId):s.push(o.globalId);s.length&&r.push(...this._mapGlobalIdsToObjectIds(s));const i=t.addOrModified.map((e=>{let{objectId:t}=e;return t}));let n;if(i.length){const e=this._queryInfo.createQuery({objectIds:i});n=await this._fetch(e)}else n=Na.empty(this._metadata);return{reader:n,removed:r}}_mapGlobalIdsToObjectIds(e){const t=new Set(e),r=this._metadata.globalIdField;if(null==r)throw new Error("InternalError: Recieved an edit with globalIds, but not supported by the service");const s=[];return this._store.forEachUnsafe((e=>{const i=e.readAttribute(r);t.has(i)&&s.push(e.getObjectId())})),s}async _fetch(e,t){const r=await this._enqueue(e,t);return await this._tryUpdateFields(r,e.inner),r}async _tryUpdateFields(e,t){const r=this._queryInfo.createPatchFieldsQuery(t,e);if(!r)return;const s=await this._enqueue(r,this._options);e.joinAttributes(s)}async _enqueue(e,t){return this._eventLog.onEvent({type:"fetchStart"}),this._queue.push({query:e,options:t}).finally((()=>{this._eventLog.onEvent({type:"fetchEnd",done:0===this._queue.length})}))}}class du extends hu{constructor(){super(...arguments),this._chunksById=new Map}unload(e){this._removeChunks(e.tile)}_addChunk(e){const t=e.tile.id;this._chunksById.has(t)||this._chunksById.set(t,[]);const r=e.size();(r||e.first||e.end)&&((0,n.Z)("esri-2d-update-debug")&&console.debug(`Chunk[${e.chunkId}] ATileLoadStrategy.addChunk [count=${r}]`),this._chunksById.get(t).push(e),this._store.insert(e))}_removeChunks(e){const t=this._chunksById.get(e.key.id)??[];for(const r of t)(0,n.Z)("esri-2d-update-debug")&&console.debug(`Tile[${e.key.id}] Chunk[${r.chunkId}] ATileLoadStrategy.removeChunk`),this._store.remove(r);this._chunksById.delete(e.key.id)}}class pu extends Tc{constructor(e,t,r,s,i,n){super(),this._reader=e,this._queryJSON=t,this._tile=r,this._sourceTile=s,this._sourceTileDepth=i,this._end=n,this.chunkId=`${this._tile.key.id}.${this._sourceTile?.key.id}${this._end?"e":""}`,this.normalizedChunkId=`${this._tile.key.normalizedId}.${this._sourceTile?.key.normalizedId}${this._end?"e":""}`}get queryInfo(){return{type:"drill-down-tile",chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,sourceTileDepth:this._sourceTileDepth,sourceTileId:this._sourceTile?.key.id,size:this.size(),end:this.end}}get first(){return 0===this._sourceTileDepth}get reader(){return this._reader}get end(){return this._end}get tile(){return this._tile}get isTiled(){return!0}getTileReader(e){return this._tile.key.id===e.key.id?this.reader:null}}class fu{constructor(e,t){this.subscription=e,this._tileIdToResult=new Map,this._controller=new AbortController,(0,a.fu)(e.options,(()=>this._controller.abort())),(0,a.fu)(t,(()=>this._controller.abort()))}get(e){return this._tileIdToResult.get(e)}set(e,t){this._tileIdToResult.set(e,t)}get options(){return{signal:this._controller.signal}}}class _u extends du{constructor(){super(...arguments),this._loadStates=new Map}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(e){this._loadStates.has(e.key.id)||this._loadStates.set(e.key.id,new fu(e,this._options));const t=this._loadStates.get(e.key.id);let r;try{for await(const r of this._fetchChunkInfos(t,e.tile,0)){const{queryJSON:t,reader:s,sourceTile:i,sourceTileDepth:n,tile:o}=r,c=new pu(s,t,o,i,n,!1);(0,a.k_)(e.options),this._addChunk(c)}}catch(i){r=i}const s=new pu(Na.empty(this._metadata),null,e.tile,null,-1,!0);if(this._addChunk(s),r)throw r}unload(e){super.unload(e),this._loadStates.delete(e.key.id)}async*_fetchChunkInfos(e,t,r){let s=e.get(t.id);const i=!!s;if(s||(s=await this._fetchChunkInfo(e,t,r),e.set(t.id,s)),s.reader.exceededTransferLimit&&r<(0,n.Z)("featurelayer-query-max-depth"))for(const n of t.createChildTiles())yield*this._fetchChunkInfos(e,n,r+1);else i||(yield s)}async _fetchChunkInfo(e,t,r){const s=e.subscription.tile.getQuantizationParameters(),i=this._queryInfo.createTileQuery(t,{returnExceededLimitFeatures:!1,quantizationParameters:s});return{reader:await this._fetch(i,e.subscription.options),queryJSON:i.inner.toJSON(),tile:e.subscription.tile,sourceTile:t,sourceTileDepth:r}}}class yu extends Tc{constructor(e,t,r,s,i){super(),this._reader=e,this._queryJSON=t,this._tile=r,this._page=s,this._end=i,this.chunkId=`${this._tile.key.id}.${this._page}${this.end?"e":""}`,this.normalizedChunkId=`${this._tile.key.normalizedId}.${this._page}${this.end?"e":""}`}get queryInfo(){return{type:"paged-tile",chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get reader(){return this._reader}get first(){return 0===this._page}get end(){return this._end}get page(){return this._page}get tile(){return this._tile}get isTiled(){return!0}getTileReader(e){return this._tile.key.id===e.key.id?this.reader:null}}class mu{constructor(e,t){this.subscription=e,this._pages=new Set,this._controller=new AbortController,this._done=!1,(0,a.fu)(e.options,(()=>this._controller.abort())),(0,a.fu)(t,(()=>this._controller.abort()))}resetAbortController(){this._controller=new AbortController}get pageStart(){let e=-1;for(const t of this._pages.values())e=Math.max(e,t);return e+1}get done(){return this._done}get options(){return{signal:this._controller.signal}}add(e,t){this._pages.add(e),this._done=this._done||t}}class gu extends du{constructor(){super(...arguments),this._loadStates=new Map}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(e){this._loadStates.has(e.key.id)||this._loadStates.set(e.key.id,new mu(e,this._options));const t=this._loadStates.get(e.key.id);let r;t.resetAbortController();try{await this._fetchPages(t)}catch(i){r=i}const s=new yu(Na.empty(this._metadata),null,e.tile,-1,!0);if((0,a.Hc)(t.options)||this._addChunk(s),r)throw r}unload(e){super.unload(e),this._loadStates.delete(e.key.id)}async _fetchPages(e){let t=0,r=e.pageStart,s=1;for(;t<20&&!e.done;){const i=[];for(let t=0;t<s;t++)i.push(this._fetchChunk(e,r++));const n=await Promise.all(i);for(const t of n)(0!==t.size()||t.first)&&(e.add(t.page,!t.reader.exceededTransferLimit),(0,a.k_)(e.options),this._addChunk(t));t++,s=Math.min(s+1,4)}}async _fetchChunk(e,t){const r=e.subscription.tile,s=this._queryInfo.createPagedTileQuery(r,t),i=await this._fetch(s,e.options);return new yu(i,s.inner.toJSON(),r,t,!1)}}class xu extends Tc{constructor(e,t,r,s){super(),this._reader=e,this._queryJSON=t,this._page=r,this._end=s,this.chunkId=`${this._page}${this.end?"e":""}`,this.normalizedChunkId=this.chunkId}get reader(){return this._reader}get first(){return 0===this._page}get end(){return this._end}get queryInfo(){return{type:"snapshot",chunkId:this.chunkId,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(e){const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}}class bu extends hu{constructor(e,t,r,s,i,n){super(e,t,r,i,n),this._random=new c.Z(1e3),this._featureCount=s}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}load(e){return null==this._promise&&(this._promise=this._downloadPages(this._featureCount)),this._promise}unload(e){}async _downloadPages(e){const t=Math.ceil(e/this._queryInfo.pageSize),r=Array.from({length:t},((e,t)=>t)).sort(((e,t)=>this._random.getInt()-this._random.getInt())),i=await Promise.all(r.map((e=>this._downloadPage(e)))),n=new xu(Na.empty(this._metadata),null,-1,!0);this._store.insert(n);const o=i.filter((e=>e));if(o.length)throw new s.Z("featurelayer-query","Encountered errors when downloading data",{errors:o})}async _downloadPage(e){try{const t=this._queryInfo.createPagedQuery(e),r=await this._fetch(t,this._options),s=new xu(r,t.inner.toJSON(),e,!1);return(0,a.k_)(this._options),this._store.insert(s),null}catch(t){return t}}}var vu=r(41700),wu=r(97463);let Iu=class extends Zs.Z{constructor(e){super(e)}get connectionStatus(){return this.connection?.connectionStatus}get errorString(){return this.connection?.errorString}};(0,St._)([(0,Ys.Cb)()],Iu.prototype,"connection",void 0),(0,St._)([(0,Ys.Cb)()],Iu.prototype,"connectionStatus",null),(0,St._)([(0,Ys.Cb)()],Iu.prototype,"errorString",null),Iu=(0,St._)([(0,js.j)("esri.views.2d.layers.features.sources.StreamConnectionState")],Iu);class Su{constructor(e,t){this._metadata=e,this._onUpdate=t,this._objectIdToFeature=new Map}get size(){return this._objectIdToFeature.size}get reader(){return Na.fromFeatures([...this._objectIdToFeature.values()],this._metadata)}add(e){this._objectIdToFeature.set(e.objectId,e)}forEach(e){this._objectIdToFeature.forEach(e)}removeById(e){const t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),t):null}clear(){this._objectIdToFeature=new Map}update(e,t){this._onUpdate(e?.length??0)}}class Tu extends Tc{constructor(e){super(),this._reader=e,this.chunkId="stream-chunk",this.normalizedChunkId="stream-chunk"}get reader(){return this._reader}get first(){return!0}get end(){return!0}get queryInfo(){return{type:"stream",chunkId:this.chunkId,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(e){const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}}class Mu extends Wc{constructor(e,t,r,s,i){super(r),this._service=e,this._dataFilter=t,this._streamOptions=s,this._metadata=i,this._connectionState=new Iu,this._forceRefresh=!1,this.events=new Ao.Z;const{objectIdField:n,timeInfo:o}=this._metadata,{purgeOptions:a}=t;this._stagingStore=new Su(this._metadata,(e=>this.events.emit("features-updated",e))),this._manager=new vu.Qo(this._stagingStore,n,o,a),this.connect()}destroy(){super.destroy(),this.disconnect()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}get connectionStatus(){return this._connectionState.connectionStatus}get errorString(){return this._connectionState?.errorString}async refresh(){const e=null!=this._chunk;this._manager.checkForUpdates()||!e||this._forceRefresh?(this._chunk&&this._store.remove(this._chunk),this._forceRefresh=!1,this._chunk=new Tu(this._stagingStore.reader),this._store.insert(this._chunk),this.events.emit("tick")):this.events.emit("tick")}async updateFields(e){throw new Error("Updating available fields not supported for StreamLayer")}async load(e){}unload(e){}disconnect(){this._connection=(0,y.SC)(this._connection),this._connectionState.connection=null,this._handlesGroup?.remove()}connect(){if(null!=this._connection)return;const{geometryType:e,spatialReference:t}=this._metadata,{maxReconnectionAttempts:r,maxReconnectionInterval:s,geometryDefinition:n,definitionExpression:o,customParameters:a}=this._dataFilter;this._connection=(0,wu.createConnection)(this._service.source,t,this._streamOptions.outSR,e,o,n,r,s,a),this._handlesGroup=(0,i.AL)([this._connection.on("data-received",(e=>this._onFeature(e))),this._connection.on("message-received",(e=>this._onWebSocketMessage(e)))]),this._connectionState.connection=this._connection}clear(){this._manager.checkForUpdates(),this._stagingStore.clear(),this._forceRefresh=!0}updateCustomParameters(e){this._connection?.updateCustomParameters(e)}sendMessageToSocket(e){this._connection?.sendMessageToSocket(e)}sendMessageToClient(e){this._connection?.sendMessageToClient(e)}_onWebSocketMessage(e){if("type"in e)switch(e.type){case"delete":if(e.objectIds)for(const t of e.objectIds)this._manager.removeById(t);if(e.trackIds)for(const t of e.trackIds)this._manager.removeByTrackId(t);break;case"clear":this.clear()}this.events.emit("message-received",e)}_onFeature(e){try{this._manager.add(e),this.events.emit("data-received",e)}catch(t){}}}class ku{constructor(e){this._onChange=e,this._chunks=new Map,this._chunksToRemove=[],this.events=new Ao.Z,this.featureAdapter=new da}destroy(){this.clear()}clear(){for(const e of this._chunks.values())this._chunksToRemove.push(e);this._chunks.clear(),null!=this._overrideChunk&&this._chunksToRemove.push(this._overrideChunk),this._overrideChunk=null}*chunks(){this._overrideChunk&&(yield this._overrideChunk),yield*this._chunks.values()}insert(e){(0,n.Z)("esri-2d-update-debug")&&console.debug(`Chunk[${e.chunkId}] SourceChunkStore.insert`),this._overrideChunk?.overridenIds.size&&e.reader.removeIds(this._overrideChunk.overridenIds),this._chunks.set(e.chunkId,e),this.events.emit("changed"),this._onChange()}remove(e){(0,n.Z)("esri-2d-update-debug")&&console.debug(`Chunk[${e.chunkId}] SourceChunkStore.remove`),this._chunks.delete(e.chunkId),this._chunksToRemove.push(e)}cleanupRemovedChunks(){const e=this._chunksToRemove;return this._chunksToRemove=[],e}applyOverrides(e,t){null==this._overrideChunk&&(this._overrideChunk=new Mc(t)),this._overrideChunk.applyOverrides(e);for(const r of this._chunks.values())r.reader.removeIds(this._overrideChunk.overridenIds),r.invalidate()}forEach(e){const t=new Set;for(const r of this.chunks()){const s=r.reader.getCursor();for(;s.next();){const r=s.getObjectId();t.has(r)||(e(s.copy()),t.add(r))}}}forEachUnsafe(e){const t=new Set;for(const r of this.chunks()){const s=r.reader.getCursor();for(;s.next();){const r=s.getObjectId();t.has(r)||(e(s),t.add(r))}}}forEachInBounds(e,t){const r=new Set;for(const s of this.chunks()){const i=s.queryFeaturesInBounds(e);for(;i.next();){const e=i.getObjectId();r.has(e)||(t(i.copy()),r.add(e))}}}forEachBounds(e,t){const r=(0,Ro.Ue)();for(const s of e)s.getBounds(r)&&t(r)}}var Fu=r(18442),Eu=r(46634);let Cu=class extends Zs.Z{constructor(e){super(e),this.debugName="",this._updatingHandles=new Eu.R,this._idToUpdatingState=new Fu.Z}get updating(){const e=this._updatingHandles.updating||Array.from(this._idToUpdatingState.values()).some((e=>e));if((0,n.Z)("esri-2d-log-updating")){const t=Array.from(this._idToUpdatingState.entries()).map((e=>{let[t,r]=e;return`-> ${t}: ${r}`})).join("\n");console.log(`${this.debugName}: Updating: ${e}\n-> Handles: ${this._updatingHandles.updating}\n${t}`)}return e}addUpdateTracking(e,t){const r=(0,u.YP)((()=>t.updating),(t=>this._idToUpdatingState.set(e,t)),{sync:!0});this.addHandles(r)}addPromise(e){return this._updatingHandles.addPromise(e)}};(0,St._)([(0,Ys.Cb)({constructOnly:!0})],Cu.prototype,"debugName",void 0),(0,St._)([(0,Ys.Cb)({readOnly:!0})],Cu.prototype,"updating",null),Cu=(0,St._)([(0,js.j)("esri.view.2d.layers.support.UpdateTracking2D")],Cu);class Pu{constructor(e,t,r,s){this._aggregateAdapter=e,this._subscriptions=t,this._onChange=r,this._connection=s,this._updateTracking=new Cu({debugName:"FeatureSource"}),this._didInvalidateData=!1,this._store=new ku(this._onChange)}destroy(){this._strategy?.destroy(),this._store.destroy(),this._streamMessenger?.destroy()}get _eventLog(){return this._connection.eventLog}get metadata(){if(!this._metadata)throw new Error("InternalError: Metadata not defined. Was update called?");return this._metadata}get service(){return this._schema.service}get store(){return this._store}get streamMessenger(){return null==this._streamMessenger&&this._initStreamMessenger(),this._streamMessenger}get statistics(){return Vc.from(this._store)}get updateTracking(){return this._updateTracking}get queryEngine(){if(!this._queryEngine){if(!this._schema)return null;const{dataFilter:e}=this._schema.mutable,t=this._schema.mutable.availableFields,r=this._metadata;this._queryEngine=new zo.q({featureStore:this._store,fieldsIndex:r.fieldsIndex,geometryType:r.geometryType,objectIdField:r.objectIdField,hasM:!1,hasZ:!1,spatialReference:e.outSpatialReference,cacheSpatialQueries:!0,aggregateAdapter:this._aggregateAdapter,timeInfo:r.timeInfo,definitionExpression:e.definitionExpression,availableFields:t})}return this._queryEngine}get isStream(){return"stream"===this._schema.type}chunks(){return Array.from(this._store.chunks())}cleanupRemovedChunks(){return this._store.cleanupRemovedChunks()}onSubscribe(e){this._eventLog.onEvent({type:"subscribe",tile:e.tile.id});const t=this._strategy?.load(e);t&&(t.then((()=>this._eventLog.onEvent({type:"loaded",tile:e.tile.id}))).catch((t=>this._eventLog.onEvent({type:"error",tile:e.tile.id,error:t}))),this._updateTracking.addPromise(t))}onResume(e){this._updateTracking.addPromise((0,a.R8)(this._strategy?.load(e)))}onUnsubscribe(e){this._eventLog.onEvent({type:"unsubscribe",tile:e.tile.id}),this._strategy?.unload(e)}getOverride(e){return this._updateTracking.addPromise(this._doGetOverride(e))}applyOverride(e){this._didInvalidateData=!0,this._store.applyOverrides(e,this.metadata)}async update(e,t){const r=e.source,s=(0,m.Hg)(this._schema?.mutable,r.mutable);if(!s)return!1;if((0,n.Z)("esri-2d-update-debug")&&console.debug(`Version[${t}] FeatureSource.update`,{changes:s}),this._schema=r,this._metadata=new _a(this._schema.service.metadata),this._queryEngine?.destroy(),this._queryEngine=null,"feature"===this._schema.type&&null!=this._schema.service.queryMetadata.lastEditDate&&(this._lastEditDate=this._schema.service.queryMetadata.lastEditDate),null==this._streamMessenger&&"stream"===this._schema.type&&this._initStreamMessenger(),(0,m.$c)(s,"sourceRefreshVersion")&&this._strategy?.refresh)return await this._strategy.refresh(),!0;if("feature"===r.type&&(0,m.$c)(s,"availableFields")){if(await this._queryLastEditDateChanged()||this._didInvalidateData)this._didInvalidateData=!1,await this._updateStrategy(t);else{this._eventLog.onEvent({type:"updateFieldsStart"});try{await this._strategy.updateFields(r.mutable.availableFields),this._eventLog.onEvent({type:"updateFieldsEnd"})}catch(i){this._eventLog.onEvent({type:"updateFieldsError",error:i})}}return!1}return!(!(0,m.jW)(s,"dataFilter")&&!(0,m.jW)(s,"sourceRefreshVersion"))&&(await this._updateStrategy(t),!0)}_initStreamMessenger(){null==this._streamMessenger&&(this._streamMessenger=new qc(this._connection))}async _doGetOverride(e){return this._strategy.queryOverride(e)}async _queryLastEditDateChanged(){if(null==this._lastEditDate)return!1;const e=this._schema.service.source,t={...e.query,f:"json"},r=(await(0,Nc.Z)(e.path,{query:t,responseType:"json"})).data.editingInfo.lastEditDate;return r!==this._lastEditDate&&(this._lastEditDate=r,!0)}async _createStrategy(){const e=this.service,t="isSourceHosted"in e&&e.isSourceHosted,r=Array.isArray(e.source),s=e.source&&"collection"in e.source,i=t||r||s;if("stream"===this._schema.type){const e=new Mu(this._schema.service,this._schema.mutable.dataFilter,this._store,{outSR:this._schema.mutable.dataFilter.outSpatialReference},this.metadata);return this._streamMessenger.strategy=e,e}const n=Uc.fromSchema(this._schema,this._metadata),o=await this._supportSnapshotMode(this._schema,n);return o?new bu(this._schema.service,n,this._store,o.featureCount,this.metadata,this._eventLog):i?new gu(this._schema.service,n,this._store,this.metadata,this._eventLog):new _u(this._schema.service,n,this._store,this.metadata,this._eventLog)}async _updateStrategy(e){const t=await this._createStrategy();this._eventLog.onEvent({type:"updateStrategyStart",about:t.about});const r=!!this._strategy;this._store.clear(),this._strategy?.destroy(),this._strategy=t,(0,n.Z)("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureSource.updateStrategy`,{strategy:t});const s=Array.from(this._subscriptions.values());if(!s.length)return void this._eventLog.onEvent({type:"updateStrategyEnd"});const i=Promise.all(s.map((e=>this._strategy.load(e).then((()=>this._eventLog.onEvent({type:"loaded",tile:e.tile.id}))).catch((t=>this._eventLog.onEvent({type:"error",tile:e.tile.id,error:t}))))));this._updateTracking.addPromise(i);try{r&&await i}catch(o){(0,a.H9)(o)}this._eventLog.onEvent({type:"updateStrategyEnd"}),(0,n.Z)("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureSource.updateStrategyEnd`,{strategy:t})}async _supportSnapshotMode(e,t){const{queryMetadata:r}=e.service,s=r.snapshotInfo;if(!s||!s.supportsSnapshotMinThreshold||!s.snapshotCountThresholds)return null;const i=e.service.source,n=t.createQuery();n.inner.orderByFields=[],n.inner.returnGeometry=!1;const o=(await(0,Bc.hH)(i,n.inner,{query:n.customParameters})).data.count,{min:a,max:c}=s.snapshotCountThresholds;return o<=a||s.supportsSnapshotMaxThreshold&&o<c?{featureCount:o}:null}}var Au=r(100);class Ru{constructor(e,t){this._handles=new Au.Z,this._abortController=new AbortController,this._resolver=(0,a.hh)(),this._isDone=!1,this._aborted=!1,this.tile=e,this._version=t,this._handles.add([])}destroy(){this.pause(),this._handles.destroy()}get key(){return this.tile.key}get version(){return this._version}set version(e){this._version=e}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get done(){return this._resolver.promise}get isDone(){return this._isDone}resolve(){this._isDone=!0,this._resolver.resolve()}get paused(){return this._aborted}resume(){this._abortController=new AbortController,this._aborted=!1}pause(){this._aborted||(this._aborted=!0,this._abortController.abort())}}var Ou=r(22213),zu=r(53866),Du=r(94618);class Nu{constructor(e,t){this.key=new p.Z(0,0,0,0),this.bounds=(0,oa.Ue)(),this.objectIds=new Set,this.key.set(t);const r=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=r.resolution,this.scale=r.scale,this.level=r.level}get lod(){return this.tileInfoView.getLODInfoAt(this.key)}get id(){return this.key.id}get extent(){return zu.Z.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createArcadeEvaluationOptions(e){return{$view:{scale:this.scale,timeZone:e}}}createChildTiles(){const e=this.key.getChildKeys(),t=Ou.Z.acquire();for(let r=0;r<e.length;r++)t[r]=new Nu(this.tileInfoView,e[r]);return t}getQuantizationParameters(){return Du.Z.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}class Bu{constructor(e){this.edit=e,this.resolver=(0,a.hh)()}}class Vu{constructor(e,t){this.schema=e,this.version=t,this.resolver=(0,a.hh)()}}class Lu{constructor(){this._aggregateAdapter={getFeatureObjectIds:e=>this._processor.getFeatureObjectIdsForAggregate(e)},this._subscriptions=new Map,this._updateRequested=!1,this._updateSubscriptionRequests=[],this._updateHighlightRequests=[]}destroy(){this._subscriptions.clear(),this._processor.destroy(),this._source.destroy(),this._handles.remove(),this._editState=null,this._tileInfoView=null}onDetach(){this.destroy(),this._initialize(this._connection)}_initialize(e){this._source=new Pu(this._aggregateAdapter,this._subscriptions,(()=>this._requestUpdate()),e),this._processor=new Dc(e,this._source),this._handles=(0,i.AL)([(0,u.YP)((()=>this._source.updateTracking.updating),(()=>{this._requestUpdate(),this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:!0})}))])}set remoteClient(e){this._connection=new _(e),this._initialize(this._connection)}get features(){const e=this._source.queryEngine;if(!e)throw new s.Z("no-queryEngine","No query engine defined");return e}get aggregates(){const e=this._processor.aggregateQueryEngine;if(!e)throw new s.Z("no-queryEngine","No aggregate query engine defined");return e}get processor(){return this._processor}get streamMessenger(){return this._source.streamMessenger}getDisplayFeatures(e){return this._processor.getDisplayFeatures(e)}async updateSchema(e,t){return(0,n.Z)("esri-2d-update-debug")&&this._updateSchemaState&&console.error("InternalError: Schema already updating"),this._updateSchemaState=new Vu(e,t),this._requestUpdate(),this._updateSchemaState.resolver.promise}updateSubscriptions(e){this._updateSubscriptionRequests.push(e),this._requestUpdate()}updateHighlight(e){this._updateHighlightRequests.push(e),this._requestUpdate()}async onEdits(e){if(null!=this._editState)throw new s.Z("InternalError - Already processing an edit");this._editState=new Bu(e);const t=this._editState.resolver.promise;return this._requestUpdate(),t}queryStatistics(){return this._source.statistics.toJSON()}async queryVisibleFeatures(e,t){return this.features.executeQuery(e,t)}async queryHeatmapStatistics(e){const t=Math.round((0,l.F2)(e.radius));let r=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;const i="string"==typeof e.fieldOffset,n=e.fieldOffset??0,o=Array.from(this._subscriptions.values()),a=this._source.chunks(),c=t**2,u=3/(Math.PI*c),h=2*t,d=Math.ceil(f.i9/h);for(const l of o){const t=l.tile,o=new Float64Array(d*d);for(const r of a){const s=r.getTileReader(t);if(!s)continue;const a=s.getCursor();for(;a.next();){let t=1;if(null!=e.field){const r=a.readAttribute(e.field);t=i?-1*+r:+r+n}const r=a.readXForDisplay()/h,s=a.readYForDisplay()/h,l=Math.floor(r),p=Math.floor(s);if(l<0||p<0||l>=d||p>=d)continue;const f=((.5+l-r)*h)**2+((.5+p-s)*h)**2;if(f>c)continue;const _=t*(u*(1-f/c)**2);o[p+l*d]+=_}}for(let e=0;e<o.length;e++)r=Math.min(r,o[e]),s=Math.max(s,o[e])}return{max:s,min:r}}async getSampleFeatures(e){const t=this._source.chunks();if(t.reduce(((e,t)=>e+t.size()),0)<=e.minFeatureCount){if(!this._source.updateTracking.updating){const e=[];return this._source.store.forEachUnsafe((t=>e.push(t.readLegacyFeatureWorldSpace()))),e}return null}const r=new Set,s=[],i=t.map((e=>e.reader.getCursor())),n=new c.Z,o=3*e.sampleSize;for(let a=0;a<o&&s.length<e.sampleSize;a++){const e=i[n.getIntRange(0,t.length-1)];if(0===e.getSize())continue;const o=n.getIntRange(0,e.getSize()-1);e.setIndex(o);const a=e.getObjectId();r.has(a)||(r.add(a),s.push(e.readLegacyFeatureWorldSpace()))}return s.length>=e.sampleSize?s:null}_requestUpdate(){this._updateRequested||(this._updateRequested=!0,(0,o.Y)((()=>this._scheduleNextUpdate())))}_scheduleNextUpdate(){this._updateRequested&&(this._ongoingUpdate||(this._ongoingUpdate=this._doUpdate().finally((()=>{this._ongoingUpdate=null,this._scheduleNextUpdate()})),this._updateRequested=!1))}_subscribe(e){const t=e.tileId;if(this._subscriptions.has(t)){const r=this._subscriptions.get(t);return void(r.paused&&((0,n.Z)("esri-2d-update-debug")&&console.debug(`Tile[${t}] Pipeline.resume`),r.resume(),r.version=e.version,this._source.onResume(r)))}(0,n.Z)("esri-2d-update-debug")&&console.debug(`Tile[${t}] Pipeline.subscribe`);const r=new Nu(this._tileInfoView,t),s=new Ru(r,e.version);this._subscriptions.set(t,s),this._source.onSubscribe(s),this._processor.onSubscribe(s)}_unsubscribe(e){const t=this._subscriptions.get(e);t&&((0,n.Z)("esri-2d-update-debug")&&console.debug(`Tile[${e}] Pipeline.unsubscribe`),this._source.onUnsubscribe(t),this._processor.onUnsubscribe(t),this._subscriptions.delete(t.key.id),t.destroy())}_pauseSubscription(e){const t=this._subscriptions.get(e);t&&((0,n.Z)("esri-2d-update-debug")&&console.debug(`Tile[${e}] Pipeline.pause`),t.pause())}async _doUpdate(){if((0,n.Z)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateStart"),await this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:!0}),this._updateSubscriptionRequests.length){const e=this._updateSubscriptionRequests;this._updateSubscriptionRequests=[];for(const t of e)this._doUpdateSubscriptions(t)}const e=this._updateSchemaState;if(this._updateSchemaState=null,null!=e){const{schema:t,version:r}=e;await this._doUpdateSchema(t,r)}const t=this._editState;if(this._editState=null,null!=t){(0,n.Z)("esri-2d-update-debug")&&console.debug("Pipeline.applyEditOverride",t.edit);const e=await this._source.getOverride(t.edit);await this._processor.applyOverride(e),(0,n.Z)("esri-2d-update-debug")&&console.debug("Pipeline.endEditOverride",t.edit)}if(this._updateHighlightRequests.length){const e=this._updateHighlightRequests;this._updateHighlightRequests=[];for(const t of e)this._processor.updateHighlight(t)}const r=this._source.cleanupRemovedChunks();this._processor.removeChunks(r);try{this._subscriptions.size&&((0,n.Z)("esri-2d-update-debug")&&console.debug("Pipeline.updateChunksStart"),await this._processor.updateChunks(),(0,n.Z)("esri-2d-update-debug")&&console.debug("Pipeline.updateChunksEnd"))}catch(s){(0,a.H9)(s)}null!=t&&t.resolver.resolve(),null!=e&&e.resolver.resolve(),this._updateRequested?((0,n.Z)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateEnd [updateRequested=true]"),await this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:!0})):((0,n.Z)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateEnd [updateRequested=false, After flush]"),await this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:this._updateRequested}))}async _doUpdateSchema(e,t){if((0,n.Z)("esri-2d-update-debug")&&console.debug(`Version[${t}] Pipeline.updateStart`,{schema:e}),!this._tileInfoView){const t=h.Z.fromJSON(e.source.tileInfoJSON);this._tileInfoView=new d.Z(t)}const r={tileInfo:this._tileInfoView?.tileInfo};try{const s=await this._source.update(e,t),i=Array.from(this._subscriptions.values());await this._processor.update(e,t,r,s,i)}catch(s){console.error(s)}(0,n.Z)("esri-2d-update-debug")&&console.debug(`Version[${t}] Pipeline.updateEnd`)}_doUpdateSubscriptions(e){if((0,n.Z)("esri-2d-update-debug")&&console.debug("Pipeline.updateSubscriptions",e),!this._tileInfoView){const t=h.Z.fromJSON(e.tileInfoJSON);this._tileInfoView=new d.Z(t)}for(const t of e.subscribe)this._subscribe(t);for(const t of e.unsubscribe)this._unsubscribe(t);if((0,n.Z)("featurelayer-query-pausing-enabled"))for(const t of e.pause)this._pauseSubscription(t)}}}}]);
//# sourceMappingURL=51213.9ae9b053.chunk.js.map