"use strict";(self.webpackChunkn2_compile=self.webpackChunkn2_compile||[]).push([[12996],{42307:(e,t,i)=>{i.d(t,{X:()=>o});var r=i(32035),n=i(96334),s=i(22186),a=i(92975);function o(e,t,i,o){if(null==t||null==o)return!1;const l=(0,n.eT)(t,n.Jz),c=(0,n.eT)(o,n.sp);if(l===c&&l!==n.Ej.UNKNOWN||(0,a.fS)(t,o))return i[0]=1,i[1]=1,i[2]=1,!0;if(l===n.Ej.SPHERICAL_ECEF){const t=(0,r.l)(e),a=t/Math.sqrt(e[0]*e[0]+e[1]*e[1]),o=t/s.sv.radius;if(c===n.Ej.WEB_MERCATOR)return i[0]=a*o,i[1]=a*o,i[2]=1,!0;if(c===n.Ej.WGS84||c===n.Ej.CGCS2000){const e=n.Ms;return i[0]=e*a*o,i[1]=e*o,i[2]=1,!0}}else if(l===n.Ej.PLATE_CARREE){if(c===n.Ej.WGS84||c===n.Ej.CGCS2000)return i[0]=n.Ms,i[1]=n.Ms,i[2]=1,!0;if(c===n.Ej.WEB_MERCATOR){const t=e[1]/s.sv.radius;return i[0]=1,i[1]=1/Math.cos(t),i[2]=1,!0}}return!1}},51066:(e,t,i)=>{i.d(t,{s:()=>o});var r=i(16889),n=i(12400),s=i(96334),a=i(22186);function o(e,t,i,r){if(null==t||null==r)return!1;const n=(0,s.Bg)(t,r,d);if(n.projector===s.iq)return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],!0;if(null==n.projector)return!1;const{source:o,dest:u}=n;if(u.spatialReferenceId===s.Ej.WEB_MERCATOR){const t=s.rf[o.spatialReferenceId][s.Ej.WGS84];return null!=t&&(t(e,0,c,0),(0,s.uT)(c,0,i,0),i[3]=l(c[1],e[2],e[3],a.sv.radius),!0)}if(o.spatialReferenceId!==s.Ej.WGS84&&o.spatialReferenceId!==s.Ej.CGCS2000||u.spatialReferenceId!==s.Ej.PLATE_CARREE){n.projector(e,0,i,0);const t=o.metersPerUnit??1,r=u.metersPerUnit??1;i[3]=e[3]*t/r}else{const t=s.rf[o.spatialReferenceId][s.Ej.SPHERICAL_ECEF],r=s.rf[s.Ej.SPHERICAL_ECEF][s.Ej.PLATE_CARREE];let c=e[3];null!=t&&null!=r&&(c=l(e[1],e[2],e[3],a.sv.radius)),n.projector(e,0,i,0),i[3]=c}return!0}function l(e,t,i,r){const n=r+t;if(n<r/2||i>n)return Number.MAX_VALUE;const s=Math.abs(u*e)+Math.asin(i/n);return s>=Math.PI/2?Number.MAX_VALUE:i/Math.cos(s)}const c=(0,n.Ue)(),d=(0,s.sw)(),u=(0,r.Vl)(1)},54907:(e,t,i)=>{var r,n,s,a,o,l,c,d,u,h,p,m,f,g,y;i.d(t,{$1:()=>d,AQ:()=>c,Em:()=>_,Lz:()=>a,MB:()=>r,Nl:()=>y,Q3:()=>b,Qd:()=>f,aw:()=>s,jE:()=>g,l7:()=>n,xL:()=>o}),function(e){e.U8="U8",e.I8="I8",e.U16="U16",e.I16="I16",e.U32="U32",e.I32="I32",e.F32="F32",e.F64="F64",e.Utf8String="Utf8String",e.NotSet="NotSet"}(r||(r={})),function(e){e.Png="Png",e.Jpeg="Jpeg",e.Dds="Dds",e.Raw="Raw",e.Dxt1="Dxt1",e.Dxt5="Dxt5",e.Etc2="Etc2",e.Astc="Astc",e.Pvrtc="Pvrtc",e.NotSet="NotSet"}(n||(n={})),function(e){e.Rgb8="Rgb8",e.Rgba8="Rgba8",e.R8="R8",e.Bgr8="Bgr8",e.Bgra8="Bgra8",e.Rg8="Rg8",e.NotSet="NotSet"}(s||(s={})),function(e){e.Position="Position",e.Normal="Normal",e.TexCoord="TexCoord",e.Color="Color",e.Tangent="Tangent",e.FeatureIndex="FeatureIndex",e.UvRegion="UvRegion",e.NotSet="NotSet"}(a||(a={})),function(e){e.Opaque="Opaque",e.Mask="Mask",e.Blend="Blend"}(o||(o={})),function(e){e.None="None",e.Mask="Mask",e.Alpha="Alpha",e.PreMultAlpha="PreMultAlpha",e.NotSet="NotSet"}(l||(l={})),function(e){e.Points="Points",e.Lines="Lines",e.LineStrip="LineStrip",e.Triangles="Triangles",e.TriangleStrip="TriangleStrip",e.NotSet="NotSet"}(c||(c={})),function(e){e.None="None",e.WrapXBit="WrapXBit",e.WrapYBit="WrapYBit",e.WrapXy="WrapXy",e.NotSet="NotSet"}(d||(d={})),function(e){e.Linear="Linear",e.Nearest="Nearest",e.NotSet="NotSet"}(u||(u={})),function(e){e.Linear="Linear",e.Nearest="Nearest",e.NearestMipmapNearest="NearestMipmapNearest",e.LinearMipmapNearest="LinearMipmapNearest",e.NearestMipmapLinear="NearestMipmapLinear",e.LinearMipmapLinear="LinearMipmapLinear",e.NotSet="NotSet"}(h||(h={})),function(e){e.FeatureId="FeatureId",e.GlobalUid="GlobalUid",e.UnspecifiedDateTime="UnspecifiedDateTime",e.EcmaIso8601DateTime="EcmaIso8601DateTime",e.EcmaIso8601DateOnly="EcmaIso8601DateOnly",e.TimeOnly="TimeOnly",e.TimeStamp="TimeStamp",e.ColorRgb="ColorRgb",e.ColorRgba="ColorRgba",e.Unrecognized="Unrecognized",e.NotSet="NotSet"}(p||(p={})),function(e){e.Texture="Texture",e.VertexAtrb="VertexAtrb",e.Implicit="Implicit",e.NotSet="NotSet"}(m||(m={})),function(e){e.Front="Front",e.Back="Back",e.None="None",e.NotSet="NotSet"}(f||(f={})),function(e){e.Pbr="Pbr",e.Unlit="Unlit"}(g||(g={})),function(e){e[e.Succeeded=0]="Succeeded",e[e.Failed=1]="Failed",e[e.MissingInputs=2]="MissingInputs"}(y||(y={}));const b=-1,_=-2},12996:(e,t,i)=>{i.r(t),i.d(t,{default:()=>le});var r=i(27366),n=i(10064),s=i(32718),a=i(92026),o=i(94172),l=i(99346),c=i(49861),d=(i(93169),i(84936),i(69912)),u=i(29303),h=i(21389),p=i(29134),m=i(7025),f=i(32035),g=i(12400),y=i(86361),b=i(83448),_=i(37998),v=i(42307),w=i(5986),E=i(25158),M=i(54907),C=i(88152),x=i(50951),R=i(20488);class S extends R.W{constructor(e,t,i,r,n,s,a){super(e,0,0,0,t),this.nodesCached=i,this.vboMB=r,this.textureMB=n,this.vboMBCached=s,this.textureMBCached=a}}var T=i(26279),P=i(42069),U=i(76241),I=i(55763),O=i(68401),N=i(8548);const A={[M.AQ.Points]:null,[M.AQ.Lines]:null,[M.AQ.LineStrip]:null,[M.AQ.Triangles]:N.MX.TRIANGLES,[M.AQ.TriangleStrip]:N.MX.TRIANGLE_STRIP,[M.AQ.NotSet]:null},L={[M.xL.Opaque]:O.JJ.Opaque,[M.xL.Mask]:O.JJ.Mask,[M.xL.Blend]:O.JJ.Blend},B={[M.Qd.Back]:O.Vr.Back,[M.Qd.Front]:O.Vr.Front,[M.Qd.None]:O.Vr.None,[M.Qd.NotSet]:O.Vr.Back},j={[M.$1.WrapYBit]:{s:N.e8.CLAMP_TO_EDGE,t:N.e8.REPEAT},[M.$1.WrapXBit]:{s:N.e8.REPEAT,t:N.e8.CLAMP_TO_EDGE},[M.$1.WrapXy]:{s:N.e8.REPEAT,t:N.e8.REPEAT},[M.$1.None]:{s:N.e8.CLAMP_TO_EDGE,t:N.e8.CLAMP_TO_EDGE},[M.$1.NotSet]:{s:N.e8.CLAMP_TO_EDGE,t:N.e8.CLAMP_TO_EDGE}},F={[M.MB.U8]:1,[M.MB.I8]:1,[M.MB.U16]:2,[M.MB.I16]:2,[M.MB.U32]:4,[M.MB.I32]:4,[M.MB.F32]:4,[M.MB.F64]:8,[M.MB.Utf8String]:1,[M.MB.NotSet]:1};var H=i(52639),V=i(85312),D=i(88153),k=i(54463);class G{constructor(e){this.layerUid=[],this.type=k.q7.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,t,i,r){const n=e.results,s=e.options.store===k.eC.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const a=this.layerView.view._stage.renderView.componentObjectCollection;this.layerView.objects.forEach((o=>{o.visible&&o.intersectionGeometry&&a.intersect(o,i,r,e.tolerance,null,((a,o,l,c)=>{if(o>=0){if(null!=t&&!t(i,r,o))return;const a=e=>{const t=new V.lt(this.layerView.layer.uid,(()=>this._createTiles3DGraphic(this.layerView.layer,{})));e.set(this.type,t,o,l)};if(this.isGround&&(null==n.ground.dist||o<n.ground.dist)&&a(n.ground),e.options.isFiltered)return;if((null==n.min.dist||o<n.min.dist)&&a(n.min),(null==n.max.dist||o>n.max.dist)&&a(n.max),s){const t=(0,D.LP)(e.ray);a(t),e.results.all.push(t)}}}))}))}_createTiles3DGraphic(e,t){return new H.Z({layer:e,sourceLayer:e,attributes:t})}}var W,z,Q=i(2985),Z=i(89414),J=i(92911),$=i(46987),q=i(89261),X=i(60113),Y=i(86097),K=i(91526),ee=i(52920),te=i(1487),ie=i(4760),re=i(33236),ne=i(67581);(z=W||(W={}))[z.API=1]="API",z[z.VerboseAPI=2]="VerboseAPI",z[z.Error=3]="Error";class se{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function ae(e){return Math.round(e/1048.576)/1e3}let oe=class extends((0,P.A)(ne.Z)){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=T.al.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(W.Error),this._dbg(W.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new n.Z("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const e=(0,U.JF)(this).then((e=>{this._intersectionHandler=new G(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add((()=>this.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(e))),this._elevationProvider=new I.u({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const t=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,(e=>this._onRemoveFromCache(e)));this._memCache=t,this._suspendedHandle=(0,o.YP)((()=>this.suspended),(e=>{const t=(0,U.WM)(this.view);t&&t.setEnabled(this,!e)}),o.nn),this.addHandles([(0,o.YP)((()=>this.layer.elevationInfo),(e=>this._elevationInfoChanged(e)))])})).catch((e=>{if((0,U.mq)(this),this._wasmLayerId=-1,e===M.Q3)throw new n.Z("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===M.Em)throw new n.Z("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})}));this.addResolvingPromise(e)}destroy(){this._dbg(W.VerboseAPI,"Tiles3DLayerView3D destroy() called"),(0,U.mq)(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach((e=>this.freeObject(e))),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=(0,a.SC)(this._memCache),this._updatingHandles=(0,a.SC)(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=(0,l.Os)((()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})))}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),this.objects.forEach((t=>{const i=this._collection.getMaterial(t);i.commonMaterialParameters.hasSlicePlane=e,i.commonMaterialParameters.cullFace=e?O.Vr.None:this._initialCullFace.get(t)}))}_elevationInfoChanged(e){const t=e?.offset??0,i=e?.unit?(0,C.Z7)(e?.unit):1,r=(0,U.WM)(this.view);r&&r.setLayerOffset(this,t*i)}get _obbs(){return this.objects.map((e=>this._collection.getComponentObb(e)))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let e=0;return this._lyrHandleToObjects.forEach((t=>{t.isVisible&&(e+=t.totalMemory())})),e}get unloadedMemory(){let e=0;return this._lyrHandleToObjects.forEach((t=>{t.isVisible||(e+=t.totalMemory())})),e}get performanceInfo(){let e=0,t=0,i=0,r=0,n=0,s=0;return this._lyrHandleToObjects.forEach((a=>{a.isVisible?(e+=a.texMemoryUsage,t+=a.vboMemoryUsage,n++):(i+=a.texMemoryUsage,r+=a.vboMemoryUsage,s++)})),new S(this.usedMemory,n,s,ae(t),ae(e),ae(r),ae(i))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===x.JY.Local){const e=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(3857!==e&&32662!==e)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return(this.layer.elevationInfo?.offset??0)*(this.layer.elevationInfo?.unit?(0,C.Z7)(this.layer.elevationInfo.unit):1)}get elevationRange(){const e=this.fullExtent;return e?.zmin&&e?.zmax?new Q.r(e.zmin,e.zmax):null}getElevationRange(e){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce(((e,t)=>e.concat(t.components)),new Array)}isUpdating(){const e=(0,U.WM)(this.view);return!(this._wasmLayerId<0||null==e)&&e.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(e){const t=e.meshData;if(null==t.data)throw new Error("meshData.data undefined");if(t.desc=JSON.parse(t.desc),null==t.desc)throw new Error("meshData.desc undefined");const i=(0,g.nI)(t.desc.origin),r=new Array,n=new Map,s=new se;s.handle=e.handle,this._lyrHandleToObjects.set(e.handle,s);const a=this.view.basemapTerrain.spatialReference;let o,l;if("global"===this.view.viewingMode){const e=(0,m.Ue)();(0,_.B)(b.kU,i,e,a),o=(0,u.xO)((0,h.Ue)(),e),l=(0,u.U_)((0,h.Ue)(),o)}else o=h.Wd,l=h.Wd;const c=(0,m.Ue)();(0,p.Iu)(c,c,i);const d=(0,p.i0)((0,g.Ue)(),c);let E=null;const C=(0,g.Ue)();for(let u=0;u<t.desc.prims.length;u++){const e=t.desc.prims[u];if(e.ptype!==M.AQ.Lines||null==t.data)continue;const{positionView:r,positionAttr:n,indicesView:s}=this.getBufferViews(e,t.data.buffer,o,!1);null!=n&&null!=r&&null!=s&&(E=(0,Z.Qb)(n),(0,f.g)(C,E.center,i),E.center=C)}for(let u=0;u<t.desc.prims.length;u++){const e=t.desc.prims[u];if(this._dbg(W.VerboseAPI,JSON.stringify(e)),e.ptype===M.AQ.Lines)continue;if(null==A[e.ptype]||null==t.data){this._dbg(W.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+e.ptype+"). Skipping primitive.");continue}const c=t.desc?.materials&&null!=e.materialId?t.desc.materials[e.materialId]:null,p=null!=c?c.lightingModel:M.jE.Unlit,m=p!==M.jE.Unlit,{positionView:b,positionAttr:_,normalsView:x,normalsAttr:R,colorAttr:S,texCoord0Attr:T,indicesView:P}=this.getBufferViews(e,t.data.buffer,o,m);if(null==_||null==b||null==P)continue;const U={colors:null!=S,textureCoordinates:null!=T?X.N.Default:X.N.None,hasNormals:null!=x,needsNormals:m},I=_.data.length/_.size,N=(e,t)=>!e||e.data.length/e.size===I||(this._dbg(W.Error,`${t} !== numPos. Skipping primitive.`),!1);if(!N(T,"numTexcoord")||!N(S,"numColors")||!N(R,"normals"))continue;const j=(0,J.N)(U);let F;if(null!=E?F=E.clone():(F=(0,Z.Qb)(_),(0,f.g)(C,F.center,i),F.center=C),o!==h.Wd)for(let t=0;t<b.count;t++)b.getVec(t,C),(0,f.t)(C,C,o),b.setVec(t,C);const H=j.createBuffer(_.data.length),V=new Map([[ie.T.POSITION,_]]);null!=T&&V.set(ie.T.UV0,T),null!=S&&V.set(ie.T.COLOR,S),null!=R&&V.set(ie.T.NORMALCOMPRESSED,R),V.forEach(((e,t)=>{null!=e&&(0,re.i9)(t,e,null,null,H,0)}));const D=new Uint32Array([0,P.typedBuffer.length]),k={vertices:{data:H.buffer,count:H.byteLength/j.stride,layoutParameters:U},positionData:{positions:b.typedBuffer,indices:P.typedBuffer},indices:P.typedBuffer,componentOffsets:D};s.cpuMemoryUsage+=b.count,s.cpuMemoryUsage+=P.count;const G=this.view.renderSpatialReference,z=(0,g.Ue)(),Q=[1,1,1];(0,v.X)(d,G,Q,a)||this._dbg(W.Error,"Unsupported coordinate system for IM overlay"),(0,w.S)(d,G,z,a);const q=this._collection.createObject({toMapSpace:(0,y.al)(z[0],z[1],Q[0],Q[1]),geometry:k,obb:F,transform:{position:d,rotationScale:l}});c&&this._collection.updateMaterial(q,(e=>{e.baseColor=c.baseColorFactor,e.usePBR=p===M.jE.Pbr,e.hasParametersFromSource=!1,e.baseColorTexture=this._getTexture(c.baseColorTex,t,n),e.usePBR&&(e.mrrFactors=[c.metallicFactor,c.roughnessFactor,0],e.emissiveFactor=c.emissiveFactor??[0,0,0],e.metallicRoughnessTexture=this._getTexture(c.metalTex,t,n),e.emissionTexture=this._getTexture(c.emissiveTex,t,n),e.occlusionTexture=this._getTexture(c.occlusionTex,t,n),e.normalTexture=this._getTexture(c.normalTex,t,n)),e.objectOpacity=0,e.alphaDiscardMode=O.JJ.Mask;const i=[];e.baseColorTexture&&i.push(e.baseColorTexture.loadPromise),e.usePBR&&e.metallicRoughnessTexture&&i.push(e.metallicRoughnessTexture.loadPromise),e.usePBR&&e.emissionTexture&&i.push(e.emissionTexture.loadPromise),e.usePBR&&e.occlusionTexture&&i.push(e.occlusionTexture.loadPromise),e.usePBR&&e.normalTexture&&i.push(e.normalTexture.loadPromise);const a=Promise.all(i);r.push(a),a.then((()=>{e.alphaDiscardMode=L[c.alphaMode],e.objectOpacity=1,s.texMemoryUsage+=e.baseColorTexture?.glTexture?.usedMemory||0,e.usePBR&&(s.texMemoryUsage+=e.metallicRoughnessTexture?.glTexture?.usedMemory||0,s.texMemoryUsage+=e.emissionTexture?.glTexture?.usedMemory||0,s.texMemoryUsage+=e.occlusionTexture?.glTexture?.usedMemory||0,s.texMemoryUsage+=e.normalTexture?.glTexture?.usedMemory||0)})),e.commonMaterialParameters.doubleSided=c.isDoubleSided,e.commonMaterialParameters.cullFace=c.faceCulling?B[c.faceCulling]:O.Vr.Back,this._initialCullFace.set(q,e.commonMaterialParameters.cullFace),e.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,e.componentParameters.castShadows=$.ws.All,e.textureAlphaCutoff=c.alphaCutoff??.1,e.alphaDiscardMode=L[c.alphaMode],e.isIntegratedMesh=!0,e.polygonOffsetEnabled=!1,e.hasOccludees=!1,e.ellipsoidMode=(0,Y.j)(this.view.spatialReference)})),s.components.push(q),s.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(q)}if(await Promise.all(r),n.forEach((e=>{s.textures.push(e)})),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${s.handle}`,s,s.totalMemory()),{memUsageBytes:s.totalMemory()}}freeRenderable(e){const t=this._lyrHandleToObjects.get(e);t&&(this.freeObject(t),this._lyrHandleToObjects.delete(e))}freeObject(e){this._memCache&&this._memCache.pop(`${e.handle}`),e.components.forEach((t=>{e.textures.forEach((e=>{this._stage.remove(e)})),this._collection.destroyObject(t),this._initialCullFace.delete(t)}))}setRenderableVisibility(e,t,i){if(this._memCache){for(let r=0;r<i;++r){const i=e[r],n=t[r];if(!n)continue;const s=this._lyrHandleToObjects.get(i);s&&(this._visibleGeometryChanged(),s.isVisible=n,s.components.forEach((e=>{this._collection.setObjectVisibility(e,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})),this._memCache.pop(`${i}`))}for(let r=0;r<i;++r){const i=e[r],n=t[r];if(n)continue;const s=this._lyrHandleToObjects.get(i);s&&(this._visibleGeometryChanged(),s.isVisible=n,s.components.forEach((e=>{this._collection.setObjectVisibility(e,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})),this._memCache.put(`${i}`,s,s.totalMemory()))}}}_getTexture(e,t,i){let r=null;if(e&&t.desc?.images&&t.data?.buffer){const n=t.desc.images[e?.imageId];if(r=i.get(n),!r&&n){const s=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,a=s>1,o=j[e.wrapMode??M.$1.None];let l=n.alpha?4:3;const c=new Uint8Array(t.data.buffer,n.data.byteOffset,n.data.byteCount);let d=null,u=null,h=null;switch(n.format){case M.l7.Raw:n.pixelFormat===M.aw.R8?(d=c.buffer,l=1,u=""):n.pixelFormat===M.aw.Rgb8?(d=c.buffer,l=3,u=""):n.pixelFormat===M.aw.Rgba8&&(d=c.buffer,l=4,u="");break;case M.l7.Dxt1:d=c.buffer,l=3,u=O.Ti.DDS_ENCODING;break;case M.l7.Dxt5:d=c.buffer,l=4,u=O.Ti.DDS_ENCODING;break;case M.l7.Png:u="image/png",h=document.createElement("img");break;case M.l7.Jpeg:u="image/jpeg",h=document.createElement("img");break;case M.l7.Etc2:u="image/ktx",h=document.createElement("img");break;case M.l7.Astc:this._dbg(W.Error,"Astc texture not supported");break;case M.l7.Pvrtc:this._dbg(W.Error,"Pvrtc texture not supported")}if(h&&u){const e=new Blob([c],{type:u});h.src=URL.createObjectURL(e),d=h}d&&null!=u&&(r=new te.x(d,{mipmap:a,maxAnisotropy:s,encoding:u,wrap:o,components:l,noUnpackFlip:!0,width:n.mip0Width,height:n.mip0Height}),this._stage.add(r),i.set(n,r))}}return r?new q.T(this.view._stage.renderView.textureRepository,r.id):null}getBufferViews(e,t,i,r){let n,s,a,o,l,c,d,u=null;for(let p=0;p<e.atrbs.length;p++){const d=e.atrbs[p],m=d.view,f=void 0,g=m.byteOffset+m.byteCount,y=m.byteCount/F[m.type],b=[...Array(y).keys()].map((e=>e));try{switch(d.sem){case M.Lz.Position:3!==m.ncomp||m.type!==M.MB.F32?this._dbg(W.Error,"[Unsupported Feature] Unsupported view for Position ("+m+")"):(n=new E.ct(t,m.byteOffset,f,g),s=new K.a(n.typedBuffer,b,3));break;case M.Lz.Normal:if(3!==m.ncomp||m.type!==M.MB.F32)this._dbg(W.Error,"[Unsupported Feature] Unsupported view for Normal ("+m+")");else if(r){const e=new E.ct(t,m.byteOffset,f,g),r=(0,ee.Pj)(e.typedBuffer,i);l=new E.o7(r),c=new K.a(l.typedBuffer,b,2)}break;case M.Lz.TexCoord:2!==m.ncomp||m.type!==M.MB.F32?this._dbg(W.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+m+")"):void 0===o&&(o=new K.a(new E.Eu(t,m.byteOffset,f,g).typedBuffer,b,2));break;case M.Lz.Color:4===m.ncomp?(m.type===M.MB.F32&&(u=new E.ek(t,m.byteOffset,f,g)),m.type===M.MB.U8&&(u=new E.mc(t,m.byteOffset,f,g)),m.type===M.MB.U16&&(u=new E.v6(t,m.byteOffset,f,g))):3===m.ncomp&&(m.type===M.MB.F32&&(u=new E.ct(t,m.byteOffset,f,g)),m.type===M.MB.U8&&(u=new E.ne(t,m.byteOffset,f,g)),m.type===M.MB.U16&&(u=new E.mw(t,m.byteOffset,f,g))),null==u?this._dbg(W.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+m+")"):a=new K.a(u.typedBuffer,b,m.ncomp);break;case M.Lz.FeatureIndex:break;default:this._dbg(W.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+d.sem+"). Skipping vertex attribute.")}}catch(h){this._dbg(W.VerboseAPI,"Error Creating buffer ("+h+"). Skipping vertex attribute.")}}if(e.index){const i=e.index.view,r=void 0,n=i.byteOffset+i.byteCount;switch(e.index.view.type){case M.MB.U16:d=new E.av(t,i.byteOffset,r,n);break;case M.MB.U32:d=new E.Nu(t,i.byteOffset,r,n);break;case M.MB.U8:default:this._dbg(W.Error,"[Unsupported Feature] index type not supported ("+i.type+").")}}if(null==d&&null!=n){const e=n.count;if(e<65535){const t=new Uint16Array(e);d=new E.av(t)}else{const t=new Uint32Array(e);d=new E.Nu(t)}for(let t=0;t<e;t++)d.set(t,t)}return{positionView:n,positionAttr:s,colorAttr:a,texCoord0Attr:o,indicesView:d,normalsView:l,normalsAttr:c}}_onRemoveFromCache(e){const t=(0,U.WM)(this.view);t&&t.onRenderableEvicted(this,e.handle,e.totalMemory()),this.freeRenderable(e.handle)}_dbg(e,t){this._dbgFlags.has(e)&&(e===W.Error?s.Z.getLogger(this).error(t):s.Z.getLogger(this).warn(t))}};(0,r._)([(0,c.Cb)()],oe.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),(0,r._)([(0,c.Cb)()],oe.prototype,"layer",void 0),(0,r._)([(0,c.Cb)()],oe.prototype,"elevationOffset",null),oe=(0,r._)([(0,d.j)("esri.views.3d.layers.Tiles3DLayerView3D")],oe);const le=oe},42069:(e,t,i)=>{i.d(t,{A:()=>d});var r=i(27366),n=i(42537),s=i(66978),a=i(94172),o=i(49861),l=(i(93169),i(32718),i(84936),i(69912)),c=i(5354);const d=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(e){super.postscript(e),(0,c.qC)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=new AbortController,t=e.signal;this.addHandles((0,n.kB)((()=>e.abort()))),await(0,a.N1)((()=>this.view.defaultsFromMap?.heightModelInfoReady),t),(0,s.k_)(t);const i=(0,c.Wt)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(i)throw i}canResume(){const e=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!e?.minScale||!e.maxScale||e.minScale>=e.maxScale)}getSuspendInfo(){const e=super.getSuspendInfo(),t=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return t&&t.minScale&&t.maxScale&&t.minScale<t.maxScale&&(e.outsideScaleRange=!0),e}};return(0,r._)([(0,o.Cb)()],t.prototype,"view",void 0),(0,r._)([(0,o.Cb)()],t.prototype,"slicePlaneEnabled",void 0),t=(0,r._)([(0,l.j)("esri.views.3d.layers.LayerView3D")],t),t}},55763:(e,t,i)=>{i.d(t,{u:()=>v});var r=i(27366),n=i(7138),s=i(91505),a=i(32718),o=i(49861),l=(i(93169),i(84936),i(69912)),c=i(29134),d=i(7025),u=i(32035),h=i(12400),p=i(51066),m=i(65156),f=i(23470),g=i(2985),y=i(4035),b=i(88153),_=i(54463);let v=class extends(s.Z.EventedMixin(n.Z)){constructor(e){super(e),this._tmpEvent=new y.c,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=(0,b.Z8)(this.view.state.viewingMode),this._intersector.options.store=_.eC.MIN,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,t,i,r){const n=this._renderCoordsHelper,s=(0,u.s)(M,e,t,i);if(!n.toRenderCoords(s,r,s))return a.Z.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:o,_intersector:l,intersectionHandler:c}=this,d=o.fullExtent,h=null!=d&&Number.isFinite(d.xmin)&&Number.isFinite(d.xmax)&&Number.isFinite(d.ymin)&&Number.isFinite(d.ymax)&&Number.isFinite(d.zmin)&&Number.isFinite(d.zmax)?new g.r(d.zmin,d.zmax):o.elevationRange;if(null==h)return null;const p=o.elevationOffset,m=h.elevationRangeMin+p,f=h.elevationRangeMax+p,y=n.setAltitude(C,f,s),b=n.setAltitude(x,m,s);return l.reset(y,b,null),c.intersect(l,null,y,b,null,!0),l.results.min.getIntersectionPoint(s)?n.getAltitude(s):null}getSphereElevationBounds(e,t){return(0,p.s)(e,t,E,this._renderSR),this._layerElevationSource.getElevationRange(E)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new g.r(e.zmin,e.zmax):null}objectsChanged(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){(0,m.cS)(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){(0,m.cS)(t);for(const i of e)this._expandExtent(i,t)}_expandExtent(e,t){const i=this.spatialReference;if(null==i)return;if(null==e)return;(0,c.en)(w,e.quaternion),w[12]=e.center[0],w[13]=e.center[1],w[14]=e.center[2];const r=e.halfSize;for(let n=0;n<8;++n)M[0]=1&n?r[0]:-r[0],M[1]=2&n?r[1]:-r[1],M[2]=4&n?r[2]:-r[2],(0,u.e)(M,M,w),this._renderCoordsHelper.fromRenderCoords(M,M,i),(0,m.jn)(t,M,t)}};(0,r._)([(0,o.Cb)({constructOnly:!0})],v.prototype,"layerElevationSource",void 0),(0,r._)([(0,o.Cb)({constructOnly:!0})],v.prototype,"intersectionHandler",void 0),(0,r._)([(0,o.Cb)({constructOnly:!0})],v.prototype,"view",void 0),(0,r._)([(0,o.Cb)()],v.prototype,"spatialReference",null),v=(0,r._)([(0,l.j)("esri.views.3d.layers.i3s.LayerElevationProvider")],v);const w=(0,d.Ue)(),E=(0,f.f)(0,0,0,0),M=(0,h.Ue)(),C=(0,h.Ue)(),x=(0,h.Ue)()},89261:(e,t,i)=>{i.d(t,{T:()=>s});var r=i(92026),n=i(66978);class s{constructor(e,t){this._textureRep=e,this.loadPromise=null,this._disposed=!1;const i=this._textureRep.acquire(t);(0,n.y8)(i)?(i.then((e=>{this._disposed?(0,r.RY)(e):this._textureRef=e})),this.loadPromise=i):this._textureRef=i}dispose(){this._textureRef=(0,r.RY)(this._textureRef),this._disposed=!0}get glTexture(){return null!=this._textureRef?this._textureRef.glTexture:null}}},67581:(e,t,i)=>{i.d(t,{Z:()=>m});var r=i(27366),n=i(7138),s=i(91505),a=i(79056),o=i(32718),l=i(92026),c=i(67426),d=i(49861),u=(i(93169),i(84936),i(69912)),h=i(46634);let p=class extends((0,a.IG)((0,c.v)(s.Z.EventedMixin(n.Z)))){constructor(e){super(e),this._updatingHandles=new h.R,this.layer=null,this.parent=null}initialize(){this.when().catch((e=>{if("layerview:create-error"!==e.name){const t=this.layer&&this.layer.id||"no id",i=this.layer?.title||"no title";o.Z.getLogger(this).error("#resolve()",`Failed to resolve layer view (layer title: '${i}', id: '${t}')`,e)}}))}destroy(){this._updatingHandles=(0,l.SC)(this._updatingHandles)}get fullOpacity(){return(this.layer?.opacity??1)*(this.parent?.fullOpacity??1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this._updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){return!0===this.layer?.visible}set visible(e){this._overrideIfSome("visible",e)}canResume(){return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready||!1}getSuspendInfo(){const e=this.parent?.suspended?this.parent.suspendInfo:{};return this.view?.ready||(e.viewNotReady=!0),this.layer&&this.layer.loaded||(e.layerNotLoaded=!0),this.visible||(e.layerInvisible=!0),e}isUpdating(){return!1}};(0,r._)([(0,d.Cb)()],p.prototype,"fullOpacity",null),(0,r._)([(0,d.Cb)()],p.prototype,"layer",void 0),(0,r._)([(0,d.Cb)()],p.prototype,"parent",void 0),(0,r._)([(0,d.Cb)({readOnly:!0})],p.prototype,"suspended",null),(0,r._)([(0,d.Cb)({readOnly:!0})],p.prototype,"suspendInfo",null),(0,r._)([(0,d.Cb)({readOnly:!0})],p.prototype,"legendEnabled",null),(0,r._)([(0,d.Cb)({type:Boolean,readOnly:!0})],p.prototype,"updating",null),(0,r._)([(0,d.Cb)({readOnly:!0})],p.prototype,"updatingProgress",null),(0,r._)([(0,d.Cb)()],p.prototype,"visible",null),(0,r._)([(0,d.Cb)()],p.prototype,"view",void 0),p=(0,r._)([(0,u.j)("esri.views.layers.LayerView")],p);const m=p}}]);
//# sourceMappingURL=12996.c9689618.chunk.js.map